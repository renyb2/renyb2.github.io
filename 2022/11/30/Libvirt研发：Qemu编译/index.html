<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Libvirt研发：Qemu编译 | 任翌博的个人博客</title><meta name="description" content="简介QEMU is a generic and open source machine &amp; userspace emulator and virtualizer. QEMU is capable of emulating a complete machine in software without any need for hardware virtualization support."><meta name="keywords" content="KVM,Libvirt,虚拟化,Qemu"><meta name="author" content="任翌博"><meta name="copyright" content="任翌博"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/icon.png"><link rel="canonical" href="https://renyb2.github.io/2022/11/30/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="Libvirt研发：Qemu编译"><meta property="og:url" content="https://renyb2.github.io/2022/11/30/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91/"><meta property="og:site_name" content="任翌博的个人博客"><meta property="og:description" content="简介QEMU is a generic and open source machine &amp; userspace emulator and virtualizer. QEMU is capable of emulating a complete machine in software without any need for hardware virtualization support."><meta property="og:image" content="https://pic4.zhimg.com/v2-13ad0113980b93e8f8841ca1f6542157_r.jpg"><meta property="article:published_time" content="2022-11-30T05:49:49.000Z"><meta property="article:modified_time" content="2022-11-30T09:00:13.563Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.1.1',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: false,
  copyright: {"limitCount":50,"languages":{"author":"作者: 任翌博","link":"链接: ","source":"来源: 任翌博的个人博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false    
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2022-11-30 17:00:13'
}</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img {
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="任翌博的个人博客" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">85</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">64</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">18</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96"><span class="toc-number">2.</span> <span class="toc-text">安装依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91Qemu"><span class="toc-number">3.</span> <span class="toc-text">编译Qemu</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%AE%98%E6%96%B9%E6%BA%90%E7%A0%81%E5%8C%85%E7%BC%96%E8%AF%91"><span class="toc-number">3.1.</span> <span class="toc-text">基于官方源码包编译</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EGitHub%E7%BC%96%E8%AF%91"><span class="toc-number">3.2.</span> <span class="toc-text">基于GitHub编译</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#configure-%E9%85%8D%E7%BD%AE"><span class="toc-number">4.</span> <span class="toc-text">configure 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.</span> <span class="toc-text">常用配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E9%80%89%E9%85%8D%E7%BD%AE"><span class="toc-number">4.2.</span> <span class="toc-text">可选配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E9%AA%8C%E8%AF%81"><span class="toc-number">5.</span> <span class="toc-text">功能验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="toc-number">6.</span> <span class="toc-text">常见问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E6%8A%A5%E9%94%99%EF%BC%9Aerror-%E2%80%98SIOCGSTAMPNS%E2%80%99undeclared-here-not-in-a-function"><span class="toc-number">6.1.</span> <span class="toc-text">编译报错：error: ‘SIOCGSTAMPNS’undeclared here (not in a function)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VM%E5%90%AF%E5%8A%A8%E5%A4%B1%E8%B4%A5%EF%BC%9Aunsupported-machine-type"><span class="toc-number">6.2.</span> <span class="toc-text">VM启动失败：unsupported machine type</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VM%E5%90%AF%E5%8A%A8%E5%A4%B1%E8%B4%A5%EF%BC%9Aseccomp-support-is-disabled"><span class="toc-number">6.3.</span> <span class="toc-text">VM启动失败：seccomp support is disabled</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VM%E5%90%AF%E5%8A%A8%E5%A4%B1%E8%B4%A5%EF%BC%9ANUMA-node-binding-are-not-supported-by-this-QEMU"><span class="toc-number">6.4.</span> <span class="toc-text">VM启动失败：NUMA node binding are not supported by this QEMU</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VM%E5%90%AF%E5%8A%A8%E5%A4%B1%E8%B4%A5%EF%BC%9AUnknown-protocol-%E2%80%98rbd%E2%80%99"><span class="toc-number">6.5.</span> <span class="toc-text">VM启动失败：Unknown protocol ‘rbd’</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3"><span class="toc-number">7.</span> <span class="toc-text">参考文档</span></a></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://pic4.zhimg.com/v2-13ad0113980b93e8f8841ca1f6542157_r.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">任翌博的个人博客</a></span><span class="pull-right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Libvirt研发：Qemu编译</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-11-30T05:49:49.000Z" title="发表于 2022-11-30 13:49:49">2022-11-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-11-30T09:00:13.563Z" title="更新于 2022-11-30 17:00:13">2022-11-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Libvirt/">Libvirt</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>QEMU is a generic and open source machine &amp; userspace emulator and virtualizer.</p>
<p>QEMU is capable of emulating a complete machine in software without any need for hardware virtualization support. By using dynamic translation, it achieves very good performance. QEMU can also integrate with the Xen and KVM hypervisors to provide emulated hardware while allowing the hypervisor to manage the CPU. With hypervisor support, QEMU can achieve near native performance for CPUs. When QEMU emulates CPUs directly it is capable of running operating systems made for one machine (e.g. an ARMv7 board) on a different machine (e.g. an x86_64 PC board).</p>
<p>QEMU is also capable of providing userspace API virtualization for Linux and BSD kernel interfaces. This allows binaries compiled against one architecture ABI (e.g. the Linux PPC64 ABI) to be run on a host using a different architecture ABI (e.g. the Linux x86_64 ABI). This does not involve any hardware emulation, simply CPU and syscall emulation.</p>
<p>QEMU aims to fit into a variety of use cases. It can be invoked directly by users wishing to have full control over its behaviour and settings. It also aims to facilitate integration into higher level management layers, by providing a stable command line interface and monitor API. It is commonly invoked indirectly via the libvirt library when using open source applications such as oVirt, OpenStack and virt-manager.</p>
<p>QEMU as a whole is released under the GNU General Public License, version 2. For full licensing details, consult the LICENSE file.</p>
<h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><p><strong>1. 安装ninja</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone git://github.com/ninja-build/ninja.git &amp;&amp; cd ninja</span><br><span class="line"> ./configure.py --bootstrap</span><br><span class="line">cp ninja /usr/bin/</span><br><span class="line">ninja --version</span><br></pre></td></tr></table></figure>

<p><strong>2. 安装其他依赖</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install -y glib2 glib2-devel gtk2-devel</span><br></pre></td></tr></table></figure>

<h2 id="编译Qemu"><a href="#编译Qemu" class="headerlink" title="编译Qemu"></a>编译Qemu</h2><h3 id="基于官方源码包编译"><a href="#基于官方源码包编译" class="headerlink" title="基于官方源码包编译"></a>基于官方源码包编译</h3><p>官网下载地址：<a target="_blank" rel="noopener" href="https://www.qemu.org/download/#source">Download QEMU - QEMU</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载源码</span></span><br><span class="line">wget https://download.qemu.org/qemu-7.2.0-rc2.tar.xz</span><br><span class="line">tar xvJf qemu-7.2.0-rc2.tar.xz</span><br><span class="line">cd qemu-7.2.0-rc2 &amp;&amp; mkdir build &amp;&amp; cd build</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置</span></span><br><span class="line">../configure</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译</span></span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h3 id="基于GitHub编译"><a href="#基于GitHub编译" class="headerlink" title="基于GitHub编译"></a>基于GitHub编译</h3><p>GitHub：<a target="_blank" rel="noopener" href="https://github.com/qemu/qemu/tree/master">https://github.com/qemu/qemu/tree/master</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载源码</span></span><br><span class="line">git clone https://github.com/qemu/qemu.git</span><br><span class="line">cd qemu</span><br><span class="line">git submodule init</span><br><span class="line">git submodule update --recursive</span><br><span class="line">mkdir build &amp;&amp; cd build</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置</span></span><br><span class="line">../configure</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译</span></span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h2 id="configure-配置"><a href="#configure-配置" class="headerlink" title="configure 配置"></a>configure 配置</h2><h3 id="常用配置"><a href="#常用配置" class="headerlink" title="常用配置"></a>常用配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../configure --enable-kvm --enable-spice --enable-vnc --enable-guest-agent --enable-rbd --enable-seccomp --enable-numa</span><br></pre></td></tr></table></figure>

<h3 id="可选配置"><a href="#可选配置" class="headerlink" title="可选配置"></a>可选配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line">[root@k104 qemu-2.12.0]# ./configure --help</span><br><span class="line"></span><br><span class="line">Usage: configure [options]</span><br><span class="line">Options: [defaults in brackets after descriptions]</span><br><span class="line"></span><br><span class="line">Standard options:</span><br><span class="line">  --help                   print this message</span><br><span class="line">  --prefix=PREFIX          install in PREFIX [/usr/local]</span><br><span class="line">  --interp-prefix=PREFIX   where to find shared libraries, etc.</span><br><span class="line">                           use %M for cpu name [/usr/gnemul/qemu-%M]</span><br><span class="line">  --target-list=LIST       set target list (default: build everything)</span><br><span class="line">                           Available targets: aarch64-softmmu alpha-softmmu</span><br><span class="line">                           arm-softmmu cris-softmmu hppa-softmmu i386-softmmu</span><br><span class="line">                           lm32-softmmu m68k-softmmu microblazeel-softmmu</span><br><span class="line">                           microblaze-softmmu mips64el-softmmu mips64-softmmu</span><br><span class="line">                           mipsel-softmmu mips-softmmu moxie-softmmu</span><br><span class="line">                           nios2-softmmu or1k-softmmu ppc64-softmmu</span><br><span class="line">                           ppcemb-softmmu ppc-softmmu riscv32-softmmu</span><br><span class="line">                           riscv64-softmmu s390x-softmmu sh4eb-softmmu</span><br><span class="line">                           sh4-softmmu sparc64-softmmu sparc-softmmu</span><br><span class="line">                           tricore-softmmu unicore32-softmmu x86_64-softmmu</span><br><span class="line">                           xtensaeb-softmmu xtensa-softmmu</span><br><span class="line">                           aarch64_be-linux-user aarch64-linux-user</span><br><span class="line">                           alpha-linux-user armeb-linux-user arm-linux-user</span><br><span class="line">                           cris-linux-user hppa-linux-user i386-linux-user</span><br><span class="line">                           m68k-linux-user microblazeel-linux-user</span><br><span class="line">                           microblaze-linux-user mips64el-linux-user</span><br><span class="line">                           mips64-linux-user mipsel-linux-user mips-linux-user</span><br><span class="line">                           mipsn32el-linux-user mipsn32-linux-user</span><br><span class="line">                           nios2-linux-user or1k-linux-user</span><br><span class="line">                           ppc64abi32-linux-user ppc64le-linux-user</span><br><span class="line">                           ppc64-linux-user ppc-linux-user riscv32-linux-user</span><br><span class="line">                           riscv64-linux-user s390x-linux-user sh4eb-linux-user</span><br><span class="line">                           sh4-linux-user sparc32plus-linux-user</span><br><span class="line">                           sparc64-linux-user sparc-linux-user</span><br><span class="line">                           tilegx-linux-user x86_64-linux-user</span><br><span class="line">                           xtensaeb-linux-user xtensa-linux-user</span><br><span class="line"></span><br><span class="line">Advanced options (experts only):</span><br><span class="line">  --source-path=PATH       path of source code [/root/renyb/qemu/qemu-2.12.0]</span><br><span class="line">  --cross-prefix=PREFIX    use PREFIX for compile tools []</span><br><span class="line">  --cc=CC                  use C compiler CC [cc]</span><br><span class="line">  --iasl=IASL              use ACPI compiler IASL [iasl]</span><br><span class="line">  --host-cc=CC             use C compiler CC [cc] for code run at</span><br><span class="line">                           build time</span><br><span class="line">  --cxx=CXX                use C++ compiler CXX [c++]</span><br><span class="line">  --objcc=OBJCC            use Objective-C compiler OBJCC [cc]</span><br><span class="line">  --extra-cflags=CFLAGS    append extra C compiler flags QEMU_CFLAGS</span><br><span class="line">  --extra-cxxflags=CXXFLAGS append extra C++ compiler flags QEMU_CXXFLAGS</span><br><span class="line">  --extra-ldflags=LDFLAGS  append extra linker flags LDFLAGS</span><br><span class="line">  --make=MAKE              use specified make [make]</span><br><span class="line">  --install=INSTALL        use specified install [install]</span><br><span class="line">  --python=PYTHON          use specified python [python]</span><br><span class="line">  --smbd=SMBD              use specified smbd [/usr/sbin/smbd]</span><br><span class="line">  --with-git=GIT           use specified git [git]</span><br><span class="line">  --static                 enable static build [no]</span><br><span class="line">  --mandir=PATH            install man pages in PATH</span><br><span class="line">  --datadir=PATH           install firmware in PATH/qemu</span><br><span class="line">  --docdir=PATH            install documentation in PATH/qemu</span><br><span class="line">  --bindir=PATH            install binaries in PATH</span><br><span class="line">  --libdir=PATH            install libraries in PATH</span><br><span class="line">  --libexecdir=PATH        install helper binaries in PATH</span><br><span class="line">  --sysconfdir=PATH        install config in PATH/qemu</span><br><span class="line">  --localstatedir=PATH     install local state in PATH (set at runtime on win32)</span><br><span class="line">  --firmwarepath=PATH      search PATH for firmware files</span><br><span class="line">  --with-confsuffix=SUFFIX suffix for QEMU data inside datadir/libdir/sysconfdir [/qemu]</span><br><span class="line">  --with-pkgversion=VERS   use specified string as sub-version of the package</span><br><span class="line">  --enable-debug           enable common debug build options</span><br><span class="line">  --enable-sanitizers      enable default sanitizers</span><br><span class="line">  --disable-strip          disable stripping binaries</span><br><span class="line">  --disable-werror         disable compilation abort on warning</span><br><span class="line">  --disable-stack-protector disable compiler-provided stack protection</span><br><span class="line">  --audio-drv-list=LIST    set audio drivers list:</span><br><span class="line">                           Available drivers: oss alsa sdl pa</span><br><span class="line">  --block-drv-whitelist=L  Same as --block-drv-rw-whitelist=L</span><br><span class="line">  --block-drv-rw-whitelist=L</span><br><span class="line">                           set block driver read-write whitelist</span><br><span class="line">                           (affects only QEMU, not qemu-img)</span><br><span class="line">  --block-drv-ro-whitelist=L</span><br><span class="line">                           set block driver read-only whitelist</span><br><span class="line">                           (affects only QEMU, not qemu-img)</span><br><span class="line">  --enable-trace-backends=B Set trace backend</span><br><span class="line">                           Available backends: dtrace ftrace log simple syslog ust</span><br><span class="line">  --with-trace-file=NAME   Full PATH,NAME of file to store traces</span><br><span class="line">                           Default:trace-&lt;pid&gt;</span><br><span class="line">  --disable-slirp          disable SLIRP userspace network connectivity</span><br><span class="line">  --enable-tcg-interpreter enable TCG with bytecode interpreter (TCI)</span><br><span class="line">  --enable-malloc-trim     enable libc malloc_trim() for memory optimization</span><br><span class="line">  --oss-lib                path to OSS library</span><br><span class="line">  --cpu=CPU                Build for host CPU [x86_64]</span><br><span class="line">  --with-coroutine=BACKEND coroutine backend. Supported options:</span><br><span class="line">                           ucontext, sigaltstack, windows</span><br><span class="line">  --enable-gcov            enable test coverage analysis with gcov</span><br><span class="line">  --gcov=GCOV              use specified gcov [gcov]</span><br><span class="line">  --disable-blobs          disable installing provided firmware blobs</span><br><span class="line">  --with-vss-sdk=SDK-path  enable Windows VSS support in QEMU Guest Agent</span><br><span class="line">  --with-win-sdk=SDK-path  path to Windows Platform SDK (to build VSS .tlb)</span><br><span class="line">  --tls-priority           default TLS protocol/cipher priority string</span><br><span class="line">  --enable-gprof           QEMU profiling with gprof</span><br><span class="line">  --enable-profiler        profiler support</span><br><span class="line">  --enable-xen-pv-domain-build</span><br><span class="line">                           xen pv domain builder</span><br><span class="line">  --enable-debug-stack-usage</span><br><span class="line">                           track the maximum stack usage of stacks created by qemu_alloc_stack</span><br><span class="line"></span><br><span class="line">Optional features, enabled with --enable-FEATURE and</span><br><span class="line">disabled with --disable-FEATURE, default is enabled if available:</span><br><span class="line"></span><br><span class="line">  system          all system emulation targets</span><br><span class="line">  user            supported user emulation targets</span><br><span class="line">  linux-user      all linux usermode emulation targets</span><br><span class="line">  bsd-user        all BSD usermode emulation targets</span><br><span class="line">  docs            build documentation</span><br><span class="line">  guest-agent     build the QEMU Guest Agent</span><br><span class="line">  guest-agent-msi build guest agent Windows MSI installation package</span><br><span class="line">  pie             Position Independent Executables</span><br><span class="line">  modules         modules support</span><br><span class="line">  debug-tcg       TCG debugging (default is disabled)</span><br><span class="line">  debug-info      debugging information</span><br><span class="line">  sparse          sparse checker</span><br><span class="line"></span><br><span class="line">  gnutls          GNUTLS cryptography support</span><br><span class="line">  nettle          nettle cryptography support</span><br><span class="line">  gcrypt          libgcrypt cryptography support</span><br><span class="line">  sdl             SDL UI</span><br><span class="line">  --with-sdlabi     select preferred SDL ABI 1.2 or 2.0</span><br><span class="line">  gtk             gtk UI</span><br><span class="line">  --with-gtkabi     select preferred GTK ABI 2.0 or 3.0</span><br><span class="line">  vte             vte support for the gtk UI</span><br><span class="line">  curses          curses UI</span><br><span class="line">  vnc             VNC UI support</span><br><span class="line">  vnc-sasl        SASL encryption for VNC server</span><br><span class="line">  vnc-jpeg        JPEG lossy compression for VNC server</span><br><span class="line">  vnc-png         PNG compression for VNC server</span><br><span class="line">  cocoa           Cocoa UI (Mac OS X only)</span><br><span class="line">  virtfs          VirtFS</span><br><span class="line">  mpath           Multipath persistent reservation passthrough</span><br><span class="line">  xen             xen backend driver support</span><br><span class="line">  xen-pci-passthrough</span><br><span class="line">  brlapi          BrlAPI (Braile)</span><br><span class="line">  curl            curl connectivity</span><br><span class="line">  membarrier      membarrier system call (for Linux 4.14+ or Windows)</span><br><span class="line">  fdt             fdt device tree</span><br><span class="line">  bluez           bluez stack connectivity</span><br><span class="line">  kvm             KVM acceleration support</span><br><span class="line">  hax             HAX acceleration support</span><br><span class="line">  hvf             Hypervisor.framework acceleration support</span><br><span class="line">  whpx            Windows Hypervisor Platform acceleration support</span><br><span class="line">  rdma            Enable RDMA-based migration and PVRDMA support</span><br><span class="line">  vde             support for vde network</span><br><span class="line">  netmap          support for netmap network</span><br><span class="line">  linux-aio       Linux AIO support</span><br><span class="line">  cap-ng          libcap-ng support</span><br><span class="line">  attr            attr and xattr support</span><br><span class="line">  vhost-net       vhost-net acceleration support</span><br><span class="line">  vhost-crypto    vhost-crypto acceleration support</span><br><span class="line">  spice           spice</span><br><span class="line">  rbd             rados block device (rbd)</span><br><span class="line">  libiscsi        iscsi support</span><br><span class="line">  libnfs          nfs support</span><br><span class="line">  smartcard       smartcard support (libcacard)</span><br><span class="line">  libusb          libusb (for usb passthrough)</span><br><span class="line">  live-block-migration   Block migration in the main migration stream</span><br><span class="line">  usb-redir       usb network redirection support</span><br><span class="line">  lzo             support of lzo compression library</span><br><span class="line">  snappy          support of snappy compression library</span><br><span class="line">  bzip2           support of bzip2 compression library</span><br><span class="line">                  (for reading bzip2-compressed dmg images)</span><br><span class="line">  seccomp         seccomp support</span><br><span class="line">  coroutine-pool  coroutine freelist (better performance)</span><br><span class="line">  glusterfs       GlusterFS backend</span><br><span class="line">  tpm             TPM support</span><br><span class="line">  libssh2         ssh block device support</span><br><span class="line">  numa            libnuma support</span><br><span class="line">  libxml2         for Parallels image format</span><br><span class="line">  tcmalloc        tcmalloc support</span><br><span class="line">  jemalloc        jemalloc support</span><br><span class="line">  replication     replication support</span><br><span class="line">  vhost-vsock     virtio sockets device support</span><br><span class="line">  opengl          opengl support</span><br><span class="line">  virglrenderer   virgl rendering support</span><br><span class="line">  xfsctl          xfsctl support</span><br><span class="line">  qom-cast-debug  cast debugging support</span><br><span class="line">  tools           build qemu-io, qemu-nbd and qemu-image tools</span><br><span class="line">  vxhs            Veritas HyperScale vDisk backend support</span><br><span class="line">  crypto-afalg    Linux AF_ALG crypto backend driver</span><br><span class="line">  vhost-user      vhost-user support</span><br><span class="line">  capstone        capstone disassembler support</span><br><span class="line"></span><br><span class="line">NOTE: The object files are built at the place where configure is launched</span><br></pre></td></tr></table></figure>

<h2 id="功能验证"><a href="#功能验证" class="headerlink" title="功能验证"></a>功能验证</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k104 ~]# qemu-system-aarch64 --version</span><br><span class="line">QEMU emulator version 2.12.0</span><br><span class="line">Copyright (c) 2003-2017 Fabrice Bellard and the QEMU Project developers</span><br><span class="line">[root@k104 ~]#</span><br><span class="line">[root@k104 ~]# qemu-aarch64 --version</span><br><span class="line">qemu-aarch64 version 2.12.0</span><br><span class="line">Copyright (c) 2003-2017 Fabrice Bellard and the QEMU Project developers</span><br></pre></td></tr></table></figure>

<p>qemu-aarch64 是用户模式的模拟器（更精确的表述应该是系统调用模拟器）</p>
<p>qemu-system-aarch64 是系统模拟器，可以模拟出整个机器并运行操作系统</p>
<p>qemu-aarch64 仅可用来运行二进制文件，因此你可以交叉编译完例如hello world之类的程序然后交给 qemu-aarch64 来运行，简单而高效。</p>
<p>而 qemu-system-aarch64 则需要把hello world程序下载到客户机操作系统能访问到的硬盘里才能运行。</p>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="编译报错：error-‘SIOCGSTAMPNS’undeclared-here-not-in-a-function"><a href="#编译报错：error-‘SIOCGSTAMPNS’undeclared-here-not-in-a-function" class="headerlink" title="编译报错：error: ‘SIOCGSTAMPNS’undeclared here (not in a function)"></a>编译报错：error: ‘SIOCGSTAMPNS’undeclared here (not in a function)</h3><p><img src="/2022/11/30/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91%5C%E7%BC%96%E8%AF%91%E6%8A%A5%E9%94%991.png"></p>
<p><strong>解决方案：</strong><code>qemu-2.12.0/linux-user/ioctls.h</code>增加头文件引用，内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sockios.h&gt;</span></span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="VM启动失败：unsupported-machine-type"><a href="#VM启动失败：unsupported-machine-type" class="headerlink" title="VM启动失败：unsupported machine type"></a>VM启动失败：unsupported machine type</h3><p><strong>报错信息：</strong> qemu-system-x86_64: -machine pc-i440fx-rhel7.2.0,accel=kvm,usb=off,dump-guest-core=off: unsupported machine type</p>
<p><img src="/2022/11/30/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91%5Cunsupported_machine_type.png"></p>
<p><strong>解决方案：</strong> 通过命令<code>qemu-system-x86_64 -machine help</code>查看支持的machine信息。若上层为OpenStack，则修改nova compute配置文件，libvirt - hw_machine_type = x86_64=pc-q35-2.12（x86_64=后面的值参考命令行输出）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@k104 ~]# qemu-system-x86_64 -machine help</span><br><span class="line">Supported machines are:</span><br><span class="line">pc-i440fx-2.9        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-2.8        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-2.7        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-2.6        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-2.5        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-2.4        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-2.3        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-2.2        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc                   Standard PC (i440FX + PIIX, 1996) (alias of pc-i440fx-2.12)</span><br><span class="line">pc-i440fx-2.12       Standard PC (i440FX + PIIX, 1996) (default)</span><br><span class="line">pc-i440fx-2.11       Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-2.10       Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-2.1        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-2.0        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-1.7        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-1.6        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-1.5        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-1.4        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-1.3               Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-1.2               Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-1.1               Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-1.0               Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-0.15              Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-0.14              Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-0.13              Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-0.12              Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-0.11              Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-0.10              Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-q35-2.9           Standard PC (Q35 + ICH9, 2009)</span><br><span class="line">pc-q35-2.8           Standard PC (Q35 + ICH9, 2009)</span><br><span class="line">pc-q35-2.7           Standard PC (Q35 + ICH9, 2009)</span><br><span class="line">pc-q35-2.6           Standard PC (Q35 + ICH9, 2009)</span><br><span class="line">pc-q35-2.5           Standard PC (Q35 + ICH9, 2009)</span><br><span class="line">pc-q35-2.4           Standard PC (Q35 + ICH9, 2009)</span><br><span class="line">q35                  Standard PC (Q35 + ICH9, 2009) (alias of pc-q35-2.12)</span><br><span class="line">pc-q35-2.12          Standard PC (Q35 + ICH9, 2009)</span><br><span class="line">pc-q35-2.11          Standard PC (Q35 + ICH9, 2009)</span><br><span class="line">pc-q35-2.10          Standard PC (Q35 + ICH9, 2009)</span><br><span class="line">isapc                ISA-only PC</span><br><span class="line">none                 empty machine</span><br></pre></td></tr></table></figure>

<h3 id="VM启动失败：seccomp-support-is-disabled"><a href="#VM启动失败：seccomp-support-is-disabled" class="headerlink" title="VM启动失败：seccomp support is disabled"></a>VM启动失败：seccomp support is disabled</h3><p><strong>报错信息：</strong> qemu-system-x86_64: -sandbox on,obsolete=deny,elevateprivileges=deny,spawn=deny,resourcecontrol=deny: seccomp support is disabled</p>
<p><img src="/2022/11/30/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91%5Cunsupported_machine_type.png"></p>
<p><strong>参考链接：</strong><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1162100">虚拟化安全sandbox技术分析 - 腾讯云开发者社区-腾讯云</a></p>
<p><strong>解决方案：</strong> 有两种方法可解决该问题：</p>
<p>方法1 - 编译时，需启用<code>seccomp</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 安装依赖</span></span><br><span class="line">yum -y install libseccomp</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. ../configure 编译时，增加--<span class="built_in">enable</span>-seccomp参数</span></span><br></pre></td></tr></table></figure>

<p>方法2 - <code>/etc/libvirt/qemu.conf</code>配置文件中，关闭<code>seccomp_sandbox</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Use seccomp syscall sandbox <span class="keyword">in</span> QEMU.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1 == seccomp enabled, 0 == seccomp disabled</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If it is <span class="built_in">unset</span> (or -1), <span class="keyword">then</span> seccomp will be enabled</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> only <span class="keyword">if</span> QEMU &gt;= 2.11.0 is detected, otherwise it is</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> left disabled. This ensures the default config gets</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> protection <span class="keyword">for</span> new QEMU using the blacklist approach.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line">seccomp_sandbox = 0</span><br></pre></td></tr></table></figure>

<h3 id="VM启动失败：NUMA-node-binding-are-not-supported-by-this-QEMU"><a href="#VM启动失败：NUMA-node-binding-are-not-supported-by-this-QEMU" class="headerlink" title="VM启动失败：NUMA node binding are not supported by this QEMU"></a>VM启动失败：NUMA node binding are not supported by this QEMU</h3><p><strong>报错信息：</strong> qemu-system-x86_64: -object memory-backend-file,id=ram-node0,prealloc=yes,mem-path=/dev/hugepages/libvirt/qemu/1-instance-0000006f,share=yes,size=4294967296,host-nodes=0,policy=bind: NUMA node binding are not supported by this QEMU</p>
<p><img src="/2022/11/30/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91%5Cunsupported_numa.png"></p>
<p><strong>解决方案：</strong> 编译时，需启用<code>numa</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 安装依赖</span></span><br><span class="line">yum -y install numactl-libs</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. ../configure 编译时，增加--<span class="built_in">enable</span>-numa参数</span></span><br></pre></td></tr></table></figure>

<h3 id="VM启动失败：Unknown-protocol-‘rbd’"><a href="#VM启动失败：Unknown-protocol-‘rbd’" class="headerlink" title="VM启动失败：Unknown protocol ‘rbd’"></a>VM启动失败：Unknown protocol ‘rbd’</h3><p><strong>报错信息：</strong> qemu-system-x86_64: -drive file=rbd:cinder-volumes/c1a319f3-9185-4f94-9986-1fb7f6a0c18d:id=cinder:auth_supported=cephx;none:mon_host=111.111.9.104:6789,file.password-secret=virtio-disk0-secret0,format=raw,if=none,id=drive-virtio-disk0,serial=c1a319f3-9185-4f94-9986-1fb7f6a0c18d,cache=writeback,discard=unmap: Unknown protocol ‘rbd’</p>
<p><img src="/2022/11/30/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91%5Cunknown_protocol_rbd.png"></p>
<p><strong>解决方案：</strong> 编译时，需启用<code>rbd</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 安装依赖</span></span><br><span class="line">yum -y install librbd-devel</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. ../configure 编译时，增加--<span class="built_in">enable</span>-rbd参数</span></span><br></pre></td></tr></table></figure>

<p>检测是否支持rbd：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">()[root@k207 /]# qemu-img -h | grep rbd</span><br><span class="line">Supported formats: blkdebug blkreplay blkverify bochs cloop copy-on-read dmg file ftp ftps gluster host_cdrom host_device http https iscsi iser luks nbd null-aio null-co nvme parallels qcow qcow2 qed quorum raw rbd sheepdog ssh throttle vdi vhdx vmdk vpc vvfat</span><br></pre></td></tr></table></figure>

<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul>
<li><a target="_blank" rel="noopener" href="https://wiki.qemu.org/Documentation">QEMU官方文档：Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.qemu.org/Hosts/Linux">QEMU官方文档：Hosts/Linux - QEMU</a></li>
<li><a target="_blank" rel="noopener" href="https://hlyani.github.io/notes/openstack/qemu_make.html">QEMU 源码编译</a></li>
</ul>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">任翌博</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://renyb2.github.io/2022/11/30/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91/">https://renyb2.github.io/2022/11/30/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://renyb2.github.io" target="_blank">任翌博的个人博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/KVM/">KVM</a><a class="post-meta__tags" href="/tags/Libvirt/">Libvirt</a><a class="post-meta__tags" href="/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/">虚拟化</a><a class="post-meta__tags" href="/tags/Qemu/">Qemu</a></div><div class="post_share"><div class="social-share" data-image="https://pic4.zhimg.com/v2-13ad0113980b93e8f8841ca1f6542157_r.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/11/30/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9A9p-virtio/"><img class="prev-cover" src="https://pic4.zhimg.com/v2-13ad0113980b93e8f8841ca1f6542157_r.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Libvirt研发：9p virtio</div></div></a></div><div class="next-post pull-right"><a href="/2022/11/22/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9AGPU%E9%A9%B1%E5%8A%A8%E5%AE%89%E8%A3%85/"><img class="next-cover" src="https://www.numerama.com/content/uploads/2019/05/nvidia-logo.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">NVIDIA使用：GPU驱动安装</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2022/11/30/Libvirt研发：9p-virtio/" title="Libvirt研发：9p virtio"><img class="relatedPosts_cover" src="https://pic4.zhimg.com/v2-13ad0113980b93e8f8841ca1f6542157_r.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-30</div><div class="relatedPosts_title">Libvirt研发：9p virtio</div></div></a></div><div class="relatedPosts_item"><a href="/2022/05/31/Libvirt使用：通用手册/" title="Libvirt使用：通用手册"><img class="relatedPosts_cover" src="https://pic4.zhimg.com/v2-13ad0113980b93e8f8841ca1f6542157_r.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-31</div><div class="relatedPosts_title">Libvirt使用：通用手册</div></div></a></div><div class="relatedPosts_item"><a href="/2022/11/10/Libvirt研发：屏蔽虚拟化特性/" title="Libvirt研发：屏蔽虚拟化特性"><img class="relatedPosts_cover" src="https://pic4.zhimg.com/v2-13ad0113980b93e8f8841ca1f6542157_r.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-10</div><div class="relatedPosts_title">Libvirt研发：屏蔽虚拟化特性</div></div></a></div><div class="relatedPosts_item"><a href="/2022/11/15/Libvirt研发：虚拟化特性检测/" title="Libvirt研发：虚拟化特性检测"><img class="relatedPosts_cover" src="https://pic4.zhimg.com/v2-13ad0113980b93e8f8841ca1f6542157_r.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-15</div><div class="relatedPosts_title">Libvirt研发：虚拟化特性检测</div></div></a></div></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By 任翌博</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><canvas class="fireworks"></canvas><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script defer="defer" id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script></div></body></html>