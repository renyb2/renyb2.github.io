<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>任翌博的个人博客</title>
  
  <subtitle>Welcome to my blog...</subtitle>
  <link href="https://renyb2.github.io/atom.xml" rel="self"/>
  
  <link href="https://renyb2.github.io/"/>
  <updated>2022-09-01T01:56:19.161Z</updated>
  <id>https://renyb2.github.io/</id>
  
  <author>
    <name>任翌博</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>OpenStack使用：GPU卡使用</title>
    <link href="https://renyb2.github.io/2022/08/22/OpenStack%E4%BD%BF%E7%94%A8%EF%BC%9AGPU%E5%8D%A1%E4%BD%BF%E7%94%A8/"/>
    <id>https://renyb2.github.io/2022/08/22/OpenStack%E4%BD%BF%E7%94%A8%EF%BC%9AGPU%E5%8D%A1%E4%BD%BF%E7%94%A8/</id>
    <published>2022-08-22T02:57:57.000Z</published>
    <updated>2022-09-01T01:56:19.161Z</updated>
    
    <content type="html"><![CDATA[<h2 id="含有多个设备的GPU"><a href="#含有多个设备的GPU" class="headerlink" title="含有多个设备的GPU"></a>含有多个设备的GPU</h2><p>常见型号：Quadro RTX 6000/8000</p><h3 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h3><p>系统内<code>lspci</code>查看显卡信息如下，可以看到同一个PCI插槽上（b1）包含了4个设备：VGA compatible、Audio device、USB、Serial bus，同时4个设备对应的驱动各不相同。</p><p><img src="/2022/08/22/OpenStack%E4%BD%BF%E7%94%A8%EF%BC%9AGPU%E5%8D%A1%E4%BD%BF%E7%94%A8/lspci%E4%BF%A1%E6%81%AF.png" alt="lspci信息"></p><p><img src="/2022/08/22/OpenStack%E4%BD%BF%E7%94%A8%EF%BC%9AGPU%E5%8D%A1%E4%BD%BF%E7%94%A8/%E5%8E%9F%E5%A7%8B%E9%A9%B1%E5%8A%A8.png" alt="原始驱动"></p><p>目前cyborg暂不支持此类加速设备的管理，cyborg采集的attach handle info中，只包含了function 0，即生成的xml中仅会透传GPU中的1个设备进入虚机，由于设备不完整，会导致libvirt会无法拉起虚机。</p><p><img src="/2022/08/22/OpenStack%E4%BD%BF%E7%94%A8%EF%BC%9AGPU%E5%8D%A1%E4%BD%BF%E7%94%A8/cyborg%E9%87%87%E9%9B%86%E5%88%B0%E7%9A%84%E4%BF%A1%E6%81%AF.png" alt="cyborg采集到的信息"></p><p>使用此类GPU，需要通过nova compute的PCI透传功能实现，<strong>总体思路</strong>如下：</p><ol><li>切换GPU卡各类设备的驱动为vfio_pci。</li><li>透传GPU卡的所有设备至虚机。</li></ol><p>若这两点有一点不满足，libvirt在拉起虚机时均会报如下报错：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br></pre></td><td class="code"><pre><span class="line">2022-08-20 16:39:06.047 3711 INFO nova.compute.claims [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Claim successful on node node01</span><br><span class="line">2022-08-20 16:39:06.259 3711 WARNING nova.virt.osinfo [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] Cannot find OS information - Reason: (No configuration information found for operating system Windows): OsInfoNotFound: No configuration information found for operating system Windows</span><br><span class="line">2022-08-20 16:39:06.282 3711 INFO nova.virt.libvirt.driver [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Ignoring supplied device name: /dev/vda. Libvirt can&#x27;t honour user-supplied dev names</span><br><span class="line">2022-08-20 16:39:06.283 3711 WARNING nova.virt.osinfo [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] Cannot find OS information - Reason: (No configuration information found for operating system Windows): OsInfoNotFound: No configuration information found for operating system Windows</span><br><span class="line">2022-08-20 16:39:06.402 3711 INFO nova.virt.block_device [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Booting with volume-backed-image eb3aee11-f487-45e3-ac36-984904ad010a at /dev/vda</span><br><span class="line">2022-08-20 16:39:12.973 3711 WARNING nova.virt.osinfo [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] Cannot find OS information - Reason: (No configuration information found for operating system Windows): OsInfoNotFound: No configuration information found for operating system Windows</span><br><span class="line">2022-08-20 16:39:12.975 3711 INFO nova.virt.libvirt.driver [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Creating image</span><br><span class="line">2022-08-20 16:39:13.008 3711 WARNING nova.virt.osinfo [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] Cannot find OS information - Reason: (No configuration information found for operating system Windows): OsInfoNotFound: No configuration information found for operating system Windows</span><br><span class="line">2022-08-20 16:39:13.013 3711 WARNING nova.virt.libvirt.driver [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] USB tablet requested for guests by host configuration. In order to accept this request VNC should be enabled or SPICE and SPICE agent disabled on host.</span><br><span class="line">2022-08-20 16:39:15.811 3711 ERROR nova.virt.libvirt.guest [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] Error launching a defined domain with XML: &lt;domain type=&#x27;kvm&#x27;&gt;</span><br><span class="line">  &lt;name&gt;instance-00000007&lt;/name&gt;</span><br><span class="line">  &lt;uuid&gt;285e807d-426d-4b4a-b500-e89f92b9172a&lt;/uuid&gt;</span><br><span class="line">  &lt;metadata&gt;</span><br><span class="line">    &lt;nova:instance xmlns:nova=&quot;http://openstack.org/xmlns/libvirt/nova/1.0&quot;&gt;</span><br><span class="line">      &lt;nova:package version=&quot;20.6.1&quot;/&gt;</span><br><span class="line">      &lt;nova:name&gt;win10-1&lt;/nova:name&gt;</span><br><span class="line">      &lt;nova:creationTime&gt;2022-08-20 16:39:12&lt;/nova:creationTime&gt;</span><br><span class="line">      &lt;nova:flavor name=&quot;win10_8C16G&quot;&gt;</span><br><span class="line">        &lt;nova:memory&gt;16384&lt;/nova:memory&gt;</span><br><span class="line">        &lt;nova:disk&gt;100&lt;/nova:disk&gt;</span><br><span class="line">        &lt;nova:swap&gt;0&lt;/nova:swap&gt;</span><br><span class="line">        &lt;nova:ephemeral&gt;0&lt;/nova:ephemeral&gt;</span><br><span class="line">        &lt;nova:vcpus&gt;8&lt;/nova:vcpus&gt;</span><br><span class="line">      &lt;/nova:flavor&gt;</span><br><span class="line">      &lt;nova:owner&gt;</span><br><span class="line">        &lt;nova:user uuid=&quot;20f2649ce88142f19048b0aa090b78a1&quot;&gt;admin&lt;/nova:user&gt;</span><br><span class="line">        &lt;nova:project uuid=&quot;a1670d65a7e644e2a78fa31a001f284b&quot;&gt;admin&lt;/nova:project&gt;</span><br><span class="line">      &lt;/nova:owner&gt;</span><br><span class="line">    &lt;/nova:instance&gt;</span><br><span class="line">  &lt;/metadata&gt;</span><br><span class="line">  &lt;memory unit=&#x27;KiB&#x27;&gt;16777216&lt;/memory&gt;</span><br><span class="line">  &lt;currentMemory unit=&#x27;KiB&#x27;&gt;16777216&lt;/currentMemory&gt;</span><br><span class="line">  &lt;memoryBacking&gt;</span><br><span class="line">    &lt;hugepages&gt;</span><br><span class="line">      &lt;page size=&#x27;1048576&#x27; unit=&#x27;KiB&#x27; nodeset=&#x27;0&#x27;/&gt;</span><br><span class="line">    &lt;/hugepages&gt;</span><br><span class="line">  &lt;/memoryBacking&gt;</span><br><span class="line">  &lt;vcpu placement=&#x27;static&#x27;&gt;8&lt;/vcpu&gt;</span><br><span class="line">  &lt;cputune&gt;</span><br><span class="line">    &lt;shares&gt;8192&lt;/shares&gt;</span><br><span class="line">    &lt;vcpupin vcpu=&#x27;0&#x27; cpuset=&#x27;3-15,35-47&#x27;/&gt;</span><br><span class="line">    &lt;vcpupin vcpu=&#x27;1&#x27; cpuset=&#x27;3-15,35-47&#x27;/&gt;</span><br><span class="line">    &lt;vcpupin vcpu=&#x27;2&#x27; cpuset=&#x27;3-15,35-47&#x27;/&gt;</span><br><span class="line">    &lt;vcpupin vcpu=&#x27;3&#x27; cpuset=&#x27;3-15,35-47&#x27;/&gt;</span><br><span class="line">    &lt;vcpupin vcpu=&#x27;4&#x27; cpuset=&#x27;3-15,35-47&#x27;/&gt;</span><br><span class="line">    &lt;vcpupin vcpu=&#x27;5&#x27; cpuset=&#x27;3-15,35-47&#x27;/&gt;</span><br><span class="line">    &lt;vcpupin vcpu=&#x27;6&#x27; cpuset=&#x27;3-15,35-47&#x27;/&gt;</span><br><span class="line">    &lt;vcpupin vcpu=&#x27;7&#x27; cpuset=&#x27;3-15,35-47&#x27;/&gt;</span><br><span class="line">    &lt;emulatorpin cpuset=&#x27;3-15,35-47&#x27;/&gt;</span><br><span class="line">  &lt;/cputune&gt;</span><br><span class="line">  &lt;numatune&gt;</span><br><span class="line">    &lt;memory mode=&#x27;strict&#x27; nodeset=&#x27;0&#x27;/&gt;</span><br><span class="line">    &lt;memnode cellid=&#x27;0&#x27; mode=&#x27;strict&#x27; nodeset=&#x27;0&#x27;/&gt;</span><br><span class="line">  &lt;/numatune&gt;</span><br><span class="line">  &lt;sysinfo type=&#x27;smbios&#x27;&gt;</span><br><span class="line">    &lt;system&gt;</span><br><span class="line">      &lt;entry name=&#x27;manufacturer&#x27;&gt;OpenStack Foundation&lt;/entry&gt;</span><br><span class="line">      &lt;entry name=&#x27;product&#x27;&gt;OpenStack Nova&lt;/entry&gt;</span><br><span class="line">      &lt;entry name=&#x27;version&#x27;&gt;20.6.1&lt;/entry&gt;</span><br><span class="line">      &lt;entry name=&#x27;serial&#x27;&gt;285e807d-426d-4b4a-b500-e89f92b9172a&lt;/entry&gt;</span><br><span class="line">      &lt;entry name=&#x27;uuid&#x27;&gt;285e807d-426d-4b4a-b500-e89f92b9172a&lt;/entry&gt;</span><br><span class="line">      &lt;entry name=&#x27;family&#x27;&gt;Virtual Machine&lt;/entry&gt;</span><br><span class="line">    &lt;/system&gt;</span><br><span class="line">  &lt;/sysinfo&gt;</span><br><span class="line">  &lt;os&gt;</span><br><span class="line">    &lt;type arch=&#x27;x86_64&#x27; machine=&#x27;pc-i440fx-rhel7.2.0&#x27;&gt;hvm&lt;/type&gt;</span><br><span class="line">    &lt;boot dev=&#x27;hd&#x27;/&gt;</span><br><span class="line">    &lt;smbios mode=&#x27;sysinfo&#x27;/&gt;</span><br><span class="line">  &lt;/os&gt;</span><br><span class="line">  &lt;features&gt;</span><br><span class="line">    &lt;acpi/&gt;</span><br><span class="line">    &lt;apic/&gt;</span><br><span class="line">  &lt;/features&gt;</span><br><span class="line">  &lt;cpu mode=&#x27;host-model&#x27; check=&#x27;partial&#x27;&gt;</span><br><span class="line">    &lt;model fallback=&#x27;allow&#x27;/&gt;</span><br><span class="line">    &lt;topology sockets=&#x27;2&#x27; cores=&#x27;1&#x27; threads=&#x27;4&#x27;/&gt;</span><br><span class="line">    &lt;numa&gt;</span><br><span class="line">      &lt;cell id=&#x27;0&#x27; cpus=&#x27;0-7&#x27; memory=&#x27;16777216&#x27; unit=&#x27;KiB&#x27; memAccess=&#x27;shared&#x27;/&gt;</span><br><span class="line">    &lt;/numa&gt;</span><br><span class="line">  &lt;/cpu&gt;</span><br><span class="line">  &lt;clock offset=&#x27;utc&#x27;&gt;</span><br><span class="line">    &lt;timer name=&#x27;pit&#x27; tickpolicy=&#x27;delay&#x27;/&gt;</span><br><span class="line">    &lt;timer name=&#x27;rtc&#x27; tickpolicy=&#x27;catchup&#x27;/&gt;</span><br><span class="line">    &lt;timer name=&#x27;hpet&#x27; present=&#x27;no&#x27;/&gt;</span><br><span class="line">  &lt;/clock&gt;</span><br><span class="line">  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;</span><br><span class="line">  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;</span><br><span class="line">  &lt;on_crash&gt;destroy&lt;/on_crash&gt;</span><br><span class="line">  &lt;devices&gt;</span><br><span class="line">    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;</span><br><span class="line">    &lt;disk type=&#x27;network&#x27; device=&#x27;disk&#x27;&gt;</span><br><span class="line">      &lt;driver name=&#x27;qemu&#x27; type=&#x27;raw&#x27; cache=&#x27;writeback&#x27; discard=&#x27;unmap&#x27;/&gt;</span><br><span class="line">      &lt;auth username=&#x27;cinder&#x27;&gt;</span><br><span class="line">        &lt;secret type=&#x27;ceph&#x27; uuid=&#x27;457eb676-33da-42ec-9a8c-9293d545c337&#x27;/&gt;</span><br><span class="line">      &lt;/auth&gt;</span><br><span class="line">      &lt;source protocol=&#x27;rbd&#x27; name=&#x27;cinder-volumes/a728e5a5-ca72-4d70-8d2f-4b193d88a595&#x27;&gt;</span><br><span class="line">        &lt;host name=&#x27;10.99.22.45&#x27; port=&#x27;6789&#x27;/&gt;</span><br><span class="line">      &lt;/source&gt;</span><br><span class="line">      &lt;target dev=&#x27;vda&#x27; bus=&#x27;virtio&#x27;/&gt;</span><br><span class="line">      &lt;serial&gt;a728e5a5-ca72-4d70-8d2f-4b193d88a595&lt;/serial&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x0a&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/disk&gt;</span><br><span class="line">    &lt;controller type=&#x27;usb&#x27; index=&#x27;0&#x27; model=&#x27;piix3-uhci&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x01&#x27; function=&#x27;0x2&#x27;/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller type=&#x27;usb&#x27; index=&#x27;1&#x27; model=&#x27;ehci&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x05&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller type=&#x27;usb&#x27; index=&#x27;2&#x27; model=&#x27;nec-xhci&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x06&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller type=&#x27;usb&#x27; index=&#x27;3&#x27; model=&#x27;ehci&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x07&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller type=&#x27;usb&#x27; index=&#x27;4&#x27; model=&#x27;nec-xhci&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x08&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller type=&#x27;pci&#x27; index=&#x27;0&#x27; model=&#x27;pci-root&#x27;/&gt;</span><br><span class="line">    &lt;controller type=&#x27;virtio-serial&#x27; index=&#x27;0&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x09&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;interface type=&#x27;bridge&#x27;&gt;</span><br><span class="line">      &lt;mac address=&#x27;fa:16:3e:58:02:a6&#x27;/&gt;</span><br><span class="line">      &lt;source bridge=&#x27;br-int&#x27;/&gt;</span><br><span class="line">      &lt;virtualport type=&#x27;openvswitch&#x27;&gt;</span><br><span class="line">        &lt;parameters interfaceid=&#x27;2fdb3a80-a1ca-4927-b11e-2c40024dad69&#x27;/&gt;</span><br><span class="line">      &lt;/virtualport&gt;</span><br><span class="line">      &lt;target dev=&#x27;tap2fdb3a80-a1&#x27;/&gt;</span><br><span class="line">      &lt;model type=&#x27;virtio&#x27;/&gt;</span><br><span class="line">      &lt;mtu size=&#x27;1500&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x03&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/interface&gt;</span><br><span class="line">    &lt;serial type=&#x27;pty&#x27;&gt;</span><br><span class="line">      &lt;log file=&#x27;/var/lib/nova/instances/285e807d-426d-4b4a-b500-e89f92b9172a/console.log&#x27; append=&#x27;off&#x27;/&gt;</span><br><span class="line">      &lt;target type=&#x27;isa-serial&#x27; port=&#x27;0&#x27;&gt;</span><br><span class="line">        &lt;model name=&#x27;isa-serial&#x27;/&gt;</span><br><span class="line">      &lt;/target&gt;</span><br><span class="line">    &lt;/serial&gt;</span><br><span class="line">    &lt;console type=&#x27;pty&#x27;&gt;</span><br><span class="line">      &lt;log file=&#x27;/var/lib/nova/instances/285e807d-426d-4b4a-b500-e89f92b9172a/console.log&#x27; append=&#x27;off&#x27;/&gt;</span><br><span class="line">      &lt;target type=&#x27;serial&#x27; port=&#x27;0&#x27;/&gt;</span><br><span class="line">    &lt;/console&gt;</span><br><span class="line">    &lt;channel type=&#x27;spicevmc&#x27;&gt;</span><br><span class="line">      &lt;target type=&#x27;virtio&#x27; name=&#x27;com.redhat.spice.0&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;virtio-serial&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; port=&#x27;1&#x27;/&gt;</span><br><span class="line">    &lt;/channel&gt;</span><br><span class="line">    &lt;channel type=&#x27;unix&#x27;&gt;</span><br><span class="line">      &lt;source mode=&#x27;bind&#x27; path=&#x27;/var/lib/libvirt/qemu/org.qemu.guest_agent.0.instance-00000007.sock&#x27;/&gt;</span><br><span class="line">      &lt;target type=&#x27;virtio&#x27; name=&#x27;org.qemu.guest_agent.0&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;virtio-serial&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; port=&#x27;2&#x27;/&gt;</span><br><span class="line">    &lt;/channel&gt;</span><br><span class="line">    &lt;input type=&#x27;mouse&#x27; bus=&#x27;ps2&#x27;/&gt;</span><br><span class="line">    &lt;input type=&#x27;keyboard&#x27; bus=&#x27;ps2&#x27;/&gt;</span><br><span class="line">    &lt;graphics type=&#x27;spice&#x27; autoport=&#x27;yes&#x27; listen=&#x27;0.0.0.0&#x27;&gt;</span><br><span class="line">      &lt;listen type=&#x27;address&#x27; address=&#x27;0.0.0.0&#x27;/&gt;</span><br><span class="line">    &lt;/graphics&gt;</span><br><span class="line">    &lt;sound model=&#x27;ac97&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x04&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/sound&gt;</span><br><span class="line">    &lt;video&gt;</span><br><span class="line">      &lt;model type=&#x27;qxl&#x27; ram=&#x27;65536&#x27; vram=&#x27;65536&#x27; vgamem=&#x27;32768&#x27; heads=&#x27;1&#x27; primary=&#x27;yes&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x02&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/video&gt;</span><br><span class="line">    &lt;hostdev mode=&#x27;subsystem&#x27; type=&#x27;pci&#x27; managed=&#x27;yes&#x27;&gt;</span><br><span class="line">      &lt;source&gt;</span><br><span class="line">        &lt;address domain=&#x27;0x0000&#x27; bus=&#x27;0xb1&#x27; slot=&#x27;0x00&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">      &lt;/source&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x0b&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/hostdev&gt;</span><br><span class="line">    &lt;redirdev bus=&#x27;usb&#x27; type=&#x27;spicevmc&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;usb&#x27; bus=&#x27;3&#x27; port=&#x27;1&#x27;/&gt;</span><br><span class="line">    &lt;/redirdev&gt;</span><br><span class="line">    &lt;redirdev bus=&#x27;usb&#x27; type=&#x27;spicevmc&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;usb&#x27; bus=&#x27;3&#x27; port=&#x27;2&#x27;/&gt;</span><br><span class="line">    &lt;/redirdev&gt;</span><br><span class="line">    &lt;redirdev bus=&#x27;usb&#x27; type=&#x27;spicevmc&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;usb&#x27; bus=&#x27;4&#x27; port=&#x27;1&#x27;/&gt;</span><br><span class="line">    &lt;/redirdev&gt;</span><br><span class="line">    &lt;redirdev bus=&#x27;usb&#x27; type=&#x27;spicevmc&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;usb&#x27; bus=&#x27;4&#x27; port=&#x27;2&#x27;/&gt;</span><br><span class="line">    &lt;/redirdev&gt;</span><br><span class="line">    &lt;redirdev bus=&#x27;usb&#x27; type=&#x27;spicevmc&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;usb&#x27; bus=&#x27;3&#x27; port=&#x27;3&#x27;/&gt;</span><br><span class="line">    &lt;/redirdev&gt;</span><br><span class="line">    &lt;redirdev bus=&#x27;usb&#x27; type=&#x27;spicevmc&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;usb&#x27; bus=&#x27;3&#x27; port=&#x27;4&#x27;/&gt;</span><br><span class="line">    &lt;/redirdev&gt;</span><br><span class="line">    &lt;redirdev bus=&#x27;usb&#x27; type=&#x27;spicevmc&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;usb&#x27; bus=&#x27;4&#x27; port=&#x27;3&#x27;/&gt;</span><br><span class="line">    &lt;/redirdev&gt;</span><br><span class="line">    &lt;redirdev bus=&#x27;usb&#x27; type=&#x27;spicevmc&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;usb&#x27; bus=&#x27;4&#x27; port=&#x27;4&#x27;/&gt;</span><br><span class="line">    &lt;/redirdev&gt;</span><br><span class="line">    &lt;memballoon model=&#x27;virtio&#x27;&gt;</span><br><span class="line">      &lt;stats period=&#x27;10&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x0c&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/memballoon&gt;</span><br><span class="line">  &lt;/devices&gt;</span><br><span class="line">&lt;/domain&gt;</span><br><span class="line">: libvirtError: internal error: process exited while connecting to monitor: 2022-08-20T16:39:15.220119Z qemu-kvm: -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=32,max_outputs=1,bus=pci.0,addr=0x2: vhost_region_add_section:Section rounded to 0 prior to previous c0000</span><br><span class="line">2022-08-20 16:39:15.813 3711 ERROR nova.virt.libvirt.driver [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Failed to start libvirt guest: libvirtError: internal error: process exited while connecting to monitor: 2022-08-20T16:39:15.220119Z qemu-kvm: -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=32,max_outputs=1,bus=pci.0,addr=0x2: vhost_region_add_section:Section rounded to 0 prior to previous c0000</span><br><span class="line">2022-08-20 16:39:15.864 3711 INFO nova.virt.libvirt.driver [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Deleting instance files /var/lib/nova/instances/285e807d-426d-4b4a-b500-e89f92b9172a_del</span><br><span class="line">2022-08-20 16:39:15.865 3711 INFO nova.virt.libvirt.driver [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Deletion of /var/lib/nova/instances/285e807d-426d-4b4a-b500-e89f92b9172a_del complete</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Instance failed to spawn: libvirtError: internal error: process exited while connecting to monitor: 2022-08-20T16:39:15.220119Z qemu-kvm: -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=32,max_outputs=1,bus=pci.0,addr=0x2: vhost_region_add_section:Section rounded to 0 prior to previous c0000</span><br><span class="line">2022-08-20T16:39:15.220245Z qemu-kvm: -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=32,max_outputs=1,bus=pci.0,addr=0x2: vhost_region_add_section:Section rounded to 0 prior to previous c0000</span><br><span class="line">2022-08-20T16:39:15.224010Z qemu-kvm: -device vfio-pci,host=0000:b1:00.0,id=hostdev0,bus=pci.0,addr=0xb: vfio error: 0000:b1:00.0: group 183 is not viable</span><br><span class="line">Please ensure all devices within the iommu_group are bound to their vfio bus driver.</span><br><span class="line">unload codec helper module</span><br><span class="line">unload codec helper module done</span><br><span class="line">unload x264 encoder module done</span><br><span class="line">unload aac encode compress module</span><br><span class="line">unload aac encode compress done</span><br><span class="line">unload aac decode compress module</span><br><span class="line">unload aac decode compress done</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Traceback (most recent call last):</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/compute/manager.py&quot;, line 2808, in _build_resources</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     yield resources</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/compute/manager.py&quot;, line 2567, in _build_and_run_instance</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     accel_info=accel_info)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/driver.py&quot;, line 3524, in spawn</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     power_on=power_on)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/driver.py&quot;, line 6431, in _create_domain_and_network</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     destroy_disks_on_failure)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/oslo_utils/excutils.py&quot;, line 220, in __exit__</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     self.force_reraise()</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/oslo_utils/excutils.py&quot;, line 196, in force_reraise</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     six.reraise(self.type_, self.value, self.tb)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/driver.py&quot;, line 6397, in _create_domain_and_network</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     post_xml_callback=post_xml_callback)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/driver.py&quot;, line 6328, in _create_domain</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     guest.launch(pause=pause)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/guest.py&quot;, line 145, in launch</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     self._encoded_xml, errors=&#x27;ignore&#x27;)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/oslo_utils/excutils.py&quot;, line 220, in __exit__</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     self.force_reraise()</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/oslo_utils/excutils.py&quot;, line 196, in force_reraise</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     six.reraise(self.type_, self.value, self.tb)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/guest.py&quot;, line 140, in launch</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     return self._domain.createWithFlags(flags)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/eventlet/tpool.py&quot;, line 190, in doit</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     result = proxy_call(self._autowrap, f, *args, **kwargs)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/eventlet/tpool.py&quot;, line 148, in proxy_call</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     rv = execute(f, *args, **kwargs)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/eventlet/tpool.py&quot;, line 129, in execute</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     six.reraise(c, e, tb)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/eventlet/tpool.py&quot;, line 83, in tworker</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     rv = meth(*args, **kwargs)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/usr/lib64/python2.7/site-packages/libvirt.py&quot;, line 1110, in createWithFlags</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     if ret == -1: raise libvirtError (&#x27;virDomainCreateWithFlags() failed&#x27;, dom=self)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] libvirtError: internal error: process exited while connecting to monitor: 2022-08-20T16:39:15.220119Z qemu-kvm: -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=32,max_outputs=1,bus=pci.0,addr=0x2: vhost_region_add_section:Section rounded to 0 prior to previous c0000</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] 2022-08-20T16:39:15.220245Z qemu-kvm: -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=32,max_outputs=1,bus=pci.0,addr=0x2: vhost_region_add_section:Section rounded to 0 prior to previous c0000</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] 2022-08-20T16:39:15.224010Z qemu-kvm: -device vfio-pci,host=0000:b1:00.0,id=hostdev0,bus=pci.0,addr=0xb: vfio error: 0000:b1:00.0: group 183 is not viable</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Please ensure all devices within the iommu_group are bound to their vfio bus driver.</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload codec helper module</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload codec helper module done</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload x264 encoder module done</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload aac encode compress module</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload aac encode compress done</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload aac decode compress module</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload aac decode compress done</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]</span><br><span class="line">2022-08-20 16:39:15.956 3711 INFO nova.compute.manager [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Terminating instance</span><br><span class="line">2022-08-20 16:39:15.961 3711 INFO nova.virt.libvirt.driver [-] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Instance destroyed successfully.</span><br><span class="line">2022-08-20 16:39:15.998 3711 INFO nova.virt.libvirt.driver [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Deletion of /var/lib/nova/instances/285e807d-426d-4b4a-b500-e89f92b9172a_del complete</span><br><span class="line">2022-08-20 16:39:16.104 3711 INFO nova.compute.manager [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Took 0.15 seconds to destroy the instance on the hypervisor.</span><br><span class="line">2022-08-20 16:39:16.412 3711 INFO nova.compute.manager [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Took 0.31 seconds to detach 1 volumes for instance.</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Failed to build and run instance: libvirtError: internal error: process exited while connecting to monitor: 2022-08-20T16:39:15.220119Z qemu-kvm: -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=32,max_outputs=1,bus=pci.0,addr=0x2: vhost_region_add_section:Section rounded to 0 prior to previous c0000</span><br><span class="line">2022-08-20T16:39:15.220245Z qemu-kvm: -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=32,max_outputs=1,bus=pci.0,addr=0x2: vhost_region_add_section:Section rounded to 0 prior to previous c0000</span><br><span class="line">2022-08-20T16:39:15.224010Z qemu-kvm: -device vfio-pci,host=0000:b1:00.0,id=hostdev0,bus=pci.0,addr=0xb: vfio error: 0000:b1:00.0: group 183 is not viable</span><br><span class="line">Please ensure all devices within the iommu_group are bound to their vfio bus driver.</span><br><span class="line">unload codec helper module</span><br><span class="line">unload codec helper module done</span><br><span class="line">unload x264 encoder module done</span><br><span class="line">unload aac encode compress module</span><br><span class="line">unload aac encode compress done</span><br><span class="line">unload aac decode compress module</span><br><span class="line">unload aac decode compress done</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Traceback (most recent call last):</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/compute/manager.py&quot;, line 2567, in _build_and_run_instance</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     accel_info=accel_info)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/driver.py&quot;, line 3524, in spawn</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     power_on=power_on)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/driver.py&quot;, line 6431, in _create_domain_and_network</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     destroy_disks_on_failure)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/oslo_utils/excutils.py&quot;, line 220, in __exit__</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     self.force_reraise()</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/oslo_utils/excutils.py&quot;, line 196, in force_reraise</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     six.reraise(self.type_, self.value, self.tb)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/driver.py&quot;, line 6397, in _create_domain_and_network</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     post_xml_callback=post_xml_callback)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/driver.py&quot;, line 6328, in _create_domain</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     guest.launch(pause=pause)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/guest.py&quot;, line 145, in launch</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     self._encoded_xml, errors=&#x27;ignore&#x27;)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/oslo_utils/excutils.py&quot;, line 220, in __exit__</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     self.force_reraise()</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/oslo_utils/excutils.py&quot;, line 196, in force_reraise</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     six.reraise(self.type_, self.value, self.tb)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/guest.py&quot;, line 140, in launch</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     return self._domain.createWithFlags(flags)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/eventlet/tpool.py&quot;, line 190, in doit</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     result = proxy_call(self._autowrap, f, *args, **kwargs)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/eventlet/tpool.py&quot;, line 148, in proxy_call</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     rv = execute(f, *args, **kwargs)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/eventlet/tpool.py&quot;, line 129, in execute</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     six.reraise(c, e, tb)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/eventlet/tpool.py&quot;, line 83, in tworker</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     rv = meth(*args, **kwargs)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/usr/lib64/python2.7/site-packages/libvirt.py&quot;, line 1110, in createWithFlags</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     if ret == -1: raise libvirtError (&#x27;virDomainCreateWithFlags() failed&#x27;, dom=self)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] libvirtError: internal error: process exited while connecting to monitor: 2022-08-20T16:39:15.220119Z qemu-kvm: -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=32,max_outputs=1,bus=pci.0,addr=0x2: vhost_region_add_section:Section rounded to 0 prior to previous c0000</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] 2022-08-20T16:39:15.220245Z qemu-kvm: -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=32,max_outputs=1,bus=pci.0,addr=0x2: vhost_region_add_section:Section rounded to 0 prior to previous c0000</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] 2022-08-20T16:39:15.224010Z qemu-kvm: -device vfio-pci,host=0000:b1:00.0,id=hostdev0,bus=pci.0,addr=0xb: vfio error: 0000:b1:00.0: group 183 is not viable</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Please ensure all devices within the iommu_group are bound to their vfio bus driver.</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload codec helper module</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload codec helper module done</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload x264 encoder module done</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload aac encode compress module</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload aac encode compress done</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload aac decode compress module</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload aac decode compress done</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]</span><br><span class="line">2022-08-20 16:39:18.018 3711 INFO nova.compute.manager [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Took 1.20 seconds to deallocate network for instance.</span><br><span class="line">2022-08-20 16:39:18.330 3711 INFO nova.scheduler.client.report [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] Deleted allocation for instance 285e807d-426d-4b4a-b500-e89f92b9172a</span><br><span class="line">2022-08-20 17:00:09.337 3711 INFO nova.compute.manager [req-c902ff9e-9ef9-484a-87ed-30e51a8c7b03 - - - - -] Running instance usage audit for host node01 from 2022-08-20 16:00:00 to 2022-08-20 17:00:00. 3 instances.</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h3><h4 id="a-更换设备的驱动为vfio-pci"><a href="#a-更换设备的驱动为vfio-pci" class="headerlink" title="a. 更换设备的驱动为vfio_pci"></a>a. 更换设备的驱动为vfio_pci</h4><ol><li><p>配置加载vfio-pci模块，编辑<code>/etc/modules-load.d/openstack-gpu.conf</code>，添加如下内容：</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vfio_pci</span><br><span class="line">pci_stub</span><br><span class="line">vfio</span><br><span class="line">vfio_iommu_type1</span><br><span class="line">kvm</span><br><span class="line">kvm_intel</span><br></pre></td></tr></table></figure></li><li><p>配置使用vfio驱动的设备（这里的设备就是<code>lspci</code>查到的GPU设备信息），编辑<code>/etc/modprobe.d/vfio.conf</code>，添加如下配置：</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">options vfio-pci ids=10de:1e30,10de:10f7,10de:1ad6,10de:1ad7</span><br></pre></td></tr></table></figure></li><li><p>重启系统，通过<code>dmesg</code>查看驱动加载情况。</p></li></ol><p><img src="/2022/08/22/OpenStack%E4%BD%BF%E7%94%A8%EF%BC%9AGPU%E5%8D%A1%E4%BD%BF%E7%94%A8/dmesg%E4%BF%A1%E6%81%AF.png" alt="dmesg信息"></p><ol start="4"><li>更新驱动后，GPU卡的各类设备驱动信息如下，Audio device与Serial bus的驱动变为vfio-pci。</li></ol><p><img src="/2022/08/22/OpenStack%E4%BD%BF%E7%94%A8%EF%BC%9AGPU%E5%8D%A1%E4%BD%BF%E7%94%A8/%E6%9B%B4%E6%8D%A2vfio%E9%A9%B1%E5%8A%A8%E5%90%8E.png" alt="更换vfio驱动后"></p><h4 id="b-更改nova配置信息"><a href="#b-更改nova配置信息" class="headerlink" title="b. 更改nova配置信息"></a>b. 更改nova配置信息</h4><ol><li><p>修改nova-api.conf，增加如下PCI信息：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[pci]</span><br><span class="line">alias = &#123;&quot;name&quot;:&quot;a1&quot;,&quot;product_id&quot;:&quot;1e30&quot;,&quot;vendor_id&quot;:&quot;10de&quot;,&quot;device_type&quot;:&quot;type-PCI&quot;&#125;</span><br><span class="line">alias = &#123;&quot;name&quot;:&quot;a2&quot;,&quot;product_id&quot;:&quot;10f7&quot;,&quot;vendor_id&quot;:&quot;10de&quot;,&quot;device_type&quot;:&quot;type-PCI&quot;&#125;</span><br><span class="line">alias = &#123;&quot;name&quot;:&quot;a3&quot;,&quot;product_id&quot;:&quot;1ad6&quot;,&quot;vendor_id&quot;:&quot;10de&quot;,&quot;device_type&quot;:&quot;type-PCI&quot;&#125;</span><br><span class="line">alias = &#123;&quot;name&quot;:&quot;a4&quot;,&quot;product_id&quot;:&quot;1ad7&quot;,&quot;vendor_id&quot;:&quot;10de&quot;,&quot;device_type&quot;:&quot;type-PCI&quot;&#125;</span><br></pre></td></tr></table></figure></li></ol><ol start="2"><li><p>修改nova-scheduler.conf文件，添加<code>PciPassthroughFilter</code>，同时添加<code>available_filters = nova.scheduler.filters.all_filters</code>，如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[filter_scheduler]</span><br><span class="line">enabled_filters = RetryFilter,AvailabilityZoneFilter,ComputeFilter,ComputeCapabilitiesFilter,ImagePropertiesFilter,ServerGroupAntiAffinityFilter,ServerGroupAffinityFilter,AggregateCoreFilter,AggregateDiskFilter,DifferentHostFilter,SameHostFilter,PciPassthroughFilter</span><br><span class="line">available_filters = nova.scheduler.filters.all_filters</span><br></pre></td></tr></table></figure></li><li><p>配置计算节点，编辑nova-compute.conf文件，如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[pci]</span><br><span class="line">alias = &#123;&quot;name&quot;:&quot;a1&quot;,&quot;product_id&quot;:&quot;1e30&quot;,&quot;vendor_id&quot;:&quot;10de&quot;,&quot;device_type&quot;:&quot;type-PCI&quot;&#125;</span><br><span class="line">alias = &#123;&quot;name&quot;:&quot;a2&quot;,&quot;product_id&quot;:&quot;10f7&quot;,&quot;vendor_id&quot;:&quot;10de&quot;,&quot;device_type&quot;:&quot;type-PCI&quot;&#125;</span><br><span class="line">alias = &#123;&quot;name&quot;:&quot;a3&quot;,&quot;product_id&quot;:&quot;1ad6&quot;,&quot;vendor_id&quot;:&quot;10de&quot;,&quot;device_type&quot;:&quot;type-PCI&quot;&#125;</span><br><span class="line">alias = &#123;&quot;name&quot;:&quot;a4&quot;,&quot;product_id&quot;:&quot;1ad7&quot;,&quot;vendor_id&quot;:&quot;10de&quot;,&quot;device_type&quot;:&quot;type-PCI&quot;&#125;</span><br><span class="line">passthrough_whitelist = [&#123;&quot;vendor_id&quot;: &quot;10de&quot;, &quot;product_id&quot;: &quot;1e30&quot;&#125;, &#123;&quot;vendor_id&quot;: &quot;10de&quot;, &quot;product_id&quot;: &quot;10f7&quot;&#125;, &#123;&quot;vendor_id&quot;: &quot;10de&quot;, &quot;product_id&quot;: &quot;1ad6&quot;&#125;, &#123;&quot;vendor_id&quot;: &quot;10de&quot;, &quot;product_id&quot;: &quot;1ad7&quot;&#125;]</span><br></pre></td></tr></table></figure></li></ol><h4 id="c-创建GPU-Flavor"><a href="#c-创建GPU-Flavor" class="headerlink" title="c. 创建GPU Flavor"></a>c. 创建GPU Flavor</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openstack flavor create --ram 2048 --disk 20 --vcpus 2 m1.large</span><br><span class="line">openstack flavor set m1.large --property pci_passthrough:alias=&#x27;a1:1,a2:1,a3:1,a4:1&#x27;</span><br></pre></td></tr></table></figure><p>使用该flavor创建虚机即可。</p><h3 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h3><p>正确instacne xml内容如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br></pre></td><td class="code"><pre><span class="line">()[root@node01 /]# virsh dumpxml instance-00000008</span><br><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">type</span>=<span class="string">&#x27;kvm&#x27;</span> <span class="attr">id</span>=<span class="string">&#x27;5&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>instance-00000008<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>1f4bb25c-d665-4f03-a0f4-6857af066781<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">metadata</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">nova:instance</span> <span class="attr">xmlns:nova</span>=<span class="string">&quot;http://openstack.org/xmlns/libvirt/nova/1.0&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">nova:package</span> <span class="attr">version</span>=<span class="string">&quot;20.6.1&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">nova:name</span>&gt;</span>win10-1<span class="tag">&lt;/<span class="name">nova:name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">nova:creationTime</span>&gt;</span>2022-08-20 17:14:33<span class="tag">&lt;/<span class="name">nova:creationTime</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">nova:flavor</span> <span class="attr">name</span>=<span class="string">&quot;win10_4C8G_GPU&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nova:memory</span>&gt;</span>8192<span class="tag">&lt;/<span class="name">nova:memory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nova:disk</span>&gt;</span>100<span class="tag">&lt;/<span class="name">nova:disk</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nova:swap</span>&gt;</span>0<span class="tag">&lt;/<span class="name">nova:swap</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nova:ephemeral</span>&gt;</span>0<span class="tag">&lt;/<span class="name">nova:ephemeral</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nova:vcpus</span>&gt;</span>4<span class="tag">&lt;/<span class="name">nova:vcpus</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">nova:flavor</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">nova:owner</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nova:user</span> <span class="attr">uuid</span>=<span class="string">&quot;20f2649ce88142f19048b0aa090b78a1&quot;</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">nova:user</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nova:project</span> <span class="attr">uuid</span>=<span class="string">&quot;a1670d65a7e644e2a78fa31a001f284b&quot;</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">nova:project</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">nova:owner</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">nova:instance</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">metadata</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>8388608<span class="tag">&lt;/<span class="name">memory</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">currentMemory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>8388608<span class="tag">&lt;/<span class="name">currentMemory</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hugepages</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">page</span> <span class="attr">size</span>=<span class="string">&#x27;1048576&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span> <span class="attr">nodeset</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">hugepages</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpu</span> <span class="attr">placement</span>=<span class="string">&#x27;static&#x27;</span>&gt;</span>4<span class="tag">&lt;/<span class="name">vcpu</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cputune</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shares</span>&gt;</span>4096<span class="tag">&lt;/<span class="name">shares</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;17-31,49-63&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;17-31,49-63&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;17-31,49-63&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;17-31,49-63&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulatorpin</span> <span class="attr">cpuset</span>=<span class="string">&#x27;17-31,49-63&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">cputune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">numatune</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memory</span> <span class="attr">mode</span>=<span class="string">&#x27;strict&#x27;</span> <span class="attr">nodeset</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memnode</span> <span class="attr">cellid</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">mode</span>=<span class="string">&#x27;strict&#x27;</span> <span class="attr">nodeset</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">numatune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">partition</span>&gt;</span>/machine<span class="tag">&lt;/<span class="name">partition</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sysinfo</span> <span class="attr">type</span>=<span class="string">&#x27;smbios&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">system</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">entry</span> <span class="attr">name</span>=<span class="string">&#x27;manufacturer&#x27;</span>&gt;</span>OpenStack Foundation<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">entry</span> <span class="attr">name</span>=<span class="string">&#x27;product&#x27;</span>&gt;</span>OpenStack Nova<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">entry</span> <span class="attr">name</span>=<span class="string">&#x27;version&#x27;</span>&gt;</span>20.6.1<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">entry</span> <span class="attr">name</span>=<span class="string">&#x27;serial&#x27;</span>&gt;</span>1f4bb25c-d665-4f03-a0f4-6857af066781<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">entry</span> <span class="attr">name</span>=<span class="string">&#x27;uuid&#x27;</span>&gt;</span>1f4bb25c-d665-4f03-a0f4-6857af066781<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">entry</span> <span class="attr">name</span>=<span class="string">&#x27;family&#x27;</span>&gt;</span>Virtual Machine<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">system</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">sysinfo</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">os</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span> <span class="attr">arch</span>=<span class="string">&#x27;x86_64&#x27;</span> <span class="attr">machine</span>=<span class="string">&#x27;pc-i440fx-rhel7.2.0&#x27;</span>&gt;</span>hvm<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">boot</span> <span class="attr">dev</span>=<span class="string">&#x27;hd&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">smbios</span> <span class="attr">mode</span>=<span class="string">&#x27;sysinfo&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">os</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">features</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">acpi</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">apic</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">features</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;custom&#x27;</span> <span class="attr">match</span>=<span class="string">&#x27;exact&#x27;</span> <span class="attr">check</span>=<span class="string">&#x27;full&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">model</span> <span class="attr">fallback</span>=<span class="string">&#x27;forbid&#x27;</span>&gt;</span>Cascadelake-Server<span class="tag">&lt;/<span class="name">model</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vendor</span>&gt;</span>Intel<span class="tag">&lt;/<span class="name">vendor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">topology</span> <span class="attr">sockets</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cores</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">threads</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;ss&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;vmx&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;hypervisor&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;tsc_adjust&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;avx512ifma&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;sha-ni&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;avx512vbmi&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;umip&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;pku&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;avx512vbmi2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;gfni&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;vaes&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;vpclmulqdq&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;avx512bitalg&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;avx512-vpopcntdq&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;la57&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;md-clear&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;stibp&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;arch-capabilities&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;xsaves&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;ibpb&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;disable&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;mpx&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;disable&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;arat&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">numa</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">cell</span> <span class="attr">id</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpus</span>=<span class="string">&#x27;0-3&#x27;</span> <span class="attr">memory</span>=<span class="string">&#x27;8388608&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span> <span class="attr">memAccess</span>=<span class="string">&#x27;shared&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">numa</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">cpu</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">clock</span> <span class="attr">offset</span>=<span class="string">&#x27;utc&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;pit&#x27;</span> <span class="attr">tickpolicy</span>=<span class="string">&#x27;delay&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;rtc&#x27;</span> <span class="attr">tickpolicy</span>=<span class="string">&#x27;catchup&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;hpet&#x27;</span> <span class="attr">present</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">clock</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_poweroff</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_poweroff</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_reboot</span>&gt;</span>restart<span class="tag">&lt;/<span class="name">on_reboot</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_crash</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_crash</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulator</span>&gt;</span>/usr/libexec/qemu-kvm<span class="tag">&lt;/<span class="name">emulator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;network&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;disk&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;raw&#x27;</span> <span class="attr">cache</span>=<span class="string">&#x27;writeback&#x27;</span> <span class="attr">discard</span>=<span class="string">&#x27;unmap&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">auth</span> <span class="attr">username</span>=<span class="string">&#x27;cinder&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">secret</span> <span class="attr">type</span>=<span class="string">&#x27;ceph&#x27;</span> <span class="attr">uuid</span>=<span class="string">&#x27;457eb676-33da-42ec-9a8c-9293d545c337&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">auth</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">protocol</span>=<span class="string">&#x27;rbd&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;cinder-volumes/9dc4fcd1-a258-4f5c-8f3f-9029f699b064&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">host</span> <span class="attr">name</span>=<span class="string">&#x27;10.99.22.45&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;6789&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;vda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">serial</span>&gt;</span>9dc4fcd1-a258-4f5c-8f3f-9029f699b064<span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;virtio-disk0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x0a&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;ehci&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;usb1&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x05&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;nec-xhci&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;usb2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x06&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;ehci&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;usb3&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x07&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;nec-xhci&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;usb4&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x08&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;piix3-uhci&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;usb&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x01&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pci-root&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;pci.0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;virtio-serial0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x09&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;bridge&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;fa:16:3e:f1:a6:a9&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">bridge</span>=<span class="string">&#x27;br-int&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">virtualport</span> <span class="attr">type</span>=<span class="string">&#x27;openvswitch&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">parameters</span> <span class="attr">interfaceid</span>=<span class="string">&#x27;f91ebe33-a80c-4038-a2f2-e543dbe509d9&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">virtualport</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;tapf91ebe33-a8&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mtu</span> <span class="attr">size</span>=<span class="string">&#x27;1500&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;net0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x03&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">serial</span> <span class="attr">type</span>=<span class="string">&#x27;pty&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">path</span>=<span class="string">&#x27;/dev/pts/5&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">log</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/nova/instances/1f4bb25c-d665-4f03-a0f4-6857af066781/console.log&#x27;</span> <span class="attr">append</span>=<span class="string">&#x27;off&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;isa-serial&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;isa-serial&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;serial0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">console</span> <span class="attr">type</span>=<span class="string">&#x27;pty&#x27;</span> <span class="attr">tty</span>=<span class="string">&#x27;/dev/pts/5&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">path</span>=<span class="string">&#x27;/dev/pts/5&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">log</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/nova/instances/1f4bb25c-d665-4f03-a0f4-6857af066781/console.log&#x27;</span> <span class="attr">append</span>=<span class="string">&#x27;off&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;serial&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;serial0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">console</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">channel</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;com.redhat.spice.0&#x27;</span> <span class="attr">state</span>=<span class="string">&#x27;disconnected&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;channel0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">channel</span> <span class="attr">type</span>=<span class="string">&#x27;unix&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">mode</span>=<span class="string">&#x27;bind&#x27;</span> <span class="attr">path</span>=<span class="string">&#x27;/var/lib/libvirt/qemu/org.qemu.guest_agent.0.instance-00000008.sock&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;org.qemu.guest_agent.0&#x27;</span> <span class="attr">state</span>=<span class="string">&#x27;disconnected&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;channel1&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;mouse&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ps2&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;input0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;keyboard&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ps2&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;input1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">graphics</span> <span class="attr">type</span>=<span class="string">&#x27;spice&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;5903&#x27;</span> <span class="attr">autoport</span>=<span class="string">&#x27;yes&#x27;</span> <span class="attr">listen</span>=<span class="string">&#x27;0.0.0.0&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">listen</span> <span class="attr">type</span>=<span class="string">&#x27;address&#x27;</span> <span class="attr">address</span>=<span class="string">&#x27;0.0.0.0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">graphics</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sound</span> <span class="attr">model</span>=<span class="string">&#x27;ac97&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;sound0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x04&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">sound</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">video</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;qxl&#x27;</span> <span class="attr">ram</span>=<span class="string">&#x27;65536&#x27;</span> <span class="attr">vram</span>=<span class="string">&#x27;65536&#x27;</span> <span class="attr">vgamem</span>=<span class="string">&#x27;32768&#x27;</span> <span class="attr">heads</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">primary</span>=<span class="string">&#x27;yes&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;video0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hostdev</span> <span class="attr">mode</span>=<span class="string">&#x27;subsystem&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;vfio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">address</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0xb1&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;hostdev0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x0b&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">hostdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hostdev</span> <span class="attr">mode</span>=<span class="string">&#x27;subsystem&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;vfio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">address</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0xb1&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;hostdev1&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x0c&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">hostdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hostdev</span> <span class="attr">mode</span>=<span class="string">&#x27;subsystem&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;vfio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">address</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0xb1&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;hostdev2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x0d&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">hostdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hostdev</span> <span class="attr">mode</span>=<span class="string">&#x27;subsystem&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;vfio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">address</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0xb1&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x3&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;hostdev3&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x0e&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">hostdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;redir0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;redir1&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;redir2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;redir3&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;redir4&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;redir5&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;4&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;redir6&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;redir7&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;4&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memballoon</span> <span class="attr">model</span>=<span class="string">&#x27;virtio&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">stats</span> <span class="attr">period</span>=<span class="string">&#x27;10&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;balloon0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x0f&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">memballoon</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">seclabel</span> <span class="attr">type</span>=<span class="string">&#x27;dynamic&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;dac&#x27;</span> <span class="attr">relabel</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>+0:+0<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">imagelabel</span>&gt;</span>+0:+0<span class="tag">&lt;/<span class="name">imagelabel</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">seclabel</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://copyfuture.com/blogs-details/20211209084308795f">openstack虚拟机透传GPU设备</a></li><li><a href="https://www.cnblogs.com/weiwei2021/p/14307896.html">openstack ussuri PCI-passthrough集成GPU</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;含有多个设备的GPU&quot;&gt;&lt;a href=&quot;#含有多个设备的GPU&quot; class=&quot;headerlink&quot; title=&quot;含有多个设备的GPU&quot;&gt;&lt;/a&gt;含有多个设备的GPU&lt;/h2&gt;&lt;p&gt;常见型号：Quadro RTX 6000/8000&lt;/p&gt;
&lt;h3 id=&quot;</summary>
      
    
    
    
    <category term="OpenStack" scheme="https://renyb2.github.io/categories/OpenStack/"/>
    
    
    <category term="OpenStack" scheme="https://renyb2.github.io/tags/OpenStack/"/>
    
  </entry>
  
  <entry>
    <title>NVIDIA使用：虚机游戏性能</title>
    <link href="https://renyb2.github.io/2022/07/18/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9A%E8%99%9A%E6%9C%BA%E6%B8%B8%E6%88%8F%E6%80%A7%E8%83%BD/"/>
    <id>https://renyb2.github.io/2022/07/18/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9A%E8%99%9A%E6%9C%BA%E6%B8%B8%E6%88%8F%E6%80%A7%E8%83%BD/</id>
    <published>2022-07-18T06:24:37.000Z</published>
    <updated>2022-08-11T10:07:38.782Z</updated>
    
    <content type="html"><![CDATA[<h2 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h2><ul><li><strong>服务器：</strong>NE5260M5</li><li><strong>CPU型号：</strong>Intel(R) Xeon(R) Silver 4210 CPU @ 2.20GHz</li><li><strong>GPU型号：</strong>vGPU GRID T4-4Q（显存4G）</li><li><strong>虚机配置：</strong>绑核大页 8C16G，数据盘100G，系统盘200G</li><li><strong>游戏：</strong>英雄联盟，画质中等</li></ul><h2 id="部署问题"><a href="#部署问题" class="headerlink" title="部署问题"></a>部署问题</h2><h3 id="Windows虚机核数未完全被使用"><a href="#Windows虚机核数未完全被使用" class="headerlink" title="Windows虚机核数未完全被使用"></a>Windows虚机核数未完全被使用</h3><p>未配置CPU拓扑信息的虚机，CPU拓扑关系如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;host-passthrough&#x27;</span> <span class="attr">check</span>=<span class="string">&#x27;none&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">topology</span> <span class="attr">sockets</span>=<span class="string">&#x27;8&#x27;</span> <span class="attr">cores</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">threads</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">numa</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cell</span> <span class="attr">id</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpus</span>=<span class="string">&#x27;0-7&#x27;</span> <span class="attr">memory</span>=<span class="string">&#x27;16777216&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span> <span class="attr">memAccess</span>=<span class="string">&#x27;shared&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">numa</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cpu</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>CPU线程数 = Sockets * Cores * Threads</strong></p><p>由于win10系统socket最大只能使用2核，即最大只能到<code>sockets=&#39;2&#39;</code>，其余需分配给<code>cores</code>与<code>threads</code>。即需配置如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;host-passthrough&#x27;</span> <span class="attr">check</span>=<span class="string">&#x27;none&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">topology</span> <span class="attr">sockets</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cores</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">threads</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;disable&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;hypervisor&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">numa</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cell</span> <span class="attr">id</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpus</span>=<span class="string">&#x27;0-7&#x27;</span> <span class="attr">memory</span>=<span class="string">&#x27;16777216&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span> <span class="attr">memAccess</span>=<span class="string">&#x27;shared&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">numa</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cpu</span>&gt;</span></span><br></pre></td></tr></table></figure><p>对应的OpenStack Flavor元数据信息如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 设置vm的cpu toplogy。 max <span class="built_in">limit</span>类型的设置也可以通过image 属性来设置.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> nova flavor-key FLAVOR-NAME <span class="built_in">set</span> hw:cpu_sockets=FLAVOR-SOCKETS</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> nova flavor-key FLAVOR-NAME <span class="built_in">set</span> hw:cpu_cores=FLAVOR-CORES</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> nova flavor-key FLAVOR-NAME <span class="built_in">set</span> hw:cpu_threads=FLAVOR-THREADS</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> nova flavor-key FLAVOR-NAME <span class="built_in">set</span> hw:cpu_max_sockets=FLAVOR-SOCKETS</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> nova flavor-key FLAVOR-NAME <span class="built_in">set</span> hw:cpu_max_cores=FLAVOR-CORES</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> nova flavor-key FLAVOR-NAME <span class="built_in">set</span> hw:cpu_max_threads=FLAVOR-THREADS</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> FLAVOR-NAME    模板的名称</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sockets x cores x threads = 总vcpu数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sockets    <span class="comment"># 标识cpu的插槽数，根据操作系统能支持的主板cpu数量来填</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cores      <span class="comment"># cpu的核心数</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> threads    <span class="comment"># 线程</span></span></span><br></pre></td></tr></table></figure><h3 id="游戏检测运行环境为虚机"><a href="#游戏检测运行环境为虚机" class="headerlink" title="游戏检测运行环境为虚机"></a>游戏检测运行环境为虚机</h3><img src="/2022/07/18/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9A%E8%99%9A%E6%9C%BA%E6%B8%B8%E6%88%8F%E6%80%A7%E8%83%BD/游戏虚机环境检测.png" alt="cluster-diagram1" style="zoom:100%;"><p>该问题，需要禁用掉虚机内的虚拟化特性，具体xml代码段如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- in &lt;features&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">kvm</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">hidden</span> <span class="attr">state</span>=<span class="string">&#x27;on&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">kvm</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- in &lt;cpu&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;disable&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;hypervisor&#x27;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>参考范例如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">features</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">acpi</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">apic</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">kvm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hidden</span> <span class="attr">state</span>=<span class="string">&#x27;on&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">kvm</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">features</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;host-passthrough&#x27;</span> <span class="attr">check</span>=<span class="string">&#x27;none&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">topology</span> <span class="attr">sockets</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cores</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">threads</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;disable&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;hypervisor&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">numa</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cell</span> <span class="attr">id</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpus</span>=<span class="string">&#x27;0-7&#x27;</span> <span class="attr">memory</span>=<span class="string">&#x27;33554432&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span> <span class="attr">memAccess</span>=<span class="string">&#x27;shared&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">numa</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cpu</span>&gt;</span></span><br></pre></td></tr></table></figure><p>对应的OpenStack Image元数据信息如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack image create --disk-format qcow2 --file cirros.qcow2 --property img_hide_hypervisor_id=true game-cirros</span><br></pre></td></tr></table></figure><h3 id="游戏无法初始化图形设备"><a href="#游戏无法初始化图形设备" class="headerlink" title="游戏无法初始化图形设备"></a>游戏无法初始化图形设备</h3><img src="/2022/07/18/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9A%E8%99%9A%E6%9C%BA%E6%B8%B8%E6%88%8F%E6%80%A7%E8%83%BD/无法初始化图形设备.jpg" alt="cluster-diagram1" style="zoom:100%;"><p>windows+R键，输入<code>dxdiag</code>，运行DirectX诊断工具，发现视频加速功能未启动。</p><img src="/2022/07/18/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9A%E8%99%9A%E6%9C%BA%E6%B8%B8%E6%88%8F%E6%80%A7%E8%83%BD/dxdiag未启用视频加速.png" alt="cluster-diagram1" style="zoom:100%;"><p>桌面右键，点击<code>NVIDIA控制面板</code>，查看当前能力，发现如下图：</p><img src="/2022/07/18/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9A%E8%99%9A%E6%9C%BA%E6%B8%B8%E6%88%8F%E6%80%A7%E8%83%BD/未启用视频加速.png" alt="cluster-diagram1" style="zoom:100%;"><p>出现该问题的原因在于，<strong>微软默认的<code>mstsc</code>无法调用GPU硬件，需要使用专业工具如：向日葵等软件</strong>，即可正常调用GPU。效果图如下：</p><img src="/2022/07/18/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9A%E8%99%9A%E6%9C%BA%E6%B8%B8%E6%88%8F%E6%80%A7%E8%83%BD/dxdiag启用视频加速.png" alt="cluster-diagram1" style="zoom:100%;"><img src="/2022/07/18/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9A%E8%99%9A%E6%9C%BA%E6%B8%B8%E6%88%8F%E6%80%A7%E8%83%BD/启用视频加速.png" alt="cluster-diagram1" style="zoom:100%;"><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://www.gzhttp.com/zhishi/cpu_841_0.html#:~:text=Intel%20%E8%87%B3%E5%BC%BA%20Silver%204210R%E7%9A%84%E5%8F%82%E6%95%B0%E5%A6%82%E4%B8%8B%EF%BC%8C%E5%9F%BA%E7%A1%80%E5%8F%82%E6%95%B0%E6%96%B9%E9%9D%A2Intel%20%E8%87%B3%E5%BC%BA%20Silver%204210R%E7%9A%84%E4%B8%BB%E9%A2%91%E4%B8%BA2.40,GHz%EF%BC%8C%E6%A0%B8%E5%BF%83%E7%BA%BF%E7%A8%8B%E6%96%B9%E9%9D%A2%EF%BC%8C%E8%BF%99%E6%98%AF%E4%B8%80%E6%AC%BE10%20%E6%A0%B820%20%E7%BA%BF%E7%A8%8BCPU%EF%BC%8C%E5%8D%95%E6%A0%B8%E7%9D%BF%E9%A2%91%E8%BE%BE%E5%88%B03.20%20GHz%EF%BC%8C%E8%BF%99%E6%AC%BECPU%E9%87%87%E7%94%A8%E7%9A%84%E6%98%AFCascade%20Lake%E6%9E%B6%E6%9E%84%EF%BC%8C%E4%BD%BF%E7%94%A8%E4%BA%8614%20nm%E7%9A%84%E5%B7%A5%E8%89%BA%EF%BC%8C%E5%86%85%E5%AD%98%E5%8F%82%E6%95%B0%E6%96%B9%E9%9D%A2CPU%E6%9C%80%E5%A4%A7%E5%8F%AF%E4%BB%A5%E6%8F%92%E5%85%A51024%20GB%E7%9A%84%E5%86%85%E5%AD%98%EF%BC%8CECC%E5%8D%B3%E6%98%AF%E5%86%85%E5%AD%98%E7%BA%A0%E9%94%99%E6%8A%80%E6%9C%AF%EF%BC%8C%E8%BF%99%E6%AC%BECPU%E6%98%AF%E6%94%AF%E6%8C%81%E7%9A%84%EF%BC%8C">Intel 至强 Silver 4210R能玩什么游戏，可以打游戏吗</a></li><li><a href="https://knowledge.civilgeo.com/knowledge-base/enabling-gpu-rendering-for-microsoft-remote-desktop/">Enabling GPU Rendering for Microsoft Remote Desktop</a></li><li><a href="https://superuser.com/questions/1387935/hiding-virtual-machine-status-from-guest-operating-system">Hiding Virtual machine status from guest operating system</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;环境信息&quot;&gt;&lt;a href=&quot;#环境信息&quot; class=&quot;headerlink&quot; title=&quot;环境信息&quot;&gt;&lt;/a&gt;环境信息&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;服务器：&lt;/strong&gt;NE5260M5&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;CPU型号：&lt;/s</summary>
      
    
    
    
    <category term="Accelerator" scheme="https://renyb2.github.io/categories/Accelerator/"/>
    
    
    <category term="NVIDIA" scheme="https://renyb2.github.io/tags/NVIDIA/"/>
    
    <category term="Accelerator" scheme="https://renyb2.github.io/tags/Accelerator/"/>
    
  </entry>
  
  <entry>
    <title>Linux配置：硬件管理</title>
    <link href="https://renyb2.github.io/2022/07/14/Linux%E9%85%8D%E7%BD%AE%EF%BC%9A%E7%A1%AC%E4%BB%B6%E7%AE%A1%E7%90%86/"/>
    <id>https://renyb2.github.io/2022/07/14/Linux%E9%85%8D%E7%BD%AE%EF%BC%9A%E7%A1%AC%E4%BB%B6%E7%AE%A1%E7%90%86/</id>
    <published>2022-07-14T09:01:20.000Z</published>
    <updated>2022-07-14T09:18:55.919Z</updated>
    
    <content type="html"><![CDATA[<h2 id="IPMI管理"><a href="#IPMI管理" class="headerlink" title="IPMI管理"></a>IPMI管理</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看ipmi信息</span></span><br><span class="line">[root@k205 ~]# ipmitool lan print 1</span><br><span class="line">Set in Progress         : Set Complete</span><br><span class="line">Auth Type Support       : MD5</span><br><span class="line">Auth Type Enable        : Callback : MD5</span><br><span class="line">                        : User     : MD5</span><br><span class="line">                        : Operator : MD5</span><br><span class="line">                        : Admin    : MD5</span><br><span class="line">                        : OEM      : MD5</span><br><span class="line">IP Address Source       : Static Address</span><br><span class="line">IP Address              : 111.111.50.14</span><br><span class="line">Subnet Mask             : 255.255.255.0</span><br><span class="line">MAC Address             : 6c:92:bf:da:18:d8</span><br><span class="line">SNMP Community String   : AMI</span><br><span class="line">IP Header               : TTL=0x40 Flags=0x40 Precedence=0x00 TOS=0x10</span><br><span class="line">BMC ARP Control         : ARP Responses Enabled, Gratuitous ARP Disabled</span><br><span class="line">Gratituous ARP Intrvl   : 0.0 seconds</span><br><span class="line">Default Gateway IP      : 111.111.50.1</span><br><span class="line">Default Gateway MAC     : 7c:1e:06:27:f3:eb</span><br><span class="line">Backup Gateway IP       : 0.0.0.0</span><br><span class="line">Backup Gateway MAC      : 00:00:00:00:00:00</span><br><span class="line">802.1q VLAN ID          : Disabled</span><br><span class="line">802.1q VLAN Priority    : 0</span><br><span class="line">RMCP+ Cipher Suites     : 0,1,2,3,6,7,8,11,12,15,16,17</span><br><span class="line">Cipher Suite Priv Max   : caaaaaaaaaaaXXX</span><br><span class="line">                        :     X=Cipher Suite Unused</span><br><span class="line">                        :     c=CALLBACK</span><br><span class="line">                        :     u=USER</span><br><span class="line">                        :     o=OPERATOR</span><br><span class="line">                        :     a=ADMIN</span><br><span class="line">                        :     O=OEM</span><br><span class="line">Bad Password Threshold  : 3</span><br><span class="line">Invalid password disable: no</span><br><span class="line">Attempt Count Reset Int.: 200</span><br><span class="line">User Lockout Interval   : 300</span><br></pre></td></tr></table></figure><h2 id="硬件管理"><a href="#硬件管理" class="headerlink" title="硬件管理"></a>硬件管理</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看所有硬件信息</span></span><br><span class="line">[root@k205 ~]# dmidecode</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看处理器硬件信息</span></span><br><span class="line">[root@k205 ~]# dmidecode --type processor</span><br><span class="line"><span class="meta">#</span><span class="bash"> dmidecode 3.2</span></span><br><span class="line">Getting SMBIOS data from sysfs.</span><br><span class="line">SMBIOS 3.2 present.</span><br><span class="line"></span><br><span class="line">Handle 0x008A, DMI type 4, 48 bytes</span><br><span class="line">Processor Information</span><br><span class="line">        Socket Designation: CPU0</span><br><span class="line">        Type: Central Processor</span><br><span class="line">        Family: Xeon</span><br><span class="line">        Manufacturer: Intel(R) Corporation</span><br><span class="line">        ID: 54 06 05 00 FF FB EB BF</span><br><span class="line">        Signature: Type 0, Family 6, Model 85, Stepping 4</span><br><span class="line">        Flags:</span><br><span class="line">                FPU (Floating-point unit on-chip)</span><br><span class="line">                VME (Virtual mode extension)</span><br><span class="line">                DE (Debugging extension)</span><br><span class="line">                PSE (Page size extension)</span><br><span class="line">                TSC (Time stamp counter)</span><br><span class="line">                MSR (Model specific registers)</span><br><span class="line">                PAE (Physical address extension)</span><br><span class="line">                MCE (Machine check exception)</span><br><span class="line">                CX8 (CMPXCHG8 instruction supported)</span><br><span class="line">                APIC (On-chip APIC hardware supported)</span><br><span class="line">                SEP (Fast system call)</span><br><span class="line">                MTRR (Memory type range registers)</span><br><span class="line">                PGE (Page global enable)</span><br><span class="line">                MCA (Machine check architecture)</span><br><span class="line">                CMOV (Conditional move instruction supported)</span><br><span class="line">                PAT (Page attribute table)</span><br><span class="line">                PSE-36 (36-bit page size extension)</span><br><span class="line">                CLFSH (CLFLUSH instruction supported)</span><br><span class="line">                DS (Debug store)</span><br><span class="line">                ACPI (ACPI supported)</span><br><span class="line">                MMX (MMX technology supported)</span><br><span class="line">                FXSR (FXSAVE and FXSTOR instructions supported)</span><br><span class="line">                SSE (Streaming SIMD extensions)</span><br><span class="line">                SSE2 (Streaming SIMD extensions 2)</span><br><span class="line">                SS (Self-snoop)</span><br><span class="line">                HTT (Multi-threading)</span><br><span class="line">                TM (Thermal monitor supported)</span><br><span class="line">                PBE (Pending break enabled)</span><br><span class="line">        Version: Intel(R) Xeon(R) Silver 4110 CPU @ 2.10GHz</span><br><span class="line">        Voltage: 1.6 V</span><br><span class="line">        External Clock: 100 MHz</span><br><span class="line">        Max Speed: 3000 MHz</span><br><span class="line">        Current Speed: 2100 MHz</span><br><span class="line">        Status: Populated, Enabled</span><br><span class="line">        Upgrade: Socket LGA3647-1</span><br><span class="line">        L1 Cache Handle: 0x0087</span><br><span class="line">        L2 Cache Handle: 0x0088</span><br><span class="line">        L3 Cache Handle: 0x0089</span><br><span class="line">        Serial Number: Not Specified</span><br><span class="line">        Asset Tag: UNKNOWN</span><br><span class="line">        Part Number: Not Specified</span><br><span class="line">        Core Count: 8</span><br><span class="line">        Core Enabled: 8</span><br><span class="line">        Thread Count: 16</span><br><span class="line">        Characteristics:</span><br><span class="line">                64-bit capable</span><br><span class="line">                Multi-Core</span><br><span class="line">                Hardware Thread</span><br><span class="line">                Execute Protection</span><br><span class="line">                Enhanced Virtualization</span><br><span class="line">                Power/Performance Control</span><br><span class="line"></span><br><span class="line">Handle 0x008E, DMI type 4, 48 bytes</span><br><span class="line">Processor Information</span><br><span class="line">        Socket Designation: CPU1</span><br><span class="line">        Type: Central Processor</span><br><span class="line">        Family: Xeon</span><br><span class="line">        Manufacturer: Intel(R) Corporation</span><br><span class="line">        ID: 54 06 05 00 FF FB EB BF</span><br><span class="line">        Signature: Type 0, Family 6, Model 85, Stepping 4</span><br><span class="line">        Flags:</span><br><span class="line">                FPU (Floating-point unit on-chip)</span><br><span class="line">                VME (Virtual mode extension)</span><br><span class="line">                DE (Debugging extension)</span><br><span class="line">                PSE (Page size extension)</span><br><span class="line">                TSC (Time stamp counter)</span><br><span class="line">                MSR (Model specific registers)</span><br><span class="line">                PAE (Physical address extension)</span><br><span class="line">                MCE (Machine check exception)</span><br><span class="line">                CX8 (CMPXCHG8 instruction supported)</span><br><span class="line">                APIC (On-chip APIC hardware supported)</span><br><span class="line">                SEP (Fast system call)</span><br><span class="line">                MTRR (Memory type range registers)</span><br><span class="line">                PGE (Page global enable)</span><br><span class="line">                MCA (Machine check architecture)</span><br><span class="line">                CMOV (Conditional move instruction supported)</span><br><span class="line">                PAT (Page attribute table)</span><br><span class="line">                PSE-36 (36-bit page size extension)</span><br><span class="line">                CLFSH (CLFLUSH instruction supported)</span><br><span class="line">                DS (Debug store)</span><br><span class="line">                ACPI (ACPI supported)</span><br><span class="line">                MMX (MMX technology supported)</span><br><span class="line">                FXSR (FXSAVE and FXSTOR instructions supported)</span><br><span class="line">                SSE (Streaming SIMD extensions)</span><br><span class="line">                SSE2 (Streaming SIMD extensions 2)</span><br><span class="line">                SS (Self-snoop)</span><br><span class="line">                HTT (Multi-threading)</span><br><span class="line">                TM (Thermal monitor supported)</span><br><span class="line">                PBE (Pending break enabled)</span><br><span class="line">        Version: Intel(R) Xeon(R) Silver 4110 CPU @ 2.10GHz</span><br><span class="line">        Voltage: 1.6 V</span><br><span class="line">        External Clock: 100 MHz</span><br><span class="line">        Max Speed: 3000 MHz</span><br><span class="line">        Current Speed: 2100 MHz</span><br><span class="line">        Status: Populated, Enabled</span><br><span class="line">        Upgrade: Socket LGA3647-1</span><br><span class="line">        L1 Cache Handle: 0x008B</span><br><span class="line">        L2 Cache Handle: 0x008C</span><br><span class="line">        L3 Cache Handle: 0x008D</span><br><span class="line">        Serial Number: Not Specified</span><br><span class="line">        Asset Tag: UNKNOWN</span><br><span class="line">        Part Number: Not Specified</span><br><span class="line">        Core Count: 8</span><br><span class="line">        Core Enabled: 8</span><br><span class="line">        Thread Count: 16</span><br><span class="line">        Characteristics:</span><br><span class="line">                64-bit capable</span><br><span class="line">                Multi-Core</span><br><span class="line">                Hardware Thread</span><br><span class="line">                Execute Protection</span><br><span class="line">                Enhanced Virtualization</span><br><span class="line">                Power/Performance Control</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看内存硬件信息</span></span><br><span class="line">[root@k205 ~]# dmidecode --type memory</span><br><span class="line"><span class="meta">#</span><span class="bash"> dmidecode 3.2</span></span><br><span class="line">Getting SMBIOS data from sysfs.</span><br><span class="line">SMBIOS 3.2 present.</span><br><span class="line"></span><br><span class="line">Handle 0x0049, DMI type 16, 23 bytes</span><br><span class="line">Physical Memory Array</span><br><span class="line">        Location: System Board Or Motherboard</span><br><span class="line">        Use: System Memory</span><br><span class="line">        Error Correction Type: Single-bit ECC</span><br><span class="line">        Maximum Capacity: 4 TB</span><br><span class="line">        Error Information Handle: Not Provided</span><br><span class="line">        Number Of Devices: 24</span><br><span class="line"></span><br><span class="line">Handle 0x004A, DMI type 17, 40 bytes</span><br><span class="line">Memory Device</span><br><span class="line">        Array Handle: 0x0049</span><br><span class="line">        Error Information Handle: Not Provided</span><br><span class="line">        Total Width: 72 bits</span><br><span class="line">        Data Width: 64 bits</span><br><span class="line">        Size: 32 GB</span><br><span class="line">        Form Factor: DIMM</span><br><span class="line">        Set: None</span><br><span class="line">        Locator: CPU0_C0D0</span><br><span class="line">        Bank Locator: NODE 1</span><br><span class="line">        Type: DDR4</span><br><span class="line">        Type Detail: Synchronous</span><br><span class="line">        Speed: 2666 MT/s</span><br><span class="line">        Manufacturer: Hynix</span><br><span class="line">        Serial Number: 430605AC</span><br><span class="line">        Asset Tag: CPU1_DIMM_A1_AssetTag</span><br><span class="line">        Part Number: HMA84GR7CJR4N-VK</span><br><span class="line">        Rank: 2</span><br><span class="line">        Configured Memory Speed: 2400 MT/s</span><br><span class="line">        Minimum Voltage: 1.2 V</span><br><span class="line">        Maximum Voltage: 1.2 V</span><br><span class="line">        Configured Voltage: 1.2 V</span><br><span class="line"></span><br><span class="line">Handle 0x004B, DMI type 17, 40 bytes</span><br><span class="line">Memory Device</span><br><span class="line">        Array Handle: 0x0049</span><br><span class="line">        Error Information Handle: Not Provided</span><br><span class="line">        Total Width: Unknown</span><br><span class="line">        Data Width: Unknown</span><br><span class="line">        Size: No Module Installed</span><br><span class="line">        Form Factor: Unknown</span><br><span class="line">        Set: None</span><br><span class="line">        Locator: CPU0_C0D1</span><br><span class="line">        Bank Locator: NODE 1</span><br><span class="line">        Type: Unknown</span><br><span class="line">        Type Detail: Unknown</span><br><span class="line">        Speed: Unknown</span><br><span class="line">        Manufacturer: NO DIMM</span><br><span class="line">        Serial Number: NO DIMM</span><br><span class="line">        Asset Tag: NO DIMM</span><br><span class="line">        Part Number: NO DIMM</span><br><span class="line">        Rank: Unknown</span><br><span class="line">        Configured Memory Speed: Unknown</span><br><span class="line">        Minimum Voltage: 1.2 V</span><br><span class="line">        Maximum Voltage: 1.2 V</span><br><span class="line">        Configured Voltage: 1.2 V</span><br><span class="line">...</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;IPMI管理&quot;&gt;&lt;a href=&quot;#IPMI管理&quot; class=&quot;headerlink&quot; title=&quot;IPMI管理&quot;&gt;&lt;/a&gt;IPMI管理&lt;/h2&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gut</summary>
      
    
    
    
    <category term="Linux" scheme="https://renyb2.github.io/categories/Linux/"/>
    
    
    <category term="Linux" scheme="https://renyb2.github.io/tags/Linux/"/>
    
    <category term="硬件" scheme="https://renyb2.github.io/tags/%E7%A1%AC%E4%BB%B6/"/>
    
  </entry>
  
  <entry>
    <title>Linux配置：CPU管理</title>
    <link href="https://renyb2.github.io/2022/07/11/Linux%E9%85%8D%E7%BD%AE%EF%BC%9ACPU%E7%AE%A1%E7%90%86/"/>
    <id>https://renyb2.github.io/2022/07/11/Linux%E9%85%8D%E7%BD%AE%EF%BC%9ACPU%E7%AE%A1%E7%90%86/</id>
    <published>2022-07-11T07:56:52.000Z</published>
    <updated>2022-08-19T03:21:46.523Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Generic-Scaling-Governors"><a href="#Generic-Scaling-Governors" class="headerlink" title="Generic Scaling Governors"></a>Generic Scaling Governors</h2><p><code>CPUFreq</code> provides generic scaling governors that can be used with all scaling drivers. As stated before, each of them implements a single, possibly parametrized, performance scaling algorithm.</p><p>Scaling governors are attached to policy objects and different policy objects can be handled by different scaling governors at the same time (although that may lead to suboptimal results in some cases).</p><p>The scaling governor for a given policy object can be changed at any time with the help of the <code>scaling_governor</code> policy attribute in <code>sysfs</code>.</p><p>Some governors expose <code>sysfs</code> attributes to control or fine-tune the scaling algorithms implemented by them. Those attributes, referred to as governor tunables, can be either global (system-wide) or per-policy, depending on the scaling driver in use. If the driver requires governor tunables to be per-policy, they are located in a subdirectory of each policy directory. Otherwise, they are located in a subdirectory under <code>/sys/devices/system/cpu/cpufreq/</code>. In either case the name of the subdirectory containing the governor tunables is the name of the governor providing them.</p><h3 id="performance"><a href="#performance" class="headerlink" title="performance"></a><code>performance</code></h3><p>When attached to a policy object, this governor causes the highest frequency, within the <code>scaling_max_freq</code> policy limit, to be requested for that policy.</p><p>The request is made once at that time the governor for the policy is set to <code>performance</code> and whenever the <code>scaling_max_freq</code> or <code>scaling_min_freq</code> policy limits change after that.</p><h3 id="powersave"><a href="#powersave" class="headerlink" title="powersave"></a><code>powersave</code></h3><p>When attached to a policy object, this governor causes the lowest frequency, within the <code>scaling_min_freq</code> policy limit, to be requested for that policy.</p><p>The request is made once at that time the governor for the policy is set to <code>powersave</code> and whenever the <code>scaling_max_freq</code> or <code>scaling_min_freq</code> policy limits change after that.</p><h3 id="userspace"><a href="#userspace" class="headerlink" title="userspace"></a><code>userspace</code></h3><p>This governor does not do anything by itself. Instead, it allows user space to set the CPU frequency for the policy it is attached to by writing to the <code>scaling_setspeed</code> attribute of that policy.</p><h3 id="schedutil"><a href="#schedutil" class="headerlink" title="schedutil"></a><code>schedutil</code></h3><p>This governor uses CPU utilization data available from the CPU scheduler. It generally is regarded as a part of the CPU scheduler, so it can access the scheduler’s internal data structures directly.</p><p>It runs entirely in scheduler context, although in some cases it may need to invoke the scaling driver asynchronously when it decides that the CPU frequency should be changed for a given policy (that depends on whether or not the driver is capable of changing the CPU frequency from scheduler context).</p><p>The actions of this governor for a particular CPU depend on the scheduling class invoking its utilization update callback for that CPU. If it is invoked by the RT or deadline scheduling classes, the governor will increase the frequency to the allowed maximum (that is, the <code>scaling_max_freq</code> policy limit). In turn, if it is invoked by the CFS scheduling class, the governor will use the Per-Entity Load Tracking (PELT) metric for the root control group of the given CPU as the CPU utilization estimate (see the <a href="https://lwn.net/Articles/531853/">Per-entity load tracking</a> LWN.net article for a description of the PELT mechanism). Then, the new CPU frequency to apply is computed in accordance with the formula</p><blockquote><p>f = 1.25 * <code>f_0</code> * <code>util</code> / <code>max</code></p></blockquote><p>where <code>util</code> is the PELT number, <code>max</code> is the theoretical maximum of <code>util</code>, and <code>f_0</code> is either the maximum possible CPU frequency for the given policy (if the PELT number is frequency-invariant), or the current CPU frequency (otherwise).</p><p>This governor also employs a mechanism allowing it to temporarily bump up the CPU frequency for tasks that have been waiting on I/O most recently, called “IO-wait boosting”. That happens when the <code>SCHED_CPUFREQ_IOWAIT</code> flag is passed by the scheduler to the governor callback which causes the frequency to go up to the allowed maximum immediately and then draw back to the value returned by the above formula over time.</p><p>This governor exposes only one tunable:</p><ul><li><p><code>rate_limit_us</code></p><p>Minimum time (in microseconds) that has to pass between two consecutive runs of governor computations (default: 1000 times the scaling driver’s transition latency).The purpose of this tunable is to reduce the scheduler context overhead of the governor which might be excessive without it.</p></li></ul><p>This governor generally is regarded as a replacement for the older <a href="https://www.kernel.org/doc/html/v4.14/admin-guide/pm/cpufreq.html#ondemand">ondemand</a> and <a href="https://www.kernel.org/doc/html/v4.14/admin-guide/pm/cpufreq.html#conservative">conservative</a> governors (described below), as it is simpler and more tightly integrated with the CPU scheduler, its overhead in terms of CPU context switches and similar is less significant, and it uses the scheduler’s own CPU utilization metric, so in principle its decisions should not contradict the decisions made by the other parts of the scheduler.</p><h3 id="ondemand"><a href="#ondemand" class="headerlink" title="ondemand"></a><code>ondemand</code></h3><p>This governor uses CPU load as a CPU frequency selection metric.</p><p>In order to estimate the current CPU load, it measures the time elapsed between consecutive invocations of its worker routine and computes the fraction of that time in which the given CPU was not idle. The ratio of the non-idle (active) time to the total CPU time is taken as an estimate of the load.</p><p>If this governor is attached to a policy shared by multiple CPUs, the load is estimated for all of them and the greatest result is taken as the load estimate for the entire policy.</p><p>The worker routine of this governor has to run in process context, so it is invoked asynchronously (via a workqueue) and CPU P-states are updated from there if necessary. As a result, the scheduler context overhead from this governor is minimum, but it causes additional CPU context switches to happen relatively often and the CPU P-state updates triggered by it can be relatively irregular. Also, it affects its own CPU load metric by running code that reduces the CPU idle time (even though the CPU idle time is only reduced very slightly by it).</p><p>It generally selects CPU frequencies proportional to the estimated load, so that the value of the <code>cpuinfo_max_freq</code> policy attribute corresponds to the load of 1 (or 100%), and the value of the <code>cpuinfo_min_freq</code> policy attribute corresponds to the load of 0, unless when the load exceeds a (configurable) speedup threshold, in which case it will go straight for the highest frequency it is allowed to use (the <code>scaling_max_freq</code> policy limit).</p><p>This governor exposes the following tunables:</p><ul><li><p><code>sampling_rate</code></p><p>This is how often the governor’s worker routine should run, in microseconds.Typically, it is set to values of the order of 10000 (10 ms). Its default value is equal to the value of <code>cpuinfo_transition_latency</code> for each policy this governor is attached to (but since the unit here is greater by 1000, this means that the time represented by <code>sampling_rate</code> is 1000 times greater than the transition latency by default).If this tunable is per-policy, the following shell command sets the time represented by it to be 750 times as high as the transition latency:<code># echo </code>$(($(cat cpuinfo_transition_latency) * 750 / 1000)) &gt; ondemand/sampling_rate `</p></li><li><p><code>up_threshold</code></p><p>If the estimated CPU load is above this value (in percent), the governor will set the frequency to the maximum value allowed for the policy. Otherwise, the selected frequency will be proportional to the estimated CPU load.</p></li><li><p><code>ignore_nice_load</code></p><p>If set to 1 (default 0), it will cause the CPU load estimation code to treat the CPU time spent on executing tasks with “nice” levels greater than 0 as CPU idle time.This may be useful if there are tasks in the system that should not be taken into account when deciding what frequency to run the CPUs at. Then, to make that happen it is sufficient to increase the “nice” level of those tasks above 0 and set this attribute to 1.</p></li><li><p><code>sampling_down_factor</code></p><p>Temporary multiplier, between 1 (default) and 100 inclusive, to apply to the <code>sampling_rate</code> value if the CPU load goes above <code>up_threshold</code>.This causes the next execution of the governor’s worker routine (after setting the frequency to the allowed maximum) to be delayed, so the frequency stays at the maximum level for a longer time.Frequency fluctuations in some bursty workloads may be avoided this way at the cost of additional energy spent on maintaining the maximum CPU capacity.</p></li><li><p><code>powersave_bias</code></p><p>Reduction factor to apply to the original frequency target of the governor (including the maximum value used when the <code>up_threshold</code> value is exceeded by the estimated CPU load) or sensitivity threshold for the AMD frequency sensitivity powersave bias driver (<code>drivers/cpufreq/amd_freq_sensitivity.c</code>), between 0 and 1000 inclusive.If the AMD frequency sensitivity powersave bias driver is not loaded, the effective frequency to apply is given byf * (1 - <code>powersave_bias</code> / 1000)where f is the governor’s original frequency target. The default value of this attribute is 0 in that case.If the AMD frequency sensitivity powersave bias driver is loaded, the value of this attribute is 400 by default and it is used in a different way.On Family 16h (and later) AMD processors there is a mechanism to get a measured workload sensitivity, between 0 and 100% inclusive, from the hardware. That value can be used to estimate how the performance of the workload running on a CPU will change in response to frequency changes.The performance of a workload with the sensitivity of 0 (memory-bound or IO-bound) is not expected to increase at all as a result of increasing the CPU frequency, whereas workloads with the sensitivity of 100% (CPU-bound) are expected to perform much better if the CPU frequency is increased.If the workload sensitivity is less than the threshold represented by the <code>powersave_bias</code> value, the sensitivity powersave bias driver will cause the governor to select a frequency lower than its original target, so as to avoid over-provisioning workloads that will not benefit from running at higher CPU frequencies.</p></li></ul><h3 id="conservative"><a href="#conservative" class="headerlink" title="conservative"></a><code>conservative</code></h3><p>This governor uses CPU load as a CPU frequency selection metric.</p><p>It estimates the CPU load in the same way as the <a href="https://www.kernel.org/doc/html/v4.14/admin-guide/pm/cpufreq.html#ondemand">ondemand</a> governor described above, but the CPU frequency selection algorithm implemented by it is different.</p><p>Namely, it avoids changing the frequency significantly over short time intervals which may not be suitable for systems with limited power supply capacity (e.g. battery-powered). To achieve that, it changes the frequency in relatively small steps, one step at a time, up or down - depending on whether or not a (configurable) threshold has been exceeded by the estimated CPU load.</p><p>This governor exposes the following tunables:</p><ul><li><p><code>freq_step</code></p><p>Frequency step in percent of the maximum frequency the governor is allowed to set (the <code>scaling_max_freq</code> policy limit), between 0 and 100 (5 by default).This is how much the frequency is allowed to change in one go. Setting it to 0 will cause the default frequency step (5 percent) to be used and setting it to 100 effectively causes the governor to periodically switch the frequency between the <code>scaling_min_freq</code> and <code>scaling_max_freq</code> policy limits.</p></li><li><p><code>down_threshold</code></p><p>Threshold value (in percent, 20 by default) used to determine the frequency change direction.If the estimated CPU load is greater than this value, the frequency will go up (by <code>freq_step</code>). If the load is less than this value (and the <code>sampling_down_factor</code> mechanism is not in effect), the frequency will go down. Otherwise, the frequency will not be changed.</p></li><li><p><code>sampling_down_factor</code></p><p>Frequency decrease deferral factor, between 1 (default) and 10 inclusive.It effectively causes the frequency to go down <code>sampling_down_factor</code> times slower than it ramps up.</p></li></ul><h2 id="CPU管理命令"><a href="#CPU管理命令" class="headerlink" title="CPU管理命令"></a>CPU管理命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看当前CPU可用策略</span></span><br><span class="line">[root@k205 ~]# cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_available_governors</span><br><span class="line">performance powersave</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看当前CPU生效策略</span></span><br><span class="line">[root@k205 ~]# cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor</span><br><span class="line">performance</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看当前CPU频率</span></span><br><span class="line">[root@k205 ~]# cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_cur_freq</span><br><span class="line">2399926</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看当前所有CPU的信息</span></span><br><span class="line">[root@k205 ~]# cpupower -c all frequency-info</span><br><span class="line">analyzing CPU 0:</span><br><span class="line">  driver: intel_pstate</span><br><span class="line">  CPUs which run at the same hardware frequency: 0</span><br><span class="line">  CPUs which need to have their frequency coordinated by software: 0</span><br><span class="line">  maximum transition latency:  Cannot determine or is not supported.</span><br><span class="line">  hardware limits: 800 MHz - 3.00 GHz</span><br><span class="line">  available cpufreq governors: performance powersave</span><br><span class="line">  current policy: frequency should be within 800 MHz and 3.00 GHz.</span><br><span class="line">                  The governor &quot;performance&quot; may decide which speed to use</span><br><span class="line">                  within this range.</span><br><span class="line">  current CPU frequency: 2.40 GHz (asserted by call to hardware)</span><br><span class="line">  boost state support:</span><br><span class="line">    Supported: yes</span><br><span class="line">    Active: yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置所有CPU的模式</span></span><br><span class="line">[root@k205 ~]# cpupower -c all frequency-set -g performance</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看CPU的频率</span></span><br><span class="line">[root@k205 ~]# cat /proc/cpuinfo | grep &quot;cpu MHz*&quot;</span><br><span class="line">cpu MHz         : 2399.926</span><br></pre></td></tr></table></figure><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://www.kernel.org/doc/html/v4.14/admin-guide/pm/working-state.html">Linux Kernel官方文档：Working-State Power Management</a></li><li><a href="https://www.intel.cn/content/www/cn/zh/gaming/resources/game-server.html">Intel官方文档：如何设置专用游戏服务器</a></li><li><a href="https://www.intel.cn/content/www/cn/zh/gaming/resources/turbo-boost.html">Intel官方文档：什么是英特尔® 睿频加速技术？</a></li><li><a href="https://www.intel.cn/content/www/cn/zh/gaming/resources/how-to-overclock.html">Intel官方文档：如何超频您未锁频的英特尔® 酷睿™ 处理器</a></li><li><a href="https://www.cnblogs.com/ggzhangxiaochao/p/13948483.html">cpupower调整CPU主频</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Generic-Scaling-Governors&quot;&gt;&lt;a href=&quot;#Generic-Scaling-Governors&quot; class=&quot;headerlink&quot; title=&quot;Generic Scaling Governors&quot;&gt;&lt;/a&gt;Generic Sca</summary>
      
    
    
    
    <category term="Linux" scheme="https://renyb2.github.io/categories/Linux/"/>
    
    
    <category term="Linux" scheme="https://renyb2.github.io/tags/Linux/"/>
    
    <category term="CPU" scheme="https://renyb2.github.io/tags/CPU/"/>
    
  </entry>
  
  <entry>
    <title>OpenStack部署：Cyborg</title>
    <link href="https://renyb2.github.io/2022/07/02/OpenStack%E9%83%A8%E7%BD%B2%EF%BC%9ACyborg/"/>
    <id>https://renyb2.github.io/2022/07/02/OpenStack%E9%83%A8%E7%BD%B2%EF%BC%9ACyborg/</id>
    <published>2022-07-02T03:13:22.000Z</published>
    <updated>2022-08-22T09:23:34.147Z</updated>
    
    <content type="html"><![CDATA[<h2 id="资源管理"><a href="#资源管理" class="headerlink" title="资源管理"></a>资源管理</h2><h3 id="Device-Profile"><a href="#Device-Profile" class="headerlink" title="Device Profile"></a>Device Profile</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建VGPU模板</span></span><br><span class="line">openstack accelerator device profile create vgpu-dp &#x27;[&#123;&quot;resources:VGPU&quot;: &quot;1&quot;&#125;]&#x27;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建PGPU模板</span></span><br><span class="line">openstack accelerator device profile create pgpu-dp &#x27;[&#123;&quot;resources:PGPU&quot;:&quot;1&quot;&#125;]&#x27;</span><br><span class="line">openstack accelerator device profile create pgpu-dp &#x27;[&#123;&quot;resources:PGPU&quot;:&quot;1&quot;&#125;, &#123;&quot;resources:PGPU&quot;:&quot;1&quot;&#125;]&#x27;</span><br><span class="line">openstack accelerator device profile create pgpu-dp &#x27;[&#123;&quot;resources:PGPU&quot;:&quot;1&quot;, &quot;trait:CUSTOM_GPU_PRODUCT_ID_1EB8&quot;: &quot;required&quot;&#125;]&#x27;</span><br></pre></td></tr></table></figure><h3 id="Flavor"><a href="#Flavor" class="headerlink" title="Flavor"></a>Flavor</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建含加速资源的Flavor</span></span><br><span class="line">openstack flavor create --vcpus 1 --ram 512 --disk 1 --property accel:device_profile=vgpu-dp vgpu-cirros</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;资源管理&quot;&gt;&lt;a href=&quot;#资源管理&quot; class=&quot;headerlink&quot; title=&quot;资源管理&quot;&gt;&lt;/a&gt;资源管理&lt;/h2&gt;&lt;h3 id=&quot;Device-Profile&quot;&gt;&lt;a href=&quot;#Device-Profile&quot; class=&quot;headerli</summary>
      
    
    
    
    <category term="OpenStack" scheme="https://renyb2.github.io/categories/OpenStack/"/>
    
    
    <category term="OpenStack" scheme="https://renyb2.github.io/tags/OpenStack/"/>
    
    <category term="Accelerator" scheme="https://renyb2.github.io/tags/Accelerator/"/>
    
    <category term="Cyborg" scheme="https://renyb2.github.io/tags/Cyborg/"/>
    
  </entry>
  
  <entry>
    <title>NVIDIA使用：渲染能力</title>
    <link href="https://renyb2.github.io/2022/06/30/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9A%E6%B8%B2%E6%9F%93%E8%83%BD%E5%8A%9B/"/>
    <id>https://renyb2.github.io/2022/06/30/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9A%E6%B8%B2%E6%9F%93%E8%83%BD%E5%8A%9B/</id>
    <published>2022-06-30T07:55:22.000Z</published>
    <updated>2022-07-04T09:40:39.549Z</updated>
    
    <content type="html"><![CDATA[<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://docs.nvidia.com/grid/7.0/grid-licensing-user-guide/index.html">NVIDIA官网文档：Virtual GPU Client Licensing User Guide</a></li><li><a href="https://cloud.tencent.com/document/product/560/30060">腾讯云：安装 NVIDIA GRID 驱动</a></li><li><a href="http://12www.cniti.com/index.php/article/index/id/12833/page/2">Unigine Valley BenchMark测试体验</a></li><li><a href="https://benchmark.unigine.com/">Unigine Benchmark官网</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;参考文档&quot;&gt;&lt;a href=&quot;#参考文档&quot; class=&quot;headerlink&quot; title=&quot;参考文档&quot;&gt;&lt;/a&gt;参考文档&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.nvidia.com/grid/7.0/grid-licensing</summary>
      
    
    
    
    <category term="Accelerator" scheme="https://renyb2.github.io/categories/Accelerator/"/>
    
    
    <category term="NVIDIA" scheme="https://renyb2.github.io/tags/NVIDIA/"/>
    
    <category term="Accelerator" scheme="https://renyb2.github.io/tags/Accelerator/"/>
    
  </entry>
  
  <entry>
    <title>KVM使用：通用手册</title>
    <link href="https://renyb2.github.io/2022/05/31/KVM%E4%BD%BF%E7%94%A8%EF%BC%9A%E9%80%9A%E7%94%A8%E6%89%8B%E5%86%8C/"/>
    <id>https://renyb2.github.io/2022/05/31/KVM%E4%BD%BF%E7%94%A8%EF%BC%9A%E9%80%9A%E7%94%A8%E6%89%8B%E5%86%8C/</id>
    <published>2022-05-31T05:39:01.000Z</published>
    <updated>2022-05-31T05:52:59.536Z</updated>
    
    <content type="html"><![CDATA[<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="Internal-error-cannot-find-character-device-null"><a href="#Internal-error-cannot-find-character-device-null" class="headerlink" title="Internal error cannot find character device (null)"></a>Internal error cannot find character device (null)</h3><ul><li><p><strong>Symptom</strong></p><p>This error message appears when attempting to connect to a guest virtual machine’s console:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> virsh console test2</span></span><br><span class="line">Connected to domain test2 </span><br><span class="line">Escape character is ^] </span><br><span class="line">error: internal error cannot find character device (null)</span><br></pre></td></tr></table></figure></li><li><p><strong>Investigation</strong></p><p>This error message shows that there is no serial console configured for the guest virtual machine.</p></li><li><p><strong>Solution</strong></p><p>Set up a serial console in the guest’s XML file.</p><p><strong>Procedure B.1. Setting up a serial console in the guest’s XML</strong></p><ol><li><p>Add the following XML to the guest virtual machine’s XML using <strong>virsh edit</strong>:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;serial type=&#x27;pty&#x27;&gt;</span><br><span class="line">  &lt;target port=&#x27;0&#x27;/&gt;</span><br><span class="line">&lt;/serial&gt;</span><br><span class="line">&lt;console type=&#x27;pty&#x27;&gt;</span><br><span class="line">  &lt;target type=&#x27;serial&#x27; port=&#x27;0&#x27;/&gt;</span><br><span class="line">&lt;/console&gt;</span><br></pre></td></tr></table></figure></li><li><p>Set up the console in the guest kernel command line.</p><p>To do this, either log in to the guest virtual machine to edit the <code>/boot/grub/grub.conf</code> file directly, or use the <strong>virt-edit</strong> command line tool. Add the following to the guest kernel command line:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">console=ttyS0,115200</span><br></pre></td></tr></table></figure></li><li><p>Run the followings command:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> virsh start vm &amp;&amp; virsh console vm</span></span><br></pre></td></tr></table></figure></li></ol></li></ul><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/virtualization_host_configuration_and_guest_installation_guide/app_domain_console">RedHat官方文档：Internal error cannot find character device (null)</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;常见问题&quot;&gt;&lt;a href=&quot;#常见问题&quot; class=&quot;headerlink&quot; title=&quot;常见问题&quot;&gt;&lt;/a&gt;常见问题&lt;/h2&gt;&lt;h3 id=&quot;Internal-error-cannot-find-character-device-null&quot;&gt;&lt;a href</summary>
      
    
    
    
    <category term="KVM" scheme="https://renyb2.github.io/categories/KVM/"/>
    
    
    <category term="KVM" scheme="https://renyb2.github.io/tags/KVM/"/>
    
    <category term="虚拟化" scheme="https://renyb2.github.io/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>MySQL部署：Percona XtraDB Cluster</title>
    <link href="https://renyb2.github.io/2022/05/16/MySQL%E9%83%A8%E7%BD%B2%EF%BC%9APercona-XtraDB-Cluster/"/>
    <id>https://renyb2.github.io/2022/05/16/MySQL%E9%83%A8%E7%BD%B2%EF%BC%9APercona-XtraDB-Cluster/</id>
    <published>2022-05-16T02:43:56.000Z</published>
    <updated>2022-05-16T07:42:40.626Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p><a href="https://www.percona.com/software/mysql-database/percona-xtradb-cluster">Percona XtraDB Cluster</a> is a fully open-source high-availability solution for MySQL. It integrates <a href="https://www.percona.com/software/mysql-database/percona-server">Percona Server</a> and <a href="https://www.percona.com/software/mysql-database/percona-xtrabackup">Percona XtraBackup</a> with the <a href="https://github.com/percona/galera">Galera</a> library to enable synchronous multi-source replication.</p><p>A <em>cluster</em> consists of <em>nodes</em>, where each node contains the same set of data synchronized accross nodes. The recommended configuration is to have at least 3 nodes, but you can have 2 nodes as well. Each node is a regular MySQL Server instance (for example, Percona Server). You can convert an existing MySQL Server instance to a node and run the cluster using this node as a base. You can also detach any node from the cluster and use it as a regular MySQL Server instance.</p><img src="/2022/05/16/MySQL%E9%83%A8%E7%BD%B2%EF%BC%9APercona-XtraDB-Cluster/cluster-diagram1.png" alt="cluster-diagram1" style="zoom:100%;"><p>Benefits:</p><ul><li>When you execute a query, it is executed locally on the node. All data is available locally, no need for remote access.</li><li>No central management. You can loose any node at any point of time, and the cluster will continue to function without any data loss.</li><li>Good solution for scaling a read workload. You can put read queries to any of the nodes.</li></ul><p>Drawbacks:</p><ul><li>Overhead of provisioning new node. When you add a new node, it has to copy the full data set from one of existing nodes. If it is 100GB, it copies 100GB.</li><li>This can’t be used as an effective write scaling solution. There might be some improvements in write throughput when you run write traffic to 2 nodes versus all traffic to 1 node, but you can’t expect a lot. All writes still have to go on all nodes.</li><li>You have several duplicates of the data, for 3 nodes you have 3 duplicates.</li></ul><h2 id="Components"><a href="#Components" class="headerlink" title="Components"></a>Components</h2><p><a href="https://www.percona.com/software/mysql-database/percona-xtradb-cluster">Percona XtraDB Cluster</a> is based on <a href="https://www.percona.com/software/mysql-database/percona-server">Percona Server</a> running with the <a href="https://www.percona.com/software/mysql-database/percona-server/xtradb">XtraDB</a> storage engine. It uses the <a href="https://github.com/percona/galera">Galera</a> library, which is an implementation of the write set replication (wsrep) API developed by <a href="http://www.galeracluster.com/">Codership Oy</a>. The default and recommended data transfer method is via <a href="https://www.percona.com/software/mysql-database/percona-xtrabackup">Percona XtraBackup</a>.</p><h2 id="Install-Guide"><a href="#Install-Guide" class="headerlink" title="Install Guide"></a>Install Guide</h2><h3 id="Environmental-information"><a href="#Environmental-information" class="headerlink" title="Environmental information"></a>Environmental information</h3><ul><li><strong>MySQL版本：</strong>percona-xtradb-cluster-57 (5.7.36-31.55-1.xenial amd64)</li></ul><table><thead><tr><th align="center">Node</th><th align="center">Host Name</th><th align="center">IP</th><th align="center">Flavor</th><th align="center">OS Distro</th></tr></thead><tbody><tr><td align="center">Node 1</td><td align="center">pxc1</td><td align="center">192.168.0.11</td><td align="center">4C8G，100G数据盘</td><td align="center">Ubuntu 16.04.7 LTS (GNU/Linux 4.4.0-210-generic x86_64)</td></tr><tr><td align="center">Node 2</td><td align="center">pxc2</td><td align="center">192.168.0.12</td><td align="center">4C8G，100G数据盘</td><td align="center">Ubuntu 16.04.7 LTS (GNU/Linux 4.4.0-210-generic x86_64)</td></tr><tr><td align="center">Node 3</td><td align="center">pxc3</td><td align="center">192.168.0.13</td><td align="center">4C8G，100G数据盘</td><td align="center">Ubuntu 16.04.7 LTS (GNU/Linux 4.4.0-210-generic x86_64)</td></tr></tbody></table><h3 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h3><ul><li><p>You need to have root access on the node where you will be installing Percona XtraDB Cluster (either logged in as a user with root privileges or be able to run commands with <code>sudo</code>).</p></li><li><p>Make sure that the following ports are not blocked by firewall or used by other software. Percona XtraDB Cluster requires them for communication.</p><blockquote><ul><li>3306</li><li>4444</li><li>4567</li><li>4568</li></ul></blockquote></li></ul><h3 id="Installing-from-Repository"><a href="#Installing-from-Repository" class="headerlink" title="Installing from Repository"></a>Installing from Repository</h3><ol><li><p>Update the sytem:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br></pre></td></tr></table></figure></li><li><p>Install the necessary packages:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y wget gnupg2 lsb-release curl</span><br></pre></td></tr></table></figure></li><li><p>Download the repository package</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://repo.percona.com/apt/percona-release_latest.generic_all.deb</span><br></pre></td></tr></table></figure></li><li><p>Install the package with <code>dpkg</code>:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg -i percona-release_latest.generic_all.deb</span><br></pre></td></tr></table></figure></li><li><p>Refresh the local cache to update the package information:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br></pre></td></tr></table></figure></li><li><p>If need, enable the <code>release</code> repository for <em>Percona XtraDB Cluster</em> (optional):</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo percona-release setup pxc80</span><br></pre></td></tr></table></figure></li><li><p>Install the cluster:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y percona-xtradb-cluster-57</span><br></pre></td></tr></table></figure></li></ol><h3 id="Configuring-Nodes-for-Write-Set-Replication"><a href="#Configuring-Nodes-for-Write-Set-Replication" class="headerlink" title="Configuring Nodes for Write-Set Replication"></a>Configuring Nodes for Write-Set Replication</h3><ol><li><p>Stop the Percona XtraDB Cluster server. After the installation completes the server is not started. You need this step if you have started the server manually.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo service mysql stop</span></span><br></pre></td></tr></table></figure></li><li><p>Edit the configuration file of the first node to provide the cluster settings.</p><p><em>If you use Debian or Ubuntu</em>, edit <code>/etc/mysql/percona-xtradb-cluster.conf.d/wsrep.cnf</code>:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Path to Galera library</span></span><br><span class="line">wsrep_provider=/usr/lib/galera3/libgalera_smm.so</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Cluster name</span></span><br><span class="line">wsrep_cluster_name=pxc-cluster</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Cluster connection URL contains IPs of nodes</span></span><br><span class="line"><span class="meta">#</span><span class="bash">If no IP is found, this implies that a new cluster needs to be created,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">in</span> order to <span class="keyword">do</span> that you need to bootstrap this node</span></span><br><span class="line">wsrep_cluster_address=gcomm://192.168.0.11,192.168.0.12,192.168.0.13</span><br></pre></td></tr></table></figure><p>Configure <em>node 1</em>.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">If wsrep_node_name is not specified,  <span class="keyword">then</span> system hostname will be used</span></span><br><span class="line">wsrep_node_name=pxc1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Node IP address</span></span><br><span class="line">wsrep_node_address=192.168.0.11</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">pxc_strict_mode allowed values: DISABLED,PERMISSIVE,ENFORCING,MASTER</span></span><br><span class="line">pxc_strict_mode=ENFORCING</span><br></pre></td></tr></table></figure></li><li><p>Set up <em>node 2</em> and <em>node 3</em> in the same way: Stop the server and update the configuration file applicable to your system. All settings are the same except for <a href="https://www.percona.com/doc/percona-xtradb-cluster/LATEST/wsrep-system-index.html#wsrep_node_name"><code>wsrep_node_name</code></a> and <a href="https://www.percona.com/doc/percona-xtradb-cluster/LATEST/wsrep-system-index.html#wsrep_node_address"><code>wsrep_node_address</code></a>.</p><ul><li><p>For node 2</p><p>wsrep_node_name=pxc2 wsrep_node_address=192.168.0.12</p></li><li><p>For node 3</p><p>wsrep_node_name=pxc3 wsrep_node_address=192.168.0.13</p></li></ul></li><li><p>Set user information for synchronization. Only the first node is set.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> SST method</span></span><br><span class="line">wsrep_sst_method=xtrabackup-v2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Authentication <span class="keyword">for</span> SST method</span></span><br><span class="line">wsrep_sst_auth=&quot;sstuser:123456&quot;</span><br></pre></td></tr></table></figure></li><li><p>Set up the traffic encryption settings. Each node of the cluster must use the same SSL certificates (optional).</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">wsrep_provider_options=”socket.ssl_key=server-key.pem;socket.ssl_cert=server-cert.pem;socket.ssl_ca=ca.pem”</span><br><span class="line"></span><br><span class="line">[sst]</span><br><span class="line">encrypt=4</span><br><span class="line">ssl-key=server-key.pem</span><br><span class="line">ssl-ca=ca.pem</span><br><span class="line">ssl-cert=server-cert.pem</span><br></pre></td></tr></table></figure></li></ol><h3 id="Bootstrapping-the-First-Node"><a href="#Bootstrapping-the-First-Node" class="headerlink" title="Bootstrapping the First Node"></a>Bootstrapping the First Node</h3><p>After you <a href="https://www.percona.com/doc/percona-xtradb-cluster/LATEST/configure.html#configure">configure all PXC nodes</a>, initialize the cluster by bootstrapping the first node. The initial node must contain all the data that you want to be replicated to other nodes.</p><p>Bootstrapping implies starting the first node without any known cluster addresses: if the wsrep_cluster_address variable is empty, Percona XtraDB Cluster assumes that this is the first node and initializes the cluster.</p><p>Instead of changing the configuration, start the first node using the following command:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@pxc1:~# /etc/init.d/mysql bootstrap-pxc</span><br></pre></td></tr></table></figure><p>After startup, you need to manually create a synchronization user (this process does not need to be executed after version 8.0)</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create user &#x27;sstuser&#x27;@&#x27;localhost&#x27; identified by &#x27;123456&#x27;;</span><br><span class="line">mysql&gt; grant reload, lock tables, replication client, process on *.* to &#x27;sstuser&#x27;@&#x27;localhost&#x27;;</span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure><p>When you start the node using the previous command, it runs in bootstrap mode with <code>wsrep_cluster_address=gcomm://</code>. This tells the node to initialize the cluster with <a href="https://www.percona.com/doc/percona-xtradb-cluster/LATEST/wsrep-status-index.html#wsrep_cluster_conf_id"><code>wsrep_cluster_conf_id</code></a> set to <code>1</code>. After you <a href="https://www.percona.com/doc/percona-xtradb-cluster/LATEST/add-node.html#add-node">add other nodes</a> to the cluster, you can then restart this node as normal, and it will use standard configuration again.</p><p>To make sure that the cluster has been initialized, run the following:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show status like &#x27;wsrep%&#x27;;</span><br><span class="line">+<span class="comment">----------------------------+--------------------------------------+</span></span><br><span class="line">| Variable_name              | Value                                |</span><br><span class="line">+<span class="comment">----------------------------+--------------------------------------+</span></span><br><span class="line">| wsrep_local_state_uuid     | c2883338-834d-11e2-0800-03c9c68e41ec |</span><br><span class="line">| ...                        | ...                                  |</span><br><span class="line">| wsrep_local_state          | 4                                    |</span><br><span class="line">| wsrep_local_state_comment  | Synced                               |</span><br><span class="line">| ...                        | ...                                  |</span><br><span class="line">| wsrep_cluster_size         | 1                                    |</span><br><span class="line">| wsrep_cluster_status       | Primary                              |</span><br><span class="line">| wsrep_connected            | ON                                   |</span><br><span class="line">| ...                        | ...                                  |</span><br><span class="line">| wsrep_ready                | ON                                   |</span><br><span class="line">+<span class="comment">----------------------------+--------------------------------------+</span></span><br><span class="line">40 rows in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><p>The previous output shows that the cluster size is 1 node, it is the primary component, the node is in the <code>Synced</code> state, it is fully connected and ready for write-set replication.</p><h3 id="Adding-Nodes-to-Cluster"><a href="#Adding-Nodes-to-Cluster" class="headerlink" title="Adding Nodes to Cluster"></a>Adding Nodes to Cluster</h3><p>Start the second node using the following command:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@pxc2:~# systemctl start mysql</span><br></pre></td></tr></table></figure><p>After the server starts, it receives <a href="https://www.percona.com/doc/percona-xtradb-cluster/LATEST/glossary.html#term-sst">SST</a> automatically.</p><p>To check the status of the second node, run the following:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show status like &#39;wsrep%&#39;;</span><br><span class="line">+----------------------------------+--------------------------------------------------+</span><br><span class="line">| Variable_name                    | Value                                            |</span><br><span class="line">+----------------------------------+--------------------------------------------------+</span><br><span class="line">| wsrep_local_state_uuid           | a08247c1-5807-11ea-b285-e3a50c8efb41             |</span><br><span class="line">| ...                              | ...                                              |</span><br><span class="line">| wsrep_local_state                | 4                                                |</span><br><span class="line">| wsrep_local_state_comment        | Synced                                           |</span><br><span class="line">| ...                              |                                                  |</span><br><span class="line">| wsrep_cluster_size               | 2                                                |</span><br><span class="line">| wsrep_cluster_status             | Primary                                          |</span><br><span class="line">| wsrep_connected                  | ON                                               |</span><br><span class="line">| ...                              | ...                                              |</span><br><span class="line">| wsrep_provider_capabilities      | :MULTI_MASTER:CERTIFICATION: ...                 |</span><br><span class="line">| wsrep_provider_name              | Galera                                           |</span><br><span class="line">| wsrep_provider_vendor            | Codership Oy &lt;info@codership.com&gt;                |</span><br><span class="line">| wsrep_provider_version           | 3.55(r8b6416d)                                   |</span><br><span class="line">| wsrep_ready                      | ON                                               |</span><br><span class="line">| ...                              | ...                                              |</span><br><span class="line">+----------------------------------+--------------------------------------------------+</span><br><span class="line">75 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>The output of <code>SHOW STATUS</code> shows that the new node has been successfully added to the cluster. The cluster size is now 2 nodes, it is the primary component, and it is fully connected and ready to receive write-set replication.</p><p>If the state of the second node is <code>Synced</code> as in the previous example, then the node received full <a href="https://www.percona.com/doc/percona-xtradb-cluster/LATEST/glossary.html#term-sst">SST</a> is synchronized with the cluster, and you can proceed to add the next node.</p><h3 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h3><ul><li>MySQL <code>root@localhost</code> 用户需要密码为空。</li></ul><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://www.percona.com/doc/percona-xtradb-cluster/5.7/intro.html">Percona官方文档：About Percona XtraDB Cluster</a></li><li><a href="https://www.percona.com/doc/percona-xtradb-cluster/LATEST/install/apt.html">Percona官方文档：Installing Percona XtraDB Cluster on Debian or Ubuntu</a></li><li><a href="https://www.percona.com/doc/percona-xtradb-cluster/LATEST/configure.html#configure">Percona官方文档：Configuring Nodes for Write-Set Replication</a></li><li><a href="https://www.percona.com/doc/percona-xtradb-cluster/LATEST/bootstrap.html#bootstrap">Percona官方文档：Bootstrapping the First Node</a></li><li><a href="https://www.percona.com/doc/percona-xtradb-cluster/LATEST/add-node.html#add-node">Percona官方文档：Adding Nodes to Cluster</a></li><li><a href="https://blog.csdn.net/weixin_43557605/article/details/102875289">Percona-xtraDB-cluster的安装、配置和使用</a></li><li><a href="https://blog.csdn.net/Aria_Miazzy/article/details/84579574">Mysql搭建PXC集群 - Percona XtraDB Cluster</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Introduction&quot;&gt;&lt;a href=&quot;#Introduction&quot; class=&quot;headerlink&quot; title=&quot;Introduction&quot;&gt;&lt;/a&gt;Introduction&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://www.percona.c</summary>
      
    
    
    
    <category term="数据库" scheme="https://renyb2.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
    <category term="MySQL" scheme="https://renyb2.github.io/tags/MySQL/"/>
    
    <category term="Percona" scheme="https://renyb2.github.io/tags/Percona/"/>
    
  </entry>
  
  <entry>
    <title>OpenStack研发：Cyborg</title>
    <link href="https://renyb2.github.io/2022/05/10/OpenStack%E7%A0%94%E5%8F%91%EF%BC%9ACyborg/"/>
    <id>https://renyb2.github.io/2022/05/10/OpenStack%E7%A0%94%E5%8F%91%EF%BC%9ACyborg/</id>
    <published>2022-05-10T06:00:18.000Z</published>
    <updated>2022-07-13T10:04:24.316Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Cyborg (previously known as <a href="https://wiki.openstack.org/wiki/Nomad">Nomad</a>) is an OpenStack project that aims to provide a general purpose management framework for acceleration resources (i.e. various types of accelerators such as GPU, FPGA, ASIC, NP, SoCs, NVMe/NOF SSDs, ODP, DPDK/SPDK and so on).</p><h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><h3 id="Cyborg内部架构"><a href="#Cyborg内部架构" class="headerlink" title="Cyborg内部架构"></a>Cyborg内部架构</h3><img src="/2022/05/10/OpenStack%E7%A0%94%E5%8F%91%EF%BC%9ACyborg/cyborg-architecture.png" alt="cyborg-architecture" style="zoom:100%;"><ul><li><strong>cyborg-api</strong> - cyborg-api is a cyborg service that provides <strong>REST API</strong> interface for the Cyborg project. It supports POST/PUT/DELETE/GET operations and interacts with cyborg-agent and cyborg-db via cyborg-conductor.</li><li><strong>cyborg-conductor</strong> - cyborg-conductor is a cyborg service that coordinates interaction, DB access between cyborg-api and cyborg-agent.</li><li><strong>cyborg-agent</strong> - cyborg-agent is a cyborg service that is responsible for interaction with accelerator backends via the Cyborg Driver. For now the only implementation in play is the Cyborg generic Driver. It will also handle the communication with the Nova placement service. Cyborg-Agent will also write to a local cache for local accelerator events.</li><li><strong>Vendor drivers</strong> - Cyborg can be integrated with drivers for various accelerator device types, such as FPGA, GPU, NIC, and so forth. You are welcome to extend your own driver for a new type of accelerator device.</li></ul><h3 id="加速资源使用架构"><a href="#加速资源使用架构" class="headerlink" title="加速资源使用架构"></a>加速资源使用架构</h3><img src="/2022/05/10/OpenStack%E7%A0%94%E5%8F%91%EF%BC%9ACyborg/cyborg-nova-interaction.png" alt="cyborg-nova-interaction" style="zoom:100%;"><h2 id="Blueprints-for-Cyborg"><a href="#Blueprints-for-Cyborg" class="headerlink" title="Blueprints for Cyborg"></a>Blueprints for Cyborg</h2><h3 id="Cyborg-API"><a href="#Cyborg-API" class="headerlink" title="Cyborg API"></a>Cyborg API</h3><p>This blueprint provides the initial design for the cyborg api. The cyborg api should support the basic operations concerning accelerators, and does not necessarily have to be user facing api at the early stage.</p><p>The api should support the following interfaces:</p><ul><li>attach: either attaching existing physical accelerators or creating new virtual functions and then allocating to the VM</li><li>detach: detaching existing physical accelerators or deallocating virtual functions for the VM</li><li>list: list all the attached accelerators</li><li>update: make modification to the accelerators (either the state or the device itself)</li><li>admin: for certain configurations that does not related to the resource centric CRUD operations.</li></ul><h3 id="Cyborg-Agent"><a href="#Cyborg-Agent" class="headerlink" title="Cyborg Agent"></a>Cyborg Agent</h3><p>The Cyborg agent will reside on compute hosts and potentially other hosts that may make use of accelerators.</p><p>Agent responsibilities:</p><ul><li>Inspect hardware to locate accelerators</li><li>Manage installing drivers, dependencies and other setup and teardown</li><li>Manage connecting the instance to the accelerator once it has spawned</li><li>Report data about available accelerators, status, and utilization to the Cyborg server</li></ul><p>Hardware Discovery:<br>The instance is scanned for accelerators and usage levels of existing accelerators every few seconds and this information is reported in a heartbeat message to the Cyborg server to help manage scheduling and availability.</p><p>Hardware Management:<br>Ansible will be used to manage configuration files and other setup for each accelerator and it’s driver. Setup and teardown playbooks will be made for each set of supported hardware. A configuration change on cyborg managed hardware will boil down to running the uninstall playbook and the install playbook with different configuration options.</p><p>Instance connection:<br>Once a instance is spawned that requires connecting to a specific accelerator on the host Cyborg server will send a message to Cyborg agent to inform the agent of the new instance. Since the connection method may change dramatically between different accelerators the driver should probably provide a connect function to call out to.</p><h2 id="Workflow"><a href="#Workflow" class="headerlink" title="Workflow"></a>Workflow</h2><h3 id="Cyborg-discovery-accelerates-device-workflow"><a href="#Cyborg-discovery-accelerates-device-workflow" class="headerlink" title="Cyborg discovery accelerates device workflow"></a>Cyborg discovery accelerates device workflow</h3><img src="/2022/05/10/OpenStack%E7%A0%94%E5%8F%91%EF%BC%9ACyborg/cyborg_acc_discover.drawio.png" alt="cyborg_acc_discover.drawio" style="zoom:100%;"><p>加速资源发现的工作流程如下：</p><ol><li>根据配置的驱动信息，调用指定驱动的<code>discover()</code>方法，后续流程以NVIDIA GPU驱动为例。</li><li>调用系统<code>lspci -nnn -D</code>命令，获取所有PCI设备。</li><li>根据<code>VENDOR_ID</code>及<code>GPU_TAG</code>匹配到GPU设备信息。</li><li>通过正则表达式，从命令行输出中提取并格式化关键信息。</li><li>根据配置文件中是否启用了vGPU，判断添加何种resource class与可用设备数量。</li><li>根据<code>VENDOR_ID</code>和<code>PRODUCT_ID</code>生成特定的traits。</li><li>实例化DriverDevice()。</li><li>返回实例化后的DriverDevice()对象，RPC方式发送给cyborg conductor，进行资源上报。</li></ol><h3 id="Cyborg-and-Nova-interaction-workflow"><a href="#Cyborg-and-Nova-interaction-workflow" class="headerlink" title="Cyborg and Nova interaction workflow"></a>Cyborg and Nova interaction workflow</h3><p>This flow is captured by the following sequence diagram, in which the Nova conductor and scheduler are together represented as the Nova controller.</p><img src="/2022/05/10/OpenStack%E7%A0%94%E5%8F%91%EF%BC%9ACyborg/cyborg-and-nova-interaction-workflow.png" alt="cyborg-and-nova-interaction-workflow" style="zoom:100%;"><p>A Cyborg client module is added to nova (cyborg-client-module). All Cyborg API calls are routed through that.</p><ol><li><p>The Nova API server receives a <code>POST /servers API</code> request with a flavor that includes a device profile name.</p></li><li><p>The Nova API server calls the Cyborg API <code>GET /v2/device_profiles?name=$device_profile_name</code> and gets back the device profile. The request groups in that device profile are added to the request spec.</p></li><li><p>The Nova scheduler invokes Placement and gets a list of allocation candidates. It selects one of those candidates and makes claim(s) in Placement. The Nova conductor then sends a RPC message <code>build_and_run_instances</code> to the Nova compute manager.</p></li><li><p>Nova conductor manager calls the Cyborg API <code>POST /v2/accelerator_requests</code> with the device profile name. Cyborg creates a set of unbound ARQs for that device profile and returns them to Nova.</p></li><li><p>The Cyborg client in Nova matches each ARQ to the resource provider picked for that accelerator.</p></li><li><p>The Nova compute manager calls the Cyborg API <code>PATCH /v2/accelerator_requests</code> to bind the ARQ with the host name, device’s RP UUID and instance UUID. This is an asynchronous call which prepares or reconfigures the device in the background.</p></li><li><p>Cyborg, on completion of the bindings (successfully or otherwise), calls Nova’s <code>POST /os-server-external-events</code> API with:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;events&quot;</span>: [</span><br><span class="line">        &#123; <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;accelerator-request-bound&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;tag&quot;</span>: $device_profile_name,</span><br><span class="line">            <span class="attr">&quot;server_uuid&quot;</span>: $instance_uuid,</span><br><span class="line">            <span class="attr">&quot;status&quot;</span>: <span class="string">&quot;completed&quot;</span> # or <span class="string">&quot;failed&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        ...</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>The Nova compute manager waits for the notification, subject to the timeout mentioned in Section Other deployer impact. It then calls the Cyborg REST API <code>GET /v2/accelerator_requests?instance=&lt;uuid&gt;&amp;bind_state=resolved</code>.</p></li><li><p>The Nova virt driver uses the attach handles returned from the Cyborg call to compose PCI passthrough devices into the VM’s definition.</p></li><li><p>If there is any error after binding has been initiated, Nova must unbind the relevant ARQs by calling Cyborg API. It may then retry on another host or delete the (unbound) ARQs for the instance.</p></li></ol><h3 id="Nova-allocate-mdevs"><a href="#Nova-allocate-mdevs" class="headerlink" title="Nova allocate mdevs"></a>Nova allocate mdevs</h3><p>Source Code：<a href="https://opendev.org/openstack/nova/src/branch/stable/victoria/nova/virt/libvirt/driver.py">(stable/victoria) Nova Compute Libvirt Driver - def _allocate_mdevs(self, allocations) </a></p><img src="/2022/05/10/OpenStack%E7%A0%94%E5%8F%91%EF%BC%9ACyborg/nova_allocate_mdevs.drawio.png" alt="nova_allocate_mdevs.drawio" style="zoom:100%;"><p>nova compute创建mdev设备的流程如下：</p><ol><li>整理出需要分配的vGPU信息。</li><li>判断需要分配的vGPU是否由同一个rp提供，目前仅支持从一个rp创建vGPU，若存在多个rp，则选取第一个。</li><li>从placement获取vGPU的rp详细信息。</li><li>从配置文件中获取当前支持的vGPU类型。</li><li>根据rp的device信息与支持的vGPU类型，获取可用的mdevs信息（所有的mdevs - 已分配的mdevs）。</li><li>若存在可用mdev设备，则直接pop弹出一个。</li><li>若不存在可用mdev设备，则调用<code>nova.privsep.libvirt.create_mdev()</code>，创建一个mdev设备。</li><li>分配mdev设备，直至数量等于需求值。</li></ol><p>代码<strong>PDB调试</strong>流程见下图：</p><img src="/2022/05/10/OpenStack%E7%A0%94%E5%8F%91%EF%BC%9ACyborg/pbd_allocate_mdevs_1.png" alt="pbd_allocate_mdevs_1" style="zoom:100%;"><img src="/2022/05/10/OpenStack%E7%A0%94%E5%8F%91%EF%BC%9ACyborg/pbd_allocate_mdevs_2.png" alt="pbd_allocate_mdevs_2" style="zoom:100%;"><img src="/2022/05/10/OpenStack%E7%A0%94%E5%8F%91%EF%BC%9ACyborg/pbd_allocate_mdevs_3.png" alt="pbd_allocate_mdevs_3" style="zoom:100%;"><img src="/2022/05/10/OpenStack%E7%A0%94%E5%8F%91%EF%BC%9ACyborg/pbd_allocate_mdevs_4.png" alt="pbd_allocate_mdevs_4" style="zoom:100%;"><h3 id="Accelerator-ARQ-state-flow-diagram"><a href="#Accelerator-ARQ-state-flow-diagram" class="headerlink" title="Accelerator ARQ state flow diagram"></a>Accelerator ARQ state flow diagram</h3><img src="/2022/05/10/OpenStack%E7%A0%94%E5%8F%91%EF%BC%9ACyborg/Accelerator-ARQ-States.drawio.png" alt="pbd_allocate_mdevs_4" style="zoom:100%;"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 状态流转范围</span></span><br><span class="line"><span class="comment"># cyborg/common/constants.py</span></span><br><span class="line">...</span><br><span class="line"><span class="comment"># TODO(Shaohe): maybe we can use oslo automaton lib</span></span><br><span class="line"><span class="comment"># ref: https://docs.openstack.org/automaton/latest/user/examples.html</span></span><br><span class="line"><span class="comment"># The states in value list can transfrom to the key state</span></span><br><span class="line">ARQ_STATES_TRANSFORM_MATRIX = &#123;</span><br><span class="line">    ARQ_INITIAL: [],</span><br><span class="line">    ARQ_BIND_STARTED: [ARQ_INITIAL, ARQ_UNBOUND],</span><br><span class="line">    ARQ_BOUND: [ARQ_BIND_STARTED],</span><br><span class="line">    ARQ_UNBOUND: [ARQ_INITIAL, ARQ_BIND_STARTED, ARQ_BOUND, ARQ_BIND_FAILED],</span><br><span class="line">    ARQ_BIND_FAILED: [ARQ_BIND_STARTED, ARQ_BOUND],</span><br><span class="line">    ARQ_DELETING: [ARQ_INITIAL, ARQ_BIND_STARTED, ARQ_BOUND,</span><br><span class="line">                   ARQ_UNBOUND, ARQ_BIND_FAILED]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># PS:</span></span><br><span class="line"><span class="comment"># 1. 除了Deleting状态，其余状态均可转为Unbound，但目前代码只有Bound状态可以流转为Unbound。</span></span><br><span class="line"><span class="comment"># 2. 所有状态均可流转为Deleting，但目前代码实现上删除操作未流转至Deleting，而是直接删除。</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 状态范围控制</span></span><br><span class="line"><span class="comment"># 参考：cyborg/objects/extarq/ext_arq_job.py &gt; start_bind_job()</span></span><br><span class="line"><span class="comment"># Check can ARC be bound.</span></span><br><span class="line"><span class="keyword">if</span> (self.arq.state <span class="keyword">not</span> <span class="keyword">in</span></span><br><span class="line">    ARQ_STATES_TRANSFORM_MATRIX[constants.ARQ_BIND_STARTED]):</span><br><span class="line"><span class="keyword">raise</span> exception.ARQInvalidState(state=self.arq.state)</span><br></pre></td></tr></table></figure><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://opendev.org/openstack/cyborg">OpenDev：openstack/cyborg</a></li><li><a href="https://wiki.openstack.org/wiki/Cyborg">OpenStack Wiki：Cyborg</a></li><li><a href="https://docs.openstack.org/cyborg/latest/user/architecture.html">OpenStack User Guide：Cyborg architecture</a></li><li><a href="https://docs.openstack.org/cyborg/latest/admin/index.html">OpenStack Admin Guide：Acceleration Service</a></li><li><a href="https://blueprints.launchpad.net/openstack-cyborg">Blueprints for Cyborg (OpenStack)</a></li><li><a href="https://wiki.openstack.org/wiki/Cyborg/TestReport/InspurFPGA">Cyborg/TestReport/InspurFPGA</a></li><li><a href="https://blog.csdn.net/wuyongpeng0912/article/details/113752165">nova实现vGPU功能</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Introduction&quot;&gt;&lt;a href=&quot;#Introduction&quot; class=&quot;headerlink&quot; title=&quot;Introduction&quot;&gt;&lt;/a&gt;Introduction&lt;/h2&gt;&lt;p&gt;Cyborg (previously known as &lt;a</summary>
      
    
    
    
    <category term="OpenStack" scheme="https://renyb2.github.io/categories/OpenStack/"/>
    
    
    <category term="OpenStack" scheme="https://renyb2.github.io/tags/OpenStack/"/>
    
    <category term="Accelerator" scheme="https://renyb2.github.io/tags/Accelerator/"/>
    
    <category term="Cyborg" scheme="https://renyb2.github.io/tags/Cyborg/"/>
    
  </entry>
  
  <entry>
    <title>消息队列：RabbitMQ</title>
    <link href="https://renyb2.github.io/2022/04/24/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9ARabbitMQ/"/>
    <id>https://renyb2.github.io/2022/04/24/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9ARabbitMQ/</id>
    <published>2022-04-24T09:55:54.000Z</published>
    <updated>2022-05-10T07:02:35.498Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Hello-world"><a href="#Hello-world" class="headerlink" title="Hello world"></a>Hello world</h2><p>参考<a href="https://www.rabbitmq.com/tutorials/tutorial-one-python.html">官方代码示例</a></p><h3 id="Producer示例"><a href="#Producer示例" class="headerlink" title="Producer示例"></a>Producer示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pika</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">username = <span class="string">&#x27;glance-rabbitmq-user&#x27;</span></span><br><span class="line">password = <span class="string">&#x27;glancepFAlXGtyZc7lTi0*&#x27;</span></span><br><span class="line">host = <span class="string">&#x27;osh-openstack-rabbitmq-rabbitmq-0.rabbitmq.openstack.svc.cluster.local&#x27;</span></span><br><span class="line">port = <span class="number">5672</span></span><br><span class="line">vhost = <span class="string">&#x27;glance&#x27;</span></span><br><span class="line">exchange = <span class="string">&#x27;demo&#x27;</span></span><br><span class="line"></span><br><span class="line">credentials = pika.PlainCredentials(username, password)</span><br><span class="line">connection = pika.BlockingConnection(</span><br><span class="line">    pika.ConnectionParameters(</span><br><span class="line">        host=host, port=port, virtual_host=vhost, credentials=credentials))</span><br><span class="line">channel = connection.channel()</span><br><span class="line">channel.exchange_declare(exchange=exchange, durable=<span class="literal">True</span>, exchange_type=<span class="string">&#x27;fanout&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    msg=json.dumps(&#123;<span class="string">&#x27;OrderId&#x27;</span>:<span class="string">&quot;1000%s&quot;</span>%i&#125;)</span><br><span class="line">    channel.basic_publish(exchange=exchange, routing_key=<span class="string">&#x27;&#x27;</span>, body=msg,</span><br><span class="line">                          properties=pika.BasicProperties(delivery_mode=<span class="number">2</span>))</span><br><span class="line">    print(msg)</span><br><span class="line"></span><br><span class="line">connection.close()</span><br></pre></td></tr></table></figure><h3 id="Consumer示例"><a href="#Consumer示例" class="headerlink" title="Consumer示例"></a>Consumer示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pika</span><br><span class="line"></span><br><span class="line">username = <span class="string">&#x27;glance-rabbitmq-user&#x27;</span></span><br><span class="line">password = <span class="string">&#x27;glancepFAlXGtyZc7lTi0*&#x27;</span></span><br><span class="line">host = <span class="string">&#x27;osh-openstack-rabbitmq-rabbitmq-0.rabbitmq.openstack.svc.cluster.local&#x27;</span></span><br><span class="line">port = <span class="number">5672</span></span><br><span class="line">vhost = <span class="string">&#x27;glance&#x27;</span></span><br><span class="line">exchange = <span class="string">&#x27;demo&#x27;</span></span><br><span class="line"></span><br><span class="line">credentials = pika.PlainCredentials(username, password)</span><br><span class="line">connection = pika.BlockingConnection(</span><br><span class="line">    pika.ConnectionParameters(</span><br><span class="line">        host=host, port=port, virtual_host=vhost, credentials=credentials))</span><br><span class="line">channel = connection.channel()</span><br><span class="line">result = channel.queue_declare(<span class="string">&#x27;&#x27;</span>, exclusive=<span class="literal">True</span>)</span><br><span class="line">channel.exchange_declare(exchange=exchange, durable=<span class="literal">True</span>, exchange_type=<span class="string">&#x27;fanout&#x27;</span>)</span><br><span class="line">channel.queue_bind(exchange=exchange, queue=result.method.queue)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span>(<span class="params">ch, method, properties, body</span>):</span></span><br><span class="line">    ch.basic_ack(delivery_tag=method.delivery_tag)</span><br><span class="line">    print(body.decode())</span><br><span class="line"></span><br><span class="line">channel.basic_consume(result.method.queue, callback, auto_ack=<span class="literal">False</span>)</span><br><span class="line">channel.start_consuming()</span><br></pre></td></tr></table></figure><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://www.rabbitmq.com/tutorials/tutorial-one-python.html">RabbitMQ官方代码示例</a></li><li><a href="https://www.cnblogs.com/guyuyun/p/14970592.html">Python三方库：Pika（RabbitMQ基础使用）</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Hello-world&quot;&gt;&lt;a href=&quot;#Hello-world&quot; class=&quot;headerlink&quot; title=&quot;Hello world&quot;&gt;&lt;/a&gt;Hello world&lt;/h2&gt;&lt;p&gt;参考&lt;a href=&quot;https://www.rabbitmq.co</summary>
      
    
    
    
    <category term="消息队列" scheme="https://renyb2.github.io/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    
    
    <category term="RabbitMQ" scheme="https://renyb2.github.io/tags/RabbitMQ/"/>
    
  </entry>
  
  <entry>
    <title>消息队列：ActiveMQ</title>
    <link href="https://renyb2.github.io/2022/04/24/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9AActiveMQ/"/>
    <id>https://renyb2.github.io/2022/04/24/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%9AActiveMQ/</id>
    <published>2022-04-24T06:27:40.000Z</published>
    <updated>2022-04-24T09:34:24.295Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Apache ActiveMQ is an open-source message broker written in Java. It supports several cross-language clients and protocols.</p><p>The Apache ActiveMQ message broker is a fast, reliable, scalable, and totally integrated open source messaging platform for handling lots of messages (ingest) or lots of consumers (dispatch). It uses memory as the storage format; it can be configured to store data persistently on a disk if necessary. The initial startup time can be slow due to the fact that ActiveMQ will load all historical information into memory. However, after the first startup period, which could take up to several minutes depending on how much history you have stored in your queues and other configuration settings, performance starts to scale well up until a point when we consider other factors such as system resources.</p><p>Based on its origins as an experience of just moving from an in-house messaging solution to a commercial product, ActiveMQ can be considered as one of those products that have been constantly developed and improved, offering extremely high quality and solid stability.</p><p>ActiveMQ provides both a simple embedded broker and a fully deployed, highly available enterprise solution. Its most important features and strengths are high availability and failover (a setup with one broker can survive up to 99.999% of message loss), support for many ways of connecting clients (including web consoles, command-line tools, and libraries, JMS client libraries, etc.), clustering across physical boundaries, load balancing through multiple internal queues per topic, flexible configuration such as persistent or non-persistent messages according to the need, the persistence of data by file or database, security implementation based on JAAS authentication model which also supports LDAP implementation.</p><p>ActiveMQ is truly the preferred messaging solution for Java developers, infrastructure architects, and system integrators. It can be used in both small deployments (in which case you will probably use the embedded broker) or big enterprise solutions (which require clustering and failover).</p><p>Depending on your needs, ActiveMQ can be easily scaled out to real high availability scenarios with full load balancing across all brokers, including dynamic addition of new nodes when existing ones go down; stateful failover with automatic re-sync and potential data loss (which is always possible), fully supported by ActiveMQ itself: just another two nodes that need to be configured into a cluster for high availability.</p><p>Apache ActiveMQ is cross-platform and runs in a Java Virtual Machine (JVM). You could use ActiveMQ on either Linux, Windows, or OS X.</p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="Ubuntu系统"><a href="#Ubuntu系统" class="headerlink" title="Ubuntu系统"></a>Ubuntu系统</h3><h4 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h4><ul><li><strong>规格：</strong>4C8G，100G数据盘</li><li><strong>系统：</strong>20.04.3 LTS (GNU/Linux 5.4.0-107-generic x86_64)</li><li><strong>PostgreSQL版本：</strong>PostgreSQL 9.5.25</li></ul><blockquote><p><strong>Pre-Installation Requirements</strong></p><p><strong>Hardware:</strong></p><ul><li>60 MB of free disk space for the ActiveMQ binary distribution.</li><li>200 MB of free disk space for the ActiveMQ source or developer’s distributions.</li></ul><p><strong>Operating Systems:</strong></p><ul><li>Windows: Windows XP SP2, Windows 2000.</li><li>Unix: Ubuntu Linux, Powerdog Linux, MacOS, AIX, HP-UX, Solaris, or any Unix platform that supports Java.</li></ul><p><strong>Environment:</strong></p><ul><li>Java Developer Kit (JDK) 1.7.x or greater for deployment and 1.7.x (Java 7) for compiling/building.</li><li>The JAVA_HOME environment variable must be set to the directory where the JDK is installed, e.g., <code>c:\Program Files\jdk.1.7.0_xx_xx</code>.</li><li>Maven 3.0 or greater (required when installing source or developer’s releases).</li><li><a href="http://cvs.apache.org/repository/geronimo-spec/jars/">JARs</a> that will be used must be added to the classpath.</li></ul></blockquote><h4 id="安装流程"><a href="#安装流程" class="headerlink" title="安装流程"></a>安装流程</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装基础依赖包</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt install openjdk-8-jdk</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载资源包</span></span><br><span class="line">sudo wget http://www.apache.org/dist/activemq/5.16.4/apache-activemq-5.16.4-bin.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 解压资源包</span></span><br><span class="line">sudo tar zxvf apache-activemq-*gz -C /opt/ </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建服务用户</span></span><br><span class="line">sudo addgroup --quiet --system activemq</span><br><span class="line">sudo adduser --quiet --system --ingroup activemq --no-create-home --disabled-password activemq</span><br><span class="line">sudo chown -R activemq:activemq /opt/apache-activemq*</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建systemctl服务</span></span><br><span class="line">ACTIVEMQ_DIR=$(cd /opt/apache-activemq* &amp;&amp; pwd)</span><br><span class="line">cat &gt; /usr/lib/systemd/system/activemq.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Apache ActiveMQ</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">User=activemq</span><br><span class="line">Group=activemq</span><br><span class="line">ExecStart=$&#123;ACTIVEMQ_DIR&#125;/bin/activemq start</span><br><span class="line">ExecStop=$&#123;ACTIVEMQ_DIR&#125;/bin/activemq stop</span><br><span class="line">ExecRestart=$&#123;ACTIVEMQ_DIR&#125;/bin/activemq stop : $&#123;ACTIVEMQ_DIR&#125;/bin/activemq start</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动服务</span></span><br><span class="line">sudo systemctl start activemq</span><br><span class="line">sudo systemctl status activemq</span><br></pre></td></tr></table></figure><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://activemq.apache.org/components/classic/documentation">官方文档：ActiveMQ 5 Documentation</a></li><li><a href="https://activemq.apache.org/version-5-getting-started">官方文档：Version 5 Getting Started</a></li><li><a href="https://vitux.com/how-to-install-apache-activemq-on-ubuntu/">How to Install Apache ActiveMQ on Ubuntu 20.04</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;Apache ActiveMQ is an open-source message broker written in Java. It s</summary>
      
    
    
    
    <category term="消息队列" scheme="https://renyb2.github.io/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    
    
    <category term="ActiveMQ" scheme="https://renyb2.github.io/tags/ActiveMQ/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQL部署：安装文档</title>
    <link href="https://renyb2.github.io/2022/04/24/PostgreSQL%E9%83%A8%E7%BD%B2%EF%BC%9A%E5%AE%89%E8%A3%85%E6%96%87%E6%A1%A3/"/>
    <id>https://renyb2.github.io/2022/04/24/PostgreSQL%E9%83%A8%E7%BD%B2%EF%BC%9A%E5%AE%89%E8%A3%85%E6%96%87%E6%A1%A3/</id>
    <published>2022-04-24T03:19:42.000Z</published>
    <updated>2022-04-24T07:50:07.303Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>PostgreSQL 是一个免费的对象-关系数据库服务器(ORDBMS)，在灵活的BSD许可证下发行。</p><p>PostgreSQL 开发者把它念作 <strong>post-gress-Q-L</strong>。</p><p>PostgreSQL 的 Slogan 是 “世界上最先进的开源关系型数据库”。</p><p>最新中文文档可参考：<a href="https://github.com/postgres-cn/pgdoc-cn/releases">官方手册</a></p><h2 id="特征"><a href="#特征" class="headerlink" title="特征"></a>特征</h2><ul><li><strong>函数</strong>：通过函数，可以在数据库服务器端执行指令程序。</li><li><strong>索引</strong>：用户可以自定义索引方法，或使用内置的 B 树，哈希表与 GiST 索引。</li><li><strong>触发器</strong>：触发器是由SQL语句查询所触发的事件。如：一个INSERT语句可能触发一个检查数据完整性的触发器。触发器通常由INSERT或UPDATE语句触发。 多版本并发控制：PostgreSQL使用多版本并发控制（MVCC，Multiversion concurrency control）系统进行并发控制，该系统向每个用户提供了一个数据库的”快照”，用户在事务内所作的每个修改，对于其他的用户都不可见，直到该事务成功提交。</li><li><strong>规则</strong>：规则（RULE）允许一个查询能被重写，通常用来实现对视图（VIEW）的操作，如插入（INSERT）、更新（UPDATE）、删除（DELETE）。</li><li><strong>数据类型</strong>：包括文本、任意精度的数值数组、JSON 数据、枚举类型、XML 数据等。</li><li><strong>全文检索</strong>：通过 Tsearch2 或 OpenFTS，8.3版本中内嵌 Tsearch2。</li><li><strong>NoSQL</strong>：JSON，JSONB，XML，HStore 原生支持，至 NoSQL 数据库的外部数据包装器。</li><li><strong>数据仓库</strong>：能平滑迁移至同属 PostgreSQL 生态的 GreenPlum，DeepGreen，HAWK 等，使用 FDW 进行 ETL。</li></ul><h2 id="Ubuntu系统"><a href="#Ubuntu系统" class="headerlink" title="Ubuntu系统"></a>Ubuntu系统</h2><h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><ul><li><strong>规格：</strong>4C8G，100G数据盘</li><li><strong>系统：</strong>Ubuntu 16.04.7 LTS</li><li><strong>PostgreSQL版本：</strong>PostgreSQL 9.5.25</li></ul><h3 id="安装流程"><a href="#安装流程" class="headerlink" title="安装流程"></a>安装流程</h3><p>Ubuntu 可以使用 apt-get 安装 PostgreSQL：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get update</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install postgresql postgresql-client</span></span><br></pre></td></tr></table></figure><p>安装完毕后，系统会创建一个数据库超级用户 postgres，密码为空。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo -i -u postgres</span></span><br></pre></td></tr></table></figure><p>这时使用以下命令进入 postgres，输出以下信息，说明安装成功：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ psql</span><br><span class="line">psql (9.5.17)</span><br><span class="line">Type &quot;<span class="keyword">help</span><span class="string">&quot; for help.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">postgres=# </span></span><br></pre></td></tr></table></figure><p>输入以下命令退出 PostgreSQL 提示符：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\q</span><br></pre></td></tr></table></figure><p>PostgreSQL 安装完成后默认是已经启动的，但是也可以通过下面的方式来手动启动服务。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo /etc/init.d/postgresql start    <span class="comment"># 开启</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo /etc/init.d/postgresql stop     <span class="comment"># 关闭</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo /etc/init.d/postgresql restart  <span class="comment"># 重启</span></span></span><br></pre></td></tr></table></figure><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://www.postgresql.org/">PostgreSQL官网</a></li><li><a href="https://github.com/postgres-cn/pgdoc-cn/releases">PostgreSQL 官方：中文手册</a></li><li><a href="https://www.runoob.com/postgresql/postgresql-tutorial.html">菜鸟教程：PostgreSQL 教程</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;PostgreSQL 是一个免费的对象-关系数据库服务器(ORDBMS)，在灵活的BSD许可证下发行。&lt;/p&gt;
&lt;p&gt;PostgreSQL </summary>
      
    
    
    
    <category term="数据库" scheme="https://renyb2.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
    <category term="PostgreSQL" scheme="https://renyb2.github.io/tags/PostgreSQL/"/>
    
  </entry>
  
  <entry>
    <title>研发工具：Jupyter</title>
    <link href="https://renyb2.github.io/2022/04/14/%E7%A0%94%E5%8F%91%E5%B7%A5%E5%85%B7%EF%BC%9AJupyter/"/>
    <id>https://renyb2.github.io/2022/04/14/%E7%A0%94%E5%8F%91%E5%B7%A5%E5%85%B7%EF%BC%9AJupyter/</id>
    <published>2022-04-14T05:43:41.000Z</published>
    <updated>2022-04-24T03:24:12.741Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Free software, open standards, and web services for interactive computing across all programming languages</p><blockquote><h3 id="JupyterLab-A-Next-Generation-Notebook-Interface"><a href="#JupyterLab-A-Next-Generation-Notebook-Interface" class="headerlink" title="JupyterLab: A Next-Generation Notebook Interface"></a>JupyterLab: A Next-Generation Notebook Interface</h3><p>JupyterLab is the latest web-based interactive development environment for notebooks, code, and data. Its flexible interface allows users to configure and arrange workflows in data science, scientific computing, computational journalism, and machine learning. A modular design invites extensions to expand and enrich functionality.</p><h3 id="Jupyter-Notebook-The-Classic-Notebook-Interface"><a href="#Jupyter-Notebook-The-Classic-Notebook-Interface" class="headerlink" title="Jupyter Notebook: The Classic Notebook Interface"></a>Jupyter Notebook: The Classic Notebook Interface</h3><p>The Jupyter Notebook is the original web application for creating and sharing computational documents. It offers a simple, streamlined, document-centric experience.</p></blockquote><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装基础包</span></span><br><span class="line">yum install -y gcc python3</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建数据目录</span></span><br><span class="line">mkdir /usr/local/jupyter</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装Jupyter</span></span><br><span class="line">pip3 install --upgrade pip</span><br><span class="line">pip3 install jupyter jupyterlab</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 运行Jupyter Lab</span></span><br><span class="line">jupyter lab --ip 0.0.0.0 --allow-root --notebook-dir=/usr/local/jupyter</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 运行Jupyter Notebook</span></span><br><span class="line">jupyter notebook --ip 0.0.0.0 --allow-root --notebook-dir=/usr/local/jupyter</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看访问信息</span></span><br><span class="line">jupyter lab list</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置systemctl</span></span><br><span class="line">cat &gt; /usr/lib/systemd/system/jupyter.service &lt;&lt; EOF </span><br><span class="line">[Unit]</span><br><span class="line">Description=Jupyter Service</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=root</span><br><span class="line">Group=root</span><br><span class="line">KillMode=mixed</span><br><span class="line">Restart=always</span><br><span class="line"></span><br><span class="line">ExecStart=/usr/local/bin/jupyter lab --ip 0.0.0.0 --allow-root --notebook-dir=/usr/local/jupyter</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>Web访问地址：<code>http://&lt;ip&gt;:8888/?token=&lt;token&gt;</code>,点击<code>Python</code>即可开始编写。测试代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> matplotlib <span class="keyword">as</span> mpl</span><br><span class="line"></span><br><span class="line">th = np.linspace(<span class="number">0</span>, <span class="number">2</span>*np.pi, <span class="number">128</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">demo</span>(<span class="params">sty</span>):</span></span><br><span class="line">    mpl.style.use(sty)</span><br><span class="line">    fig, ax = plt.subplots(figsize=(<span class="number">3</span>, <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">    ax.set_title(<span class="string">&#x27;style: &#123;!r&#125;&#x27;</span>.format(sty), color=<span class="string">&#x27;C0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    ax.plot(th, np.cos(th), <span class="string">&#x27;C1&#x27;</span>, label=<span class="string">&#x27;C1&#x27;</span>)</span><br><span class="line">    ax.plot(th, np.sin(th), <span class="string">&#x27;C2&#x27;</span>, label=<span class="string">&#x27;C2&#x27;</span>)</span><br><span class="line">    ax.legend()</span><br><span class="line"></span><br><span class="line">demo(<span class="string">&#x27;seaborn&#x27;</span>)</span><br></pre></td></tr></table></figure><p><img src="/2022/04/14/%E7%A0%94%E5%8F%91%E5%B7%A5%E5%85%B7%EF%BC%9AJupyter/%E6%BC%94%E7%A4%BA1.png" alt="演示1"></p><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://jupyter.org/">Jupyter官网</a></li><li><a href="https://zhuanlan.zhihu.com/p/33105153">Jupyter Notebook介绍、安装及使用教程</a></li><li><a href="https://zhuanlan.zhihu.com/p/87403131">JupyterLab，极其强大的下一代notebook！</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;Free software, open standards, and web services for interactive comput</summary>
      
    
    
    
    <category term="研发工具" scheme="https://renyb2.github.io/categories/%E7%A0%94%E5%8F%91%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="研发工具" scheme="https://renyb2.github.io/tags/%E7%A0%94%E5%8F%91%E5%B7%A5%E5%85%B7/"/>
    
    <category term="Jupyter" scheme="https://renyb2.github.io/tags/Jupyter/"/>
    
  </entry>
  
  <entry>
    <title>OpenStack研发：Nova与Cyborg交互流程研究</title>
    <link href="https://renyb2.github.io/2022/04/13/OpenStack%E7%A0%94%E5%8F%91%EF%BC%9ANova%E4%B8%8ECyborg%E4%BA%A4%E4%BA%92%E6%B5%81%E7%A8%8B%E7%A0%94%E7%A9%B6/"/>
    <id>https://renyb2.github.io/2022/04/13/OpenStack%E7%A0%94%E5%8F%91%EF%BC%9ANova%E4%B8%8ECyborg%E4%BA%A4%E4%BA%92%E6%B5%81%E7%A8%8B%E7%A0%94%E7%A9%B6/</id>
    <published>2022-04-13T05:45:59.000Z</published>
    <updated>2022-05-23T07:42:59.316Z</updated>
    
    <content type="html"><![CDATA[<p>本文只研究含有加速资源的虚机在生命周期管理的流程，即深挖<code>Nova</code>与<code>Cyborg</code>组件之间的交互流程，对<code>Nova</code>与其余组件的交互并不做详细展开，有兴趣可以对代码中具体函数进行深入分析。</p><h2 id="组件版本"><a href="#组件版本" class="headerlink" title="组件版本"></a>组件版本</h2><ul><li>Nova：22.4.0（Victoria）</li><li>Cyborg： 5.0.1（Victoria）</li><li>Placement：4.0.0（Victoria）</li></ul><h2 id="社区支持情况"><a href="#社区支持情况" class="headerlink" title="社区支持情况"></a>社区支持情况</h2><blockquote><p>Nova supports only specific operations for instances with accelerators. The lists of supported and unsupported operations are as below:</p><ul><li>Supported operations.<ul><li>Creation and deletion.</li><li>Reboots (soft and hard).</li><li>Pause and unpause.</li><li>Stop and start.</li><li>Take a snapshot.</li><li>Backup.</li><li>Rescue and unrescue.</li><li>Rebuild.</li><li>Evacuate.</li><li>Shelve and unshelve.</li></ul></li><li>Unsupported operations<ul><li>Resize.</li><li>Suspend and resume.</li><li>Cold migration.</li><li>Live migration.</li></ul></li></ul><p>Changed in version 22.0.0(Victoria): Added support for rebuild and evacuate operations.</p><p>Changed in version 23.0.0(Wallaby): Added support for shelve and unshelve operations.</p></blockquote><h2 id="加速资源虚机创建"><a href="#加速资源虚机创建" class="headerlink" title="加速资源虚机创建"></a>加速资源虚机创建</h2><h3 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h3><p><img src="/2022/04/13/OpenStack%E7%A0%94%E5%8F%91%EF%BC%9ANova%E4%B8%8ECyborg%E4%BA%A4%E4%BA%92%E6%B5%81%E7%A8%8B%E7%A0%94%E7%A9%B6/%E5%8A%A0%E9%80%9F%E8%B5%84%E6%BA%90%E8%99%9A%E6%9C%BA%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B.drawio.png" alt="加速资源虚机创建流程.drawio"></p><h3 id="各模块作用"><a href="#各模块作用" class="headerlink" title="各模块作用"></a>各模块作用</h3><ul><li><strong>Nova API：</strong>响应创建虚机请求，调用conductor进行创建虚机处理。</li><li><strong>Nova Conductor：</strong>先调用Nova Scheduler选择计算节点，其次向Cyborg发起请求，绑定该节点instance uuid与resource provider，最后调用Nova Computer在指定计算节点创建虚机。</li><li><strong>Cyborg API：</strong>响应Nova Conductor请求，调用Cyborg Conductor创建并绑定ARQ。</li><li><strong>Cyborg Conductor：</strong>负责创建并绑定ARQ，数据库层面操作。（Cyborg agent仅处理FPGA烧录及资源发现操作。）</li><li><strong>Nova Computer：</strong>寻找可用的加速资源设备，若没有现成的则创建一个，生成xml并孵化虚机。</li></ul><h3 id="代码调用关系"><a href="#代码调用关系" class="headerlink" title="代码调用关系"></a>代码调用关系</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##############################</span></span><br><span class="line"><span class="comment">## nova api</span></span><br><span class="line"><span class="comment">##############################</span></span><br><span class="line"><span class="comment"># 1. nova.api.openstack.coumpute.servers</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, req, body</span>):</span></span><br><span class="line">    -&gt; (instances, resv_id) = self.compute_api.create(context, *</span><br><span class="line"><span class="comment"># 2. nova.compute.api</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, context, instance_type, *</span></span></span><br><span class="line"><span class="function"><span class="params">    -&gt; self._create_instance(<span class="params"> *</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">def _create_instance(<span class="params">self, context, instance_type, *</span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params">    -&gt; self.compute_task_api.schedule_and_build_instances(<span class="params"> *</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment">##############################</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment">## nova api -&gt; nova conductor</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment">##############################</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment"># 3. nova.conductor.manager</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params">def schedule_and_build_instances(<span class="params">self, context, build_requests, *</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; host_lists = self._schedule_instances(<span class="params">context, request_specs[<span class="number">0</span>], *</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; accel_uuids = self._create_and_bind_arq_for_instance(<span class="params"> *</span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; self.compute_rpcapi.build_and_run_instance(<span class="params"> *</span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment">##############################</span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment">## nova conductor -&gt; nova scheduler</span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment">##############################</span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment"># 4. nova.scheduler.manager</span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def select_destinations(<span class="params">self, ctxt, request_spec=None, *</span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment">##############################</span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment">## nova conductor -&gt; cyborg api</span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment">##############################</span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment"># 5. nova.conductor.manager</span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def _create_and_bind_arq_for_instance(<span class="params">self, context, instance, host, *</span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; return self._create_and_bind_arqs(<span class="params"> *</span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def _create_and_bind_arqs(<span class="params">self, context, instance_uuid, extra_specs, *</span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; arqs = cyclient.create_arqs_and_match_resource_providers(<span class="params"> *</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; cyclient.bind_arqs(<span class="params">bindings=bindings</span>)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment"># 6. nova.accelerator.cyborg</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def create_arqs_and_match_resource_providers(<span class="params">self, dp_name, rg_rp_map</span>):</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; arqs = self._create_arqs(<span class="params">dp_name</span>)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def _create_arqs(<span class="params">self, dp_name</span>):</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; resp, err_msg = self._call_cyborg(<span class="params">self._client.post, *</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def bind_arqs(<span class="params">self, bindings</span>):</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; resp, err_msg = self._call_cyborg(<span class="params">self._client.patch, *</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment">## Part 1: _create_arqs()</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment"># 7. cyborg.api.controllers.v2.arqs</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">@authorize_wsgi.authorize_wsgi(<span class="params"><span class="string">&quot;cyborg:arq&quot;</span>, <span class="string">&quot;create&quot;</span>, False</span>)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def post(<span class="params">self, req</span>):</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">       obj_extarq = objects.ExtARQ(<span class="params">context, **extarq_fields</span>)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; new_extarq = pecan.request.conductor_api.arq_create(<span class="params"> *</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment"># 8. cyborg.conductor.manager</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def arq_create(<span class="params">self, context, obj_extarq, devprof_id</span>):</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; obj_extarq.create(<span class="params">context, devprof_id</span>)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment"># 9. cyborg.objects.ext_arq</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def create(<span class="params">self, context, device_profile_id=None</span>):</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; db_extarq = self.dbapi.extarq_create(<span class="params">context, values</span>)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment"># 10. cyborg.db.sqlalchemy.api</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def extarq_create(<span class="params">self, context, values</span>):</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment">## Part 2: bind_arqs()</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment"># 11. cyborg.api.controllers.v2.arqs</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">@authorize_wsgi.authorize_wsgi(<span class="params"><span class="string">&quot;cyborg:arq&quot;</span>, <span class="string">&quot;update&quot;</span>, False</span>)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def patch(<span class="params">self, patch_list</span>):</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; objects.ExtARQ.apply_patch(<span class="params">context, patch_list, valid_fields</span>)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment"># 12. cyborg.objects.extarq.ext_arq_job</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def apply_patch(<span class="params">cls, context, patch_list, valid_fields</span>):</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; job = extarq.start_bind_job(<span class="params">context, valid_fields</span>)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def start_bind_job(<span class="params">self, context, valid_fields</span>):</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; return self._bind_job(<span class="params">context, dep</span>)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def _bind_job(<span class="params">self, context, deployable</span>):</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; self.bind(<span class="params">context, deployable</span>)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment"># 13. cyborg.objects.ext_arq</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def bind(<span class="params">self, context, deployable</span>):</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; self._allocate_attach_handle(<span class="params">context, deployable</span>)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; self.update_check_state(<span class="params">context, constants.ARQ_BOUND</span>)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def _allocate_attach_handle(<span class="params">self, context, deployable</span>):</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; ah = AttachHandle.allocate(<span class="params">context, deployable.id</span>)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment"># 14. cyborg.objects.attach_handle</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def allocate(<span class="params">cls, context, deployable_id</span>):</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; db_ah = cls.dbapi.attach_handle_allocate(<span class="params">context, deployable_id</span>)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment"># 15. cyborg.db.sqlalchemy.api</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def attach_handle_allocate(<span class="params">self, context, deployable_id</span>):</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; ah = self._do_allocate_attach_handle(<span class="params"> *</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def _do_allocate_attach_handle(<span class="params">self, context, deployable_id</span>):</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment">##############################</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment">## nova conductor -&gt; nova compute</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment">##############################</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment"># 16. nova.compute.manager</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def build_and_run_instance(<span class="params">self, context, instance, image, request_spec, *</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; result = self._do_build_and_run_instance(<span class="params">*args, **kwargs</span>)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment"># 17. nova.compute.manager</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def _do_build_and_run_instance(<span class="params">self, context, instance, image, *</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; self._build_and_run_instance(<span class="params">context, instance, image, *</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment"># 18. nova.compute.manager</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def _build_and_run_instance(<span class="params">self, context, instance, image, injected_files, *</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; with self._build_resources(<span class="params">context, instance, *</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; self.driver.spawn(<span class="params">context, instance, image_meta, *</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment"># 19. nova.compute.manager</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def _build_resources(<span class="params">self, context, instance, requested_networks, *</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; arqs = self._get_bound_arq_resources(<span class="params"> *</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def _get_bound_arq_resources(<span class="params">self, context, instance, arq_uuids</span>):</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; return arqs</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="comment"># 20. nova.virt.libvirt.driver</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def spawn(<span class="params">self, context, instance, image_meta, injected_files,</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; mdevs = self._allocate_mdevs(<span class="params">allocations</span>)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; self._create_guest_with_network(<span class="params"></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def _allocate_mdevs(<span class="params">self, allocations</span>):</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; mdevs_available = self._get_existing_mdevs_not_assigned(<span class="params"> *</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; chosen_mdev = self._create_new_mediated_device(<span class="params">parent_device</span>)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; return chosen_mdevs</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def _create_guest_with_network(<span class="params">self, context, xml, instance, network_info, *</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; guest = self._create_guest(<span class="params"> *</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def _create_guest(<span class="params"> *</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; guest = libvirt_guest.Guest.create(<span class="params">xml, self._host</span>)</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br></pre></td></tr></table></figure><h2 id="加速资源虚机删除"><a href="#加速资源虚机删除" class="headerlink" title="加速资源虚机删除"></a>加速资源虚机删除</h2><h3 id="各模块作用-1"><a href="#各模块作用-1" class="headerlink" title="各模块作用"></a>各模块作用</h3><ul><li><strong>Nova API：</strong>响应删除虚机请求，根据虚机不同状态做出相应的处理：<ul><li>虚机正常：先释放各类资源，然后调用其宿主机节点的nova compute组件进行删除操作。</li></ul></li><li><strong>Cyborg API：</strong>响应Nova API请求，调用Cyborg Conductor解绑并删除ARQ。</li><li><strong>Cyborg Conductor：</strong>负责解绑并删除ARQ，数据库层面操作。</li><li><strong>Nova Computer：</strong>删除虚机，不删除已创建的vGPU资源。</li></ul><h3 id="代码调用关系-1"><a href="#代码调用关系-1" class="headerlink" title="代码调用关系"></a>代码调用关系</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##############################</span></span><br><span class="line"><span class="comment">## nova api</span></span><br><span class="line"><span class="comment">##############################</span></span><br><span class="line"><span class="comment"># 1. nova.api.openstack.coumpute.servers</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self, req, id</span>):</span></span><br><span class="line">    -&gt; self._delete(req.environ[&#x27;nova.context&#x27;], req, id)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_delete</span>(<span class="params">self, context, req, instance_uuid</span>):</span></span><br><span class="line">    -&gt; self.compute_api.delete(context, instance)</span><br><span class="line"><span class="comment"># 2. nova.compute.api</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self, context, instance</span>):</span></span><br><span class="line">    -&gt; self._delete_instance(context, instance)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_delete_instance</span>(<span class="params">self, context, instance</span>):</span></span><br><span class="line">    -&gt; self._delete(context, instance, &#x27;delete&#x27;, self._do_delete, *</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_delete</span>(<span class="params">self, context, instance, delete_type, cb, **instance_attrs</span>):</span></span><br><span class="line">    -&gt; self._local_delete(cctxt, instance, bdms, delete_type, cb)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_local_delete</span>(<span class="params">self, context, instance, bdms, delete_type, cb</span>):</span></span><br><span class="line">    -&gt; compute_utils.delete_arqs_if_needed(context, instance)</span><br><span class="line">    -&gt; cb(context, instance, bdms, local=True)</span><br><span class="line"></span><br><span class="line"><span class="comment">##############################</span></span><br><span class="line"><span class="comment">## nova api -&gt; cyborg api</span></span><br><span class="line"><span class="comment">##############################</span></span><br><span class="line"><span class="comment"># 3. nova.compute.utils</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_arqs_if_needed</span>(<span class="params">context, instance</span>):</span></span><br><span class="line">    -&gt; cyclient.delete_arqs_for_instance(instance.uuid)</span><br><span class="line"><span class="comment"># 4. nova.accelerator.cyborg</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_arqs_for_instance</span>(<span class="params">self, instance_uuid</span>):</span></span><br><span class="line">    -&gt; resp, err_msg = self._call_cyborg(self._client.delete, *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. cyborg.api.controllers.v2.arqs</span></span><br><span class="line"><span class="meta">@authorize_wsgi.authorize_wsgi(&quot;cyborg:arq&quot;, &quot;delete&quot;, False)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self, arqs=None, instance=None</span>):</span></span><br><span class="line">    -&gt; pecan.request.conductor_api.arq_delete_by_instance_uuid( *</span><br><span class="line"><span class="comment"># 6. cyborg.conductor.manager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">arq_delete_by_instance_uuid</span>(<span class="params">self, context, instance</span>):</span></span><br><span class="line">    -&gt; ExtARQ.delete_by_instance(context, instance)</span><br><span class="line"><span class="comment"># 7. cyborg.objects.ext_arq</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_by_instance</span>(<span class="params">cls, context, instance_uuid</span>):</span></span><br><span class="line">    -&gt; obj_extarq.unbind(context)</span><br><span class="line">    -&gt; obj_extarq.destroy(context)</span><br><span class="line"></span><br><span class="line"><span class="comment">## Part 1: obj_extarq.unbind(context)</span></span><br><span class="line"><span class="comment"># 8. cyborg.objects.ext_arq</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">unbind</span>(<span class="params">self, context</span>):</span></span><br><span class="line">    -&gt; attach_handle.deallocate(context)</span><br><span class="line"><span class="comment"># 9. cyborg.objects.attach_handle</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deallocate</span>(<span class="params">self, context</span>):</span></span><br><span class="line">    -&gt; self.dbapi.attach_handle_update(context, self.uuid, values)</span><br><span class="line"><span class="comment"># 10. cyborg.db.sqlalchemy.api</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">attach_handle_update</span>(<span class="params">self, context, uuid, values</span>):</span></span><br><span class="line">    -&gt; return self._do_update_attach_handle(context, uuid, values)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_do_update_attach_handle</span>(<span class="params">self, context, uuid, values</span>):</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Part 2: obj_extarq.destroy(context)</span></span><br><span class="line"><span class="comment"># 11. cyborg.objects.ext_arq</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">destroy</span>(<span class="params">self, context</span>):</span></span><br><span class="line">    -&gt; self.dbapi.extarq_delete(context, self.arq.uuid)</span><br><span class="line"><span class="comment"># 12. cyborg.db.sqlalchemy.api</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extarq_delete</span>(<span class="params">self, context, uuid</span>):</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################</span></span><br><span class="line"><span class="comment">## nova api -&gt; nova compute</span></span><br><span class="line"><span class="comment">##############################</span></span><br><span class="line"><span class="comment"># 13. nova.compute.api</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_do_delete</span>(<span class="params">self, context, instance, bdms, local=False</span>):</span></span><br><span class="line">    -&gt; self.compute_rpcapi.terminate_instance(context, instance, bdms)</span><br><span class="line"><span class="comment"># 14. nova.compute.manager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">terminate_instance</span>(<span class="params">self, context, instance, bdms</span>):</span></span><br><span class="line">    -&gt; do_terminate_instance(instance, bdms)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_terminate_instance</span>(<span class="params">instance, bdms</span>):</span></span><br><span class="line">    -&gt; self._delete_instance(context, instance, bdms)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_delete_instance</span>(<span class="params">self, context, instance, bdms</span>):</span></span><br><span class="line">    -&gt; self._shutdown_instance(context, instance, bdms)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_shutdown_instance</span>(<span class="params">self, context, instance,</span></span></span><br><span class="line"><span class="function"><span class="params">    -&gt; self.driver.destroy(<span class="params">context, instance, network_info, *</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">    -&gt; compute_utils.delete_arqs_if_needed(<span class="params">context, instance</span>)</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="comment"># 15. nova.virt.libvirt.driver</span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">def destroy(<span class="params">self, context, instance, network_info, block_device_info=None, *</span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params">    -&gt; self._destroy(<span class="params">instance</span>)</span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params">def _destroy(<span class="params">self, instance, attempt=<span class="number">1</span></span>):</span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params">    -&gt; guest.poweroff(<span class="params"></span>)</span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="comment"># 16. nova.virt.libvirt.guest</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params">def poweroff(<span class="params">self</span>):</span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params">    -&gt; self._domain.destroy(<span class="params"></span>)</span></span></span></span></span><br></pre></td></tr></table></figure><h2 id="加速资源虚机开机"><a href="#加速资源虚机开机" class="headerlink" title="加速资源虚机开机"></a>加速资源虚机开机</h2><h3 id="各模块作用-2"><a href="#各模块作用-2" class="headerlink" title="各模块作用"></a>各模块作用</h3><ul><li><strong>Nova API：</strong>响应虚机启动请求，调用宿主机节点的nova compute服务，启动虚机。</li><li><strong>Nova Computer：</strong>查询虚机对应的加速资源信息，生成xml文件，在宿主机创建并启动虚机。</li><li><strong>Cyborg API：</strong>响应Nova Compute的请求，返回虚机对应的ARQ信息。</li></ul><h3 id="代码调用关系-2"><a href="#代码调用关系-2" class="headerlink" title="代码调用关系"></a>代码调用关系</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##############################</span></span><br><span class="line"><span class="comment">## nova api</span></span><br><span class="line"><span class="comment">##############################</span></span><br><span class="line"><span class="comment"># 1. nova.api.openstack.coumpute.servers</span></span><br><span class="line"><span class="meta">@wsgi.action(&#x27;os-start&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_start_server</span>(<span class="params">self, req, id, body</span>):</span></span><br><span class="line">    -&gt; self.compute_api.start(context, instance)</span><br><span class="line"><span class="comment"># 2. nova.compute.api</span></span><br><span class="line"><span class="meta">@check_instance_state(vm_state=[vm_states.STOPPED])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="params">self, context, instance</span>):</span></span><br><span class="line">    -&gt; self.compute_rpcapi.start_instance(context, instance)</span><br><span class="line"></span><br><span class="line"><span class="comment">##############################</span></span><br><span class="line"><span class="comment">## nova api -&gt; nova compute</span></span><br><span class="line"><span class="comment">##############################</span></span><br><span class="line"><span class="comment"># 3. nova.compute.manager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_instance</span>(<span class="params">self, context, instance</span>):</span></span><br><span class="line">    -&gt; self._power_on(context, instance)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_power_on</span>(<span class="params">self, context, instance</span>):</span></span><br><span class="line">    -&gt; accel_info = self._get_accel_info(context, instance)</span><br><span class="line">    -&gt; self.driver.power_on(context, instance, *</span><br><span class="line"></span><br><span class="line"><span class="comment"># Part 1: self._get_accel_info()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_accel_info</span>(<span class="params">self, context, instance</span>):</span></span><br><span class="line">    -&gt; accel_info = cyclient.get_arqs_for_instance(instance.uuid)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Part 2: self.driver.power_on()</span></span><br><span class="line"><span class="comment"># 4. nova.virt.libvirt.driver</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">power_on</span>(<span class="params">self, context, instance, network_info, *</span></span></span><br><span class="line"><span class="function"><span class="params">    -&gt; self._hard_reboot(<span class="params">context, instance, network_info, block_device_info, *</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">def _hard_reboot(<span class="params">self, context, instance, network_info, *</span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params">    -&gt; self._create_guest_with_network(<span class="params"> *</span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params">def _create_guest_with_network(<span class="params">self, context, xml, instance, network_info, *</span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">    -&gt; guest = self._create_guest(<span class="params"> *</span></span></span></span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params"><span class="params">def _create_guest(<span class="params"> *</span></span></span></span></span></span></span></span></span><br></pre></td></tr></table></figure><h2 id="加速资源虚机关机"><a href="#加速资源虚机关机" class="headerlink" title="加速资源虚机关机"></a>加速资源虚机关机</h2><h3 id="各模块作用-3"><a href="#各模块作用-3" class="headerlink" title="各模块作用"></a>各模块作用</h3><ul><li><strong>Nova API：</strong>响应虚机关机请求，调用宿主机节点的nova compute服务，销毁虚机。</li><li><strong>Nova Computer：</strong>在宿主机上销毁虚机。</li></ul><h3 id="代码调用关系-3"><a href="#代码调用关系-3" class="headerlink" title="代码调用关系"></a>代码调用关系</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##############################</span></span><br><span class="line"><span class="comment">## nova api</span></span><br><span class="line"><span class="comment">##############################</span></span><br><span class="line"><span class="comment"># 1. nova.api.openstack.coumpute.servers</span></span><br><span class="line"><span class="meta">@wsgi.action(&#x27;os-stop&#x27;)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_stop_server</span>(<span class="params">self, req, id, body</span>):</span></span><br><span class="line">    -&gt; self.compute_api.stop(context, instance)</span><br><span class="line"><span class="comment"># 2. nova.compute.api</span></span><br><span class="line"><span class="meta">@check_instance_state(vm_state=[vm_states.ACTIVE, vm_states.ERROR])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stop</span>(<span class="params">self, context, instance, do_cast=True, clean_shutdown=True</span>):</span></span><br><span class="line">    -&gt; self.force_stop(context, instance, do_cast, clean_shutdown)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">force_stop</span>(<span class="params">self, context, instance, do_cast=True, clean_shutdown=True</span>):</span></span><br><span class="line">    -&gt; self.compute_rpcapi.stop_instance(context, instance, do_cast=do_cast, *</span><br><span class="line"></span><br><span class="line"><span class="comment">##############################</span></span><br><span class="line"><span class="comment">## nova api -&gt; nova compute</span></span><br><span class="line"><span class="comment">##############################</span></span><br><span class="line"><span class="comment"># 3. nova.compute.manager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stop_instance</span>(<span class="params">self, context, instance, clean_shutdown</span>):</span></span><br><span class="line">    -&gt; self._power_off_instance(instance, clean_shutdown)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_power_off_instance</span>(<span class="params">self, instance, clean_shutdown=True</span>):</span></span><br><span class="line">    -&gt; self.driver.power_off(instance, timeout, retry_interval)</span><br><span class="line"><span class="comment"># 4. nova.virt.libvirt.driver</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">power_off</span>(<span class="params">self, instance, timeout=<span class="number">0</span>, retry_interval=<span class="number">0</span></span>):</span></span><br><span class="line">    -&gt; self._destroy(instance)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_destroy</span>(<span class="params">self, instance, attempt=<span class="number">1</span></span>):</span></span><br><span class="line">    -&gt; guest.poweroff()</span><br></pre></td></tr></table></figure><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://docs.openstack.org/api-guide/compute/accelerator-support.html">Using accelerators with Cyborg</a></li><li><a href="http://www.c114.com.cn/tech/222/a1107306.html">OpenStack硬件管理加速利器：Cyborg</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;本文只研究含有加速资源的虚机在生命周期管理的流程，即深挖&lt;code&gt;Nova&lt;/code&gt;与&lt;code&gt;Cyborg&lt;/code&gt;组件之间的交互流程，对&lt;code&gt;Nova&lt;/code&gt;与其余组件的交互并不做详细展开，有兴趣可以对代码中具体函数进行深入分析。&lt;/p&gt;
&lt;h2</summary>
      
    
    
    
    <category term="OpenStack" scheme="https://renyb2.github.io/categories/OpenStack/"/>
    
    
    <category term="OpenStack" scheme="https://renyb2.github.io/tags/OpenStack/"/>
    
    <category term="Cyborg" scheme="https://renyb2.github.io/tags/Cyborg/"/>
    
    <category term="Nova" scheme="https://renyb2.github.io/tags/Nova/"/>
    
  </entry>
  
  <entry>
    <title>NVIDIA使用：vGPU</title>
    <link href="https://renyb2.github.io/2022/03/30/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9AvGPU/"/>
    <id>https://renyb2.github.io/2022/03/30/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9AvGPU/</id>
    <published>2022-03-30T06:37:07.000Z</published>
    <updated>2022-08-08T02:13:14.477Z</updated>
    
    <content type="html"><![CDATA[<h2 id="vGPU选择"><a href="#vGPU选择" class="headerlink" title="vGPU选择"></a>vGPU选择</h2><p>NVIDIA 虚拟 GPU 软件产品包括 GRID 虚拟 PC (GRID vPC)、GRID 虚拟应用程序 (GRID vApp)，以及 Quadro 虚拟数据中心工作站 (Quadro vDWS)。</p><ul><li>vGPU推荐对比：<a href="https://www.nvidia.cn/data-center/graphics-cards-for-virtualization/">https://www.nvidia.cn/data-center/graphics-cards-for-virtualization/</a></li><li>vGPU支持型号：<a href="https://docs.nvidia.com/grid/gpus-supported-by-vgpu.html">https://docs.nvidia.com/grid/gpus-supported-by-vgpu.html</a></li><li>vGPU支持服务器：<a href="https://www.nvidia.com/en-us/data-center/resources/vgpu-certified-servers/">https://www.nvidia.com/en-us/data-center/resources/vgpu-certified-servers/</a></li><li>vGPU文档：<a href="https://docs.nvidia.com/grid/index.html">https://docs.nvidia.com/grid/index.html</a></li></ul><p><img src="/2022/03/30/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9AvGPU/vGPU%E6%94%AF%E6%8C%81%E6%83%85%E5%86%B5.png" alt="vGPU支持情况"></p><h2 id="vGPU驱动安装"><a href="#vGPU驱动安装" class="headerlink" title="vGPU驱动安装"></a>vGPU驱动安装</h2><blockquote><p>vGPU驱动说明：</p><p>A physical GPU that is passed through to a VM is bound to the vfio-pci kernel module. A physical GPU that is bound to the vfio-pci kernel module can be used only for pass-through. To enable the GPU to be used for vGPU, the GPU must be unbound from vfio-pci kernel module and bound to the nvidia kernel module.</p></blockquote><h3 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h3><ul><li>系统：CentOS Linux release 7.8.2003 (Core)</li><li>内核：3.10.0-1127.el7.x86_64</li></ul><h3 id="驱动安装"><a href="#驱动安装" class="headerlink" title="驱动安装"></a>驱动安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看GPU信息</span></span><br><span class="line">[root@k205 ~]# lspci -nnn -D | grep NVIDIA</span><br><span class="line">0000:86:00.0 3D controller [0302]: NVIDIA Corporation TU104GL [Tesla T4] [10de:1eb8] (rev a1)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 基础依赖包</span></span><br><span class="line">[root@k205 ~]# yum install -y gcc</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装NVIDIA驱动</span></span><br><span class="line">[root@k205 ~]# ./NVIDIA-Linux-x86_64-460.32.04-vgpu-kvm.run</span><br></pre></td></tr></table></figure><h3 id="问题汇总"><a href="#问题汇总" class="headerlink" title="问题汇总"></a>问题汇总</h3><p><strong>问题1：</strong>安装报<code>X library path &#39;/usr/lib64&#39; ... were not queryable from the system</code>，问题截图如下：</p><p><img src="/2022/03/30/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9AvGPU/%E9%97%AE%E9%A2%981.png" alt="X library not queryable"></p><p><strong>解决办法：</strong>关闭<code>vnc server</code></p><h2 id="vGPU使用"><a href="#vGPU使用" class="headerlink" title="vGPU使用"></a>vGPU使用</h2><h3 id="宿主机使用"><a href="#宿主机使用" class="headerlink" title="宿主机使用"></a>宿主机使用</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看GPU PCI信息</span></span><br><span class="line">[root@k205 ~]# lspci -nnn -D | grep NVIDIA</span><br><span class="line">0000:86:00.0 3D controller [0302]: NVIDIA Corporation TU104GL [Tesla T4] [10de:1eb8] (rev a1)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看GPU PCI详情</span></span><br><span class="line">[root@k205 ~]# lspci -d 10de: -k</span><br><span class="line">86:00.0 3D controller: NVIDIA Corporation TU104GL [Tesla T4] (rev a1)</span><br><span class="line">        Subsystem: NVIDIA Corporation Device 12a2</span><br><span class="line">        Kernel driver in use: nvidia</span><br><span class="line">        Kernel modules: nouveau, nvidia_vgpu_vfio, nvidia</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看支持的vGPU类型</span></span><br><span class="line">[root@k205 mdev_supported_types]# cd /sys/class/mdev_bus/0000:86:00.0/mdev_supported_types &amp;&amp; ls</span><br><span class="line">nvidia-222  nvidia-224  nvidia-226  nvidia-228  nvidia-230  nvidia-232  nvidia-234  nvidia-319  nvidia-321</span><br><span class="line">nvidia-223  nvidia-225  nvidia-227  nvidia-229  nvidia-231  nvidia-233  nvidia-252  nvidia-320</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看指定类型vGPU信息</span></span><br><span class="line">[root@k205 mdev_supported_types]# cat nvidia-222/name</span><br><span class="line">GRID T4-1B</span><br><span class="line">[root@k205 mdev_supported_types]# cat nvidia-222/available_instances</span><br><span class="line">16</span><br><span class="line">[root@k205 mdev_supported_types]# cat nvidia-222/description</span><br><span class="line">num_heads=4, frl_config=45, framebuffer=1024M, max_resolution=5120x2880, max_instance=16</span><br><span class="line"><span class="meta">#</span><span class="bash"> PS:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> num_heads: The maximum number of virtual display heads that the vGPU <span class="built_in">type</span> supports</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> frl_config: The frame rate limiter (FRL) configuration <span class="keyword">in</span> frames per second</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> framebuffer: The frame buffer size <span class="keyword">in</span> Mbytes</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> max_resolution: The maximum resolution per display head</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> max_instance: The maximum number of vGPU instances per physical GPU</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建vGPU</span></span><br><span class="line">[root@k205 mdev_supported_types]# uuidgen</span><br><span class="line">8da209ce-7865-48f0-9b04-fd6ef55dca63</span><br><span class="line">[root@k205 mdev_supported_types]# echo 8da209ce-7865-48f0-9b04-fd6ef55dca63 &gt; nvidia-222/create</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看现有vGPU设备</span></span><br><span class="line">[root@k205 mdev_supported_types]# ls /sys/bus/mdev/devices/</span><br><span class="line">8da209ce-7865-48f0-9b04-fd6ef55dca63</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除指定vGPU设备</span></span><br><span class="line">[root@k205 mdev_supported_types]# echo 1 &gt; nvidia-222/devices/8da209ce-7865-48f0-9b04-fd6ef55dca63/remove</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 脚本</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看所有vGPU类型信息</span></span><br><span class="line">vGPU_DIR=&#x27;/sys/class/mdev_bus/0000:18:00.0/mdev_supported_types&#x27;</span><br><span class="line">for type in $(ls $vGPU_DIR)</span><br><span class="line">do</span><br><span class="line">echo &quot;-----&quot;</span><br><span class="line">echo &quot;$type&quot;</span><br><span class="line">echo &quot;name: $(cat $vGPU_DIR/$type/name)&quot;</span><br><span class="line">echo &quot;description: $(cat $vGPU_DIR/$type/description)&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="虚机使用"><a href="#虚机使用" class="headerlink" title="虚机使用"></a>虚机使用</h3><p>创建虚机增加如下配置：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-device vfio-pci,sysfsdev=/sys/bus/mdev/devices/8da209ce-7865-48f0-9b04-fd6ef55dca63 -uuid xxxxxxxxxxxxxxxxxxxxx</span><br></pre></td></tr></table></figure><p>虚机xml内相关配置如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">hostdev</span> <span class="attr">mode</span>=<span class="string">&#x27;subsystem&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;mdev&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;no&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;vfio-pci&#x27;</span> <span class="attr">display</span>=<span class="string">&#x27;off&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">address</span> <span class="attr">uuid</span>=<span class="string">&#x27;8da209ce-7865-48f0-9b04-fd6ef55dca63&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;hostdev0&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x07&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">hostdev</span>&gt;</span></span><br></pre></td></tr></table></figure><p>后面就是虚拟机内部安装对应的驱动程序了，一般名称为：<em>xxxx_grid_win10_server2016_server2019_64bit_international.exe</em></p><h2 id="vGPU授权"><a href="#vGPU授权" class="headerlink" title="vGPU授权"></a>vGPU授权</h2><p>NVIDIA的vGPU在虚拟机内部使用是需要购买license的，具体的部署方式是需要搭建一台授权服务器，虚拟机内部安装显卡驱动后需要配置授权服务器的地址和端口，前提是虚拟机和授权服务器网络是通的，虚拟机每次开机后都要连接到授权服务器进行授权。</p><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://docs.nvidia.com/grid/9.0/grid-vgpu-user-guide/index.html#abstract">NVIDIA官方文档：Virtual GPU Software User Guide</a></li><li><a href="https://docs.nvidia.com/grid/index.html">NVIDIA官方文档：NVIDIA® Virtual GPU (vGPU) Software Documentation</a></li><li><a href="https://documentation.suse.com/sles/15-SP3/html/SLES-all/article-nvidia-vgpu.html">SUSE官方文档：NVIDIA Virtual GPU for KVM Guests</a></li><li><a href="https://zhuanlan.zhihu.com/p/424967206">英伟达显卡虚拟化vGPU实践指南</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;vGPU选择&quot;&gt;&lt;a href=&quot;#vGPU选择&quot; class=&quot;headerlink&quot; title=&quot;vGPU选择&quot;&gt;&lt;/a&gt;vGPU选择&lt;/h2&gt;&lt;p&gt;NVIDIA 虚拟 GPU 软件产品包括 GRID 虚拟 PC (GRID vPC)、GRID 虚拟应用程序</summary>
      
    
    
    
    <category term="Accelerator" scheme="https://renyb2.github.io/categories/Accelerator/"/>
    
    
    <category term="NVIDIA" scheme="https://renyb2.github.io/tags/NVIDIA/"/>
    
    <category term="Accelerator" scheme="https://renyb2.github.io/tags/Accelerator/"/>
    
  </entry>
  
  <entry>
    <title>Python</title>
    <link href="https://renyb2.github.io/2022/03/08/Python/"/>
    <id>https://renyb2.github.io/2022/03/08/Python/</id>
    <published>2022-03-08T03:34:36.000Z</published>
    <updated>2022-06-30T08:44:51.758Z</updated>
    
    <content type="html"><![CDATA[<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>在需要调试的代码位置，加入如下代码，即可进入PDB交互式源代码调试模式。详细用法参考官方文档：<a href="https://docs.python.org/zh-cn/3/library/pdb.html">pdb — Python 的调试器</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pdb;pdb.set_trace()</span><br></pre></td></tr></table></figure><table><thead><tr><th align="left"><strong>命令</strong></th><th><strong>解释</strong></th></tr></thead><tbody><tr><td align="left">break 或 b 设置断点</td><td>设置断点</td></tr><tr><td align="left">continue 或 c</td><td>继续执行程序</td></tr><tr><td align="left">list 或 l</td><td>查看当前行的代码段</td></tr><tr><td align="left">step 或 s</td><td>进入函数</td></tr><tr><td align="left">return 或 r</td><td>执行代码直到从当前函数返回</td></tr><tr><td align="left">exit 或 q</td><td>中止并退出</td></tr><tr><td align="left">next 或 n</td><td>执行下一行</td></tr><tr><td align="left">pp</td><td>打印变量的值</td></tr><tr><td align="left">help</td><td>帮助</td></tr></tbody></table><h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="python修改sys-path的三种方法"><a href="#python修改sys-path的三种方法" class="headerlink" title="python修改sys.path的三种方法"></a>python修改sys.path的三种方法</h3><p>sys.path是一个列表，存放的是python搜索模块时可以搜索的路径，启动python脚本时，会将执行当前命令所在的目录添加到这个列表中，而且是在列表的最前面，正是因为这个操作，你才能在自己的项目里引用自己编写的模块，当模块名称与第三方模块或系统模块冲突时，优先引用项目里的模块。通常，sys.path里的内容如下所示：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sys</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.path</span><br><span class="line">[<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;/root/.pyenv/versions/3.6.5/lib/python36.zip&#x27;</span>, <span class="string">&#x27;/root/.pyenv/versions/3.6.5/lib/python3.6&#x27;</span>, <span class="string">&#x27;/root/.pyenv/versions/3.6.5/lib/python3.6/lib-dynload&#x27;</span>, <span class="string">&#x27;/root/.pyenv/versions/3.6.5/lib/python3.6/site-packages&#x27;</span>]</span><br></pre></td></tr></table></figure><p>这里，你重点关注site-packages， 我们安装的第三方库和模块都放在了这里。将sys.path设计为一个可变的列表，而不是元组，就是考虑到了开发人员有很强的动机和需要去修改模块的搜索路径和顺序。</p><p><strong>方法1，直接修改sys.path列表</strong></p><p>设想，如果你的系统允许用户提交自定义的python脚本，那么你可以为此专门创建一个目录用于存放这些脚本，并将这个目录加入到sys.path中，这样，在你的系统里，你可以像引用其他模块一样去引用用户上传的python脚本来执行他们，这就是本文所提到的修改sys.path的三种方法中的一个，你只需要使用sys.path.append方法将目录添加即可。</p><p><strong>方法2， 创建.pth文件</strong></p><p>另一种修改sys.path的方法时在site-packages目录新建一个<code>.pth</code>文件，并在文件中加入搜索模块的路径</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/root/test</span><br></pre></td></tr></table></figure><p>重新启动一个python交互式解释器，输出sys.path，你可以看到/root/test目录也在其中。</p><p><strong>方法3，设置PYTHONPATH环境变量</strong></p><p>第三种修改方法，通过<strong>PYTHONPATH</strong>环境变量，我使用export 命令设置该环境变量</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@sheng studyflask]# export PYTHONPATH=/root/studyflask</span><br><span class="line">[root@sheng studyflask]# echo $PYTHONPATH</span><br><span class="line">/root/studyflask</span><br></pre></td></tr></table></figure><p>这种设置方法仅仅是为了验证是否凑效，退出终端后，环境变量就会失效，如果你想永久生效，可以在/etc/profile，或者.bashrc中进行设置，设置完<strong>PYTHONPATH</strong>后，启动一个新的python交互式解释器，输出sys.path</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sys</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.path</span><br><span class="line">[<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;/root/studyflask&#x27;</span>, <span class="string">&#x27;/root/.pyenv/versions/3.6.5/lib/python36.zip&#x27;</span>, <span class="string">&#x27;/root/.pyenv/versions/3.6.5/lib/python3.6&#x27;</span>, <span class="string">&#x27;/root/.pyenv/versions/3.6.5/lib/python3.6/lib-dynload&#x27;</span>, <span class="string">&#x27;/root/.pyenv/versions/3.6.5/lib/python3.6/site-packages&#x27;</span>]</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;调试&quot;&gt;&lt;a href=&quot;#调试&quot; class=&quot;headerlink&quot; title=&quot;调试&quot;&gt;&lt;/a&gt;调试&lt;/h2&gt;&lt;p&gt;在需要调试的代码位置，加入如下代码，即可进入PDB交互式源代码调试模式。详细用法参考官方文档：&lt;a href=&quot;https://docs.p</summary>
      
    
    
    
    <category term="开发语言" scheme="https://renyb2.github.io/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
    
    <category term="Python" scheme="https://renyb2.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Linux运维：CPU load average过高</title>
    <link href="https://renyb2.github.io/2022/03/03/Linux%E8%BF%90%E7%BB%B4%EF%BC%9ACPU-load-average%E8%BF%87%E9%AB%98/"/>
    <id>https://renyb2.github.io/2022/03/03/Linux%E8%BF%90%E7%BB%B4%EF%BC%9ACPU-load-average%E8%BF%87%E9%AB%98/</id>
    <published>2022-03-03T10:07:20.000Z</published>
    <updated>2022-03-22T09:08:17.270Z</updated>
    
    <content type="html"><![CDATA[<h2 id="load-average基础"><a href="#load-average基础" class="headerlink" title="load average基础"></a>load average基础</h2><p>top命令中load average显示的是最近1分钟、5分钟和15分钟的系统平均负载。</p><p>系统平均负载被定义为在<strong>特定时间间隔内</strong>运行队列中(<strong>在CPU上运行或者等待运行多少进程</strong>)的平均进程数。如果一个进程满足以下条件则其就会位于运行队列中：</p><ul><li>它没有在等待I/O操作的结果</li><li>它没有主动进入等待状态(也就是没有调用’wait’)</li><li>没有被停止(例如：等待终止)</li></ul><p>在Linux中，进程分为三种状态，一种是阻塞的进程blocked process，一种是可运行的进程runnable process，另外就是正在运行的进程running process。</p><p>进程可运行状态时，它处在一个运行队列run queue中，与其他可运行进程争夺CPU时间。 <strong>系统的load是指正在运行和准备好运行的进程的总数。</strong>比如现在系统有2个正在运行的进程，3个可运行进程，那么系统的load就是5。load average就是一定时间内的load数量。</p><p>一般来说只要每个CPU的当前活动进程数不大于3那么系统的性能就是良好的，如果每个CPU的任务数大于5，那么就表示这台机器的性能有严重问题。</p><p><strong>CPU使用率高并不总是意味着CPU工作繁忙，它有可能是正在等待其他子系统。</strong>在进行性能分析时，将所有子系统当做一个整体来看是非常重要的，因为在子系统中可能会出现瀑布效应。衡量CPU 系统负载的指标是load,load 就是对计算机系统能够承担的多少负载的度量,简单的说是进程队列的长度。简单的例子比如食堂有五个窗口，当有小于五个学生来打饭，五个窗口都能及时处理，但是当学生个数超过5个，必然会出现等待的学生。请求大于当前的处理能力，会出现等待，引起load升高。<br>Load Average 就是一段时间(1min,5min,15min)内平均Load。<strong>平均负载的最佳值是1</strong>，这意味着每个进程都可以在一个完整的CPU 周期内完成。</p><h2 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h2><p>经反馈发现，虚机环境CentOS系统的CPU负载超过正常水平，并持续升高，经过一晚的时间，负载提升至1000+的水平。</p><p><img src="/2022/03/03/Linux%E8%BF%90%E7%BB%B4%EF%BC%9ACPU-load-average%E8%BF%87%E9%AB%98/CPU%E8%B4%9F%E8%BD%BD%E8%BF%87%E9%AB%98.png" alt="CPU负载过高"></p><h2 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h2><ul><li>12c32G vCenter 虚机 * 3台</li><li>部署Kubernetes + OpenStack</li></ul><h2 id="问题定位"><a href="#问题定位" class="headerlink" title="问题定位"></a>问题定位</h2><ol><li>通过top查看各CPU使用率，发现CPU各核使用率并不高，说明CPU性能并不是导致拥塞的瓶颈。</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看CPU各核使用率</span></span><br><span class="line">top后按1</span><br></pre></td></tr></table></figure><p><img src="/2022/03/03/Linux%E8%BF%90%E7%BB%B4%EF%BC%9ACPU-load-average%E8%BF%87%E9%AB%98/CPU%E4%BD%BF%E7%94%A8%E7%8E%87.png" alt="CPU使用率"></p><ol start="2"><li>计算通常不会存在瓶颈，一般性能瓶颈出在IO处。接下来需要确认是否由于IO问题，导致拥塞，引起负载升高。</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> IO监控命令</span></span><br><span class="line">[root@k104 ~]# iostat</span><br><span class="line">[root@k104 ~]# dstat</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 简单磁盘写测速</span></span><br><span class="line">[root@k104 ~]# dd if=/dev/zero of=test.img bs=1M count=1024</span><br><span class="line">1024+0 records in</span><br><span class="line">1024+0 records out</span><br><span class="line">1073741824 bytes (1.1 GB) copied, 0.603499 s, 1.8 GB/s</span><br></pre></td></tr></table></figure><ol start="3"><li>检测发现IO不存在瓶颈，推测可能程序有问题，未正常退出导致cpu load average异常升高。这里先寻找哪个进程有问题，命令如下：</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看所有线程</span></span><br><span class="line">[root@k104 ~]# ps -eLl</span><br></pre></td></tr></table></figure><ol start="4"><li>检查发现cephcsi线程数过多，且都处于S（休眠）状态，统计数量与load average一致，故load average升高由cephcsi线程未正常退出导致。</li></ol><p><img src="/2022/03/03/Linux%E8%BF%90%E7%BB%B4%EF%BC%9ACPU-load-average%E8%BF%87%E9%AB%98/%E4%BC%91%E7%9C%A0%E7%BA%BF%E7%A8%8B%E8%BF%87%E5%A4%9A.png" alt="休眠线程过多"></p><ol start="5"><li>追踪定位cephcsi线程未正常退出原因，该线程为rook-ceph创建，提供cephfs服务，检查ceph状态。</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看ceph状态概况</span></span><br><span class="line">[root@k104 ~]# ceph -s</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看ceph健康详情</span></span><br><span class="line">[root@k104 ~]# ceph health detail</span><br></pre></td></tr></table></figure><p><img src="/2022/03/03/Linux%E8%BF%90%E7%BB%B4%EF%BC%9ACPU-load-average%E8%BF%87%E9%AB%98/ceph%E5%BC%82%E5%B8%B8.png" alt="ceph异常"></p><p><img src="/2022/03/03/Linux%E8%BF%90%E7%BB%B4%EF%BC%9ACPU-load-average%E8%BF%87%E9%AB%98/ceph%E5%81%A5%E5%BA%B7%E5%BC%82%E5%B8%B8.png" alt="ceph健康异常"></p><ol start="6"><li>发现cephfs异常，根据报错信息<code>1 mds daemon damaged</code>从网上寻找到如下解决办法：</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph mds repaired 0</span><br></pre></td></tr></table></figure><blockquote><p><strong>Ceph部分组件用途</strong></p><ul><li><strong>MDS：</strong>Ceph元数据服务器，跟踪文件层次结构并存储只供CephFS使用的元数据。Ceph块设备和RADOS网关不需要元数据。MDS不直接给client提供数据服务。</li><li><strong>CephFS：</strong>提供了一个任意大小且兼容POSlX的分布式文件系统。CephFS 依赖Ceph MDS 来跟踪文件层次结构，即元数据。</li><li><strong>CSI CephFS plugin：</strong>用来提供CephFS存储卷和挂载存储卷。</li></ul></blockquote><ol start="7"><li>cephfs问题修复后，重启相关pod，cpu load average问题未出现。</li></ol><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://blog.csdn.net/xiaoqiaoq0/article/details/106932338">CPU负载均衡之loadavg计算</a></li><li><a href="https://blog.csdn.net/xingjing1226/article/details/81977129">线程的5种状态详解</a></li><li><a href="https://www.cnblogs.com/lddbupt/p/5779655.html">cpu load过高问题排查</a></li><li><a href="https://blog.csdn.net/canot/article/details/78079085">CPU load过高产生的原因及排查</a></li><li><a href="https://www.cnblogs.com/weifeng1463/p/9007369.html">cpu使用率低负载高，原因分析</a></li><li><a href="https://juejin.cn/post/6844904173843005447">记一次CPU使用率低负载高的排查过程</a></li><li><a href="https://blog.csdn.net/whatday/article/details/108933578">linux 查看线程数的方法</a></li><li><a href="https://blog.csdn.net/mayue_web/article/details/106942440">查看Linux的所有线程</a></li><li><a href="https://www.cnblogs.com/xrq730/p/11041741.html">对cpu与load的理解及线上问题处理思路解读</a></li><li><a href="https://www.jianshu.com/p/94d130b457ce">Linux CPU负载过高问题排查</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;load-average基础&quot;&gt;&lt;a href=&quot;#load-average基础&quot; class=&quot;headerlink&quot; title=&quot;load average基础&quot;&gt;&lt;/a&gt;load average基础&lt;/h2&gt;&lt;p&gt;top命令中load average显示的是</summary>
      
    
    
    
    <category term="Linux" scheme="https://renyb2.github.io/categories/Linux/"/>
    
    
    <category term="Linux" scheme="https://renyb2.github.io/tags/Linux/"/>
    
    <category term="CPU" scheme="https://renyb2.github.io/tags/CPU/"/>
    
  </entry>
  
  <entry>
    <title>OpenStack研发：Trove Cluster Controller</title>
    <link href="https://renyb2.github.io/2022/01/25/OpenStack%E7%A0%94%E5%8F%91%EF%BC%9ATrove-Cluster-Controller/"/>
    <id>https://renyb2.github.io/2022/01/25/OpenStack%E7%A0%94%E5%8F%91%EF%BC%9ATrove-Cluster-Controller/</id>
    <published>2022-01-25T09:45:32.000Z</published>
    <updated>2022-07-26T08:08:39.211Z</updated>
    
    <content type="html"><![CDATA[<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>对程序员来说，最好的文档就是源码。Trove 官方对于<strong>Clueter Controller</strong>能力的描述文档不多，给的参考例子只涉及到MongoDB集群，参考<a href="https://docs.openstack.org/trove/wallaby/user/set-up-clustering.html">Set up database clustering</a>。为了深入了解Trove的集群能力，本文档对<code>Trove Cluster Controller</code>的能力进行深入剖析，从API入手，解析如何构建整个后端数据库集群生命周期管理架构。摸清Trove现有能力的同时，梳理代码设计思路，为后续研发做准备。</p><h2 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h2><ul><li>OpenStack Train版本（16 October, 2019）</li><li>Trove 12.1.0</li></ul><p><strong>备注：</strong></p><p>在深入剖析Trove源码后，发现Trove在14.0.0后，调整了虚机内数据库服务的部署方式，从原先的直接RPM部署调整为Docker部署，优点就是横向扩展很容易，缺点是为了打通Trove虚机与Docker仓库的网络，导致Trove服务网络结构会比较复杂。<strong>Trove更新为docker后，留了一个深坑，就是原先已支持的数据库，现在很多都不支持了，Guest Agent正在重构。目前最新版本支持情况：MySQL 5.7.X, MariaDB 10.4.X. PostgreSQL 12.4 is partially supported</strong>。目前已经两个大版本过去了，依然没有新的数据库类型支持，考虑到研发代价，决定使用弃用Docker形式的新版本，使用稳定的老版本。</p><p><img src="/2022/01/25/OpenStack%E7%A0%94%E5%8F%91%EF%BC%9ATrove-Cluster-Controller/trove-releasenote-14.0.0.png" alt="trove-releasenote-14.0.0"></p><p><img src="/2022/01/25/OpenStack%E7%A0%94%E5%8F%91%EF%BC%9ATrove-Cluster-Controller/trove-administrator-guide-16.0.0.png" alt="trove-administrator-guide-16.0.0"></p><h2 id="源生能力"><a href="#源生能力" class="headerlink" title="源生能力"></a>源生能力</h2><h3 id="Clueter-相关接口"><a href="#Clueter-相关接口" class="headerlink" title="Clueter 相关接口"></a>Clueter 相关接口</h3><table><thead><tr><th>接口</th><th>接口路由</th><th>请求方式</th></tr></thead><tbody><tr><td>index cluster</td><td><code>/&#123;tenant_id&#125;/clusters</code></td><td>GET</td></tr><tr><td>show cluster</td><td><code>/&#123;tenant_id&#125;/clusters/&#123;id&#125;</code></td><td>GET</td></tr><tr><td>create cluster</td><td><code>/&#123;tenant_id&#125;/clusters</code></td><td>POST</td></tr><tr><td>cluster action</td><td><code>/&#123;tenant_id&#125;/clusters/&#123;id&#125;</code></td><td>POST</td></tr><tr><td>show instance in cluster</td><td><code>/&#123;tenant_id&#125;/clusters/&#123;cluster_id&#125;/instances/</code></td><td>GET</td></tr><tr><td>delete cluster</td><td><code>/&#123;tenant_id&#125;/clusters/&#123;id&#125;</code></td><td>DELETE</td></tr></tbody></table><h3 id="Clueter-支持的集群类型"><a href="#Clueter-支持的集群类型" class="headerlink" title="Clueter 支持的集群类型"></a>Clueter 支持的集群类型</h3><table><thead><tr><th>数据库</th><th>集群类型</th><th>入口函数（strategy）</th></tr></thead><tbody><tr><td><em>Percona XtraDB</em></td><td>Galera</td><td><code>trove.common.strategies.cluster.experimental.galera_common</code></td></tr><tr><td><em>MariaDB</em></td><td>Galera</td><td><code>trove.common.strategies.cluster.experimental.galera_common</code></td></tr><tr><td><em>Redis</em></td><td>Redis Cluster</td><td><code>trove.common.strategies.cluster.experimental.redis</code></td></tr><tr><td><em>MongoDB</em></td><td>MongoDB Cluster</td><td><code>trove.common.strategies.cluster.experimental.mongodb</code></td></tr><tr><td><em>Cassandra</em></td><td>Cassandra Cluster</td><td><code>trove.common.strategies.cluster.experimental.cassandra</code></td></tr><tr><td><em>Vertica</em></td><td>Vertica Cluster</td><td><code>trove.common.strategies.cluster.experimental.vertica</code></td></tr></tbody></table><h2 id="代码走读"><a href="#代码走读" class="headerlink" title="代码走读"></a>代码走读</h2><p>OpenStack源码分析，需要从组件包管理<code>setup.cfg</code>中的<code>entry_points</code>入手，根据<code>entry_points</code>中<code>trove-api</code>的配置，确定入口为<code>trove.cmd.api:main</code>。<code>setup.cfg</code>源码如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">[entry_points]</span><br><span class="line">console_scripts &#x3D; </span><br><span class="line">trove-api &#x3D; trove.cmd.api:main</span><br><span class="line">trove-taskmanager &#x3D; trove.cmd.taskmanager:main</span><br><span class="line">trove-mgmt-taskmanager &#x3D; trove.cmd.taskmanager:mgmt_main</span><br><span class="line">trove-conductor &#x3D; trove.cmd.conductor:main</span><br><span class="line">trove-manage &#x3D; trove.cmd.manage:main</span><br><span class="line">trove-guestagent &#x3D; trove.cmd.guest:main</span><br><span class="line">trove-fake-mode &#x3D; trove.cmd.fakemode:main</span><br><span class="line">trove-status &#x3D; trove.cmd.status:main</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>trove-api调用wsgi模块，启动api服务。源码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># trove.cmd.api</span></span><br><span class="line"><span class="keyword">from</span> oslo_concurrency <span class="keyword">import</span> processutils</span><br><span class="line"><span class="keyword">from</span> trove.cmd.common <span class="keyword">import</span> with_initialize</span><br><span class="line"><span class="keyword">from</span> trove.common <span class="keyword">import</span> profile</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@with_initialize</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">CONF</span>):</span></span><br><span class="line">    <span class="keyword">from</span> trove.common <span class="keyword">import</span> cfg</span><br><span class="line">    <span class="keyword">from</span> trove.common <span class="keyword">import</span> notification</span><br><span class="line">    <span class="keyword">from</span> trove.common <span class="keyword">import</span> wsgi</span><br><span class="line">    <span class="keyword">from</span> trove.instance <span class="keyword">import</span> models <span class="keyword">as</span> inst_models</span><br><span class="line"></span><br><span class="line">    notification.DBaaSAPINotification.register_notify_callback(</span><br><span class="line">        inst_models.persist_instance_fault)</span><br><span class="line">    cfg.set_api_config_defaults()</span><br><span class="line">    profile.setup_profiler(<span class="string">&#x27;api&#x27;</span>, CONF.host)</span><br><span class="line">    conf_file = CONF.find_file(CONF.api_paste_config)</span><br><span class="line">    workers = CONF.trove_api_workers <span class="keyword">or</span> processutils.get_worker_count()</span><br><span class="line">    launcher = wsgi.launch(<span class="string">&#x27;trove&#x27;</span>, CONF.bind_port, conf_file,</span><br><span class="line">                           host=CONF.bind_host, workers=workers)</span><br><span class="line">    launcher.wait()</span><br></pre></td></tr></table></figure><p>确定trove api接口能力，需要先从wsgi模块关于Router的定义，其中<code>wsgi.Router</code>主要负责对请求进行匹配，未匹配到返回<code>404 HTTPNotFound</code>。<code>base_wsgi.Router</code>为<code>wsgi.Router</code>的父类，定义了Router的使用方式。相关源码见下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># trove.common.wsgi</span></span><br><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span>(<span class="params">base_wsgi.Router</span>):</span></span><br><span class="line">    <span class="comment"># Original router did not allow for serialization of the 404 error.</span></span><br><span class="line">    <span class="comment"># To fix this the _dispatch was modified to use Fault() objects.</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line"><span class="meta">    @webob.dec.wsgify</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_dispatch</span>(<span class="params">req</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Called by self._router after matching the incoming request to a route</span></span><br><span class="line"><span class="string">        and putting the information into req.environ.  Either returns 404</span></span><br><span class="line"><span class="string">        or the routed WSGI app&#x27;s response.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        match = req.environ[<span class="string">&#x27;wsgiorg.routing_args&#x27;</span>][<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> match:</span><br><span class="line">            <span class="keyword">return</span> Fault(webob.exc.HTTPNotFound())</span><br><span class="line">        app = match[<span class="string">&#x27;controller&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> app</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># trove.common.base_wsgi</span></span><br><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Router</span>(<span class="params">object</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    WSGI middleware that maps incoming requests to WSGI apps.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, mapper</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Create a router for the given routes.Mapper.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Each route in `mapper` must specify a &#x27;controller&#x27;, which is a</span></span><br><span class="line"><span class="string">        WSGI app to call.  You&#x27;ll probably want to specify an &#x27;action&#x27; as</span></span><br><span class="line"><span class="string">        well and have your controller be a wsgi.Controller, who will route</span></span><br><span class="line"><span class="string">        the request to the action method.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Examples:</span></span><br><span class="line"><span class="string">          mapper = routes.Mapper()</span></span><br><span class="line"><span class="string">          sc = ServerController()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">          # Explicit mapping of one route to a controller+action</span></span><br><span class="line"><span class="string">          mapper.connect(None, &quot;/svrlist&quot;, controller=sc, action=&quot;list&quot;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">          # Actions are all implicitly defined</span></span><br><span class="line"><span class="string">          mapper.resource(&quot;server&quot;, &quot;servers&quot;, controller=sc)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">          # Pointing to an arbitrary WSGI app.  You can specify the</span></span><br><span class="line"><span class="string">          # &#123;path_info:.*&#125; parameter so the target app can be handed just that</span></span><br><span class="line"><span class="string">          # section of the URL.</span></span><br><span class="line"><span class="string">          mapper.connect(None, &quot;/v1.0/&#123;path_info:.*&#125;&quot;, controller=BlogApp())</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.map = mapper</span><br><span class="line">        self._router = routes.middleware.RoutesMiddleware(self._dispatch,</span><br><span class="line">                                                          self.map)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @webob.dec.wsgify</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span>(<span class="params">self, req</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Route the incoming request to a controller based on self.map.</span></span><br><span class="line"><span class="string">        If no match, return a 404.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self._router</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line"><span class="meta">    @webob.dec.wsgify</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_dispatch</span>(<span class="params">req</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Called by self._router after matching the incoming request to a route</span></span><br><span class="line"><span class="string">        and putting the information into req.environ.  Either returns 404</span></span><br><span class="line"><span class="string">        or the routed WSGI app&#x27;s response.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        match = req.environ[<span class="string">&#x27;wsgiorg.routing_args&#x27;</span>][<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> match:</span><br><span class="line">            <span class="keyword">return</span> webob.exc.HTTPNotFound()</span><br><span class="line">        app = match[<span class="string">&#x27;controller&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> app</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>trove api的详细router定义是在<code>trove.common.api:API</code>中，定义了trove api所有接口路由。根据Trove API Rrouter定义的接口，cluster支持增删改查能力，Cluster Controller的路由代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># trove.common.api</span></span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_cluster_router</span>(<span class="params">self, mapper</span>):</span></span><br><span class="line">        cluster_resource = ClusterController().create_resource()</span><br><span class="line">        mapper.connect(<span class="string">&quot;/&#123;tenant_id&#125;/clusters&quot;</span>,</span><br><span class="line">                       controller=cluster_resource,</span><br><span class="line">                       action=<span class="string">&quot;index&quot;</span>,</span><br><span class="line">                       conditions=&#123;<span class="string">&#x27;method&#x27;</span>: [<span class="string">&#x27;GET&#x27;</span>]&#125;)</span><br><span class="line">        mapper.connect(<span class="string">&quot;/&#123;tenant_id&#125;/clusters/&#123;id&#125;&quot;</span>,</span><br><span class="line">                       controller=cluster_resource,</span><br><span class="line">                       action=<span class="string">&quot;show&quot;</span>,</span><br><span class="line">                       conditions=&#123;<span class="string">&#x27;method&#x27;</span>: [<span class="string">&#x27;GET&#x27;</span>]&#125;)</span><br><span class="line">        mapper.connect(<span class="string">&quot;/&#123;tenant_id&#125;/clusters&quot;</span>,</span><br><span class="line">                       controller=cluster_resource,</span><br><span class="line">                       action=<span class="string">&quot;create&quot;</span>,</span><br><span class="line">                       conditions=&#123;<span class="string">&#x27;method&#x27;</span>: [<span class="string">&#x27;POST&#x27;</span>]&#125;)</span><br><span class="line">        mapper.connect(<span class="string">&quot;/&#123;tenant_id&#125;/clusters/&#123;id&#125;&quot;</span>,</span><br><span class="line">                       controller=cluster_resource,</span><br><span class="line">                       action=<span class="string">&quot;action&quot;</span>,</span><br><span class="line">                       conditions=&#123;<span class="string">&#x27;method&#x27;</span>: [<span class="string">&#x27;POST&#x27;</span>]&#125;)</span><br><span class="line">        mapper.connect(<span class="string">&quot;/&#123;tenant_id&#125;/clusters/&#123;cluster_id&#125;/instances/&quot;</span></span><br><span class="line">                       <span class="string">&quot;&#123;instance_id&#125;&quot;</span>,</span><br><span class="line">                       controller=cluster_resource,</span><br><span class="line">                       action=<span class="string">&quot;show_instance&quot;</span>,</span><br><span class="line">                       conditions=&#123;<span class="string">&#x27;method&#x27;</span>: [<span class="string">&#x27;GET&#x27;</span>]&#125;)</span><br><span class="line">        mapper.connect(<span class="string">&quot;/&#123;tenant_id&#125;/clusters/&#123;id&#125;&quot;</span>,</span><br><span class="line">                       controller=cluster_resource,</span><br><span class="line">                       action=<span class="string">&quot;delete&quot;</span>,</span><br><span class="line">                       conditions=&#123;<span class="string">&#x27;method&#x27;</span>: [<span class="string">&#x27;DELETE&#x27;</span>]&#125;)</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>我们从创建流程入手，进行更深一步的分析。路由中定义的后端响应类为<code>trove.cluster.service:ClusterController</code>,每个路由对应一个具体的方法，关于创建的源码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># trove.cluster.service</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">from</span> trove.cluster <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClusterController</span>(<span class="params">wsgi.Controller</span>):</span></span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, req, body, tenant_id</span>):</span></span><br><span class="line">        LOG.debug((<span class="string">&quot;Creating a Cluster for Tenant &#x27;%(tenant_id)s&#x27;\n&quot;</span></span><br><span class="line">                   <span class="string">&quot;req : &#x27;%(req)s&#x27;\n\nbody : &#x27;%(body)s&#x27;\n\n&quot;</span>),</span><br><span class="line">                  &#123;<span class="string">&quot;tenant_id&quot;</span>: tenant_id, <span class="string">&quot;req&quot;</span>: req, <span class="string">&quot;body&quot;</span>: body&#125;)</span><br><span class="line"></span><br><span class="line">        context = req.environ[wsgi.CONTEXT_KEY]</span><br><span class="line">        policy.authorize_on_tenant(context, <span class="string">&#x27;cluster:create&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        name = body[<span class="string">&#x27;cluster&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">        datastore_args = body[<span class="string">&#x27;cluster&#x27;</span>].get(<span class="string">&#x27;datastore&#x27;</span>, &#123;&#125;)</span><br><span class="line">        datastore, datastore_version = (</span><br><span class="line">            datastore_models.get_datastore_version(**datastore_args))</span><br><span class="line"></span><br><span class="line">        extended_properties = body[<span class="string">&#x27;cluster&#x27;</span>].get(<span class="string">&#x27;extended_properties&#x27;</span>, &#123;&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            clusters_enabled = (CONF.get(datastore_version.manager)</span><br><span class="line">                                .get(<span class="string">&#x27;cluster_support&#x27;</span>))</span><br><span class="line">        <span class="keyword">except</span> NoSuchOptError:</span><br><span class="line">            clusters_enabled = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> clusters_enabled:</span><br><span class="line">            <span class="keyword">raise</span> exception.ClusterDatastoreNotSupported(</span><br><span class="line">                datastore=datastore.name,</span><br><span class="line">                datastore_version=datastore_version.name)</span><br><span class="line"></span><br><span class="line">        nodes = body[<span class="string">&#x27;cluster&#x27;</span>][<span class="string">&#x27;instances&#x27;</span>]</span><br><span class="line">        instances = []</span><br><span class="line">        <span class="keyword">for</span> node <span class="keyword">in</span> nodes:</span><br><span class="line">            flavor_id = utils.get_id_from_href(node[<span class="string">&#x27;flavorRef&#x27;</span>])</span><br><span class="line">            volume_size = volume_type = nics = availability_zone = <span class="literal">None</span></span><br><span class="line">            modules = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;volume&#x27;</span> <span class="keyword">in</span> node:</span><br><span class="line">                volume_size = int(node[<span class="string">&#x27;volume&#x27;</span>][<span class="string">&#x27;size&#x27;</span>])</span><br><span class="line">                volume_type = node[<span class="string">&#x27;volume&#x27;</span>].get(<span class="string">&#x27;type&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;nics&#x27;</span> <span class="keyword">in</span> node:</span><br><span class="line">                nics = node[<span class="string">&#x27;nics&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;availability_zone&#x27;</span> <span class="keyword">in</span> node:</span><br><span class="line">                availability_zone = node[<span class="string">&#x27;availability_zone&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;modules&#x27;</span> <span class="keyword">in</span> node:</span><br><span class="line">                modules = node[<span class="string">&#x27;modules&#x27;</span>]</span><br><span class="line"></span><br><span class="line">            instances.append(&#123;<span class="string">&quot;flavor_id&quot;</span>: flavor_id,</span><br><span class="line">                              <span class="string">&quot;volume_size&quot;</span>: volume_size,</span><br><span class="line">                              <span class="string">&quot;volume_type&quot;</span>: volume_type,</span><br><span class="line">                              <span class="string">&quot;nics&quot;</span>: nics,</span><br><span class="line">                              <span class="string">&quot;availability_zone&quot;</span>: availability_zone,</span><br><span class="line">                              <span class="string">&#x27;region_name&#x27;</span>: node.get(<span class="string">&#x27;region_name&#x27;</span>),</span><br><span class="line">                              <span class="string">&quot;modules&quot;</span>: modules&#125;)</span><br><span class="line"></span><br><span class="line">        locality = body[<span class="string">&#x27;cluster&#x27;</span>].get(<span class="string">&#x27;locality&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> locality:</span><br><span class="line">            locality_domain = [<span class="string">&#x27;affinity&#x27;</span>, <span class="string">&#x27;anti-affinity&#x27;</span>]</span><br><span class="line">            locality_domain_msg = (<span class="string">&quot;Invalid locality &#x27;%s&#x27;. &quot;</span></span><br><span class="line">                                   <span class="string">&quot;Must be one of [&#x27;%s&#x27;]&quot;</span> %</span><br><span class="line">                                   (locality,</span><br><span class="line">                                    <span class="string">&quot;&#x27;, &#x27;&quot;</span>.join(locality_domain)))</span><br><span class="line">            <span class="keyword">if</span> locality <span class="keyword">not</span> <span class="keyword">in</span> locality_domain:</span><br><span class="line">                <span class="keyword">raise</span> exception.BadRequest(message=locality_domain_msg)</span><br><span class="line"></span><br><span class="line">        configuration = body[<span class="string">&#x27;cluster&#x27;</span>].get(<span class="string">&#x27;configuration&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        context.notification = notification.DBaaSClusterCreate(context,</span><br><span class="line">                                                               request=req)</span><br><span class="line">        <span class="keyword">with</span> StartNotification(context, name=name, datastore=datastore.name,</span><br><span class="line">                               datastore_version=datastore_version.name):</span><br><span class="line">            cluster = models.Cluster.create(context, name, datastore,</span><br><span class="line">                                            datastore_version, instances,</span><br><span class="line">                                            extended_properties,</span><br><span class="line">                                            locality, configuration)</span><br><span class="line">        cluster.locality = locality</span><br><span class="line">        view = views.load_view(cluster, req=req, load_servers=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> wsgi.Result(view.data(), <span class="number">200</span>)</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>分析ClusterController中create的流程，create做了以下三件事：</p><ol><li>根据配置文件中，指定数据库类型的cluster_support配置，检查该数据库是否支持集群模式。</li><li>拼装集群内instance配置参数。</li><li>调用trove.cluster.models.Cluster.create()，创建数据库集群。</li></ol><p>创建实际是在<code>trove.cluster.models:Cluster.create</code>执行的，进一步分析<strong>trove.cluster.models</strong>中的创建流程，源码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># trove.cluster.models</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">cls, context, name, datastore, datastore_version,</span></span></span><br><span class="line"><span class="function"><span class="params">               instances, extended_properties, locality, configuration</span>):</span></span><br><span class="line">        locality = srv_grp.ServerGroup.build_scheduler_hint(</span><br><span class="line">            context, locality, name)</span><br><span class="line">        api_strategy = strategy.load_api_strategy(datastore_version.manager)</span><br><span class="line">        <span class="keyword">return</span> api_strategy.cluster_class.create(context, name, datastore,</span><br><span class="line">                                                 datastore_version, instances,</span><br><span class="line">                                                 extended_properties,</span><br><span class="line">                                                 locality, configuration)</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><code>trove.cluster.models:Cluster.create</code>做了三件事，依次分别是：</p><ol><li>调用novaclient，为cluster创建server group，便于统一管理。</li><li>根据数据库版本，加载指定的api strategy。</li><li>调用api strategy中对应的create方法。</li></ol><p>研究strategy究竟做了哪些事情，这里看下<code>load_api_strategy</code>代码，源码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># trove.common.strategise.cluster.strategy</span></span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_api_strategy</span>(<span class="params">manager</span>):</span></span><br><span class="line">    clazz = CONF.get(manager).get(<span class="string">&#x27;api_strategy&#x27;</span>)</span><br><span class="line">    LOG.debug(<span class="string">&quot;Loading class %s&quot;</span>, clazz)</span><br><span class="line">    api_strategy = import_class(clazz)</span><br><span class="line">    <span class="keyword">return</span> api_strategy()</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>strategy根据配置文件中，不同数据库配置的<code>api_strategy</code>参数，找到指定的管理代码，从而实现不同的数据库类型统一的管理。这里以<code>galera_common</code>为例，进行后续分析，源码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># trove.common.strategies.cluster.experimental.galera_common.api</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">cls, context, name, datastore, datastore_version,</span></span></span><br><span class="line"><span class="function"><span class="params">               instances, extended_properties, locality, configuration</span>):</span></span><br><span class="line">        LOG.debug(<span class="string">&quot;Initiating Galera cluster creation.&quot;</span>)</span><br><span class="line">        ds_conf = CONF.get(datastore_version.manager)</span><br><span class="line">        <span class="comment"># Check number of instances is at least min_cluster_member_count</span></span><br><span class="line">        <span class="keyword">if</span> len(instances) &lt; ds_conf.min_cluster_member_count:</span><br><span class="line">            <span class="keyword">raise</span> exception.ClusterNumInstancesNotLargeEnough(</span><br><span class="line">                num_instances=ds_conf.min_cluster_member_count)</span><br><span class="line">        cls._validate_cluster_instances(context, instances, datastore,</span><br><span class="line">                                        datastore_version)</span><br><span class="line">        <span class="comment"># Updating Cluster Task</span></span><br><span class="line">        db_info = cluster_models.DBCluster.create(</span><br><span class="line">            name=name, tenant_id=context.project_id,</span><br><span class="line">            datastore_version_id=datastore_version.id,</span><br><span class="line">            task_status=ClusterTasks.BUILDING_INITIAL,</span><br><span class="line">            configuration_id=configuration)</span><br><span class="line"></span><br><span class="line">        cls._create_instances(context, db_info, datastore, datastore_version,</span><br><span class="line">                              instances, extended_properties, locality,</span><br><span class="line">                              configuration)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Calling taskmanager to further proceed for cluster-configuration</span></span><br><span class="line">        task_api.load(context, datastore_version.manager).create_cluster(</span><br><span class="line">            db_info.id)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cls(context, db_info, datastore, datastore_version)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_create_instances</span>(<span class="params">context, db_info, datastore, datastore_version,</span></span></span><br><span class="line"><span class="function"><span class="params">                          instances, extended_properties, locality,</span></span></span><br><span class="line"><span class="function"><span class="params">                          configuration_id</span>):</span></span><br><span class="line">        member_config = &#123;<span class="string">&quot;id&quot;</span>: db_info.id,</span><br><span class="line">                         <span class="string">&quot;instance_type&quot;</span>: <span class="string">&quot;member&quot;</span>&#125;</span><br><span class="line">        name_index = int(time.time())</span><br><span class="line">        <span class="keyword">for</span> instance <span class="keyword">in</span> instances:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> instance.get(<span class="string">&quot;name&quot;</span>):</span><br><span class="line">                instance[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&quot;%s-member-%s&quot;</span> % (db_info.name,</span><br><span class="line">                                                     str(name_index))</span><br><span class="line">                name_index += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [Instance.create(context,</span><br><span class="line">                                instance[<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">                                instance[<span class="string">&#x27;flavor_id&#x27;</span>],</span><br><span class="line">                                datastore_version.image_id,</span><br><span class="line">                                [], [],</span><br><span class="line">                                datastore, datastore_version,</span><br><span class="line">                                instance.get(<span class="string">&#x27;volume_size&#x27;</span>, <span class="literal">None</span>),</span><br><span class="line">                                <span class="literal">None</span>,</span><br><span class="line">                                availability_zone=instance.get(</span><br><span class="line">                                    <span class="string">&#x27;availability_zone&#x27;</span>, <span class="literal">None</span>),</span><br><span class="line">                                nics=instance.get(<span class="string">&#x27;nics&#x27;</span>, <span class="literal">None</span>),</span><br><span class="line">                                configuration_id=configuration_id,</span><br><span class="line">                                cluster_config=member_config,</span><br><span class="line">                                volume_type=instance.get(</span><br><span class="line">                                    <span class="string">&#x27;volume_type&#x27;</span>, <span class="literal">None</span>),</span><br><span class="line">                                modules=instance.get(<span class="string">&#x27;modules&#x27;</span>),</span><br><span class="line">                                locality=locality,</span><br><span class="line">                                region_name=instance.get(<span class="string">&#x27;region_name&#x27;</span>)</span><br><span class="line">                                )</span><br><span class="line">                <span class="keyword">for</span> instance <span class="keyword">in</span> instances]</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_validate_cluster_instances</span>(<span class="params">context, instances, datastore,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    datastore_version</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Validate the flavor and volume&quot;&quot;&quot;</span></span><br><span class="line">        ds_conf = CONF.get(datastore_version.manager)</span><br><span class="line">        num_instances = len(instances)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Checking volumes and get delta for quota check</span></span><br><span class="line">        cluster_models.validate_instance_flavors(</span><br><span class="line">            context, instances, ds_conf.volume_support, ds_conf.device_path)</span><br><span class="line"></span><br><span class="line">        req_volume_size = cluster_models.get_required_volume_size(</span><br><span class="line">            instances, ds_conf.volume_support)</span><br><span class="line"></span><br><span class="line">        cluster_models.assert_homogeneous_cluster(instances)</span><br><span class="line"></span><br><span class="line">        deltas = &#123;<span class="string">&#x27;instances&#x27;</span>: num_instances, <span class="string">&#x27;volumes&#x27;</span>: req_volume_size&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># quota check</span></span><br><span class="line">        check_quotas(context.project_id, deltas)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Checking networks are same for the cluster</span></span><br><span class="line">        cluster_models.validate_instance_nics(context, instances)    </span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>galera_common.api中，做了如下几个步骤：</p><ol><li>检查集群内的实例数量是否满足配置中要求的集群最小实例数。</li><li>检查集群实例配置。</li><li>更新cluster状态信息。</li><li>创建集群内各实例。</li><li>调用<code>galera_common.taskmanager.create_cluster</code>进行进一步的集群配置。</li></ol><p>galera_common.taskmanager.create_cluster源码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># trove.common.strategies.cluster.experimental.galera_common.taskmanager</span></span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_cluster</span>(<span class="params">self, context, cluster_id</span>):</span></span><br><span class="line">        LOG.debug(<span class="string">&quot;Begin create_cluster for id: %s.&quot;</span>, cluster_id)</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_create_cluster</span>():</span></span><br><span class="line">            <span class="comment"># Fetch instances by cluster_id against instances table.</span></span><br><span class="line">            db_instances = DBInstance.find_all(cluster_id=cluster_id).all()</span><br><span class="line">            instance_ids = [db_instance.id <span class="keyword">for</span> db_instance <span class="keyword">in</span> db_instances]</span><br><span class="line"></span><br><span class="line">            LOG.debug(<span class="string">&quot;Waiting for instances to get to cluster-ready status.&quot;</span>)</span><br><span class="line">            <span class="comment"># Wait for cluster members to get to cluster-ready status.</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self._all_instances_ready(instance_ids, cluster_id):</span><br><span class="line">                <span class="keyword">raise</span> TroveError(_(<span class="string">&quot;Instances in cluster did not report &quot;</span></span><br><span class="line">                                   <span class="string">&quot;ACTIVE&quot;</span>))</span><br><span class="line"></span><br><span class="line">            LOG.debug(<span class="string">&quot;All members ready, proceeding for cluster setup.&quot;</span>)</span><br><span class="line">            instances = [Instance.load(context, instance_id) <span class="keyword">for</span> instance_id</span><br><span class="line">                         <span class="keyword">in</span> instance_ids]</span><br><span class="line"></span><br><span class="line">            cluster_ips = [self.get_ip(instance) <span class="keyword">for</span> instance <span class="keyword">in</span> instances]</span><br><span class="line">            instance_guests = []</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Create replication user and password for synchronizing the</span></span><br><span class="line">            <span class="comment"># galera cluster</span></span><br><span class="line">            replication_user = &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: self.CLUSTER_REPLICATION_USER,</span><br><span class="line">                <span class="string">&quot;password&quot;</span>: utils.generate_random_password(),</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Galera cluster name must be unique and be shorter than a full</span></span><br><span class="line">            <span class="comment"># uuid string so we remove the hyphens and chop it off. It was</span></span><br><span class="line">            <span class="comment"># recommended to be 16 chars or less.</span></span><br><span class="line">            <span class="comment"># (this is not currently documented on Galera docs)</span></span><br><span class="line">            cluster_name = utils.generate_uuid().replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>)[:<span class="number">16</span>]</span><br><span class="line"></span><br><span class="line">            LOG.debug(<span class="string">&quot;Configuring cluster configuration.&quot;</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># Set the admin password for all the instances because the</span></span><br><span class="line">                <span class="comment"># password in the my.cnf will be wrong after the joiner</span></span><br><span class="line">                <span class="comment"># instances syncs with the donor instance.</span></span><br><span class="line">                admin_password = str(utils.generate_random_password())</span><br><span class="line"></span><br><span class="line">                bootstrap = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">for</span> instance <span class="keyword">in</span> instances:</span><br><span class="line">                    guest = self.get_guest(instance)</span><br><span class="line">                    instance_guests.append(guest)</span><br><span class="line">                    guest.reset_admin_password(admin_password)</span><br><span class="line">                    <span class="comment"># render the conf.d/cluster.cnf configuration</span></span><br><span class="line">                    cluster_configuration = self._render_cluster_config(</span><br><span class="line">                        context,</span><br><span class="line">                        instance,</span><br><span class="line">                        <span class="string">&quot;,&quot;</span>.join(cluster_ips),</span><br><span class="line">                        cluster_name,</span><br><span class="line">                        replication_user)</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># push the cluster config and bootstrap the first instance</span></span><br><span class="line">                    guest.install_cluster(replication_user,</span><br><span class="line">                                          cluster_configuration,</span><br><span class="line">                                          bootstrap)</span><br><span class="line">                    bootstrap = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">                LOG.debug(<span class="string">&quot;Finalizing cluster configuration.&quot;</span>)</span><br><span class="line">                <span class="keyword">for</span> guest <span class="keyword">in</span> instance_guests:</span><br><span class="line">                    guest.cluster_complete()</span><br><span class="line">            <span class="keyword">except</span> Exception:</span><br><span class="line">                LOG.exception(<span class="string">&quot;Error creating cluster.&quot;</span>)</span><br><span class="line">                self.update_statuses_on_failure(cluster_id)</span><br><span class="line"></span><br><span class="line">        timeout = Timeout(CONF.cluster_usage_timeout)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            _create_cluster()</span><br><span class="line">            self.reset_task()</span><br><span class="line">        <span class="keyword">except</span> Timeout <span class="keyword">as</span> t:</span><br><span class="line">            <span class="keyword">if</span> t <span class="keyword">is</span> <span class="keyword">not</span> timeout:</span><br><span class="line">                <span class="keyword">raise</span>  <span class="comment"># not my timeout</span></span><br><span class="line">            LOG.exception(<span class="string">&quot;Timeout for building cluster.&quot;</span>)</span><br><span class="line">            self.update_statuses_on_failure(cluster_id)</span><br><span class="line">        <span class="keyword">except</span> TroveError:</span><br><span class="line">            LOG.exception(<span class="string">&quot;Error creating cluster %s.&quot;</span>, cluster_id)</span><br><span class="line">            self.update_statuses_on_failure(cluster_id)</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            timeout.cancel()</span><br><span class="line"></span><br><span class="line">        LOG.debug(<span class="string">&quot;End create_cluster for id: %s.&quot;</span>, cluster_id)</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>taskmanager依次做了以下几件事情：</p><ol><li>根据cluster id，定位到集群内所有的instance。</li><li>检测所有instance状态是否为ACTIVE。</li><li>生成集群配置信息。</li><li>依次调用各个instance内的guest agent，更新集群配置信息，并启动第一个节点。</li><li>更新集群状态。</li></ol><p>到这里，所有流程就走完了。为了更深一步了解trove，这里我们继续深入实例，研究instance内guest agent操作，具体干了哪些事情，首先从guest agent启动代码入手，看guest agent如何响应rpc调用，源码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># trove.cmd.guest</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> oslo_config <span class="keyword">import</span> cfg <span class="keyword">as</span> openstack_cfg</span><br><span class="line"><span class="keyword">from</span> oslo_log <span class="keyword">import</span> log <span class="keyword">as</span> logging</span><br><span class="line"><span class="keyword">from</span> oslo_service <span class="keyword">import</span> service <span class="keyword">as</span> openstack_service</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> trove.common <span class="keyword">import</span> cfg</span><br><span class="line"><span class="keyword">from</span> trove.common <span class="keyword">import</span> debug_utils</span><br><span class="line"><span class="keyword">from</span> trove.common.i18n <span class="keyword">import</span> _</span><br><span class="line"><span class="keyword">from</span> trove.guestagent <span class="keyword">import</span> api <span class="keyword">as</span> guest_api</span><br><span class="line"></span><br><span class="line">CONF = cfg.CONF</span><br><span class="line"><span class="comment"># The guest_id opt definition must match the one in common/cfg.py</span></span><br><span class="line">CONF.register_opts([openstack_cfg.StrOpt(<span class="string">&#x27;guest_id&#x27;</span>, default=<span class="literal">None</span>,</span><br><span class="line">                                         help=<span class="string">&quot;ID of the Guest Instance.&quot;</span>),</span><br><span class="line">                    openstack_cfg.StrOpt(<span class="string">&#x27;instance_rpc_encr_key&#x27;</span>,</span><br><span class="line">                                         help=(<span class="string">&#x27;Key (OpenSSL aes_cbc) for &#x27;</span></span><br><span class="line">                                               <span class="string">&#x27;instance RPC encryption.&#x27;</span>))])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    cfg.parse_args(sys.argv)</span><br><span class="line">    logging.setup(CONF, <span class="literal">None</span>)</span><br><span class="line">    debug_utils.setup()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> trove.guestagent <span class="keyword">import</span> dbaas</span><br><span class="line">    manager = dbaas.datastore_registry().get(CONF.datastore_manager)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> manager:</span><br><span class="line">        msg = (_(<span class="string">&quot;Manager class not registered for datastore manager %s&quot;</span>) %</span><br><span class="line">               CONF.datastore_manager)</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(msg)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> CONF.guest_id:</span><br><span class="line">        msg = (_(<span class="string">&quot;The guest_id parameter is not set. guest_info.conf &quot;</span></span><br><span class="line">               <span class="string">&quot;was not injected into the guest or not read by guestagent&quot;</span>))</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(msg)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># BUG(1650518): Cleanup in the Pike release</span></span><br><span class="line">    <span class="comment"># make it fatal if CONF.instance_rpc_encr_key is None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># rpc module must be loaded after decision about thread monkeypatching</span></span><br><span class="line">    <span class="comment"># because if thread module is not monkeypatched we can&#x27;t use eventlet</span></span><br><span class="line">    <span class="comment"># executor from oslo_messaging library.</span></span><br><span class="line">    <span class="keyword">from</span> trove <span class="keyword">import</span> rpc</span><br><span class="line">    rpc.init(CONF)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> trove.common.rpc <span class="keyword">import</span> service <span class="keyword">as</span> rpc_service</span><br><span class="line">    server = rpc_service.RpcService(</span><br><span class="line">        key=CONF.instance_rpc_encr_key,</span><br><span class="line">        topic=<span class="string">&quot;guestagent.%s&quot;</span> % CONF.guest_id,</span><br><span class="line">        manager=manager, host=CONF.guest_id,</span><br><span class="line">        rpc_api_version=guest_api.API.API_LATEST_VERSION)</span><br><span class="line"></span><br><span class="line">    launcher = openstack_service.launch(CONF, server, restart_method=<span class="string">&#x27;mutate&#x27;</span>)</span><br><span class="line">    launcher.wait()</span><br></pre></td></tr></table></figure><p>guest agent启动流程中，做了如下几件事：</p><ol><li><p>从<code>trove.guestagent.dbaas</code>中到manager入口函数，找到符合的datastore_manager。</p></li><li><p>将datastore_manager注册进rpcservice内，远程调用时接收到指定的rpc操作后，即可触发manager对应的方法。</p></li></ol><p>这里我们看下<code>trove.guestagent.dbaas</code>注册了哪些入口，源码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># trove.guestagent.dbaas</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Handles all processes within the Guest VM, considering it as a Platform</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The :py:class:`GuestManager` class is a :py:class:`nova.manager.Manager` that</span></span><br><span class="line"><span class="string">handles RPC calls relating to Platform specific operations.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">**Related Flags**</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> oslo_log <span class="keyword">import</span> log <span class="keyword">as</span> logging</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> trove.common <span class="keyword">import</span> cfg</span><br><span class="line"><span class="keyword">from</span> trove.common.i18n <span class="keyword">import</span> _</span><br><span class="line"><span class="keyword">from</span> trove.common <span class="keyword">import</span> utils</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LOG = logging.getLogger(__name__)</span><br><span class="line">defaults = &#123;</span><br><span class="line">    <span class="string">&#x27;mysql&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;trove.guestagent.datastore.mysql.manager.Manager&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;percona&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;trove.guestagent.datastore.experimental.percona.manager.Manager&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;pxc&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;trove.guestagent.datastore.experimental.pxc.manager.Manager&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;redis&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;trove.guestagent.datastore.experimental.redis.manager.Manager&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;cassandra&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;trove.guestagent.datastore.experimental.cassandra.manager.Manager&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;couchbase&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;trove.guestagent.datastore.experimental.couchbase.manager.Manager&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;mongodb&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;trove.guestagent.datastore.experimental.mongodb.manager.Manager&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;postgresql&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;trove.guestagent.datastore.experimental.postgresql.manager.Manager&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;couchdb&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;trove.guestagent.datastore.experimental.couchdb.manager.Manager&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;vertica&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;trove.guestagent.datastore.experimental.vertica.manager.Manager&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;db2&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;trove.guestagent.datastore.experimental.db2.manager.Manager&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;mariadb&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;trove.guestagent.datastore.experimental.mariadb.manager.Manager&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">datastore_registry</span>():</span></span><br><span class="line">    <span class="keyword">return</span> dict(chain(defaults.items(),</span><br><span class="line">                get_custom_managers().items()))</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>dbaas内我们可以到所有数据库的入口函数，即可根据rpc的消息类型，找到对应的入口，对应的影响函数了。回到taskmanager发消息的流程，taskmanager调用guest内的install_cluster方法，我们看下install_cluster的方法，源码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># trove.common.strategies.cluster.experimental.galera_common.guestagent</span></span><br><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GaleraCommonGuestAgentAPI</span>(<span class="params">guest_api.API</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Cluster Specific Datastore Guest API</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    **** VERSION CONTROLLED API ****</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    The methods in this class are subject to version control as</span></span><br><span class="line"><span class="string">    coordinated by guestagent/api.py.  Whenever a change is made to</span></span><br><span class="line"><span class="string">    any API method in this class, add a version number and comment</span></span><br><span class="line"><span class="string">    to the top of guestagent/api.py and use the version number as</span></span><br><span class="line"><span class="string">    appropriate in this file</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install_cluster</span>(<span class="params">self, replication_user, cluster_configuration,</span></span></span><br><span class="line"><span class="function"><span class="params">                        bootstrap</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Install the cluster.&quot;&quot;&quot;</span></span><br><span class="line">        LOG.debug(<span class="string">&quot;Installing Galera cluster.&quot;</span>)</span><br><span class="line">        version = guest_api.API.API_BASE_VERSION</span><br><span class="line"></span><br><span class="line">        self._call(<span class="string">&quot;install_cluster&quot;</span>, CONF.cluster_usage_timeout,</span><br><span class="line">                   version=version,</span><br><span class="line">                   replication_user=replication_user,</span><br><span class="line">                   cluster_configuration=cluster_configuration,</span><br><span class="line">                   bootstrap=bootstrap)</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>向guest发送了一个同步调用的rpc请求（<code>_call</code>为同步调用，<code>_cast</code>为异步调用），触发<code>install_cluster</code>方法，这里我们从manager入手，看下install_cluster具体干了哪些事情，源码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># trove.guestagent.datastore.galera_common.manager</span></span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install_cluster</span>(<span class="params">self, context, replication_user, cluster_configuration,</span></span></span><br><span class="line"><span class="function"><span class="params">                        bootstrap</span>):</span></span><br><span class="line">        app = self.mysql_app(self.mysql_app_status.get())</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            app.install_cluster(</span><br><span class="line">                replication_user, cluster_configuration, bootstrap)</span><br><span class="line">            LOG.debug(<span class="string">&quot;install_cluster call has finished.&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            LOG.exception(<span class="string">&#x27;Cluster installation failed.&#x27;</span>)</span><br><span class="line">            app.status.set_status(</span><br><span class="line">                rd_instance.ServiceStatuses.FAILED)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>这里，实际上就调用了service内对应的install_cluster方法，做了些异常判断，进入service内，看下具体干了那些事，源码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># trove.guestagent.datastore.galera_common.service</span></span><br><span class="line">...</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GaleraApp</span>(<span class="params">service.BaseMySqlApp</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, status, local_sql_client, keep_alive_connection_cls</span>):</span></span><br><span class="line">        super(GaleraApp, self).__init__(status, local_sql_client,</span><br><span class="line">                                        keep_alive_connection_cls)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">install_cluster</span>(<span class="params">self, replication_user, cluster_configuration,</span></span></span><br><span class="line"><span class="function"><span class="params">                        bootstrap=False</span>):</span></span><br><span class="line">        LOG.info(<span class="string">&quot;Installing cluster configuration.&quot;</span>)</span><br><span class="line">        self._grant_cluster_replication_privilege(replication_user)</span><br><span class="line">        self.stop_db()</span><br><span class="line">        self.write_cluster_configuration_overrides(cluster_configuration)</span><br><span class="line">        self.wipe_ib_logfiles()</span><br><span class="line">        LOG.debug(<span class="string">&quot;bootstrap the instance? : %s&quot;</span>, bootstrap)</span><br><span class="line">        <span class="comment"># Have to wait to sync up the joiner instances with the donor instance.</span></span><br><span class="line">        <span class="keyword">if</span> bootstrap:</span><br><span class="line">            self._bootstrap_cluster(timeout=CONF.restore_usage_timeout)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.start_mysql(timeout=CONF.restore_usage_timeout)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_grant_cluster_replication_privilege</span>(<span class="params">self, replication_user</span>):</span></span><br><span class="line">        LOG.info(<span class="string">&quot;Granting Replication Slave privilege.&quot;</span>)</span><br><span class="line">        <span class="keyword">with</span> self.local_sql_client(self.get_engine()) <span class="keyword">as</span> client:</span><br><span class="line">            perms = [<span class="string">&#x27;REPLICATION CLIENT&#x27;</span>, <span class="string">&#x27;RELOAD&#x27;</span>, <span class="string">&#x27;LOCK TABLES&#x27;</span>]</span><br><span class="line">            g = sql_query.Grant(permissions=perms,</span><br><span class="line">                                user=replication_user[<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">                                clear=replication_user[<span class="string">&#x27;password&#x27;</span>])</span><br><span class="line">            t = text(str(g))</span><br><span class="line">            client.execute(t)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write_cluster_configuration_overrides</span>(<span class="params">self, cluster_configuration</span>):</span></span><br><span class="line">        self.configuration_manager.apply_system_override(</span><br><span class="line">            cluster_configuration, <span class="string">&#x27;cluster&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_bootstrap_cluster</span>(<span class="params">self, timeout=<span class="number">120</span></span>):</span></span><br><span class="line">        LOG.info(<span class="string">&quot;Bootstraping cluster.&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            utils.execute_with_timeout(</span><br><span class="line">                self.mysql_service[<span class="string">&#x27;cmd_bootstrap_galera_cluster&#x27;</span>],</span><br><span class="line">                shell=<span class="literal">True</span>, timeout=timeout)</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            LOG.exception(<span class="string">&quot;Error bootstrapping cluster.&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(_(<span class="string">&quot;Service is not discovered.&quot;</span>))</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>这里就是各实例内的具体操作流程了，流程如下：</p><ol><li>对集群内各实例赋权。</li><li>停止数据库服务。</li><li>更新MySQL配置文件。</li><li>删除ib_logfiles。</li><li>首节点为启动集群方式启动，其余节点直接启动mysql即可。</li></ol><p>到这里，MySQL集群创建流程即全部解析完成。</p><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://docs.openstack.org/api-ref/database/">OpenStack Documentation: Database API</a></li><li><a href="https://docs.openstack.org/trove/wallaby/install/index.html">OpenStack Documentation: Database Service</a></li><li><a href="https://docs.openstack.org/releasenotes/trove/train.html#relnotes-12-0-0-stable-train">OpenStack Documentation: Trove Release Notes</a></li><li><a href="https://opendev.org/openstack/trove">OpenDev: OpenStack Trove</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;对程序员来说，最好的文档就是源码。Trove 官方对于&lt;strong&gt;Clueter Controller&lt;/strong&gt;能力的描述文档不</summary>
      
    
    
    
    <category term="OpenStack" scheme="https://renyb2.github.io/categories/OpenStack/"/>
    
    
    <category term="OpenStack" scheme="https://renyb2.github.io/tags/OpenStack/"/>
    
    <category term="Trove" scheme="https://renyb2.github.io/tags/Trove/"/>
    
  </entry>
  
  <entry>
    <title>性能测试工具：Sysbench</title>
    <link href="https://renyb2.github.io/2021/12/24/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7%EF%BC%9ASysbench/"/>
    <id>https://renyb2.github.io/2021/12/24/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7%EF%BC%9ASysbench/</id>
    <published>2021-12-24T05:49:58.000Z</published>
    <updated>2022-05-10T07:06:32.039Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>源码地址：<a href="https://github.com/akopytov/sysbench">https://github.com/akopytov/sysbench</a></p><blockquote><p>sysbench is a scriptable multi-threaded benchmark tool based on LuaJIT. It is most frequently used for database benchmarks, but can also be used to create arbitrarily complex workloads that do not involve a database server.</p><p>sysbench comes with the following bundled benchmarks:</p><ul><li><code>oltp_*.lua</code>: a collection of OLTP-like database benchmarks</li><li><code>fileio</code>: a filesystem-level benchmark</li><li><code>cpu</code>: a simple CPU benchmark</li><li><code>memory</code>: a memory access benchmark</li><li><code>threads</code>: a thread-based scheduler benchmark</li><li><code>mutex</code>: a POSIX mutex benchmark</li></ul><p><strong>Features</strong></p><ul><li>extensive statistics about rate and latency is available, including latency percentiles and histograms;</li><li>low overhead even with thousands of concurrent threads. sysbench is capable of generating and tracking hundreds of millions of events per second;</li><li>new benchmarks can be easily created by implementing pre-defined hooks in user-provided Lua scripts;</li><li>can be used as a general-purpose Lua interpreter as well, simply replace <code>#!/usr/bin/lua</code> with <code>#!/usr/bin/sysbench</code> in your script.</li></ul></blockquote><p>简单的说，sysbench是一个基于Lua即时编译器（<a href="http://luajit.org/luajit.html">http://luajit.org/luajit.html</a> ）实现的多线程基准测试工具。它被频繁用于数据库基准测试，除此之外，它也可以被用于进行其他复杂的负载测试，比如fileio，cpu，memory等。</p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>本文以“sysbench-1.0.20”版本为例，下载源码，并编译安装。</p><ol><li>下载地址：<ul><li>sysbench源码：<a href="https://github.com/akopytov/sysbench/releases">https://github.com/akopytov/sysbench/releases</a></li></ul></li><li>安装sysbench的依赖包。</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install gcc gcc-c++ automake make libtool mariadb-devel -y</span><br></pre></td></tr></table></figure><ol start="3"><li>下载并安装sysbench。</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载sysbench源码</span></span><br><span class="line">wget https://github.com/akopytov/sysbench/archive/refs/tags/1.0.20.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 解压</span></span><br><span class="line">mv 1.0.20.tar.gz sysbench-1.0.20.tar.gz</span><br><span class="line">tar zxvf sysbench-1.0.20.tar.gz &amp;&amp; cd sysbench-1.0.20</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置及生成编译文件</span></span><br><span class="line">./autogen.sh &amp;&amp; ./configure</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译并安装</span></span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证sysbench</span></span><br><span class="line">sysbench --version</span><br></pre></td></tr></table></figure><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="CPU性能测试"><a href="#CPU性能测试" class="headerlink" title="CPU性能测试"></a>CPU性能测试</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 10秒钟CPU素数计算次数</span></span><br><span class="line">sysbench cpu --cpu-max-prime=20000 --threads=1 run</span><br></pre></td></tr></table></figure><h3 id="内存性能测试"><a href="#内存性能测试" class="headerlink" title="内存性能测试"></a>内存性能测试</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 内存顺序：10秒钟，内存顺序访问次数与速度</span></span><br><span class="line">sysbench memory --threads=1 --memory-block-size=8K --memory-total-size=200G --memory-access-mode=seq run</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 内存随机：10秒钟，内存随机访问次数与速度</span></span><br><span class="line">sysbench memory --threads=1 --memory-block-size=8K --memory-total-size=200G --memory-access-mode=rnd run</span><br></pre></td></tr></table></figure><h3 id="存储性能测试"><a href="#存储性能测试" class="headerlink" title="存储性能测试"></a>存储性能测试</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">fileio options:</span><br><span class="line">  --file-num=N                  number of files to create [128]</span><br><span class="line">  --file-block-size=N           block size to use in all IO operations [16384]</span><br><span class="line">  --file-total-size=SIZE        total size of files to create [2G]</span><br><span class="line">  --file-test-mode=STRING       test mode &#123;seqwr, seqrewr, seqrd, rndrd, rndwr, rndrw&#125;</span><br><span class="line">  --file-io-mode=STRING         file operations mode &#123;sync,async,mmap&#125; [sync]</span><br><span class="line">  --file-extra-flags=[LIST,...] list of additional flags to use to open files &#123;sync,dsync,direct&#125; []</span><br><span class="line">  --file-fsync-freq=N           do fsync() after this number of requests (0 - don&#x27;t use fsync()) [100]</span><br><span class="line">  --file-fsync-all[=on|off]     do fsync() after each write operation [off]</span><br><span class="line">  --file-fsync-end[=on|off]     do fsync() at the end of test [on]</span><br><span class="line">  --file-fsync-mode=STRING      which method to use for synchronization &#123;fsync, fdatasync&#125; [fsync]</span><br><span class="line">  --file-merged-requests=N      merge at most this number of IO requests if possible (0 - don&#x27;t merge) [0]</span><br><span class="line">  --file-rw-ratio=N             reads/writes ratio for combined test [1.5]</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 加载4k测试数据</span></span><br><span class="line">sysbench fileio --threads=1 --file-block-size=4k --file-total-size=20G --file-test-mode=rndrw prepare</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 随机读</span></span><br><span class="line">sysbench fileio --threads=1 --file-block-size=4k --file-total-size=20G --time=60 --file-test-mode=rndrd run</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 随机写</span></span><br><span class="line">sysbench fileio --threads=1 --file-block-size=4k --file-total-size=20G --time=60 --file-test-mode=rndwr run</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 加载1M测试数据</span></span><br><span class="line">sysbench fileio --threads=1 --file-block-size=1M --file-total-size=20G --file-test-mode=rndrw prepare</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 顺序读</span></span><br><span class="line">sysbench fileio --threads=1 --file-block-size=1M --file-total-size=20G --time=60 --file-test-mode=seqrd run</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 顺序写</span></span><br><span class="line">sysbench fileio --threads=1 --file-block-size=1M --file-total-size=20G --time=60 --file-test-mode=seqwr run</span><br></pre></td></tr></table></figure><h3 id="MySQL性能测试"><a href="#MySQL性能测试" class="headerlink" title="MySQL性能测试"></a>MySQL性能测试</h3><p>参考本博客文档：《MySQL测试：性能基准测试》</p><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://github.com/akopytov/sysbench">Github：sysbench</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;源码地址：&lt;a href=&quot;https://github.com/akopytov/sysbench&quot;&gt;https://github.com</summary>
      
    
    
    
    <category term="性能测试工具" scheme="https://renyb2.github.io/categories/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="Sysbench" scheme="https://renyb2.github.io/tags/Sysbench/"/>
    
  </entry>
  
  <entry>
    <title>Windows使用：通用手册</title>
    <link href="https://renyb2.github.io/2021/11/29/Windows%E4%BD%BF%E7%94%A8%EF%BC%9A%E9%80%9A%E7%94%A8%E6%89%8B%E5%86%8C/"/>
    <id>https://renyb2.github.io/2021/11/29/Windows%E4%BD%BF%E7%94%A8%EF%BC%9A%E9%80%9A%E7%94%A8%E6%89%8B%E5%86%8C/</id>
    <published>2021-11-29T01:27:37.000Z</published>
    <updated>2021-12-24T10:10:41.988Z</updated>
    
    <content type="html"><![CDATA[<h2 id="常见场景"><a href="#常见场景" class="headerlink" title="常见场景"></a>常见场景</h2><h3 id="远程登录"><a href="#远程登录" class="headerlink" title="远程登录"></a>远程登录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mstsc</span><br></pre></td></tr></table></figure><h3 id="计算MD5"><a href="#计算MD5" class="headerlink" title="计算MD5"></a>计算MD5</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">certutil -hashfile  &lt;文件名&gt;  &lt;hash类型&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成MD5</span></span><br><span class="line">certutil -hashfile demo.txt MD5</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成SHA1</span></span><br><span class="line">certutil -hashfile demo.txt SHA1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成SHA256</span></span><br><span class="line">certutil -hashfile demo.txt SHA256</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成SHA512</span></span><br><span class="line">certutil -hashfile demo.txt SHA512</span><br></pre></td></tr></table></figure><h3 id="网卡MTU管理"><a href="#网卡MTU管理" class="headerlink" title="网卡MTU管理"></a>网卡MTU管理</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看各网卡MTU值</span></span><br><span class="line">netsh interface ipv4 show subinterfaces</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改指定网卡MTU值</span></span><br><span class="line">netsh interface ipv4 set subinterface &lt;interface_name&gt; mtu=&lt;value&gt; store=persistent </span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;常见场景&quot;&gt;&lt;a href=&quot;#常见场景&quot; class=&quot;headerlink&quot; title=&quot;常见场景&quot;&gt;&lt;/a&gt;常见场景&lt;/h2&gt;&lt;h3 id=&quot;远程登录&quot;&gt;&lt;a href=&quot;#远程登录&quot; class=&quot;headerlink&quot; title=&quot;远程登录&quot;&gt;&lt;/a</summary>
      
    
    
    
    <category term="Windows" scheme="https://renyb2.github.io/categories/Windows/"/>
    
    
    <category term="通用手册" scheme="https://renyb2.github.io/tags/%E9%80%9A%E7%94%A8%E6%89%8B%E5%86%8C/"/>
    
    <category term="Windows" scheme="https://renyb2.github.io/tags/Windows/"/>
    
  </entry>
  
</feed>
