<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Renyb の 小窝</title>
  
  <subtitle>Welcome to my blog...</subtitle>
  <link href="https://renyb2.github.io/atom.xml" rel="self"/>
  
  <link href="https://renyb2.github.io/"/>
  <updated>2023-03-06T09:00:34.862Z</updated>
  <id>https://renyb2.github.io/</id>
  
  <author>
    <name>Renyb</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Libvirt研发：VirtIO GPU</title>
    <link href="https://renyb2.github.io/2023/02/24/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AVirtIO-GPU/"/>
    <id>https://renyb2.github.io/2023/02/24/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AVirtIO-GPU/</id>
    <published>2023-02-24T08:15:34.000Z</published>
    <updated>2023-03-06T09:00:34.862Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>随着AI与云应用的发展，逐渐对GPU的图形算力提出了更高的要求。工业级的GPU卡单卡性能很高，直接提供给某一个虚机或者程序使用，很容易造成资源的浪费，如何灵活的利用GPU算力成为各厂商的需求，因此各种GPU虚拟化方案便应运而生。</p><p>目前主流的GPU虚拟化方案主要有以下三个方向：</p><ul><li><p>Mediated Pass-Through方向，该方向主要由NVIDIA推进，NVIDIA的GRID vGPU为NVIDIA提供的源生能力，通过NVIDIA vGPU驱动实现显存及算力的切分，根据vGPU的类型可选择启用不同的切分模型。</p></li><li><p>API Forwarding方向，该方向主要的方案有vCUDA、rCUDA等，主要应用于容器场景，通过CUDA层API的拦截与转发，将程序的GPU请求转发至GPU卡处理。</p></li><li><p>Device Emulation方向，该方向主要应用于虚拟化场景，通过虚拟层对GPU的模拟，配合物理GPU硬件，实现GPU能力的透传。</p></li></ul><p>各方案的具体性能水平如下：</p><img src= "/img/loading.gif" data-lazy-src="/2023/02/24/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AVirtIO-GPU/GPU虚拟化方案性能对比.png" title alt data-align="center"><p>本文主要介绍Device Emulation方向中的VirtIO GPU方案实现，主要从原理及部署实操角度进行介绍。文末附有GPU虚拟化技术的所有参考文档，感兴趣的同学可以深入学习研究。</p><h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><img src= "/img/loading.gif" data-lazy-src="/2023/02/24/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AVirtIO-GPU/Collabora_Virtualized-OpenGL-Stack.png" title alt data-align="center"><p>There are a few parts to this implementation.</p><p>QEMU, virglrenderer and virtio-gpu. The way it works is by letting the guest applications speak unmodified OpenGL to the Mesa. But instead of Mesa handing commands over to the hardware it is channeled through virtio-gpu on the guest to QEMU on the host.</p><p>QEMU then receives the raw graphics stack state (Gallium state) and interprets it using virglrenderer from the raw state into an OpenGL form, which can be executed as entirely normal OpenGL on the host machine.</p><p>The host OpenGL stack does not even have to be Mesa, and could for example be the proprietary nvidia stack.</p><h2 id="部署流程"><a href="#部署流程" class="headerlink" title="部署流程"></a>部署流程</h2><h3 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h3><ul><li><p>CPU：Intel(R) Xeon(R) Silver 4210 CPU @ 2.20GHz</p></li><li><p>GPU：NVIDIA Corporation TU104GL [Tesla T4] [10de:1eb8]</p></li><li><p>Kernel：5.4.134-1.el7.elrepo.x86_64</p></li><li><p>OS：CentOS Linux release 7.8.2003 (Core)</p></li><li><p>Python：3.6.8</p></li><li><p>GCC：4.8.5</p></li><li><p>Qemu：4.2.0</p></li><li><p>Libvirt：5.9.0</p></li></ul><h3 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装开发套件（非必要安装，可后面缺啥补啥）</span></span><br><span class="line">sudo yum -y groupinstall Development</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装meson编译构建工具</span></span><br><span class="line">pip3 install meson</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装ninja编译构建工具</span></span><br><span class="line">wget https://github.com/ninja-build/ninja/releases/download/v1.11.1/ninja-linux.zip</span><br><span class="line">unzip ninja-linux.zip &amp;&amp; cp ninja /usr/bin/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装GCC 8.xx版本（系统自带的GCC 4.xx无法满足编译需求）</span></span><br><span class="line">sudo yum -y install centos-release-scl</span><br><span class="line">sudo yum -y install devtoolset-8-gcc*</span><br><span class="line">scl enable devtoolset-8 bash</span><br><span class="line">gcc -v</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装编译依赖包</span></span><br><span class="line">sudo yum install -y cmake ninja-build</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装libepoxy依赖包</span></span><br><span class="line">sudo yum -y install libX11-devel mesa-libEGL mesa-libEGL-devel</span><br></pre></td></tr></table></figure><h3 id="编译Libepoxy"><a href="#编译Libepoxy" class="headerlink" title="编译Libepoxy"></a>编译Libepoxy</h3><p>libepoxy is a library for managing OpenGL function pointers for you. And it is a dependency of virglrenderer, which we’ll get to below.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/anholt/libepoxy.git</span><br><span class="line"></span><br><span class="line">cd libepoxy &amp;&amp; mkdir _build &amp;&amp; cd _build</span><br><span class="line">meson --prefix=/usr</span><br><span class="line">ninja</span><br><span class="line">sudo ninja install</span><br></pre></td></tr></table></figure><h3 id="编译Virglrender"><a href="#编译Virglrender" class="headerlink" title="编译Virglrender"></a>编译Virglrender</h3><p>Virgilrenderer is the component that QEMU uses to provide accelerated rendering.<br>It receives Gallium states from the guest kernel via its virtio-gpu interface, which are then translated into OpenGL on the host. It also translates shaders from the TGSI format used by Gallium into the GLSL format used by OpenGL.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone git://anongit.freedesktop.org/virglrenderer</span><br><span class="line"></span><br><span class="line">cd virglrenderer &amp;&amp; mkdir _build &amp;&amp; cd _build</span><br><span class="line">meson --prefix=/usr</span><br><span class="line">ninja</span><br><span class="line">sudo ninja install</span><br></pre></td></tr></table></figure><h3 id="编译Qemu"><a href="#编译Qemu" class="headerlink" title="编译Qemu"></a>编译Qemu</h3><p>虚拟化层需要启用VirGLRenderer与OpenGL能力，默认rpm安装为关闭状态，这里需要下载源码后重新编译。常见的编译问题可参考文档《Libvirt研发：Qemu编译》。</p><p>这里版本选择的是4.2.0，测试过以下两个版本的Qemu，均存在一些问题：</p><ul><li><p>2.12.0版本，编译可以成功，但是拉起虚机时会报unsupported configuration: This QEMU doesn’t support OpenGL rendernode with egl-headless graphics type。</p></li><li><p>7.2.0版本，由于该版本编译需要的C环境与CentOS 7.8差异较大，编译无法通过。</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget https://download.qemu.org/qemu-4.2.0.tar.xz --no-check-certificate</span><br><span class="line"></span><br><span class="line">../configure --target-list=x86_64-softmmu --enable-kvm \</span><br><span class="line">    --enable-spice --enable-vnc --enable-guest-agent \</span><br><span class="line">    --enable-rbd --enable-seccomp --enable-numa \</span><br><span class="line">    --enable-virglrenderer --enable-opengl \</span><br><span class="line">    --disable-glusterfs</span><br></pre></td></tr></table></figure><h3 id="Libvirt-Domain-XML"><a href="#Libvirt-Domain-XML" class="headerlink" title="Libvirt Domain XML"></a>Libvirt Domain XML</h3><p>需要将虚机XML文件中关于graphics与video片段调整为如下内容，主要改动点有：</p><ul><li><p>graphics协议调整为spice协议</p></li><li><p>graphics启动egl-headless，用于OpenGL的支持，来使用本地设备进行3D加速。</p><blockquote><p><a href="https://libvirt.org/formatdomain.html">Libvirt官方文档</a>介绍内容如下：</p><p>This display type provides support for an OpenGL accelerated display accessible both locally and remotely (for comparison, Spice’s native OpenGL support only works locally using UNIX sockets at the moment, but has better performance). Since this display type doesn’t provide any window or graphical console like the other types, for practical reasons it should be paired with either vnc or spice graphics types. This display type is only supported by QEMU domains (needs QEMU 2.10 or newer). 5.0.0 this element accepts a <gl> sub-element with an optional attribute rendernode which can be used to specify an absolute path to a host’s DRI device to be used for OpenGL rendering.</gl></p></blockquote></li><li><p>video devices类型使用virtio，启用accel3d能力。</p></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">graphics</span> <span class="attr">type</span>=<span class="string">&#x27;spice&#x27;</span> <span class="attr">autoport</span>=<span class="string">&#x27;yes&#x27;</span> <span class="attr">listen</span>=<span class="string">&#x27;0.0.0.0&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">listen</span> <span class="attr">type</span>=<span class="string">&#x27;address&#x27;</span> <span class="attr">address</span>=<span class="string">&#x27;0.0.0.0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">graphics</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">graphics</span> <span class="attr">type</span>=<span class="string">&#x27;egl-headless&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">gl</span> <span class="attr">rendernode</span>=<span class="string">&#x27;/dev/dri/renderD128&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">graphics</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span> <span class="attr">heads</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">primary</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">acceleration</span> <span class="attr">accel3d</span>=<span class="string">&#x27;yes&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">model</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x01&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br></pre></td></tr></table></figure><p>虚机最终运行的Qemu命令如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/qemu-system-x86_64 -name guest=instance-00000012,debug-threads=on \</span><br><span class="line">  -S -object secret,id=masterKey0,format=raw,file=/var/lib/libvirt/qemu/domain-55-instance-00000012/master-key.aes \</span><br><span class="line">  -machine pc-q35-2.12,accel=kvm,usb=off,dump-guest-core=off \</span><br><span class="line">  -cpu Cascadelake-Server,ss=on,vmx=on,hypervisor=off,tsc-adjust=on,umip=on,pku=on,md-clear=on,stibp=on,arch-capabilities=on,xsaves=on,ibpb=on,amd-ssbd=on,rdctl-no=on,ibrs-all=on,skip-l1dfl-vmentry=on,mds-no=off,kvm=off \</span><br><span class="line">  -m 8192 -overcommit mem-lock=off -smp 4,sockets=4,cores=1,threads=1 -uuid f56bfe1f-43ec-42c8-b4a8-7705fd22ff01 \</span><br><span class="line">  -smbios type=1,manufacturer=OpenStack Foundation,product=OpenStack Nova,version=20.3.0,serial=f56bfe1f-43ec-42c8-b4a8-7705fd22ff01,uuid=f56bfe1f-43ec-42c8-b4a8-7705fd22ff01,family=Virtual Machine \</span><br><span class="line">  -no-user-config -nodefaults -chardev socket,id=charmonitor,fd=43,server,nowait -mon chardev=charmonitor,id=monitor,mode=control \</span><br><span class="line">  -rtc base=utc,driftfix=slew -global kvm-pit.lost_tick_policy=delay -no-hpet -no-shutdown -boot strict=on \</span><br><span class="line">  -device qemu-xhci,id=usb,bus=pci.2,addr=0x0 -device virtio-serial-pci,id=virtio-serial0,bus=pci.3,addr=0x0 \</span><br><span class="line">  -drive file=/var/lib/nova/instances/f56bfe1f-43ec-42c8-b4a8-7705fd22ff01/disk.config,format=raw,if=none,id=drive-sata0-0-0,readonly=on,cache=none,discard=unmap \</span><br><span class="line">  -device ide-cd,bus=ide.0,drive=drive-sata0-0-0,id=sata0-0-0,write-cache=on \</span><br><span class="line">  -object secret,id=virtio-disk0-secret0,data=yNCwz/EwiF7jJ6PbcEdzYkLjqrH9K9rf8dGLsf4CKkA=,keyid=masterKey0,iv=NySICz8lLuVEceJIZjk+Ug==,format=base64 \</span><br><span class="line">  -drive file=rbd:cinder-volumes/7d0fcc10-a094-4acb-8b4f-b4ec3756fb93:id=cinder:auth_supported=cephx\;none:mon_host=111.111.9.104\:6789,file.password-secret=virtio-disk0-secret0,format=raw,if=none,id=drive-virtio-disk0,cache=writeback,discard=unmap \</span><br><span class="line">  -device virtio-blk-pci,scsi=off,bus=pci.4,addr=0x0,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1,write-cache=on,serial=7d0fcc10-a094-4acb-8b4f-b4ec3756fb93 \</span><br><span class="line">  -netdev tap,fd=47,id=hostnet0,vhost=on,vhostfd=48 -device virtio-net-pci,host_mtu=1500,netdev=hostnet0,id=net0,mac=fa:16:3e:5b:9f:f2,bus=pci.1,addr=0x0 \</span><br><span class="line">  -add-fd set=3,fd=50 -chardev pty,id=charserial0,logfile=/dev/fdset/3,logappend=on -device isa-serial,chardev=charserial0,id=serial0 \</span><br><span class="line">  -chardev socket,id=charchannel0,fd=49,server,nowait -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charchannel0,id=channel0,name=org.qemu.guest_agent.0 \</span><br><span class="line">  -device usb-tablet,id=input0,bus=usb.0,port=1 -spice port=5903,addr=0.0.0.0,disable-ticketing,seamless-migration=on \</span><br><span class="line">  -display egl-headless,rendernode=/dev/dri/renderD128 \</span><br><span class="line">  -device virtio-vga,id=video0,virgl=on,max_outputs=1,bus=pcie.0,addr=0x1 \</span><br><span class="line">  -device virtio-balloon-pci,id=balloon0,bus=pci.5,addr=0x0 \</span><br><span class="line">  -sandbox on,obsolete=deny,elevateprivileges=deny,spawn=deny,resourcecontrol=deny -msg timestamp=on</span><br></pre></td></tr></table></figure><h2 id="能力测试"><a href="#能力测试" class="headerlink" title="能力测试"></a>能力测试</h2><p>本次测试使用winserver 2019虚机进行测试，通过检测虚机内DirectX功能启用情况及3D游戏运行情况，来判断虚机是否具备了3D加速能力。</p><h3 id="DirectX功能"><a href="#DirectX功能" class="headerlink" title="DirectX功能"></a>DirectX功能</h3><p>win + r启动运行窗口，输入<code>dxdiag</code>，启动DirectX诊断工具，检测结果显示DirectX功能均已启动。</p><img src= "/img/loading.gif" data-lazy-src="/2023/02/24/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AVirtIO-GPU/DirectX功能检测结果.png" title alt data-align="center"><h3 id="游戏测试"><a href="#游戏测试" class="headerlink" title="游戏测试"></a>游戏测试</h3><p>本次测试使用的游戏为《英雄联盟》，未启用3D能力情况下，无法进入游戏界面。经过VirtIO GPU配置后，可成功打开游戏界面。但目前测试效果并不理想，性能方面还比较卡，无法跟真实的显卡相媲美。</p><img src= "/img/loading.gif" data-lazy-src="/2023/02/24/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AVirtIO-GPU/英雄联盟测试结果.png" title alt data-align="center"><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><h3 id="关键文档"><a href="#关键文档" class="headerlink" title="关键文档"></a>关键文档</h3><ul><li><a href="https://www.collabora.com/news-and-blog/blog/2018/02/12/virtualizing-gpu-access/">Virtualizing GPU Access</a></li></ul><h3 id="技术介绍"><a href="#技术介绍" class="headerlink" title="技术介绍"></a>技术介绍</h3><ul><li><p><a href="https://www.studiopixl.com/2017-08-27/3d-acceleration-using-virtio.html">GSoC 2017 - 3D acceleration using VirtIOGPU</a></p></li><li><p><a href="https://wiki.archlinux.org/title/QEMU/Guest_graphics_acceleration">QEMU/Guest graphics acceleration - ArchWiki</a></p></li><li><p><a href="https://docs.mesa3d.org/drivers/virgl.html">MESA3D - VirGL</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/432215702">Linux图形显示系统之Mesa</a></p></li><li><p><a href="https://en.wikipedia.org/wiki/Direct_Rendering_Manager#Hardware_support">WIKIPEDIA - Direct Rendering Manager</a></p></li><li><p><a href="https://en.wikipedia.org/wiki/Nouveau_(software)">WIKIPEDIA - nouveau (software)</a></p></li><li><p><a href="https://lug.hit.edu.cn/archive/KVM_QEMU_PCIE_PASSTHROUGH.pdf">KVM_QEMU_PCIE_PASSTHROUGH</a></p></li><li><p><a href="https://docs.oasis-open.org/virtio/virtio/v1.1/cs01/virtio-v1.1-cs01.html#x1-3200007">Virtual I/O Device (VIRTIO) Version 1.1</a></p></li><li><p><a href="https://chromium.googlesource.com/chromiumos/platform2/+/9e91613d2da1b3d6cfb1c77681444e688ce99cf4/vm_tools/docs/vsock.md">virtio-vsock</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/486984696">深入理解SR-IOV和IO虚拟化</a></p></li></ul><h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><ul><li><a href="https://frankhashope.github.io/virtualization/virtio_vga_and_virtio_gpu/#:~:text=virtio-vga%E4%B8%8Evirtio-gpu%E6%98%AFqemu%E6%A8%A1%E6%8B%9F%E7%9A%84%E8%BE%83%E6%96%B0%E7%9A%84%E6%98%BE%E5%8D%A1%E8%AE%BE%E5%A4%87%EF%BC%8C%E5%AE%83%E4%BB%AC%E9%83%BD%E6%98%AF%E7%94%B1Dave%20Airlie%E7%AD%89%E4%BA%BA%E5%BC%95%E5%85%A5%EF%BC%8C%E9%81%BF%E5%85%8D%E9%80%9A%E8%BF%87%E7%9B%B4%E9%80%9AGPU%E6%9D%A5%E5%8A%A0%E9%80%9F%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%86%85%E9%83%A8%E7%9A%843D%E6%B8%B2%E6%9F%93%E3%80%82,x86%E4%B8%8B%E4%BD%BF%E7%94%A8virtio-vga%EF%BC%8Carm%E4%B8%8B%E4%BD%BF%E7%94%A8virtio-gpu%EF%BC%8Cguest%E9%87%8C%E4%BD%BF%E7%94%A8virtio-gpu%E4%BD%9C%E4%B8%BA%E5%89%8D%E7%AB%AF%E9%A9%B1%E5%8A%A8%E3%80%82%20x86%E4%B8%8B%E5%A6%82%E6%9E%9CGuest%20OS%E4%B8%AD%E6%B2%A1%E6%9C%89virtio-gpu%E9%A9%B1%E5%8A%A8%EF%BC%8C%E5%88%99%E4%BD%BF%E7%94%A8%E5%85%BC%E5%AE%B9%E7%9A%84%E6%A0%87%E5%87%86vga%E6%A8%A1%E5%BC%8F%E3%80%82">virtio显卡实现分析</a></li><li><a href="https://blog.csdn.net/huang987246510/article/details/107729881">VirtIO GPU基本原理_享乐主的博客-CSDN博客</a></li><li><a href="https://zhuanlan.zhihu.com/p/94420231">Virtio 基本概念和设备操作</a></li><li><a href="https://www.cnblogs.com/edver/p/15874178.html">virtio简介（四）—— 从零实现一个virtio设备 - Edver - 博客园</a></li></ul><h3 id="实操记录"><a href="#实操记录" class="headerlink" title="实操记录"></a>实操记录</h3><ul><li><p><a href="https://blog.csdn.net/huang987246510/article/details/106245900">VirtIO-GPU环境搭建与应用_享乐主的博客-CSDN博客</a></p></li><li><p><a href="https://www.reddit.com/r/VFIO/comments/pmqvwf/some_tips_on_using_virtiogpu_and_nvidia_drivers/">Some tips on using virtio-gpu and nvidia drivers.</a></p></li><li><p><a href="https://nyblnet.blogspot.com/2020/11/virgl-3d-acceleration-on-kvm-with.html">VirGL 3D Acceleration on KVM with LibVirt and Nvidia Drivers</a></p></li><li><p><a href="https://zingmars.info/2018/07/15/Virgl-with-qemu-and-libvirt-on-ubuntu/">Setting up Virgl VMs with QEMU and libvirt on Ubuntu 18.04</a></p></li><li><p><a href="https://ryan.himmelwright.net/post/virtio-3d-vms/">Running VMs with VirtIO 3D Acceleration</a></p></li><li><p><a href="https://www.collabora.com/news-and-blog/blog/2019/08/28/virglrenderer-state-of-virtualized-virtual-worlds/">Virglrenderer and the state of virtualized virtual worlds</a></p></li><li><p><a href="https://www.smslm.com/article/622331.html">virtio-gpu介绍 - 编程小站</a></p></li><li><p>[CentOS 7升级gcc版本](<a href="https://www.cnblogs.com/jixiaohua/p/11732225.html#:~:text=Centos%207%E9%BB%98%E8%AE%A4gcc%E7%89%88%E6%9C%AC%E4%B8%BA4.8%EF%BC%8C%E6%9C%89%E6%97%B6%E9%9C%80%E8%A6%81%E6%9B%B4%E9%AB%98%E7%89%88%E6%9C%AC%E7%9A%84%EF%BC%8C%E8%BF%99%E9%87%8C%E4%BB%A5%E5%8D%87%E7%BA%A7%E8%87%B38.3.1%E7%89%88%E6%9C%AC%E4%B8%BA%E4%BE%8B%EF%BC%8C%E5%88%86%E5%88%AB%E6%89%A7%E8%A1%8C%E4%B8%8B%E9%9D%A2%E4%B8%89%E6%9D%A1%E5%91%BD%E4%BB%A4%E5%8D%B3%E5%8F%AF%EF%BC%8C%E6%97%A0%E9%9C%80%E6%89%8B%E5%8A%A8%20%E4%B8%8B%E8%BD%BD%E6%BA%90%E7%A0%81%20%E7%BC%96%E8%AF%91%201%E3%80%81%E5%AE%89%E8%A3%85centos-release-scl,sudo%20yum%20install%20centos-release-scl%202%E3%80%81%E5%AE%89%E8%A3%85devtoolset%EF%BC%8C%E6%B3%A8%E6%84%8F%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%83%B3%E5%AE%89%E8%A3%857.%2A%E7%89%88%E6%9C%AC%E7%9A%84%EF%BC%8C%E5%B0%B1%E6%94%B9%E6%88%90devtoolset-7-gcc%2A%EF%BC%8C%E4%BB%A5%E6%AD%A4%E7%B1%BB%E6%8E%A8">CentOS 7升级gcc版本 - 姬无华 - 博客园</a>)</p></li></ul><h3 id="GPU虚拟化方案"><a href="#GPU虚拟化方案" class="headerlink" title="GPU虚拟化方案"></a>GPU虚拟化方案</h3><ul><li><p><a href="https://zhuanlan.zhihu.com/p/368288368">GPU共享技术选型</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/285994980">针对深度学习的GPU共享</a></p></li><li><p><a href="https://www.usenix.org/system/files/conference/atc14/atc14-paper-tian.pdf">A Full GPU Virtualization Solution with Mediated Pass-Through - USENIX</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/383496258">A Full GPU Virtualization Solution with Mediated Pass-Through概述</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/377073683">GPU虚拟化，算力隔离，和qGPU</a></p></li><li><p><a href="https://www.kraxel.org/blog/2019/09/display-devices-in-qemu/">VGA and other display devices in qemu | 🇺🇦 kraxel’s news</a></p></li><li><p><a href="https://juejin.cn/post/7044456677621366821">云游戏常用技术 - 掘金</a></p></li><li><p><a href="https://cloud.tencent.com/developer/article/1534779">云游戏技术概述 - 腾讯云开发者社区-腾讯云</a></p></li><li><p><a href="https://www-file.huawei.com/-/media/corporate/pdf/ilab/2019/cloud_game_whitepaper.pdf">云游戏白皮书 - 华为云</a></p></li><li><p><a href="https://developer.aliyun.com/article/599189">浅谈GPU虚拟化技术（四）- GPU分片虚拟化-阿里云开发者社区</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/399405214">聊聊GPU通信那些事 - 趋动科技</a></p></li><li><p><a href="https://www.jianshu.com/p/e40059d5c832">GPU卡的底层通信原理 - 简书</a></p></li><li><p><a href="https://blog.csdn.net/danteLiujie/article/details/102901255">GPU 通信技术初探（一）- 深度学习集群_danteliujie的博客-CSDN博客</a></p></li><li><p><a href="https://source.android.google.cn/docs/devices/automotive/virtualization/architecture?hl=zh-cn">架构 | Android 开源项目 | Android Open Source Project</a></p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;随着AI与云应用的发展，逐渐对GPU的图形算力提出了更高的要求。工业级的GPU卡单卡性能很高，直接提供给某一个虚机或者程序使用，很容易造成资</summary>
      
    
    
    
    <category term="Libvirt" scheme="https://renyb2.github.io/categories/Libvirt/"/>
    
    
    <category term="KVM" scheme="https://renyb2.github.io/tags/KVM/"/>
    
    <category term="Libvirt" scheme="https://renyb2.github.io/tags/Libvirt/"/>
    
    <category term="虚拟化" scheme="https://renyb2.github.io/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
    <category term="Qemu" scheme="https://renyb2.github.io/tags/Qemu/"/>
    
    <category term="GPU" scheme="https://renyb2.github.io/tags/GPU/"/>
    
  </entry>
  
  <entry>
    <title>Windows使用：系统防火墙</title>
    <link href="https://renyb2.github.io/2023/02/14/Windows%E4%BD%BF%E7%94%A8%EF%BC%9A%E7%B3%BB%E7%BB%9F%E9%98%B2%E7%81%AB%E5%A2%99/"/>
    <id>https://renyb2.github.io/2023/02/14/Windows%E4%BD%BF%E7%94%A8%EF%BC%9A%E7%B3%BB%E7%BB%9F%E9%98%B2%E7%81%AB%E5%A2%99/</id>
    <published>2023-02-14T07:30:10.000Z</published>
    <updated>2023-02-14T07:52:19.957Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>本文主要整理windows防火墙常用的管理操作。</p><h2 id="常见场景"><a href="#常见场景" class="headerlink" title="常见场景"></a>常见场景</h2><h3 id="阻止系统内指定程序联网"><a href="#阻止系统内指定程序联网" class="headerlink" title="阻止系统内指定程序联网"></a>阻止系统内指定程序联网</h3><p><strong>操作流程：</strong></p><p>    1、在桌面左下角的搜索框中搜索“控制面板”，打开控制面板，点击其中的“系统与安全”；</p><p>    2、在“系统和安全”的界面中，点击“Windows防火墙”；</p><p>    3、再点击左侧栏中的“高级设置”；</p><p>    4、点击左侧栏中的“出站规则”–新建规则；</p><p>    5、我们在新建出站规则向导界面中，点击左侧栏中的“程序”–浏览–找到需要阻止访问网络的程序，比如QQ，找到QQ的路径即可。</p><p>    6、在进入“操作”，勾选“阻止连接”，按照提示完成操作即可阻止某个程序联网。</p><p><strong>流程截图：</strong></p><img title src= "/img/loading.gif" data-lazy-src="/2023/02/14/Windows%E4%BD%BF%E7%94%A8%EF%BC%9A%E7%B3%BB%E7%BB%9F%E9%98%B2%E7%81%AB%E5%A2%99/阻止程序外出-01.png" alt data-align="center"><img title src= "/img/loading.gif" data-lazy-src="/2023/02/14/Windows%E4%BD%BF%E7%94%A8%EF%BC%9A%E7%B3%BB%E7%BB%9F%E9%98%B2%E7%81%AB%E5%A2%99/阻止程序外出-02.png" alt data-align="center"><img title src= "/img/loading.gif" data-lazy-src="/2023/02/14/Windows%E4%BD%BF%E7%94%A8%EF%BC%9A%E7%B3%BB%E7%BB%9F%E9%98%B2%E7%81%AB%E5%A2%99/阻止程序外出-03.png" alt data-align="center"><img title src= "/img/loading.gif" data-lazy-src="/2023/02/14/Windows%E4%BD%BF%E7%94%A8%EF%BC%9A%E7%B3%BB%E7%BB%9F%E9%98%B2%E7%81%AB%E5%A2%99/阻止程序外出-04.png" alt data-align="center"><img title src= "/img/loading.gif" data-lazy-src="/2023/02/14/Windows%E4%BD%BF%E7%94%A8%EF%BC%9A%E7%B3%BB%E7%BB%9F%E9%98%B2%E7%81%AB%E5%A2%99/阻止程序外出-05.png" alt data-align="center"><img title src= "/img/loading.gif" data-lazy-src="/2023/02/14/Windows%E4%BD%BF%E7%94%A8%EF%BC%9A%E7%B3%BB%E7%BB%9F%E9%98%B2%E7%81%AB%E5%A2%99/阻止程序外出-06.png" alt data-align="center"><img title src= "/img/loading.gif" data-lazy-src="/2023/02/14/Windows%E4%BD%BF%E7%94%A8%EF%BC%9A%E7%B3%BB%E7%BB%9F%E9%98%B2%E7%81%AB%E5%A2%99/阻止程序外出-07.png" alt data-align="center"><img title src= "/img/loading.gif" data-lazy-src="/2023/02/14/Windows%E4%BD%BF%E7%94%A8%EF%BC%9A%E7%B3%BB%E7%BB%9F%E9%98%B2%E7%81%AB%E5%A2%99/阻止程序外出-08.png" alt data-align="center">]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;本文主要整理windows防火墙常用的管理操作。&lt;/p&gt;
&lt;h2 id=&quot;常见场景&quot;&gt;&lt;a href=&quot;#常见场景&quot; class=&quot;head</summary>
      
    
    
    
    <category term="Windows" scheme="https://renyb2.github.io/categories/Windows/"/>
    
    
    <category term="Windows" scheme="https://renyb2.github.io/tags/Windows/"/>
    
    <category term="防火墙" scheme="https://renyb2.github.io/tags/%E9%98%B2%E7%81%AB%E5%A2%99/"/>
    
  </entry>
  
  <entry>
    <title>License共享：vAPP方案</title>
    <link href="https://renyb2.github.io/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/"/>
    <id>https://renyb2.github.io/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/</id>
    <published>2023-01-19T07:12:21.000Z</published>
    <updated>2023-02-24T01:48:30.599Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>为节约软件License购买成本，在合理的、不被查封的情况下，通过技术手段来降低license开销，实现软件的正版激活。本方案是实现License共享的方案之一，另一个方案为硬件克隆方案，可参考文档《License共享：硬件克隆方案》。 </p><h2 id="主体思路"><a href="#主体思路" class="headerlink" title="主体思路"></a>主体思路</h2><p>本方案的总体思路是通过将已激活的软件分发出去，利用软件共享，来实现多人复用同一个已激活软件的目的。目前Windows Server提供RDS服务，可提供多用户远程启动已分发软件，本方案就是基于RDS服务设计，主要讲解整理架构及部署流程。</p><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/winserver%20rds.png" title alt data-align="center"><h2 id="局限性"><a href="#局限性" class="headerlink" title="局限性"></a>局限性</h2><p>只要支持RDP协议的软件，均可通过该方案实现License共享。目前测试，不支持的软件有：UG NX。</p><h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置会话集合-15.png" title alt data-align="center"><h2 id="部署流程"><a href="#部署流程" class="headerlink" title="部署流程"></a>部署流程</h2><p>本文只介绍最简单的架构部署方式，了解基础配置后其他架构的配置方式则较为轻松，这里不做赘述。<strong>服务器系统统一使用Windows Server 2019</strong>。</p><h3 id="配置AD域控服务器"><a href="#配置AD域控服务器" class="headerlink" title="配置AD域控服务器"></a>配置AD域控服务器</h3><p>域控服务器的职责，主要是负责用户的身份认证、域服务器管理、提供web访问。</p><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置AD域-01.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置AD域-02.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置AD域-03.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置AD域-04.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置AD域-05.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置AD域-06.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置AD域-07.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置AD域-08.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置AD域-09.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置AD域-10.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置AD域-11.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置AD域-12.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置AD域-13.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置AD域-14.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置AD域-15.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置AD域-16.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置AD域-17.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置AD域-18.png" title alt data-align="center"><h3 id="应用服务器加域"><a href="#应用服务器加域" class="headerlink" title="应用服务器加域"></a>应用服务器加域</h3><ol><li>修改应用服务器的主机名。</li></ol><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/服务器加域-01.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/服务器加域-02.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/服务器加域-03.png" title alt data-align="center"><ol start="2"><li>修改应用服务器的DNS地址，DNS指向域控服务器IP。使其可以解析域名地址，为后续加域准备。</li></ol><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/服务器加域-04.png" title alt data-align="center"><ol start="3"><li>应用服务器加域，需要输入域控服务器的用户密码认证。</li></ol><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/服务器加域-05.png" title alt data-align="center"><ol start="4"><li>应用服务器开放远程桌面。</li></ol><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/服务器加域-06.png" title alt data-align="center"><h3 id="配置RDS服务"><a href="#配置RDS服务" class="headerlink" title="配置RDS服务"></a>配置RDS服务</h3><p>在域控服务器上进行配置，配置内容如下：</p><ol><li>添加应用服务器，使域控服务器可管理应用服务器。</li></ol><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置应用服务器-01.png" title alt data-align="center"><ol start="2"><li>配置基于会话的远程桌面服务。</li></ol><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置应用服务器-02.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置应用服务器-03.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置应用服务器-04.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置应用服务器-05.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置应用服务器-06.png" title alt data-align="center"><p>代理服务器，通常由域控服务器担任，已发布应用统一经过代理服务器进行代理访问。</p><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置应用服务器-07.png" title alt data-align="center"><p>Web服务器，通常由域控服务器担任，提供RDS服务的Web访问服务，用户通过web可查看已发布应用，并访问已发布应用。</p><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置应用服务器-08.png" title alt data-align="center"><p>会话服务器指后端具体部署应用的服务器，应用会通过代理服务器发布出去，用户通过web可打开会话服务器的已发布应用。</p><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置应用服务器-09.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置应用服务器-10.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置应用服务器-11.png" title alt data-align="center"><h3 id="配置会话集合"><a href="#配置会话集合" class="headerlink" title="配置会话集合"></a>配置会话集合</h3><p>会话集合是至少包含一个应用服务器的服务器组，可发布一个或多个共有应用，各服务器间可实现负载均衡。</p><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置会话集合-01.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置会话集合-02.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置会话集合-03.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置会话集合-04.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置会话集合-05.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置会话集合-06.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置会话集合-07.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置会话集合-08.png" title alt data-align="center"><h3 id="发布RemoteAPP"><a href="#发布RemoteAPP" class="headerlink" title="发布RemoteAPP"></a>发布RemoteAPP</h3><p>配置好集合后，即可在集合内发布应用。</p><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置会话集合-09.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置会话集合-10.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置会话集合-11.png" title alt data-align="center"><p>应用发布后，即可通过web服务器进行访问，<strong>地址为：https://(web server ip)/rdweb</strong></p><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置会话集合-12.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置会话集合-13.png" title alt data-align="center"><p>若修改过远程访问的端口，则需要在发布应用前，修改会话集合的端口。注册表位置：<code>计算机\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Terminal Server\CentralPublishedResources\PublishedFarms</code>。</p><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置会话集合-14.png" title alt data-align="center"><p>多个应用服务器若需要发布独立的APP，则可创建不同的会话集合，应用服务器分别加入不同的会话集合，进行独立发布应用。</p><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置会话集合-15.png" title alt data-align="center"><img src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9AvAPP%E6%96%B9%E6%A1%88/配置会话集合-16.png" title alt data-align="center"><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><p><a href="https://learn.microsoft.com/en-us/windows-server/remote/remote-desktop-services/welcome-to-rds">Welcome to Remote Desktop Services in Windows Server 2016 | Microsoft Learn</a></p></li><li><p><a href="https://blog.51cto.com/lvzhenjiang/2396451">Windows server 2016 搭建RDS服务_51CTO博客_windows server 2016域服务器搭建</a></p></li><li><p><a href="https://blog.csdn.net/weixin_39568073/article/details/107449785">windows_RDS服务远程桌面一_每天努力一点点，哈哈的博客-CSDN博客_rds windows</a></p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;为节约软件License购买成本，在合理的、不被查封的情况下，通过技术手段来降低license开销，实现软件的正版激活。本方案是实现Lice</summary>
      
    
    
    
    <category term="Windows" scheme="https://renyb2.github.io/categories/Windows/"/>
    
    
    <category term="License" scheme="https://renyb2.github.io/tags/License/"/>
    
    <category term="技术方案" scheme="https://renyb2.github.io/tags/%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88/"/>
    
  </entry>
  
  <entry>
    <title>License共享：硬件克隆方案</title>
    <link href="https://renyb2.github.io/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9A%E7%A1%AC%E4%BB%B6%E5%85%8B%E9%9A%86%E6%96%B9%E6%A1%88/"/>
    <id>https://renyb2.github.io/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9A%E7%A1%AC%E4%BB%B6%E5%85%8B%E9%9A%86%E6%96%B9%E6%A1%88/</id>
    <published>2023-01-19T07:07:24.000Z</published>
    <updated>2023-02-03T03:10:01.830Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>为节约软件License购买成本，在合理的、不被查封的情况下，通过技术手段来降低license开销，实现软件的正版激活。本方案是实现License共享的方案之一，另一个方案为vAPP方案，可参考文档《License共享：vAPP方案》。</p><h2 id="主体思路"><a href="#主体思路" class="headerlink" title="主体思路"></a>主体思路</h2><p>软件License通常会采集系统层级的硬件信息来区分主机，如网卡MAC、主板信息等。本方案主要通过底层硬件的虚拟化，将所有虚机的硬件信息虚拟化为同一个，使其在系统层级内部无法感知硬件层级的差异，从License检测层面来看，就是同一台机器。</p><img title src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9A%E7%A1%AC%E4%BB%B6%E5%85%8B%E9%9A%86%E6%96%B9%E6%A1%88/硬件共享.drawio.png" alt data-align="center"><h2 id="局限性"><a href="#局限性" class="headerlink" title="局限性"></a>局限性</h2><p>该方案的局限性较大，只要有以下几点：</p><ol><li><p>网卡MAC在同一个局域网内无法相同，所以需要隔离至不同的私网，会造成网络结构过于复杂。</p></li><li><p>每个软件检测硬件的信息方式不同，对于检测简单的软件可用该方法，检测复杂的软件不推荐该方式，适配难度过高。</p></li><li><p>软件License检测方式对适配而言均为黑盒，适配难度高。</p></li><li><p>该方案目前暂时未大规模使用测试，无法评估其法律风险。</p></li></ol><h2 id="虚拟化配置"><a href="#虚拟化配置" class="headerlink" title="虚拟化配置"></a>虚拟化配置</h2><h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><p>使用<code>host-passthrough</code>模式即可，参考xml相关配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;host-passthrough&#x27;</span> <span class="attr">check</span>=<span class="string">&#x27;none&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">topology</span> <span class="attr">sockets</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cores</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">threads</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;disable&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;hypervisor&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">numa</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cell</span> <span class="attr">id</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpus</span>=<span class="string">&#x27;0-7&#x27;</span> <span class="attr">memory</span>=<span class="string">&#x27;33554432&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span> <span class="attr">memAccess</span>=<span class="string">&#x27;shared&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">numa</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cpu</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="网卡"><a href="#网卡" class="headerlink" title="网卡"></a>网卡</h3><p>可通过OpenStack设置Port MAC地址，然后挂载给虚机使用。若直接使用KVM，则可直接配置xml即可，参考配置如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;bridge&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;fa:16:3e:fa:21:60&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">source</span> <span class="attr">bridge</span>=<span class="string">&#x27;br-int&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">virtualport</span> <span class="attr">type</span>=<span class="string">&#x27;openvswitch&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">parameters</span> <span class="attr">interfaceid</span>=<span class="string">&#x27;e0f2760f-3652-4d68-9332-f95b77c8ff03&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">virtualport</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;tape0f2760f-36&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mtu</span> <span class="attr">size</span>=<span class="string">&#x27;1500&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x03&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="硬盘"><a href="#硬盘" class="headerlink" title="硬盘"></a>硬盘</h3><p>磁盘需要使用直通方式，ceph rbd在系统内部无法读取产品序列号，也无法设置其厂商id和产品id。</p><h3 id="SMBIOS-System-Information"><a href="#SMBIOS-System-Information" class="headerlink" title="SMBIOS System Information"></a>SMBIOS System Information</h3><ol><li>屏蔽透传给主机的底层系统信息，可修改为PC厂商的信息，或直接使用host模式。</li></ol><p>参考xml相关配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">os</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">smbios</span> <span class="attr">mode</span>=<span class="string">&quot;host&quot;</span>/&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">os</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>Windows系统内可通过<code>systeminfo</code>命令查看效果。</p><p>smbios mode为<code>smbios</code>时，系统内部可查看到的信息如下：</p><img title src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9A%E7%A1%AC%E4%BB%B6%E5%85%8B%E9%9A%86%E6%96%B9%E6%A1%88/smbios_mode_smbios.png" alt="smbiosmodesmbios" data-align="center"><p>smbios mode为<code>host</code>时，系统内部可查看到的信息如下：</p><img title src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9A%E7%A1%AC%E4%BB%B6%E5%85%8B%E9%9A%86%E6%96%B9%E6%A1%88/smbios_mode_host.png" alt="smbios-mode-host" data-align="center"><h2 id="实测案例"><a href="#实测案例" class="headerlink" title="实测案例"></a>实测案例</h2><p>本次测试，使用NVIDIA的vGPU License进行测试，验证硬件克隆是否可以实现License共享。NVIDIA License与MAC地址绑定，通过官网填写License Manager Server MAC申请license后，即可从License Manager Server导入license文件，启用License管理分发功能。</p><img title src= "/img/loading.gif" data-lazy-src="/2023/01/19/License%E5%85%B1%E4%BA%AB%EF%BC%9A%E7%A1%AC%E4%BB%B6%E5%85%8B%E9%9A%86%E6%96%B9%E6%A1%88/vGPU%20License%20Manager.png" alt data-align="center"><p>本轮测试进行如下两个方案验证：</p><ul><li><p>场景一：Client MAC一致，请求同一个License Manager Server，验证是否可复用同一个License名额。</p></li><li><p>场景二：License Manager Server的MAC一致，验证是否可复用同一个License.bin文件</p></li></ul><p>验证结果：</p><ul><li><p>场景一：无法实现复用，MAC一致，第二个Client在申请时可以申请成功，但是会把第一个Client挤下去，无法实现共享。</p></li><li><p>场景二：<strong>可以实现复用，多台License Manager Server MAC一致，网络隔离情况下，均可使用同一个License.bin文件，进行License分发。</strong></p></li></ul><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://libvirt.org/formatdomain.html">Libvirt官方文档：Domain XML format</a></li><li><a href="https://cloud.tencent.com/developer/article/1508435">多租户 Saas 系统架构的设计思路 - 腾讯云开发者社区-腾讯云</a></li><li><a href="https://juejin.cn/post/6844903858628476936">SaaS(软件即服务)架构设计 - 掘金</a></li><li><a href="https://cloud.tencent.com/developer/article/1162140">定制虚拟机smbios信息 - 腾讯云开发者社区-腾讯云</a></li><li><a href="https://www.jianshu.com/p/5c86cb1c5b8b">linux系统product_uuid和product_serial有何区别 - 简书</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;为节约软件License购买成本，在合理的、不被查封的情况下，通过技术手段来降低license开销，实现软件的正版激活。本方案是实现Lice</summary>
      
    
    
    
    <category term="Windows" scheme="https://renyb2.github.io/categories/Windows/"/>
    
    
    <category term="License" scheme="https://renyb2.github.io/tags/License/"/>
    
    <category term="技术方案" scheme="https://renyb2.github.io/tags/%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88/"/>
    
  </entry>
  
  <entry>
    <title>Python研发：setup打包</title>
    <link href="https://renyb2.github.io/2023/01/10/Python%E7%A0%94%E5%8F%91%EF%BC%9Asetup%E6%89%93%E5%8C%85/"/>
    <id>https://renyb2.github.io/2023/01/10/Python%E7%A0%94%E5%8F%91%EF%BC%9Asetup%E6%89%93%E5%8C%85/</id>
    <published>2023-01-10T09:41:46.000Z</published>
    <updated>2023-01-19T07:03:43.983Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h2><p>项目部署时，发现CI自动打包的Docker镜像内代码不全，最终定位原因是由于python打包时未打包新建的代码文件导致。特意整理本文章，整理python打包配置。</p><h2 id="基础信息"><a href="#基础信息" class="headerlink" title="基础信息"></a>基础信息</h2><p>python标准打包工具为setuptools，可通过<a href="https://setuptools.pypa.io/en/latest/userguide/quickstart.html">setuptools官方文档</a>详细了解该工具。现整理一些常用内容，记录如下：</p><h3 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h3><p>Python官方文档：<a href="https://packaging.python.org/tutorials/distributing-packages/">https://packaging.python.org/tutorials/distributing-packages/</a></p><p>根据 application 包含的代码类型以及其所支持的 python 版本， wheel 格式可细分为三种</p><ul><li><strong>Universal wheel</strong>：纯 python 代码，并且支持 python 2 和 3</li><li><strong>Pure python wheel</strong>：纯 python 代码，不同时支持 python2 和 3</li><li><strong>Platform wheel</strong>：非纯 python 代码</li></ul><p>采用如下命令可编译成 universal wheel：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python setup.py bdist_wheel --universal</span><br></pre></td></tr></table></figure><p>采用如下命令可编译成非 universal wheel(即 pure python wheel 或 platform wheel)：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python setup.py bdist_wheel</span><br></pre></td></tr></table></figure><p>其它的类型的包：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python setup.py bdist_egg       # 生成类似 -0.0.1-py2.7.egg，支持 easy_install</span><br><span class="line">python setup.py sdist           # 生成类似 -0.0.1.tar.gz，支持 pip</span><br><span class="line">python setup.py build           # 编译</span><br><span class="line">python setup.py bdist_wininst   # Windows exe</span><br><span class="line">python setup.py bdist_rpm       # rpm</span><br></pre></td></tr></table></figure><h3 id="配置参数"><a href="#配置参数" class="headerlink" title="配置参数"></a>配置参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">name              -&gt; 为项目名称，和顶层目录名称一致;</span><br><span class="line">version           -&gt; 是项目当前的版本，1.0.0.dev1表示1.0.0版，目前还处于开发阶段</span><br><span class="line">description       -&gt; 是包的简单描述，这个包是做什么的</span><br><span class="line">long_description  -&gt; 这是项目的详细描述，出现在pypi软件的首页上</span><br><span class="line">url               -&gt; 为项目访问地址，我的项目放在github上。</span><br><span class="line">author            -&gt; 为项目开发人员名称</span><br><span class="line">author_email      -&gt; 为项目开发人员联系邮件</span><br><span class="line">license           -&gt; 为本项目遵循的授权许可</span><br><span class="line">classifiers       -&gt; 有很多设置，具体内容可以参考官方文档</span><br><span class="line">keywords          -&gt; 是本项目的关键词，理解为标签</span><br><span class="line">packages          -&gt; 是本项目包含哪些包，使用工具函数自动发现包</span><br><span class="line">package_data      -&gt; 通常包含与包实现相关的文件</span><br><span class="line">data_files        -&gt; 指定其他的一些文件（如配置文件）</span><br><span class="line">cmdclass          -&gt; build或install的时候执行的额外操作</span><br><span class="line">entry_points      -&gt; 可以定义安装该模块后执行的脚本，比如将某个函数作为linux命令</span><br></pre></td></tr></table></figure><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><p><a href="https://setuptools.pypa.io/en/latest/userguide/quickstart.html">Quickstart - setuptools</a></p></li><li><p><a href="https://packaging.python.org/tutorials/distributing-packages/">Packaging Python Projects - PyPA</a></p></li><li><p><a href="https://www.cnblogs.com/schangech/p/8951939.html">python环境下制作pypi软件包 - schangech - 博客园</a></p></li><li><p><a href="http://wsfdl.com/python/2015/09/06/Python%E5%BA%94%E7%94%A8%E7%9A%84%E6%89%93%E5%8C%85%E5%92%8C%E5%8F%91%E5%B8%83%E4%B8%8A.html">Python application 的打包和发布——(上)</a></p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;简述&quot;&gt;&lt;a href=&quot;#简述&quot; class=&quot;headerlink&quot; title=&quot;简述&quot;&gt;&lt;/a&gt;简述&lt;/h2&gt;&lt;p&gt;项目部署时，发现CI自动打包的Docker镜像内代码不全，最终定位原因是由于python打包时未打包新建的代码文件导致。特意整理本文章，整理</summary>
      
    
    
    
    <category term="开发语言" scheme="https://renyb2.github.io/categories/%E5%BC%80%E5%8F%91%E8%AF%AD%E8%A8%80/"/>
    
    
    <category term="Python" scheme="https://renyb2.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Windows使用：系统激活方案调研</title>
    <link href="https://renyb2.github.io/2023/01/10/Windows%E4%BD%BF%E7%94%A8%EF%BC%9A%E7%B3%BB%E7%BB%9F%E6%BF%80%E6%B4%BB%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94/"/>
    <id>https://renyb2.github.io/2023/01/10/Windows%E4%BD%BF%E7%94%A8%EF%BC%9A%E7%B3%BB%E7%BB%9F%E6%BF%80%E6%B4%BB%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94/</id>
    <published>2023-01-10T02:58:40.000Z</published>
    <updated>2023-01-20T01:05:10.248Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h2><p>由于项目需求，需调研目前所有的windows 10激活方式成本及其法律风险，现将调研内容整理至本文章，本文主要介绍目前各种常见的windows 10激活方式对企业用户的风险及成本评估。微软不追究个人用户的盗版使用，所以个人用户不在本次调研范围内，个人用户可随意使用本文中的各种激活方式。</p><h2 id="永久激活方案"><a href="#永久激活方案" class="headerlink" title="永久激活方案"></a>永久激活方案</h2><h3 id="方案介绍"><a href="#方案介绍" class="headerlink" title="方案介绍"></a>方案介绍</h3><h4 id="官方渠道"><a href="#官方渠道" class="headerlink" title="官方渠道"></a>官方渠道</h4><p><strong>官方渠道报价：1800/套，量大可优惠至1600 ~ 1700</strong></p><p>官方license可接受5次硬件变动，同时只能有一套该license激活的系统在运行。硬件变动范围包括但不限于插拔内存条、插拔硬盘、更换主板等操作。</p><p>该激活方式不存在法律风险，唯一的不足就是太贵了。在云场景上，虚机需要不断创删，删除后的虚机会消耗license数量，无法回收，所以该方案的成本非常高。</p><h4 id="淘宝店铺"><a href="#淘宝店铺" class="headerlink" title="淘宝店铺"></a>淘宝店铺</h4><p>淘宝/京东搜索windows激活，即可搜到很多可提供windows激活的店铺，<strong>激活价格在几块到几百不等</strong>。区别在于一次性过期还是可重复安装，根据调研及网络上各企业反馈，该方式激活的windows同样也会收到微软的律师函，及该方式企业使用是存在法律风险的。该方式个人认为是最不值得的一种方式，既花了钱，还不能规避法律风险。</p><h4 id="激活工具"><a href="#激活工具" class="headerlink" title="激活工具"></a>激活工具</h4><p>网上的激活工具有很多，这里推荐GITHUB上的一款开源工具：<a href="https://github.com/massgravel/Microsoft-Activation-Scripts/">GitHub - massgravel/Microsoft-Activation-Scripts</a></p><p>激活流程在该工具的README内有提及，按照流程几步操作即可激活windows系统。该方式即破解版，企业使用风险较大，但胜在不花钱，如果纯内网的场景下，可考虑该方案</p><h4 id="license共享"><a href="#license共享" class="headerlink" title="license共享"></a>license共享</h4><p>基于正版渠道，通过技术手段降低license成本，但是提升了硬件复杂度且适用性较低。</p><ol><li>windows正版降低成本，总的来看瘦终端形式没有正规技术手段降低成本方式，只能通过商务层面进行（买一些license，然后其余用盗版），胖终端可以通过提升硬件复杂度最多节约75%的license成本（1拖4最多，但是硬件选型很难，一般推荐1拖2）。</li><li>通过网络连接windows（如瘦客户端场景）复用同一个license均会被判定为盗版，只能通过硬件直连的方式去解决（冰特云桌面提供的方案有一拖四，即胖客户端内虚4个虚机，每个虚机直通一个网卡，硬件直连的方式去使用，4个虚机公用一个windows license。这个方案受制于硬件，如主板很难直接插4个显卡，一般一拖二用的最多）。</li><li>硬件直连的方式不能过交换机，只能点对点连接。</li><li>通过加速卡实现<a href="https://zhuanlan.zhihu.com/p/392364044">HDMI信号远距离传输</a>，可以压缩HDMI和VDI的信号，通过网线传输，延长HDMI信号距离，整机部署架构就受制于网线长度了（网线能做到100m左右，覆盖一栋楼），痛点就是要重新布线。</li></ol><img title src= "/img/loading.gif" data-lazy-src="/2023/01/10/Windows%E4%BD%BF%E7%94%A8%EF%BC%9A%E7%B3%BB%E7%BB%9F%E6%BF%80%E6%B4%BB%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94/胖终端license共享.png" alt data-align="center"><h3 id="法律风险"><a href="#法律风险" class="headerlink" title="法律风险"></a>法律风险</h3><ol><li>windows正版只有官网和渠道商提供，其余什么淘宝几十、几百的、OEM这种企业使用都有概率收到微软的律师函（跟企业大小、使用量等都有关系）</li><li>微软发现盗版后会先收集证据和侵权数量，然后发律师函，先派销售上门沟通，然后要钱，这种一般商务谈判可以购买60% ~ 80%，达到微软后续不再骚扰的目的，这种一般就是所谓的保护费。</li><li>一般到商务谈判这一步就基本解决了，协商不成功的话，微软会上版权局，然后政府介入收集证据，最后走法院。到法院之后，微软有极大概率会胜诉，胜诉后基本就是微软要多少是多少了，不到万不得已，不要走到这一步，败诉后的赔偿数额是很高的。</li></ol><h2 id="云解决方案"><a href="#云解决方案" class="headerlink" title="云解决方案"></a>云解决方案</h2><h3 id="公有云如何提供windows"><a href="#公有云如何提供windows" class="headerlink" title="公有云如何提供windows"></a>公有云如何提供windows</h3><p>共有云对windows的用法都是通过自建的KMS自动激活并按时收取激活费用，一般由微软官方渠道商提供镜像。具体计划可参考微软官网提供的内容：<a href="https://learn.microsoft.com/zh-cn/partner-center/csp-overview">云解决方案提供商计划概述 - Partner Center | Microsoft Learn</a></p><p>一般根据windows的类型，由不同的供应商提供，分别如下：</p><ul><li><p>windows系统：云供应商较多，其中比较火的是成都春山云网络科技有限公司。</p></li><li><p>winserver系统：目前只看到华为云的供货商，为深圳市伊登软件有限公司。</p></li></ul><img title src= "/img/loading.gif" data-lazy-src="/2023/01/10/Windows%E4%BD%BF%E7%94%A8%EF%BC%9A%E7%B3%BB%E7%BB%9F%E6%BF%80%E6%B4%BB%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94/华为云-winserver.png" alt data-align="center"><img title src= "/img/loading.gif" data-lazy-src="/2023/01/10/Windows%E4%BD%BF%E7%94%A8%EF%BC%9A%E7%B3%BB%E7%BB%9F%E6%BF%80%E6%B4%BB%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94/华为云-windows-01.png" alt data-align="center"><img title src= "/img/loading.gif" data-lazy-src="/2023/01/10/Windows%E4%BD%BF%E7%94%A8%EF%BC%9A%E7%B3%BB%E7%BB%9F%E6%BF%80%E6%B4%BB%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94/华为云-windows-02.png" alt data-align="center"><p>成都春山云网络科技有限公司公开的微软授权书内容：</p><img title src= "/img/loading.gif" data-lazy-src="/2023/01/10/Windows%E4%BD%BF%E7%94%A8%EF%BC%9A%E7%B3%BB%E7%BB%9F%E6%BF%80%E6%B4%BB%E6%96%B9%E6%A1%88%E8%B0%83%E7%A0%94/成都春山云网络科技有限公司.png" alt data-align="center"><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><h3 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h3><ul><li><p><a href="https://learn.microsoft.com/zh-cn/windows/deployment/volume-activation/volume-activation-windows-10">Windows 10 批量激活 - Windows Deployment | Microsoft Learn</a></p></li><li><p><a href="https://learn.microsoft.com/zh-cn/partner-center/csp-overview">云解决方案提供商计划概述 - Partner Center | Microsoft Learn</a></p></li><li><p><a href="https://learn.microsoft.com/zh-cn/partner-center/csp-documents-and-learning-resources?source=recommendations">云解决方案提供商协议、价目表和产品/服务 - Partner Center | Microsoft Learn</a></p></li><li><p><a href="https://learn.microsoft.com/zh-cn/windows-server/get-started/kms-client-activation-keys">适用于 Windows Server 和 Windows 的密钥管理服务 (KMS) 客户端激活和产品密钥 | Microsoft Learn</a></p></li><li><p><a href="https://www.microsoft.com/zh-cn/licensing/existing-customer/activation-centers">批量许可密钥电话号码 | 微软批量许可</a></p></li></ul><h3 id="社区文档"><a href="#社区文档" class="headerlink" title="社区文档"></a>社区文档</h3><ul><li><a href="https://zhuanlan.zhihu.com/p/260014354?utm_source=wechat_session">win10激活的几种方式及其原理（支持win11）</a></li><li><a href="https://github.com/massgravel/Microsoft-Activation-Scripts/">GitHub - massgravel/Microsoft-Activation-Scripts</a></li><li><a href="https://zhuanlan.zhihu.com/p/363666124">微软律师函又来了，老板不想花钱怎么办？适用于中小企业</a></li><li><a href="https://zhuanlan.zhihu.com/p/338805607">淘宝京东买的Windows/office秘钥是正版吗？</a></li><li><a href="https://zhuanlan.zhihu.com/p/104640134">微软对正版及盗版的定义</a></li><li><a href="https://www.zhihu.com/question/67684166">微软对盗版用户的态度是怎么样的？</a></li></ul><h3 id="公有云文档"><a href="#公有云文档" class="headerlink" title="公有云文档"></a>公有云文档</h3><ul><li><a href="https://docs.jdcloud.com/cn/virtual-machines/windows-cloud-host-adjustment-activation-mode-is-kms">京东云 - Windows云主机调整激活方式为KMS</a></li><li><a href="https://help.aliyun.com/document_detail/41056.htm">如何使用KMS域名激活VPC网络中的Windows实例_云服务器 ECS-阿里云帮助中心</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;简述&quot;&gt;&lt;a href=&quot;#简述&quot; class=&quot;headerlink&quot; title=&quot;简述&quot;&gt;&lt;/a&gt;简述&lt;/h2&gt;&lt;p&gt;由于项目需求，需调研目前所有的windows 10激活方式成本及其法律风险，现将调研内容整理至本文章，本文主要介绍目前各种常见的window</summary>
      
    
    
    
    <category term="Windows" scheme="https://renyb2.github.io/categories/Windows/"/>
    
    
    <category term="Windows" scheme="https://renyb2.github.io/tags/Windows/"/>
    
    <category term="调研" scheme="https://renyb2.github.io/tags/%E8%B0%83%E7%A0%94/"/>
    
  </entry>
  
  <entry>
    <title>NVIDIA研发：vGPU Unlock</title>
    <link href="https://renyb2.github.io/2022/12/10/NVIDIA%E7%A0%94%E5%8F%91%EF%BC%9AvGPU-Unlock/"/>
    <id>https://renyb2.github.io/2022/12/10/NVIDIA%E7%A0%94%E5%8F%91%EF%BC%9AvGPU-Unlock/</id>
    <published>2022-12-10T08:17:22.000Z</published>
    <updated>2023-01-16T07:14:22.415Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>This tool enables the use of Geforce and Quadro GPUs with the NVIDIA vGPU graphics virtualization technology. NVIDIA vGPU normally only supports a few datacenter Teslas and professional Quadro GPUs by design, but not consumer graphics cards through a software limitation. This vgpu_unlock tool aims to remove this limitation on Linux based systems, thus enabling most Maxwell, Pascal, Volta (untested), and Turing based GPUs to use the vGPU technology. Ampere support is currently a work in progress.</p><p>A community maintained Wiki written by Krutav Shah with a lot more information is <a href="https://docs.google.com/document/d/1pzrWJ9h-zANCtyqRgS7Vzla0Y8Ea2-5z2HEi4X75d2Q/edit?usp=sharing">available here.</a></p><h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><ul><li>This tool requires Python3 and Python3-pip; the latest version is recommended.</li><li>The python package “frida” is required. <code>pip3 install frida</code>.</li><li>The tool requires the NVIDIA GRID vGPU driver.</li><li>“dkms” is required as it simplifies the process of rebuilding the driver alot. Install DKMS with the package manager in your OS.</li></ul><h2 id="安装流程"><a href="#安装流程" class="headerlink" title="安装流程"></a>安装流程</h2><p>In the following instructions <code>&lt;path_to_vgpu_unlock&gt;</code> need to be replaced with the path to this repository on the target system and <code>&lt;version&gt;</code> need to be replaced with the version of the NVIDIA GRID vGPU driver.</p><p>Install the NVIDIA GRID vGPU driver, make sure to install it as a dkms module.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;nvidia-installer --dkms</span><br></pre></td></tr></table></figure><p>Modify the line begining with <code>ExecStart=</code> in <code>/lib/systemd/system/nvidia-vgpud.service</code> and <code>/lib/systemd/system/nvidia-vgpu-mgr.service</code> to use <code>vgpu_unlock</code> as the executable and pass the original executable as the first argument. Example:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExecStart&#x3D;&lt;path_to_vgpu_unlock&gt;&#x2F;vgpu_unlock &#x2F;usr&#x2F;bin&#x2F;nvidia-vgpud</span><br></pre></td></tr></table></figure><p>Reload the systemd daemons:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure><p>Modify the file <code>/usr/src/nvidia-&lt;version&gt;/nvidia/os-interface.c</code> and add the following line after the lines begining with <code>#include</code> at the beginning of the file.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;&lt;path_to_vgpu_unlock&gt;&#x2F;vgpu_unlock_hooks.c&quot;</span><br></pre></td></tr></table></figure><p>Modify the file <code>/usr/src/nvidia-&lt;version&gt;/nvidia/nvidia.Kbuild</code> and add the following line at the bottom of the file.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldflags-y +&#x3D; -T &lt;path_to_vgpu_unlock&gt;&#x2F;kern.ld</span><br></pre></td></tr></table></figure><p>Remove the nvidia kernel module using dkms:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dkms remove -m nvidia -v &lt;version&gt; --all</span><br></pre></td></tr></table></figure><p>Rebuild and reinstall the nvidia kernel module using dkms:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dkms install -m nvidia -v &lt;version&gt;</span><br></pre></td></tr></table></figure><p>Reboot.</p><h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><h3 id="vGPU-supported"><a href="#vGPU-supported" class="headerlink" title="vGPU supported?"></a>vGPU supported?</h3><p>In order to determine if a certain GPU supports the vGPU functionality the driver looks at the PCI device ID. This identifier together with the PCI vendor ID is unique for each type of PCI device. In order to enable vGPU support we need to tell the driver that the PCI device ID of the installed GPU is one of the device IDs used by a vGPU capable GPU.</p><h3 id="Userspace-script-vgpu-unlock"><a href="#Userspace-script-vgpu-unlock" class="headerlink" title="Userspace script: vgpu_unlock"></a>Userspace script: vgpu_unlock</h3><p>The userspace services nvidia-vgpud and nvidia-vgpu-mgr uses the ioctl syscall to communicate with the kernel module. Specifically they read the PCI device ID and determines if the installed GPU is vGPU capable.</p><p>The python script vgpu_unlock intercepts all ioctl syscalls between the executable specified as the first argument and the kernel. The script then modifies the kernel responses to indicate a PCI device ID with vGPU support and a vGPU capable GPU.</p><h3 id="Kernel-module-hooks-vgpu-unlock-hooks-c"><a href="#Kernel-module-hooks-vgpu-unlock-hooks-c" class="headerlink" title="Kernel module hooks: vgpu_unlock_hooks.c"></a>Kernel module hooks: vgpu_unlock_hooks.c</h3><p>In order to exchange data with the GPU the kernel module maps the physical address space of the PCI bus into its own virtual address space. This is done using the ioremap* kernel functions. The kernel module then reads and writes data into that mapped address space. This is done using the memcpy kernel function.</p><p>By including the vgpu_unlock_hooks.c file into the os-interface.c file we can use C preprocessor macros to replace and intercept calls to the iormeap and memcpy functions. Doing this allows us to maintain a view of what is mapped where and what data that is being accessed.</p><h3 id="Kernel-module-linker-script-kern-ld"><a href="#Kernel-module-linker-script-kern-ld" class="headerlink" title="Kernel module linker script: kern.ld"></a>Kernel module linker script: kern.ld</h3><p>This is a modified version of the default linker script provided by gcc. The script is modified to place the .rodata section of nv-kernel.o into .data section instead of .rodata, making it writable. The script also provide the symbols <code>vgpu_unlock_nv_kern_rodata_beg</code> and <code>vgpu_unlock_nv_kern_rodata_end</code> to let us know where that section begins and ends.</p><h3 id="How-it-all-comes-together"><a href="#How-it-all-comes-together" class="headerlink" title="How it all comes together"></a>How it all comes together</h3><p>After boot the nvidia-vgpud service queries the kernel for all installed GPUs and checks for vGPU capability. This call is intercepted by the vgpu_unlock python script and the GPU is made vGPU capable. If a vGPU capable GPU is found then nvidia-vgpu creates an MDEV device and the /sys/class/mdev_bus directory is created by the system.</p><p>vGPU devices can now be created by echoing UUIDs into the <code>create</code> files in the mdev bus representation. This will create additional structures representing the new vGPU device on the MDEV bus. These devices can then be assigned to VMs, and when the VM starts it will open the MDEV device. This causes nvidia-vgpu-mgr to start communicating with the kernel using ioctl. Again these calls are intercepted by the vgpu_unlock python script and when nvidia-vgpu-mgr asks if the GPU is vGPU capable the answer is changed to yes. After that check it attempts to initialize the vGPU device instance.</p><p>Initialization of the vGPU device is handled by the kernel module and it performs its own check for vGPU capability, this one is a bit more complicated.</p><p>The kernel module maps the physical PCI address range 0xf0000000-0xf1000000 into its virtual address space, it then performs some magical operations which we don’t really know what they do. What we do know is that after these operations it accesses a 128 bit value at physical address 0xf0029624, which we call the magic value. The kernel module also accessses a 128 bit value at physical address 0xf0029634, which we call the key value.</p><p>The kernel module then has a couple of lookup tables for the magic value, one for vGPU capable GPUs and one for the others. So the kernel module looks for the magic value in both of these lookup tables, and if it is found that table entry also contains a set of AES-128 encrypted data blocks and a HMAC-SHA256 signature.</p><p>The signature is then validated by using the key value mentioned earlier to calculate the HMAC-SHA256 signature over the encrypted data blocks. If the signature is correct, then the blocks are decrypted using AES-128 and the same key.</p><p>Inside of the decrypted data is once again the PCI device ID.</p><p>So in order for the kernel module to accept the GPU as vGPU capable the magic value will have to be in the table of vGPU capable magic values, the key has to generate a valid HMAC-SHA256 signature and the AES-128 decrypted data blocks has to contain a vGPU capable PCI device ID. If any of these checks fail, then the error code 0x56 “Call not supported” is returned.</p><p>In order to make these checks pass the hooks in vgpu_unlock_hooks.c will look for a ioremap call that maps the physical address range that contain the magic and key values, recalculate the addresses of those values into the virtual address space of the kernel module, monitor memcpy operations reading at those addresses, and if such an operation occurs, keep a copy of the value until both are known, locate the lookup tables in the .rodata section of nv-kernel.o, find the signature and data bocks, validate the signature, decrypt the blocks, edit the PCI device ID in the decrypted data, reencrypt the blocks, regenerate the signature and insert the magic, blocks and signature into the table of vGPU capable magic values. And that’s what they do.</p><h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>支持的虚拟化卡类型，<code>pci_devid</code>转换源码如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">uint16_t</span> <span class="title">vgpu_unlock_pci_devid_to_vgpu_capable</span><span class="params">(<span class="keyword">uint16_t</span> pci_devid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (pci_devid)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">/* Maxwell */</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x1340</span> ... <span class="number">0x13bd</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x174d</span> ... <span class="number">0x179c</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x13bd</span>; <span class="comment">/* Tesla M10 */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Maxwell 2.0 */</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x13c0</span> ... <span class="number">0x1436</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x1617</span> ... <span class="number">0x1667</span>: <span class="comment">/* GM204 */</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x17c2</span> ... <span class="number">0x17fd</span>: <span class="comment">/* GM200 */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x13f2</span>; <span class="comment">/* Tesla M60 */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Pascal */</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x15f0</span> ... <span class="number">0x15f1</span>: <span class="comment">/* GP100GL */</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x1b00</span> ... <span class="number">0x1d56</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x1725</span> ... <span class="number">0x172f</span>: <span class="comment">/* GP100 */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x1b38</span>; <span class="comment">/* Tesla P40 */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Volta GV100 */</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x1d81</span>: <span class="comment">/* Titan V 16GB */</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x1dba</span>: <span class="comment">/* Quadro GV100 32GB */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x1db6</span>; <span class="comment">/* Tesla V100 32GB PCIE */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Turing */</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x1e02</span> ... <span class="number">0x1ff9</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x2182</span> ... <span class="number">0x21d1</span>: <span class="comment">/* TU116 */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x1e30</span>; <span class="comment">/* Quadro RTX 6000 */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Ampere */</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x2200</span> ... <span class="number">0x2600</span>: </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x2230</span>; <span class="comment">/* RTX A6000 */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pci_devid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><p><a href="https://github.com/DualCoder/vgpu_unlock">GitHub - DualCoder/vgpu_unlock: Unlock vGPU functionality for consumer grade GPUs.</a></p></li><li><p><a href="https://github.com/rupansh/vgpu_unlock_5.12">GitHub - rupansh/vgpu_unlock_5.12: Unlock vGPU functionality for consumer grade GPUs.</a></p></li><li><p><a href="https://github.com/mbilker/vgpu_unlock-rs">GitHub - mbilker/vgpu_unlock-rs: Unlock vGPU functionality for consumer grade GPUs</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/412942206">vgpu_unlock:解锁适用于消费级GPU的vGPU功能（Ubuntu 18.04/RHEL 8)</a></p></li><li><p><a href="https://www.jianshu.com/p/ba707afb5d57">在Proxmox VE 7.1 中开启vGPU_unlock，实现显卡虚拟化 - 简书</a></p></li><li><p><a href="https://cloud-atlas.readthedocs.io/zh_CN/latest/kvm/vgpu/vgpu_unlock.html#id6">vgpu_unlock介绍</a></p></li><li><p><a href="https://devicehunt.com/view/type/pci/vendor/10DE/">PCI 设备查询</a></p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;This tool enables the use of Geforce and Quadro GPUs with the NVIDIA v</summary>
      
    
    
    
    <category term="Accelerator" scheme="https://renyb2.github.io/categories/Accelerator/"/>
    
    
    <category term="NVIDIA" scheme="https://renyb2.github.io/tags/NVIDIA/"/>
    
    <category term="Accelerator" scheme="https://renyb2.github.io/tags/Accelerator/"/>
    
    <category term="vGPU" scheme="https://renyb2.github.io/tags/vGPU/"/>
    
  </entry>
  
  <entry>
    <title>NVIDIA使用：CUDA安装</title>
    <link href="https://renyb2.github.io/2022/11/30/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9ACUDA%E5%AE%89%E8%A3%85/"/>
    <id>https://renyb2.github.io/2022/11/30/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9ACUDA%E5%AE%89%E8%A3%85/</id>
    <published>2022-11-30T09:07:46.000Z</published>
    <updated>2022-11-30T10:08:31.974Z</updated>
    
    <content type="html"><![CDATA[<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="资源包下载"><a href="#资源包下载" class="headerlink" title="资源包下载"></a>资源包下载</h3><p>根据NVIDIA GPU Driver Version，在官网寻找合适的CUDA版本：<a href="https://docs.nvidia.com/cuda/cuda-toolkit-release-notes/index.html">Release Notes :: CUDA Toolkit Documentation</a></p><p>CUDA Toolkit下载地址：<a href="https://developer.nvidia.com/cuda-11.2.0-download-archive">CUDA Toolkit 11.2 Downloads | NVIDIA Developer</a></p><p>cuDNN下载地址：<a href="https://developer.nvidia.com/rdp/cudnn-download">官方cuDNN下载</a></p><table><thead><tr><th>CUDA Toolkit</th><th>Toolkit Driver Version</th><th></th></tr></thead><tbody><tr><td>—</td><td>Linux x86_64 Driver Version</td><td>Windows x86_64 Driver Version</td></tr><tr><td>CUDA 11.8 GA</td><td>&gt;=520.61.05</td><td>&gt;=522.06</td></tr><tr><td>CUDA 11.7 Update 1</td><td>&gt;=515.48.07</td><td>&gt;=516.31</td></tr><tr><td>CUDA 11.7 GA</td><td>&gt;=515.43.04</td><td>&gt;=516.01</td></tr><tr><td>CUDA 11.6 Update 2</td><td>&gt;=510.47.03</td><td>&gt;=511.65</td></tr><tr><td>CUDA 11.6 Update 1</td><td>&gt;=510.47.03</td><td>&gt;=511.65</td></tr><tr><td>CUDA 11.6 GA</td><td>&gt;=510.39.01</td><td>&gt;=511.23</td></tr><tr><td>CUDA 11.5 Update 2</td><td>&gt;=495.29.05</td><td>&gt;=496.13</td></tr><tr><td>CUDA 11.5 Update 1</td><td>&gt;=495.29.05</td><td>&gt;=496.13</td></tr><tr><td>CUDA 11.5 GA</td><td>&gt;=495.29.05</td><td>&gt;=496.04</td></tr><tr><td>CUDA 11.4 Update 4</td><td>&gt;=470.82.01</td><td>&gt;=472.50</td></tr><tr><td>CUDA 11.4 Update 3</td><td>&gt;=470.82.01</td><td>&gt;=472.50</td></tr><tr><td>CUDA 11.4 Update 2</td><td>&gt;=470.57.02</td><td>&gt;=471.41</td></tr><tr><td>CUDA 11.4 Update 1</td><td>&gt;=470.57.02</td><td>&gt;=471.41</td></tr><tr><td>CUDA 11.4.0 GA</td><td>&gt;=470.42.01</td><td>&gt;=471.11</td></tr><tr><td>CUDA 11.3.1 Update 1</td><td>&gt;=465.19.01</td><td>&gt;=465.89</td></tr><tr><td>CUDA 11.3.0 GA</td><td>&gt;=465.19.01</td><td>&gt;=465.89</td></tr><tr><td>CUDA 11.2.2 Update 2</td><td>&gt;=460.32.03</td><td>&gt;=461.33</td></tr><tr><td>CUDA 11.2.1 Update 1</td><td>&gt;=460.32.03</td><td>&gt;=461.09</td></tr><tr><td>CUDA 11.2.0 GA</td><td>&gt;=460.27.03</td><td>&gt;=460.82</td></tr><tr><td>CUDA 11.1.1 Update 1</td><td>&gt;=455.32</td><td>&gt;=456.81</td></tr><tr><td>CUDA 11.1 GA</td><td>&gt;=455.23</td><td>&gt;=456.38</td></tr><tr><td>CUDA 11.0.3 Update 1</td><td>&gt;= 450.51.06</td><td>&gt;= 451.82</td></tr><tr><td>CUDA 11.0.2 GA</td><td>&gt;= 450.51.05</td><td>&gt;= 451.48</td></tr><tr><td>CUDA 11.0.1 RC</td><td>&gt;= 450.36.06</td><td>&gt;= 451.22</td></tr><tr><td>CUDA 10.2.89</td><td>&gt;= 440.33</td><td>&gt;= 441.22</td></tr><tr><td>CUDA 10.1 (10.1.105 general release, and updates)</td><td>&gt;= 418.39</td><td>&gt;= 418.96</td></tr><tr><td>CUDA 10.0.130</td><td>&gt;= 410.48</td><td>&gt;= 411.31</td></tr><tr><td>CUDA 9.2 (9.2.148 Update 1)</td><td>&gt;= 396.37</td><td>&gt;= 398.26</td></tr><tr><td>CUDA 9.2 (9.2.88)</td><td>&gt;= 396.26</td><td>&gt;= 397.44</td></tr><tr><td>CUDA 9.1 (9.1.85)</td><td>&gt;= 390.46</td><td>&gt;= 391.29</td></tr><tr><td>CUDA 9.0 (9.0.76)</td><td>&gt;= 384.81</td><td>&gt;= 385.54</td></tr><tr><td>CUDA 8.0 (8.0.61 GA2)</td><td>&gt;= 375.26</td><td>&gt;= 376.51</td></tr><tr><td>CUDA 8.0 (8.0.44)</td><td>&gt;= 367.48</td><td>&gt;= 369.30</td></tr><tr><td>CUDA 7.5 (7.5.16)</td><td>&gt;= 352.31</td><td>&gt;= 353.66</td></tr><tr><td>CUDA 7.0 (7.0.28)</td><td>&gt;= 346.46</td><td>&gt;= 347.62</td></tr></tbody></table><h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装依赖</span></span><br><span class="line">yum install kernel-devel-$(uname -r) gcc dkms -y</span><br></pre></td></tr></table></figure><h3 id="安装CUDA"><a href="#安装CUDA" class="headerlink" title="安装CUDA"></a>安装CUDA</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> wget https://developer.download.nvidia.com/compute/cuda/11.2.0/local_installers/cuda_11.2.0_460.27.04_linux.run</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo sh cuda_11.2.0_460.27.04_linux.run</span></span><br></pre></td></tr></table></figure><p>输入<code>accept</code>，接受User License。</p><p><img src= "/img/loading.gif" data-lazy-src="/2022/11/30/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9ACUDA%E5%AE%89%E8%A3%85/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9ACUDA%E5%AE%89%E8%A3%85%5CCUDA%E5%AE%89%E8%A3%851.png"></p><p>若已安装GPU Driver，则需要取消Driver安装流程。</p><p><img src= "/img/loading.gif" data-lazy-src="/2022/11/30/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9ACUDA%E5%AE%89%E8%A3%85/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9ACUDA%E5%AE%89%E8%A3%85%5CCUDA%E5%AE%89%E8%A3%852.png"></p><p>安装完成。</p><p><img src= "/img/loading.gif" data-lazy-src="/2022/11/30/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9ACUDA%E5%AE%89%E8%A3%85/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9ACUDA%E5%AE%89%E8%A3%85%5CCUDA%E5%AE%89%E8%A3%853.png"></p><p>添加环境变量至<code>/etc/profile</code>，并更新当前环境变量信息：<code>source /etc/profile</code>。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export PATH=/usr/local/cuda-11.2/bin:$PATH</span><br><span class="line">export LD_LIBRARY_PATH=/usr/local/cuda-11.2/lib64:$LD_LIBRARY_PATH</span><br></pre></td></tr></table></figure><h3 id="安装cuDNN"><a href="#安装cuDNN" class="headerlink" title="安装cuDNN"></a>安装cuDNN</h3><p>cuDNN官方下载需要开发者账号，这里可以从百度网盘下载，资源链接：<a href="https://pan.baidu.com/s/10tNMl-X_2FscFBvIBjKcJg">cudnn-11.2-linux-x64-v8.1.0.77</a>，提取码：hq5x</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 转换格式</span></span><br><span class="line">cp cudnn-11.2-linux-x64-v8.1.0.77.solitairetheme8 cudnn-11.2-linux-x64-v8.1.0.77.tgz</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 解压至当前目录</span></span><br><span class="line">tar zxvf cudnn-11.2-linux-x64-v8.1.0.77.tgz</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝</span></span><br><span class="line">cd cuda</span><br><span class="line">cp ./include/cudnn.h /usr/local/cuda-11.2/include</span><br><span class="line">cp ./lib64/libcudnn* /usr/local/cuda-11.2/lib64</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 赋权</span></span><br><span class="line">chmod a+r /usr/local/cuda-11.2/include/cudnn.h /xxx/xxx/cuda-11.2/lib64/libcudnn*</span><br></pre></td></tr></table></figure><h2 id="功能验证"><a href="#功能验证" class="headerlink" title="功能验证"></a>功能验证</h2><h3 id="查看版本信息"><a href="#查看版本信息" class="headerlink" title="查看版本信息"></a>查看版本信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k104 renyb]# nvcc --version</span><br><span class="line">nvcc: NVIDIA (R) Cuda compiler driver</span><br><span class="line">Copyright (c) 2005-2020 NVIDIA Corporation</span><br><span class="line">Built on Mon_Nov_30_19:08:53_PST_2020</span><br><span class="line">Cuda compilation tools, release 11.2, V11.2.67</span><br><span class="line">Build cuda_11.2.r11.2/compiler.29373293_0</span><br></pre></td></tr></table></figure><h3 id="测试CUDA用例"><a href="#测试CUDA用例" class="headerlink" title="测试CUDA用例"></a>测试CUDA用例</h3><p>进入测试用例目录：<code>/root/NVIDIA_CUDA-11.2_Samples/1_Utilities/deviceQuery</code>，编译后运行<code>./deviceQuery</code>。</p><p>PS：编译需要c++环境，安装c++：<code>yum install -y gcc-c++</code></p><p><img src= "/img/loading.gif" data-lazy-src="/2022/11/30/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9ACUDA%E5%AE%89%E8%A3%85/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9ACUDA%E5%AE%89%E8%A3%85%5CCUDA_deviceQuery1.png"></p><p><img src= "/img/loading.gif" data-lazy-src="/2022/11/30/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9ACUDA%E5%AE%89%E8%A3%85/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9ACUDA%E5%AE%89%E8%A3%85%5CCUDA_deviceQuery2.png"></p><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><p><a href="https://docs.nvidia.com/cuda/cuda-toolkit-release-notes/index.html">Release Notes :: CUDA Toolkit Documentation</a></p></li><li><p><a href="https://developer.nvidia.com/cuda-11.2.0-download-archive">CUDA Toolkit 11.2 Downloads | NVIDIA Developer</a></p></li><li><p><a href="https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html#driver-installation">Installation Guide Linux :: CUDA Toolkit Documentation</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/466056522">CentOS 非root用户安装CUDA和cuDNN 多图详细教程</a></p></li><li><p><a href="https://blog.csdn.net/xueshengke/article/details/78134991">CentOS 7 安装 NVIDIA 显卡驱动和 CUDA Toolkit</a></p></li><li><p><a href="https://blog.csdn.net/qq_42683011/article/details/115438430">CentOS 7 安装CUDA 11.2</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/361835502">linux安装cudnn8.1.0（跳过NVIDIA官网）</a></p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;安装&quot;&gt;&lt;a href=&quot;#安装&quot; class=&quot;headerlink&quot; title=&quot;安装&quot;&gt;&lt;/a&gt;安装&lt;/h2&gt;&lt;h3 id=&quot;资源包下载&quot;&gt;&lt;a href=&quot;#资源包下载&quot; class=&quot;headerlink&quot; title=&quot;资源包下载&quot;&gt;&lt;/a&gt;资源包下</summary>
      
    
    
    
    <category term="Accelerator" scheme="https://renyb2.github.io/categories/Accelerator/"/>
    
    
    <category term="NVIDIA" scheme="https://renyb2.github.io/tags/NVIDIA/"/>
    
    <category term="Accelerator" scheme="https://renyb2.github.io/tags/Accelerator/"/>
    
  </entry>
  
  <entry>
    <title>Libvirt研发：9p virtio</title>
    <link href="https://renyb2.github.io/2022/11/30/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9A9p-virtio/"/>
    <id>https://renyb2.github.io/2022/11/30/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9A9p-virtio/</id>
    <published>2022-11-30T09:04:48.000Z</published>
    <updated>2023-02-10T09:48:07.589Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>主要需求是透传主机目录至虚机内部使用，9p virtio可以提供该能力，9p的官方介绍如下：</p><p>With QEMU’s 9pfs you can create virtual filesystem devices (virtio-9p-device) and expose them to guests, which essentially means that a certain directory on host machine is made directly accessible by a guest OS as a pass-through file system by using the <a href="https://en.wikipedia.org/wiki/Plan_9_from_Bell_Labs#9P_protocol">9P network protocol</a> for communication between host and guest, if desired even accessible, shared by several guests simultaniously.</p><p>This section details the steps involved in setting up VirtFS (Plan 9 folder sharing over Virtio - I/O virtualization framework) between the guest and host operating systems. The instructions are followed by an example usage of the mentioned steps.</p><p>This page is focused on user aspects like setting up 9pfs, configuration, performance tweaks. For the developers documentation of 9pfs refer to <a href="https://wiki.qemu.org/Documentation/9p" title="Documentation/9p">Documentation/9p</a> instead.</p><p>See also <a href="https://wiki.qemu.org/Documentation/9p_root_fs" title="Documentation/9p root fs">Documentation/9p_root_fs</a> for a complete HOWTO about installing and configuring an entire guest system ontop of 9p as root fs. </p><h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><h3 id="Libvirt层面"><a href="#Libvirt层面" class="headerlink" title="Libvirt层面"></a>Libvirt层面</h3><ol><li>在host OS上面创建新的目录和在这个目录里面创建一个文件</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@kvm:~# mkdir /tmp/shared</span><br><span class="line">root@kvm:~# touch /tmp/shared/file</span><br></pre></td></tr></table></figure><ol start="2"><li>在停止KVM的实例后，添加下面的配置</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@kvm:~# virsh edit kvm1</span><br><span class="line"> ...</span><br><span class="line"> &lt;devices&gt;</span><br><span class="line">   ...</span><br><span class="line">   &lt;filesystem type=&#x27;mount&#x27; accessmode=&#x27;passthrough&#x27;&gt;</span><br><span class="line">     &lt;source dir=&#x27;/tmp/shared&#x27;/&gt;</span><br><span class="line">     &lt;target dir=&#x27;tmp_shared&#x27;/&gt;</span><br><span class="line">   &lt;/filesystem&gt;</span><br><span class="line">   ...</span><br><span class="line"> &lt;/devices&gt;</span><br><span class="line"> ...</span><br><span class="line">Domain kvm1 XML configuration edited.</span><br></pre></td></tr></table></figure><ol start="3"><li>启动VM虚拟机：</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@kvm:~# virsh start kvm1</span><br><span class="line">Domain kvm1 started</span><br></pre></td></tr></table></figure><ol start="4"><li>执行以下命令连接控制台</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@kvm:~# virsh console kvm1</span><br><span class="line">Connected to domain kvm1</span><br><span class="line">Escape character is ^]</span><br><span class="line"></span><br><span class="line">Debian GNU/Linux 8 debian ttyS0</span><br><span class="line"></span><br><span class="line">debian login: root</span><br><span class="line">Password:</span><br><span class="line">...</span><br></pre></td></tr></table></figure><ol start="5"><li>虚机内部，确保9p和virtio内存驱动已经加载</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@debian:~# lsmod | grep 9p</span><br><span class="line">9pnet_virtio 17006 0</span><br><span class="line">9pnet 61632 1 9pnet_virtio</span><br><span class="line">virtio_ring 17513 3 virtio_pci,virtio_balloon,9pnet_virtio</span><br><span class="line">virtio 13058 3 virtio_pci,virtio_balloon,9pnet_virtio</span><br></pre></td></tr></table></figure><ol start="6"><li>虚机内部，挂载共享的目录到/mnt</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@debian:~# mount -t 9p -o trans=virtio tmp_shared /mnt</span><br></pre></td></tr></table></figure><ol start="7"><li>虚机内部，列出刚刚挂载的东西</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@debian:~# mount | grep tmp_shared</span><br><span class="line">tmp_shared on /mnt type 9p (rw,relatime,sync,dirsync,trans=virtio)</span><br></pre></td></tr></table></figure><ol start="8"><li>虚机内部，查看下我们在第一步创建的文件是否能看的到</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@debian:~# ls -la /mnt/</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 2 root root 4096 Mar 23 11:25 .</span><br><span class="line">drwxr-xr-x 22 root root 4096 Mar 22 16:28 ..</span><br><span class="line">-rw-r--r-- 1 root root 0 Mar 23 11:25 file</span><br></pre></td></tr></table></figure><h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="VM启动失败：’virtio-9p-pci’-is-not-a-valid-device-model-name"><a href="#VM启动失败：’virtio-9p-pci’-is-not-a-valid-device-model-name" class="headerlink" title="VM启动失败：’virtio-9p-pci’ is not a valid device model name"></a>VM启动失败：’virtio-9p-pci’ is not a valid device model name</h3><p><strong>解决方法：</strong> 需要重新编译 qemu, 编译时添加额外的 configure 参数 –enable-virtfs，可参考文档《Libvirt研发：Qemu编译》</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 安装依赖</span></span><br><span class="line">yum install -y libcap-devel libattr-devel</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. ../configure 编译时，增加--<span class="built_in">enable</span>-virtfs参数</span></span><br></pre></td></tr></table></figure><h3 id="VM挂载失败：mount-unknown-filesystem-type-‘9p’"><a href="#VM挂载失败：mount-unknown-filesystem-type-‘9p’" class="headerlink" title="VM挂载失败：mount: unknown filesystem type ‘9p’"></a>VM挂载失败：mount: unknown filesystem type ‘9p’</h3><p><strong>解决方法：</strong> 虚机的内核不支持‘9p’文件系统，需要重新编译内核，enable 9p功能。</p><p>可通过如下方法检测虚机内核是否支持9p，以下输出结果表示不支持。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k104 ~]# cat /boot/config-$(uname -r) | grep -i 9p</span><br><span class="line"><span class="meta">#</span><span class="bash"> CONFIG_NET_9P is not <span class="built_in">set</span></span></span><br></pre></td></tr></table></figure><p>编译内核时，添加如下配置至config文件内</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_NET_9P=y</span><br><span class="line">CONFIG_NET_9P_VIRTIO=y</span><br><span class="line">CONFIG_NET_9P_DEBUG=y (Optional)</span><br><span class="line">CONFIG_9P_FS=y</span><br><span class="line">CONFIG_9P_FS_POSIX_ACL=y</span><br><span class="line">CONFIG_PCI=y</span><br><span class="line">CONFIG_VIRTIO_PCI=y</span><br></pre></td></tr></table></figure><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><p><a href="https://wiki.qemu.org/Documentation/9p">Documentation/9p - QEMU</a></p></li><li><p><a href="https://wiki.qemu.org/Documentation/9psetup">Documentation/9psetup - QEMU</a></p></li><li><p><a href="http://www.linux-kvm.org/page/9p_virtio">9p virtio - KVM</a></p></li><li><p><a href="https://libvirt.org/formatdomain.html#filesystems">libvirt: Domain XML format</a></p></li><li><p><a href="https://www.cnblogs.com/wangjq19920210/p/11303309.html">在KVM主机和虚拟机之间共享目录 - salami_china - 博客园</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/359573010">qemu中使用 9p virtio, 支持 host 和 guest 中共享目录</a></p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;主要需求是透传主机目录至虚机内部使用，9p virtio可以提供该能力，9p的官方介绍如下：&lt;/p&gt;
&lt;p&gt;With QEMU’s 9pfs</summary>
      
    
    
    
    <category term="Libvirt" scheme="https://renyb2.github.io/categories/Libvirt/"/>
    
    
    <category term="KVM" scheme="https://renyb2.github.io/tags/KVM/"/>
    
    <category term="Libvirt" scheme="https://renyb2.github.io/tags/Libvirt/"/>
    
    <category term="虚拟化" scheme="https://renyb2.github.io/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
    <category term="Qemu" scheme="https://renyb2.github.io/tags/Qemu/"/>
    
  </entry>
  
  <entry>
    <title>Libvirt研发：Qemu编译</title>
    <link href="https://renyb2.github.io/2022/11/30/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91/"/>
    <id>https://renyb2.github.io/2022/11/30/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91/</id>
    <published>2022-11-30T05:49:49.000Z</published>
    <updated>2023-02-22T06:10:31.339Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>QEMU is a generic and open source machine &amp; userspace emulator and virtualizer.</p><p>QEMU is capable of emulating a complete machine in software without any need for hardware virtualization support. By using dynamic translation, it achieves very good performance. QEMU can also integrate with the Xen and KVM hypervisors to provide emulated hardware while allowing the hypervisor to manage the CPU. With hypervisor support, QEMU can achieve near native performance for CPUs. When QEMU emulates CPUs directly it is capable of running operating systems made for one machine (e.g. an ARMv7 board) on a different machine (e.g. an x86_64 PC board).</p><p>QEMU is also capable of providing userspace API virtualization for Linux and BSD kernel interfaces. This allows binaries compiled against one architecture ABI (e.g. the Linux PPC64 ABI) to be run on a host using a different architecture ABI (e.g. the Linux x86_64 ABI). This does not involve any hardware emulation, simply CPU and syscall emulation.</p><p>QEMU aims to fit into a variety of use cases. It can be invoked directly by users wishing to have full control over its behaviour and settings. It also aims to facilitate integration into higher level management layers, by providing a stable command line interface and monitor API. It is commonly invoked indirectly via the libvirt library when using open source applications such as oVirt, OpenStack and virt-manager.</p><p>QEMU as a whole is released under the GNU General Public License, version 2. For full licensing details, consult the LICENSE file.</p><h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><p><strong>1. 安装ninja</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone git://github.com/ninja-build/ninja.git &amp;&amp; cd ninja</span><br><span class="line"> ./configure.py --bootstrap</span><br><span class="line">cp ninja /usr/bin/</span><br><span class="line">ninja --version</span><br></pre></td></tr></table></figure><p><strong>2. 安装其他依赖</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install -y glib2 glib2-devel gtk2-devel</span><br></pre></td></tr></table></figure><h2 id="编译Qemu"><a href="#编译Qemu" class="headerlink" title="编译Qemu"></a>编译Qemu</h2><h3 id="基于官方源码包编译"><a href="#基于官方源码包编译" class="headerlink" title="基于官方源码包编译"></a>基于官方源码包编译</h3><p>官网下载地址：<a href="https://www.qemu.org/download/#source">Download QEMU - QEMU</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载源码</span></span><br><span class="line">wget https://download.qemu.org/qemu-7.2.0-rc2.tar.xz</span><br><span class="line">tar xvJf qemu-7.2.0-rc2.tar.xz</span><br><span class="line">cd qemu-7.2.0-rc2 &amp;&amp; mkdir build &amp;&amp; cd build</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置</span></span><br><span class="line">../configure</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译</span></span><br><span class="line">make -j$(nproc --ignore=1)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line">make install</span><br></pre></td></tr></table></figure><h3 id="基于GitHub编译"><a href="#基于GitHub编译" class="headerlink" title="基于GitHub编译"></a>基于GitHub编译</h3><p>GitHub：<a href="https://github.com/qemu/qemu/tree/master">https://github.com/qemu/qemu/tree/master</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载源码</span></span><br><span class="line">git clone https://github.com/qemu/qemu.git</span><br><span class="line">cd qemu</span><br><span class="line">git submodule init</span><br><span class="line">git submodule update --recursive</span><br><span class="line">mkdir build &amp;&amp; cd build</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置</span></span><br><span class="line">../configure</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译</span></span><br><span class="line">make -j$(nproc --ignore=1)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line">make install</span><br></pre></td></tr></table></figure><h2 id="configure-配置"><a href="#configure-配置" class="headerlink" title="configure 配置"></a>configure 配置</h2><h3 id="常用配置"><a href="#常用配置" class="headerlink" title="常用配置"></a>常用配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">../configure --target-list=x86_64-softmmu \</span><br><span class="line">    --enable-kvm --enable-spice --enable-vnc --enable-guest-agent \</span><br><span class="line">    --enable-rbd --enable-seccomp --enable-numa --enable-virglrenderer</span><br></pre></td></tr></table></figure><h3 id="可选配置"><a href="#可选配置" class="headerlink" title="可选配置"></a>可选配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line">[root@k104 qemu-2.12.0]# ./configure --help</span><br><span class="line"></span><br><span class="line">Usage: configure [options]</span><br><span class="line">Options: [defaults in brackets after descriptions]</span><br><span class="line"></span><br><span class="line">Standard options:</span><br><span class="line">  --help                   print this message</span><br><span class="line">  --prefix=PREFIX          install in PREFIX [/usr/local]</span><br><span class="line">  --interp-prefix=PREFIX   where to find shared libraries, etc.</span><br><span class="line">                           use %M for cpu name [/usr/gnemul/qemu-%M]</span><br><span class="line">  --target-list=LIST       set target list (default: build everything)</span><br><span class="line">                           Available targets: aarch64-softmmu alpha-softmmu</span><br><span class="line">                           arm-softmmu cris-softmmu hppa-softmmu i386-softmmu</span><br><span class="line">                           lm32-softmmu m68k-softmmu microblazeel-softmmu</span><br><span class="line">                           microblaze-softmmu mips64el-softmmu mips64-softmmu</span><br><span class="line">                           mipsel-softmmu mips-softmmu moxie-softmmu</span><br><span class="line">                           nios2-softmmu or1k-softmmu ppc64-softmmu</span><br><span class="line">                           ppcemb-softmmu ppc-softmmu riscv32-softmmu</span><br><span class="line">                           riscv64-softmmu s390x-softmmu sh4eb-softmmu</span><br><span class="line">                           sh4-softmmu sparc64-softmmu sparc-softmmu</span><br><span class="line">                           tricore-softmmu unicore32-softmmu x86_64-softmmu</span><br><span class="line">                           xtensaeb-softmmu xtensa-softmmu</span><br><span class="line">                           aarch64_be-linux-user aarch64-linux-user</span><br><span class="line">                           alpha-linux-user armeb-linux-user arm-linux-user</span><br><span class="line">                           cris-linux-user hppa-linux-user i386-linux-user</span><br><span class="line">                           m68k-linux-user microblazeel-linux-user</span><br><span class="line">                           microblaze-linux-user mips64el-linux-user</span><br><span class="line">                           mips64-linux-user mipsel-linux-user mips-linux-user</span><br><span class="line">                           mipsn32el-linux-user mipsn32-linux-user</span><br><span class="line">                           nios2-linux-user or1k-linux-user</span><br><span class="line">                           ppc64abi32-linux-user ppc64le-linux-user</span><br><span class="line">                           ppc64-linux-user ppc-linux-user riscv32-linux-user</span><br><span class="line">                           riscv64-linux-user s390x-linux-user sh4eb-linux-user</span><br><span class="line">                           sh4-linux-user sparc32plus-linux-user</span><br><span class="line">                           sparc64-linux-user sparc-linux-user</span><br><span class="line">                           tilegx-linux-user x86_64-linux-user</span><br><span class="line">                           xtensaeb-linux-user xtensa-linux-user</span><br><span class="line"></span><br><span class="line">Advanced options (experts only):</span><br><span class="line">  --source-path=PATH       path of source code [/root/renyb/qemu/qemu-2.12.0]</span><br><span class="line">  --cross-prefix=PREFIX    use PREFIX for compile tools []</span><br><span class="line">  --cc=CC                  use C compiler CC [cc]</span><br><span class="line">  --iasl=IASL              use ACPI compiler IASL [iasl]</span><br><span class="line">  --host-cc=CC             use C compiler CC [cc] for code run at</span><br><span class="line">                           build time</span><br><span class="line">  --cxx=CXX                use C++ compiler CXX [c++]</span><br><span class="line">  --objcc=OBJCC            use Objective-C compiler OBJCC [cc]</span><br><span class="line">  --extra-cflags=CFLAGS    append extra C compiler flags QEMU_CFLAGS</span><br><span class="line">  --extra-cxxflags=CXXFLAGS append extra C++ compiler flags QEMU_CXXFLAGS</span><br><span class="line">  --extra-ldflags=LDFLAGS  append extra linker flags LDFLAGS</span><br><span class="line">  --make=MAKE              use specified make [make]</span><br><span class="line">  --install=INSTALL        use specified install [install]</span><br><span class="line">  --python=PYTHON          use specified python [python]</span><br><span class="line">  --smbd=SMBD              use specified smbd [/usr/sbin/smbd]</span><br><span class="line">  --with-git=GIT           use specified git [git]</span><br><span class="line">  --static                 enable static build [no]</span><br><span class="line">  --mandir=PATH            install man pages in PATH</span><br><span class="line">  --datadir=PATH           install firmware in PATH/qemu</span><br><span class="line">  --docdir=PATH            install documentation in PATH/qemu</span><br><span class="line">  --bindir=PATH            install binaries in PATH</span><br><span class="line">  --libdir=PATH            install libraries in PATH</span><br><span class="line">  --libexecdir=PATH        install helper binaries in PATH</span><br><span class="line">  --sysconfdir=PATH        install config in PATH/qemu</span><br><span class="line">  --localstatedir=PATH     install local state in PATH (set at runtime on win32)</span><br><span class="line">  --firmwarepath=PATH      search PATH for firmware files</span><br><span class="line">  --with-confsuffix=SUFFIX suffix for QEMU data inside datadir/libdir/sysconfdir [/qemu]</span><br><span class="line">  --with-pkgversion=VERS   use specified string as sub-version of the package</span><br><span class="line">  --enable-debug           enable common debug build options</span><br><span class="line">  --enable-sanitizers      enable default sanitizers</span><br><span class="line">  --disable-strip          disable stripping binaries</span><br><span class="line">  --disable-werror         disable compilation abort on warning</span><br><span class="line">  --disable-stack-protector disable compiler-provided stack protection</span><br><span class="line">  --audio-drv-list=LIST    set audio drivers list:</span><br><span class="line">                           Available drivers: oss alsa sdl pa</span><br><span class="line">  --block-drv-whitelist=L  Same as --block-drv-rw-whitelist=L</span><br><span class="line">  --block-drv-rw-whitelist=L</span><br><span class="line">                           set block driver read-write whitelist</span><br><span class="line">                           (affects only QEMU, not qemu-img)</span><br><span class="line">  --block-drv-ro-whitelist=L</span><br><span class="line">                           set block driver read-only whitelist</span><br><span class="line">                           (affects only QEMU, not qemu-img)</span><br><span class="line">  --enable-trace-backends=B Set trace backend</span><br><span class="line">                           Available backends: dtrace ftrace log simple syslog ust</span><br><span class="line">  --with-trace-file=NAME   Full PATH,NAME of file to store traces</span><br><span class="line">                           Default:trace-&lt;pid&gt;</span><br><span class="line">  --disable-slirp          disable SLIRP userspace network connectivity</span><br><span class="line">  --enable-tcg-interpreter enable TCG with bytecode interpreter (TCI)</span><br><span class="line">  --enable-malloc-trim     enable libc malloc_trim() for memory optimization</span><br><span class="line">  --oss-lib                path to OSS library</span><br><span class="line">  --cpu=CPU                Build for host CPU [x86_64]</span><br><span class="line">  --with-coroutine=BACKEND coroutine backend. Supported options:</span><br><span class="line">                           ucontext, sigaltstack, windows</span><br><span class="line">  --enable-gcov            enable test coverage analysis with gcov</span><br><span class="line">  --gcov=GCOV              use specified gcov [gcov]</span><br><span class="line">  --disable-blobs          disable installing provided firmware blobs</span><br><span class="line">  --with-vss-sdk=SDK-path  enable Windows VSS support in QEMU Guest Agent</span><br><span class="line">  --with-win-sdk=SDK-path  path to Windows Platform SDK (to build VSS .tlb)</span><br><span class="line">  --tls-priority           default TLS protocol/cipher priority string</span><br><span class="line">  --enable-gprof           QEMU profiling with gprof</span><br><span class="line">  --enable-profiler        profiler support</span><br><span class="line">  --enable-xen-pv-domain-build</span><br><span class="line">                           xen pv domain builder</span><br><span class="line">  --enable-debug-stack-usage</span><br><span class="line">                           track the maximum stack usage of stacks created by qemu_alloc_stack</span><br><span class="line"></span><br><span class="line">Optional features, enabled with --enable-FEATURE and</span><br><span class="line">disabled with --disable-FEATURE, default is enabled if available:</span><br><span class="line"></span><br><span class="line">  system          all system emulation targets</span><br><span class="line">  user            supported user emulation targets</span><br><span class="line">  linux-user      all linux usermode emulation targets</span><br><span class="line">  bsd-user        all BSD usermode emulation targets</span><br><span class="line">  docs            build documentation</span><br><span class="line">  guest-agent     build the QEMU Guest Agent</span><br><span class="line">  guest-agent-msi build guest agent Windows MSI installation package</span><br><span class="line">  pie             Position Independent Executables</span><br><span class="line">  modules         modules support</span><br><span class="line">  debug-tcg       TCG debugging (default is disabled)</span><br><span class="line">  debug-info      debugging information</span><br><span class="line">  sparse          sparse checker</span><br><span class="line"></span><br><span class="line">  gnutls          GNUTLS cryptography support</span><br><span class="line">  nettle          nettle cryptography support</span><br><span class="line">  gcrypt          libgcrypt cryptography support</span><br><span class="line">  sdl             SDL UI</span><br><span class="line">  --with-sdlabi     select preferred SDL ABI 1.2 or 2.0</span><br><span class="line">  gtk             gtk UI</span><br><span class="line">  --with-gtkabi     select preferred GTK ABI 2.0 or 3.0</span><br><span class="line">  vte             vte support for the gtk UI</span><br><span class="line">  curses          curses UI</span><br><span class="line">  vnc             VNC UI support</span><br><span class="line">  vnc-sasl        SASL encryption for VNC server</span><br><span class="line">  vnc-jpeg        JPEG lossy compression for VNC server</span><br><span class="line">  vnc-png         PNG compression for VNC server</span><br><span class="line">  cocoa           Cocoa UI (Mac OS X only)</span><br><span class="line">  virtfs          VirtFS</span><br><span class="line">  mpath           Multipath persistent reservation passthrough</span><br><span class="line">  xen             xen backend driver support</span><br><span class="line">  xen-pci-passthrough</span><br><span class="line">  brlapi          BrlAPI (Braile)</span><br><span class="line">  curl            curl connectivity</span><br><span class="line">  membarrier      membarrier system call (for Linux 4.14+ or Windows)</span><br><span class="line">  fdt             fdt device tree</span><br><span class="line">  bluez           bluez stack connectivity</span><br><span class="line">  kvm             KVM acceleration support</span><br><span class="line">  hax             HAX acceleration support</span><br><span class="line">  hvf             Hypervisor.framework acceleration support</span><br><span class="line">  whpx            Windows Hypervisor Platform acceleration support</span><br><span class="line">  rdma            Enable RDMA-based migration and PVRDMA support</span><br><span class="line">  vde             support for vde network</span><br><span class="line">  netmap          support for netmap network</span><br><span class="line">  linux-aio       Linux AIO support</span><br><span class="line">  cap-ng          libcap-ng support</span><br><span class="line">  attr            attr and xattr support</span><br><span class="line">  vhost-net       vhost-net acceleration support</span><br><span class="line">  vhost-crypto    vhost-crypto acceleration support</span><br><span class="line">  spice           spice</span><br><span class="line">  rbd             rados block device (rbd)</span><br><span class="line">  libiscsi        iscsi support</span><br><span class="line">  libnfs          nfs support</span><br><span class="line">  smartcard       smartcard support (libcacard)</span><br><span class="line">  libusb          libusb (for usb passthrough)</span><br><span class="line">  live-block-migration   Block migration in the main migration stream</span><br><span class="line">  usb-redir       usb network redirection support</span><br><span class="line">  lzo             support of lzo compression library</span><br><span class="line">  snappy          support of snappy compression library</span><br><span class="line">  bzip2           support of bzip2 compression library</span><br><span class="line">                  (for reading bzip2-compressed dmg images)</span><br><span class="line">  seccomp         seccomp support</span><br><span class="line">  coroutine-pool  coroutine freelist (better performance)</span><br><span class="line">  glusterfs       GlusterFS backend</span><br><span class="line">  tpm             TPM support</span><br><span class="line">  libssh2         ssh block device support</span><br><span class="line">  numa            libnuma support</span><br><span class="line">  libxml2         for Parallels image format</span><br><span class="line">  tcmalloc        tcmalloc support</span><br><span class="line">  jemalloc        jemalloc support</span><br><span class="line">  replication     replication support</span><br><span class="line">  vhost-vsock     virtio sockets device support</span><br><span class="line">  opengl          opengl support</span><br><span class="line">  virglrenderer   virgl rendering support</span><br><span class="line">  xfsctl          xfsctl support</span><br><span class="line">  qom-cast-debug  cast debugging support</span><br><span class="line">  tools           build qemu-io, qemu-nbd and qemu-image tools</span><br><span class="line">  vxhs            Veritas HyperScale vDisk backend support</span><br><span class="line">  crypto-afalg    Linux AF_ALG crypto backend driver</span><br><span class="line">  vhost-user      vhost-user support</span><br><span class="line">  capstone        capstone disassembler support</span><br><span class="line"></span><br><span class="line">NOTE: The object files are built at the place where configure is launched</span><br></pre></td></tr></table></figure><h2 id="功能验证"><a href="#功能验证" class="headerlink" title="功能验证"></a>功能验证</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k104 ~]# qemu-system-aarch64 --version</span><br><span class="line">QEMU emulator version 2.12.0</span><br><span class="line">Copyright (c) 2003-2017 Fabrice Bellard and the QEMU Project developers</span><br><span class="line">[root@k104 ~]#</span><br><span class="line">[root@k104 ~]# qemu-aarch64 --version</span><br><span class="line">qemu-aarch64 version 2.12.0</span><br><span class="line">Copyright (c) 2003-2017 Fabrice Bellard and the QEMU Project developers</span><br></pre></td></tr></table></figure><p>qemu-aarch64 是用户模式的模拟器（更精确的表述应该是系统调用模拟器）</p><p>qemu-system-aarch64 是系统模拟器，可以模拟出整个机器并运行操作系统</p><p>qemu-aarch64 仅可用来运行二进制文件，因此你可以交叉编译完例如hello world之类的程序然后交给 qemu-aarch64 来运行，简单而高效。</p><p>而 qemu-system-aarch64 则需要把hello world程序下载到客户机操作系统能访问到的硬盘里才能运行。</p><h2 id="卸载Qemu"><a href="#卸载Qemu" class="headerlink" title="卸载Qemu"></a>卸载Qemu</h2><p>源码安装的Qemu，无法通过系统工具进行卸载，也没有办法通过make uninstall方法卸载，只能通过删除文件的方式进行卸载，需要到这四个目录中找出相关的文件然后删除掉：</p><ul><li><p>可执行文件默认放在：/usr/local/bin</p></li><li><p>库文件默认放在：/usr/local/libexec</p></li><li><p>配置文件默认放在：/usr/local/etc</p></li><li><p>共享文件默认放在：/usr/local/share</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 编译默认存储位置，执行configure后输出</span></span><br><span class="line">Install prefix    /usr/local</span><br><span class="line">BIOS directory    /usr/local/share/qemu</span><br><span class="line">firmware path     /usr/local/share/qemu-firmware</span><br><span class="line">binary directory  /usr/local/bin</span><br><span class="line">library directory /usr/local/lib</span><br><span class="line">module directory  /usr/local/lib/qemu</span><br><span class="line">libexec directory /usr/local/libexec</span><br><span class="line">include directory /usr/local/include</span><br><span class="line">config directory  /usr/local/etc</span><br><span class="line">local state directory   /usr/local/var</span><br><span class="line">Manual directory  /usr/local/share/man</span><br><span class="line">ELF interp prefix /usr/gnemul/qemu-%M</span><br><span class="line">Source path       /root/renyb/qemu-2.12.0</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="编译报错：error-‘SIOCGSTAMPNS’undeclared-here-not-in-a-function"><a href="#编译报错：error-‘SIOCGSTAMPNS’undeclared-here-not-in-a-function" class="headerlink" title="编译报错：error: ‘SIOCGSTAMPNS’undeclared here (not in a function)"></a>编译报错：error: ‘SIOCGSTAMPNS’undeclared here (not in a function)</h3><p><img src= "/img/loading.gif" data-lazy-src="/2022/11/30/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91%5C%E7%BC%96%E8%AF%91%E6%8A%A5%E9%94%991.png"></p><p><strong>解决方案：</strong><code>qemu-2.12.0/linux-user/ioctls.h</code>增加头文件引用，内容如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sockios.h&gt;</span></span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="VM启动失败：unsupported-machine-type"><a href="#VM启动失败：unsupported-machine-type" class="headerlink" title="VM启动失败：unsupported machine type"></a>VM启动失败：unsupported machine type</h3><p><strong>报错信息：</strong> qemu-system-x86_64: -machine pc-i440fx-rhel7.2.0,accel=kvm,usb=off,dump-guest-core=off: unsupported machine type</p><p><img src= "/img/loading.gif" data-lazy-src="/2022/11/30/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91%5Cunsupported_machine_type.png"></p><p><strong>解决方案：</strong> 通过命令<code>qemu-system-x86_64 -machine help</code>查看支持的machine信息。若上层为OpenStack，则修改nova compute配置文件，libvirt - hw_machine_type = x86_64=pc-q35-2.12（x86_64=后面的值参考命令行输出）。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@k104 ~]# qemu-system-x86_64 -machine help</span><br><span class="line">Supported machines are:</span><br><span class="line">pc-i440fx-2.9        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-2.8        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-2.7        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-2.6        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-2.5        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-2.4        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-2.3        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-2.2        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc                   Standard PC (i440FX + PIIX, 1996) (alias of pc-i440fx-2.12)</span><br><span class="line">pc-i440fx-2.12       Standard PC (i440FX + PIIX, 1996) (default)</span><br><span class="line">pc-i440fx-2.11       Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-2.10       Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-2.1        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-2.0        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-1.7        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-1.6        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-1.5        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-i440fx-1.4        Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-1.3               Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-1.2               Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-1.1               Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-1.0               Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-0.15              Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-0.14              Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-0.13              Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-0.12              Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-0.11              Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-0.10              Standard PC (i440FX + PIIX, 1996)</span><br><span class="line">pc-q35-2.9           Standard PC (Q35 + ICH9, 2009)</span><br><span class="line">pc-q35-2.8           Standard PC (Q35 + ICH9, 2009)</span><br><span class="line">pc-q35-2.7           Standard PC (Q35 + ICH9, 2009)</span><br><span class="line">pc-q35-2.6           Standard PC (Q35 + ICH9, 2009)</span><br><span class="line">pc-q35-2.5           Standard PC (Q35 + ICH9, 2009)</span><br><span class="line">pc-q35-2.4           Standard PC (Q35 + ICH9, 2009)</span><br><span class="line">q35                  Standard PC (Q35 + ICH9, 2009) (alias of pc-q35-2.12)</span><br><span class="line">pc-q35-2.12          Standard PC (Q35 + ICH9, 2009)</span><br><span class="line">pc-q35-2.11          Standard PC (Q35 + ICH9, 2009)</span><br><span class="line">pc-q35-2.10          Standard PC (Q35 + ICH9, 2009)</span><br><span class="line">isapc                ISA-only PC</span><br><span class="line">none                 empty machine</span><br></pre></td></tr></table></figure><h3 id="VM启动失败：seccomp-support-is-disabled"><a href="#VM启动失败：seccomp-support-is-disabled" class="headerlink" title="VM启动失败：seccomp support is disabled"></a>VM启动失败：seccomp support is disabled</h3><p><strong>报错信息：</strong> qemu-system-x86_64: -sandbox on,obsolete=deny,elevateprivileges=deny,spawn=deny,resourcecontrol=deny: seccomp support is disabled</p><p><img src= "/img/loading.gif" data-lazy-src="/2022/11/30/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91%5Cunsupported_machine_type.png"></p><p><strong>参考链接：</strong><a href="https://cloud.tencent.com/developer/article/1162100">虚拟化安全sandbox技术分析 - 腾讯云开发者社区-腾讯云</a></p><p><strong>解决方案：</strong> 有两种方法可解决该问题：</p><p>方法1 - 编译时，需启用<code>seccomp</code>。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 安装依赖</span></span><br><span class="line">yum -y install libseccomp libseccomp-devel</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. ../configure 编译时，增加--<span class="built_in">enable</span>-seccomp参数</span></span><br></pre></td></tr></table></figure><p>方法2 - <code>/etc/libvirt/qemu.conf</code>配置文件中，关闭<code>seccomp_sandbox</code>。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Use seccomp syscall sandbox <span class="keyword">in</span> QEMU.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1 == seccomp enabled, 0 == seccomp disabled</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If it is <span class="built_in">unset</span> (or -1), <span class="keyword">then</span> seccomp will be enabled</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> only <span class="keyword">if</span> QEMU &gt;= 2.11.0 is detected, otherwise it is</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> left disabled. This ensures the default config gets</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> protection <span class="keyword">for</span> new QEMU using the blacklist approach.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line">seccomp_sandbox = 0</span><br></pre></td></tr></table></figure><h3 id="VM启动失败：NUMA-node-binding-are-not-supported-by-this-QEMU"><a href="#VM启动失败：NUMA-node-binding-are-not-supported-by-this-QEMU" class="headerlink" title="VM启动失败：NUMA node binding are not supported by this QEMU"></a>VM启动失败：NUMA node binding are not supported by this QEMU</h3><p><strong>报错信息：</strong> qemu-system-x86_64: -object memory-backend-file,id=ram-node0,prealloc=yes,mem-path=/dev/hugepages/libvirt/qemu/1-instance-0000006f,share=yes,size=4294967296,host-nodes=0,policy=bind: NUMA node binding are not supported by this QEMU</p><p><img src= "/img/loading.gif" data-lazy-src="/2022/11/30/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91%5Cunsupported_numa.png"></p><p><strong>解决方案：</strong> 编译时，需启用<code>numa</code>。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 安装依赖</span></span><br><span class="line">yum -y install numactl-libs</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. ../configure 编译时，增加--<span class="built_in">enable</span>-numa参数</span></span><br></pre></td></tr></table></figure><h3 id="VM启动失败：Unknown-protocol-‘rbd’"><a href="#VM启动失败：Unknown-protocol-‘rbd’" class="headerlink" title="VM启动失败：Unknown protocol ‘rbd’"></a>VM启动失败：Unknown protocol ‘rbd’</h3><p><strong>报错信息：</strong> qemu-system-x86_64: -drive file=rbd:cinder-volumes/c1a319f3-9185-4f94-9986-1fb7f6a0c18d:id=cinder:auth_supported=cephx;none:mon_host=111.111.9.104:6789,file.password-secret=virtio-disk0-secret0,format=raw,if=none,id=drive-virtio-disk0,serial=c1a319f3-9185-4f94-9986-1fb7f6a0c18d,cache=writeback,discard=unmap: Unknown protocol ‘rbd’</p><p><img src= "/img/loading.gif" data-lazy-src="/2022/11/30/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91%5Cunknown_protocol_rbd.png"></p><p><strong>解决方案：</strong> 编译时，需启用<code>rbd</code>。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 安装依赖</span></span><br><span class="line">yum -y install librbd-devel</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. ../configure 编译时，增加--<span class="built_in">enable</span>-rbd参数</span></span><br></pre></td></tr></table></figure><p>检测是否支持rbd：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">()[root@k207 /]# qemu-img -h | grep rbd</span><br><span class="line">Supported formats: blkdebug blkreplay blkverify bochs cloop copy-on-read dmg file ftp ftps gluster host_cdrom host_device http https iscsi iser luks nbd null-aio null-co nvme parallels qcow qcow2 qed quorum raw rbd sheepdog ssh throttle vdi vhdx vmdk vpc vvfat</span><br></pre></td></tr></table></figure><h3 id="VM启动失败：no-secret-with-matching-uuid-‘xxx’"><a href="#VM启动失败：no-secret-with-matching-uuid-‘xxx’" class="headerlink" title="VM启动失败：no secret with matching uuid ‘xxx’"></a>VM启动失败：no secret with matching uuid ‘xxx’</h3><p><strong>报错信息：</strong> libvirtError: Secret not found: no secret with matching uuid ‘457eb676-33da-42ec-9a8c-9293d545c337’</p><p><img src= "/img/loading.gif" data-lazy-src="/2022/11/30/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91%5Csecret_not_found.png"></p><p><strong>解决方案：</strong> 更换libvirt后，ceph对接的secret本机不存在，导致创建ceph卷报错，需手动导入该secret。libvirt对接ceph可参考官方文档：</p><ul><li><p><a href="https://docs.ceph.com/en/latest/rbd/libvirt/">Using libvirt with Ceph RBD &mdash; Ceph Documentation</a></p></li><li><p><a href="https://libvirt.org/formatsecret.html">libvirt: Secret XML format</a></p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建virsh secret xml</span></span><br><span class="line">cat &gt; secret.xml &lt;&lt;EOF</span><br><span class="line">&lt;secret ephemeral=&#x27;no&#x27; private=&#x27;no&#x27;&gt;</span><br><span class="line">    &lt;uuid&gt;457eb676-33da-42ec-9a8c-9293d545c337&lt;/uuid&gt;</span><br><span class="line">    &lt;usage type=&#x27;ceph&#x27;&gt;</span><br><span class="line">        &lt;name&gt;client.libvirt secret&lt;/name&gt;</span><br><span class="line">    &lt;/usage&gt;</span><br><span class="line">&lt;/secret&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建virsh secret</span></span><br><span class="line">virsh secret-define --file secret.xml</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看ceph secret key</span></span><br><span class="line">[root@k104 ceph]# cat ceph.client.cinder.keyring</span><br><span class="line">[client.cinder]</span><br><span class="line">        key = AQCK1O1jjokSKxAAClJwrXT/POuFyRX5LCS2dQ==</span><br><span class="line">        caps mon = &quot;profile rbd&quot;</span><br><span class="line">        caps osd = &quot;profile rbd&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置virsh secret</span></span><br><span class="line">virsh secret-set-value --secret 457eb676-33da-42ec-9a8c-9293d545c337 --base64 AQCK1O1jjokSKxAAClJwrXT/POuFyRX5LCS2dQ==</span><br></pre></td></tr></table></figure><h3 id="VM启动失败：-Could-not-access-KVM-kernel-module-Permission-denied"><a href="#VM启动失败：-Could-not-access-KVM-kernel-module-Permission-denied" class="headerlink" title="VM启动失败： Could not access KVM kernel module: Permission denied"></a>VM启动失败： Could not access KVM kernel module: Permission denied</h3><p><strong>报错信息：</strong> libvirtError: internal error: process exited while connecting to monitor: Could not access KVM kernel module: Permission denied</p><p><img src= "/img/loading.gif" data-lazy-src="/2022/11/30/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9AQemu%E7%BC%96%E8%AF%91%5Ckvm_kernel_module_permission_denied.png"></p><p><strong>解决方案：</strong> /dev/kvm设备权限不对，需授予普通用户读写权限。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@k104 ~]# ll /dev/kvm</span><br><span class="line">crw------- 1 root root 10, 232 Feb 22 13:47 /dev/kvm</span><br><span class="line">[root@k104 ~]#</span><br><span class="line">[root@k104 ~]# rmmod kvm_intel</span><br><span class="line">[root@k104 ~]# rmmod kvm</span><br><span class="line">[root@k104 ~]# modprobe kvm</span><br><span class="line">[root@k104 ~]# modprobe kvm_intel</span><br><span class="line">[root@k104 ~]#</span><br><span class="line">[root@k104 ~]# ll /dev/kvm</span><br><span class="line">crw------- 1 root root 10, 232 Feb 22 13:48 /dev/kvm</span><br><span class="line">[root@k104 ~]#</span><br><span class="line">[root@k104 ~]# chmod 666 /dev/kvm</span><br><span class="line">[root@k104 ~]#</span><br><span class="line">[root@k104 ~]# ll /dev/kvm</span><br><span class="line">crw-rw-rw- 1 root root 10, 232 Feb 22 13:48 /dev/kvm</span><br></pre></td></tr></table></figure><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://wiki.qemu.org/Documentation">QEMU官方文档：Documentation</a></li><li><a href="https://wiki.qemu.org/Hosts/Linux">QEMU官方文档：Hosts/Linux - QEMU</a></li><li><a href="https://hlyani.github.io/notes/openstack/qemu_make.html">QEMU 源码编译</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;QEMU is a generic and open source machine &amp;amp; userspace emulator and</summary>
      
    
    
    
    <category term="Libvirt" scheme="https://renyb2.github.io/categories/Libvirt/"/>
    
    
    <category term="KVM" scheme="https://renyb2.github.io/tags/KVM/"/>
    
    <category term="Libvirt" scheme="https://renyb2.github.io/tags/Libvirt/"/>
    
    <category term="虚拟化" scheme="https://renyb2.github.io/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
    <category term="Qemu" scheme="https://renyb2.github.io/tags/Qemu/"/>
    
  </entry>
  
  <entry>
    <title>NVIDIA使用：GPU驱动安装</title>
    <link href="https://renyb2.github.io/2022/11/22/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9AGPU%E9%A9%B1%E5%8A%A8%E5%AE%89%E8%A3%85/"/>
    <id>https://renyb2.github.io/2022/11/22/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9AGPU%E9%A9%B1%E5%8A%A8%E5%AE%89%E8%A3%85/</id>
    <published>2022-11-22T08:12:56.000Z</published>
    <updated>2023-02-13T06:38:23.721Z</updated>
    
    <content type="html"><![CDATA[<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="安装依赖环境"><a href="#安装依赖环境" class="headerlink" title="安装依赖环境"></a>安装依赖环境</h3><p>要装的两个依赖分别是：gcc、kernel-devel，其中需要注意的是，kernel-devel的版本需要与当前内核的版本一致，不然后面会出现找不到文件的情况。</p><p>1）查看我的内核版本：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k104 vGPU]# uname -r</span><br><span class="line">3.10.0-1127.el7.x86_64</span><br></pre></td></tr></table></figure><p>2）查看一下可以安装的版本，安装对应内核版本：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k104 vGPU]# yum list | grep kernel-devel</span><br><span class="line">kernel-devel.x86_64                       3.10.0-1127.el7              @/kernel-devel-3.10.0-1127.el7.x86_64</span><br></pre></td></tr></table></figure><p>3）安装依赖</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install kernel-devel-$(uname -r) gcc dkms -y</span><br></pre></td></tr></table></figure><h3 id="屏蔽系统自带的nouveau（重启生效）"><a href="#屏蔽系统自带的nouveau（重启生效）" class="headerlink" title="屏蔽系统自带的nouveau（重启生效）"></a>屏蔽系统自带的nouveau（重启生效）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;blacklist nouveau&quot; &gt;&gt; /lib/modprobe.d/dist-blacklist.conf</span><br><span class="line">echo &quot;options nouveau modeset=0&quot; &gt;&gt; /lib/modprobe.d/dist-blacklist.conf</span><br><span class="line">mv /boot/initramfs-$(uname -r).img /boot/initramfs-$(uname -r).img.bak </span><br><span class="line">dracut /boot/initramfs-$(uname -r).img $(uname -r)</span><br><span class="line">systemctl set-default multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">执行结束后重启</span></span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">重启后查看是否成功禁用</span></span><br><span class="line">lspci -nn |grep -i NVI</span><br><span class="line">lspci -kkd 10de:1eb8</span><br></pre></td></tr></table></figure><p>禁用前：</p><img src= "/img/loading.gif" data-lazy-src="/2022/11/22/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9AGPU%E9%A9%B1%E5%8A%A8%E5%AE%89%E8%A3%85/enable_nouveau.png" title alt data-align="center"><p>禁用后：</p><img src= "/img/loading.gif" data-lazy-src="/2022/11/22/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9AGPU%E9%A9%B1%E5%8A%A8%E5%AE%89%E8%A3%85/disable_nouveau.png" title alt data-align="center"><h3 id="安装NVIDIA-GPU驱动"><a href="#安装NVIDIA-GPU驱动" class="headerlink" title="安装NVIDIA GPU驱动"></a>安装NVIDIA GPU驱动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 启动安装</span></span><br><span class="line">chmod +x NVIDIA-Linux-x86_64-470.82.01.run &amp;&amp; ./NVIDIA-Linux-x86_64-470.82.01.run</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装完成检测</span></span><br><span class="line">nvidia-smi</span><br></pre></td></tr></table></figure><img src= "/img/loading.gif" data-lazy-src="/2022/11/22/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9AGPU%E9%A9%B1%E5%8A%A8%E5%AE%89%E8%A3%85/nvidia-smi.png" title alt data-align="center"><p><strong>PS：</strong> 如果遇到报错 ：Error: failed to start container “nginx”: Error response from daemon: error gathering device information while adding custom device “/dev/nvidia-uvm”: no such file or directory</p><p>可以尝试手动加载，参考链接： <a href="https://blog.csdn.net/JosephThatwho/article/details/107869332">https://blog.csdn.net/JosephThatwho/article/details/107869332</a>  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node3 package]# ls /dev | grep nvidia</span><br><span class="line">nvidia0</span><br><span class="line">nvidia-caps</span><br><span class="line">nvidiactl</span><br><span class="line">[root@k8s-node3 package]# nvidia-modprobe -u -c=0</span><br><span class="line">[root@k8s-node3 package]# ls /dev | grep nvidia</span><br><span class="line">nvidia0</span><br><span class="line">nvidia-caps</span><br><span class="line">nvidiactl</span><br><span class="line">nvidia-uvm</span><br><span class="line">nvidia-uvm-tools</span><br></pre></td></tr></table></figure><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://www.cnblogs.com/deny/p/16305945.html">centos 7 安装NVIDIA显卡驱动</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;安装&quot;&gt;&lt;a href=&quot;#安装&quot; class=&quot;headerlink&quot; title=&quot;安装&quot;&gt;&lt;/a&gt;安装&lt;/h2&gt;&lt;h3 id=&quot;安装依赖环境&quot;&gt;&lt;a href=&quot;#安装依赖环境&quot; class=&quot;headerlink&quot; title=&quot;安装依赖环境&quot;&gt;&lt;/a&gt;安</summary>
      
    
    
    
    <category term="Accelerator" scheme="https://renyb2.github.io/categories/Accelerator/"/>
    
    
    <category term="NVIDIA" scheme="https://renyb2.github.io/tags/NVIDIA/"/>
    
    <category term="Accelerator" scheme="https://renyb2.github.io/tags/Accelerator/"/>
    
  </entry>
  
  <entry>
    <title>NVIDIA研发：GPU Manager部署</title>
    <link href="https://renyb2.github.io/2022/11/22/NVIDIA%E7%A0%94%E5%8F%91%EF%BC%9AGPU-Manager%E9%83%A8%E7%BD%B2/"/>
    <id>https://renyb2.github.io/2022/11/22/NVIDIA%E7%A0%94%E5%8F%91%EF%BC%9AGPU-Manager%E9%83%A8%E7%BD%B2/</id>
    <published>2022-11-22T03:13:04.000Z</published>
    <updated>2022-12-10T08:18:39.286Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>本文介绍GPU Manager的部署流程，其原理本文不做介绍，原理可参考：<a href="https://pokerfacesad.github.io/2020/02/07/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0%E3%80%8AGaiaGPU%20Sharing%20GPUs%20in%20Container%20Clouds%E3%80%8B/#c-vGPU-Manager">论文笔记《GaiaGPU：Sharing GPUs in Container Clouds》</a></p><h2 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a>源码地址</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Github</span></span><br><span class="line">gpu-quota-admission     https://github.com/tkestack/gpu-admission</span><br><span class="line">gpu-manager             https://github.com/tkestack/gpu-manager</span><br><span class="line">vcuda-controller        https://github.com/tkestack/vcuda-controller</span><br></pre></td></tr></table></figure><h2 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k104 vGPU]# uname -a</span><br><span class="line">Linux k104 3.10.0-1127.el7.x86_64 #1 SMP Tue Mar 31 23:36:51 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span><br><span class="line"></span><br><span class="line">[root@k104 vGPU]# cat /etc/centos-release</span><br><span class="line">CentOS Linux release 7.8.2003 (Core)</span><br><span class="line"></span><br><span class="line">[root@k104 vGPU]# kubectl version</span><br><span class="line">Client Version: version.Info&#123;Major:&quot;1&quot;, Minor:&quot;19&quot;, GitVersion:&quot;v1.19.10&quot;, GitCommit:&quot;98d5dc5d36d34a7ee13368a7893dcb400ec4e566&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2021-04-15T03:28:42Z&quot;, GoVersion:&quot;go1.15.10&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/amd64&quot;&#125;</span><br><span class="line">Server Version: version.Info&#123;Major:&quot;1&quot;, Minor:&quot;21&quot;, GitVersion:&quot;v1.21.4&quot;, GitCommit:&quot;3cce4a82b44f032d0cd1a1790e6d2f5a55d20aae&quot;, GitTreeState:&quot;clean&quot;, BuildDate:&quot;2021-08-11T18:10:22Z&quot;, GoVersion:&quot;go1.16.7&quot;, Compiler:&quot;gc&quot;, Platform:&quot;linux/amd64&quot;&#125;</span><br></pre></td></tr></table></figure><h2 id="部署流程"><a href="#部署流程" class="headerlink" title="部署流程"></a>部署流程</h2><h3 id="安装NVIDIA驱动"><a href="#安装NVIDIA驱动" class="headerlink" title="安装NVIDIA驱动"></a>安装NVIDIA驱动</h3><p>参考文档：<a href="https://renyb2.github.io/2022/11/22/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9AGPU%E9%A9%B1%E5%8A%A8%E5%AE%89%E8%A3%85/">《NVIDIA使用：GPU驱动安装》</a></p><h3 id="安装gpu-quota-admission"><a href="#安装gpu-quota-admission" class="headerlink" title="安装gpu-quota-admission"></a>安装gpu-quota-admission</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f gpu-admission.yaml</span><br></pre></td></tr></table></figure><p><code>gpu-admission.yaml</code>内容如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-quota-admission</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">gpu-quota-admission.config:</span> <span class="string">|</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="attr">&quot;QuotaConfigMapName&quot;:</span> <span class="string">&quot;gpuquota&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;QuotaConfigMapNamespace&quot;:</span> <span class="string">&quot;kube-system&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;GPUModelLabel&quot;:</span> <span class="string">&quot;gaia.tencent.com/gpu-model&quot;</span>,</span><br><span class="line">         <span class="attr">&quot;GPUPoolLabel&quot;:</span> <span class="string">&quot;gaia.tencent.com/gpu-pool&quot;</span></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-quota-admission</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3456</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">3456</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">gpu-quota-admission</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">gpu-quota-admission</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-quota-admission</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">gpu-quota-admission</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">gpu-quota-admission</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">preference:</span></span><br><span class="line">              <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">            <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LOG_LEVEL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">EXTRA_FLAGS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">--incluster-mode=true</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">ccr.ccs.tencentyun.com/tkeimages/gpu-quota-admission:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">gpu-quota-admission</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3456</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">2Gi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/root/gpu-quota-admission/</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirstWithHostNet</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#x27; mkdir -p /etc/kubernetes/ &amp;&amp; cp /root/gpu-quota-admission/gpu-quota-admission.config</span></span><br><span class="line"><span class="string">          /etc/kubernetes/&#x27;</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">init-kube-config</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/root/gpu-quota-admission/</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">priority:</span> <span class="number">2000000000</span></span><br><span class="line">      <span class="attr">priorityClassName:</span> <span class="string">system-cluster-critical</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">gpu-manager</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">gpu-manager</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">gpu-quota-admission</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">config</span></span><br></pre></td></tr></table></figure><h3 id="安装gpu-manager-daemonset"><a href="#安装gpu-manager-daemonset" class="headerlink" title="安装gpu-manager-daemonset"></a>安装gpu-manager-daemonset</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f gpu-manager.yaml</span><br></pre></td></tr></table></figure><p><code>gpu-manager.yaml</code>内容如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-manager</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-manager</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-manager</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-manager-metric</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">kubernetes.io/cluster-service:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">metrics</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">5678</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">5678</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gpu-manager-ds</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-manager-daemonset</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">updateStrategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">gpu-manager-ds</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="comment"># This annotation is deprecated. Kept here for backward compatibility</span></span><br><span class="line">      <span class="comment"># See https://kubernetes.io/docs/tasks/administer-cluster/guaranteed-scheduling-critical-addon-pods/</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">scheduler.alpha.kubernetes.io/critical-pod:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">gpu-manager-ds</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">gpu-manager</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">        <span class="comment"># This toleration is deprecated. Kept here for backward compatibility</span></span><br><span class="line">        <span class="comment"># See https://kubernetes.io/docs/tasks/administer-cluster/guaranteed-scheduling-critical-addon-pods/</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">CriticalAddonsOnly</span></span><br><span class="line">          <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">tencent.com/vcuda-core</span></span><br><span class="line">          <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">          <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="comment"># Mark this pod as a critical add-on; when enabled, the critical add-on</span></span><br><span class="line">      <span class="comment"># scheduler reserves resources for critical add-on pods so that they can</span></span><br><span class="line">      <span class="comment"># be rescheduled after a failure.</span></span><br><span class="line">      <span class="comment"># See https://kubernetes.io/docs/tasks/administer-cluster/guaranteed-scheduling-critical-addon-pods/</span></span><br><span class="line">      <span class="attr">priorityClassName:</span> <span class="string">&quot;system-node-critical&quot;</span></span><br><span class="line">      <span class="comment"># only run node has gpu device</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">nvidia-device-enable:</span> <span class="string">enable</span></span><br><span class="line">      <span class="attr">hostPID:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">tkestack/gpu-manager:v1.1.5</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">gpu-manager</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5678</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">device-plugin</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/lib/kubelet/device-plugins</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vdriver</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/gpu-manager/vdriver</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vmdata</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/gpu-manager/vm</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">log</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/log/gpu-manager</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">checkpoint</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/gpu-manager/checkpoint</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run-dir</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/run</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cgroup</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/sys/fs/cgroup</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">usr-directory</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/usr/local/host</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LOG_LEVEL</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">EXTRA_FLAGS</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;--logtostderr=false&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">device-plugin</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">Directory</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/var/lib/kubelet/device-plugins</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vmdata</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/etc/gpu-manager/vm</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vdriver</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/etc/gpu-manager/vdriver</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">log</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/etc/gpu-manager/log</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">checkpoint</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/etc/gpu-manager/checkpoint</span></span><br><span class="line">        <span class="comment"># We have to mount the whole /var/run directory into container, because of bind mount docker.sock</span></span><br><span class="line">        <span class="comment"># inode change after host docker is restarted</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run-dir</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">Directory</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/var/run</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cgroup</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">Directory</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/sys/fs/cgroup</span></span><br><span class="line">        <span class="comment"># We have to mount /usr directory instead of specified library path, because of non-existing</span></span><br><span class="line">        <span class="comment"># problem for different distro</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">usr-directory</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">Directory</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/usr</span></span><br></pre></td></tr></table></figure><p>GPU节点打标签</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node k104 nvidia-device-enable&#x3D;enable</span><br></pre></td></tr></table></figure><p>验证gpu-manager是否正确派发到GPU节点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure><h3 id="自定义调度器"><a href="#自定义调度器" class="headerlink" title="自定义调度器"></a>自定义调度器</h3><p>创建自定义调度器文件<code>/etc/kubernetes/scheduler-policy-config.json</code>，内容如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;kind&quot;</span>: <span class="string">&quot;Policy&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;predicates&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;PodFitsHostPorts&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;PodFitsResources&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;NoDiskConflict&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;MatchNodeSelector&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;HostName&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;priorities&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;BalancedResourceAllocation&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;weight&quot;</span>: <span class="number">1</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;ServiceSpreadingPriority&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;weight&quot;</span>: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;extenders&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;urlPrefix&quot;</span>: <span class="string">&quot;http://gpu-quota-admission.kube-system:3456/scheduler&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;apiVersion&quot;</span>: <span class="string">&quot;v1beta1&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;filterVerb&quot;</span>: <span class="string">&quot;predicates&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;enableHttps&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;nodeCacheCapable&quot;</span>: <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;hardPodAffinitySymmetricWeight&quot;</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="attr">&quot;alwaysCheckAllPredicates&quot;</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="kubeadm部署"><a href="#kubeadm部署" class="headerlink" title="kubeadm部署"></a>kubeadm部署</h4><p>如果是kubeadm部署的k8s，调度器是以pod形式运行的，kubelet会一直监听manifest文件的修改，发现文件被修改后会自动重启pod以加载新的配置。因此，这里我们只需要修改调度器的manifest文件即可。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/kubernetes/manifests/kube-scheduler.yaml /etc/kubernetes/manifests/kube-scheduler.yaml.bak</span><br></pre></td></tr></table></figure><p>在command关键字下面加两行内容：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--policy-config-file=/etc/kubernetes/scheduler-policy-config.json</span><br><span class="line">--use-legacy-policy-config=true</span><br></pre></td></tr></table></figure><p>修改后文件为：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">kube-scheduler</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">control-plane</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-scheduler</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kube-scheduler</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--authentication-kubeconfig=/etc/kubernetes/scheduler.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--authorization-kubeconfig=/etc/kubernetes/scheduler.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--bind-address=127.0.0.1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--kubeconfig=/etc/kubernetes/scheduler.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--leader-elect=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--port=0</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--policy-config-file=/etc/kubernetes/scheduler-policy-config.json</span>              <span class="comment">####  增加项</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--use-legacy-policy-config=true</span>                                                <span class="comment">#### 增加项</span></span><br><span class="line">    <span class="attr">image:</span> <span class="number">10.2</span><span class="number">.57</span><span class="number">.16</span><span class="string">:5000/kubernetes/kube-scheduler:v1.19.8</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">8</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">10259</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">15</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kube-scheduler</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">    <span class="attr">startupProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">24</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/healthz</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">10259</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">15</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/scheduler.conf</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">kubeconfig</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/kubernetes/scheduler-policy-config.json</span>              <span class="comment">#### 将文件挂载</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">policyconfig</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirstWithHostNet</span>                                   <span class="comment">#### 修改dns策略</span></span><br><span class="line">  <span class="attr">priorityClassName:</span> <span class="string">system-node-critical</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/kubernetes/scheduler.conf</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">FileOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kubeconfig</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/etc/kubernetes/scheduler-policy-config.json</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">FileOrCreate</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">policyconfig</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h4 id="rancher部署"><a href="#rancher部署" class="headerlink" title="rancher部署"></a>rancher部署</h4><p><code>cluster.yaml</code>文件中，增加scheduler的额外启动参数配置，内容如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scheduler:</span></span><br><span class="line">  <span class="comment"># 增加scheduler启动额外参数配置</span></span><br><span class="line">  <span class="attr">extra_args:</span></span><br><span class="line">    <span class="attr">policy-config-file:</span> <span class="string">/etc/kubernetes/scheduler-policy-config.json</span></span><br><span class="line">    <span class="attr">use-legacy-policy-config:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>修改后，文件内容如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">nodes:</span><br><span class="line">  - address: k104</span><br><span class="line">    port: &quot;22&quot; # ssh 端口</span><br><span class="line">    internal_address: &quot;&quot; # 内网IP，如果是公有云的这种有公私网两个IP的，则address配置为公网IP</span><br><span class="line">    role:</span><br><span class="line">      - controlplane  # 控制节点校色，等于k8s的master</span><br><span class="line">      - etcd</span><br><span class="line">      - worker</span><br><span class="line">    user: cloud  # 服务器登陆账户</span><br><span class="line">    # labels: &#123;&#125; # 标签说明</span><br><span class="line">services:</span><br><span class="line"><span class="meta">#</span><span class="bash"> ETCD相关配置，另外备份是可以备份到s3的，这个配置见官方文档</span></span><br><span class="line">  etcd:</span><br><span class="line">    extra_args:</span><br><span class="line">      auto-compaction-retention: 240 #(单位小时)</span><br><span class="line">      # 修改空间配额为$((6*1024*1024*1024))，默认2G,最大8G</span><br><span class="line">      quota-backend-bytes: &quot;6442450944&quot;</span><br><span class="line">    backup_config:</span><br><span class="line">      enabled: true</span><br><span class="line">      interval_hours: 12</span><br><span class="line">      retention: 6</span><br><span class="line">  kube-api:</span><br><span class="line">    service_cluster_ip_range: 10.96.0.0/12</span><br><span class="line">    service_node_port_range: &quot;20000-40000&quot;</span><br><span class="line">    pod_security_policy: false</span><br><span class="line">    always_pull_images: false</span><br><span class="line"><span class="meta">#</span><span class="bash"> 控制器的一些配置，比如节点判断失联后多久开始迁移等</span></span><br><span class="line">  kube-controller:</span><br><span class="line">    extra_args:</span><br><span class="line">      ## 当节点通信失败后，再等一段时间kubernetes判定节点为notready状态。</span><br><span class="line">      ## 这个时间段必须是kubelet的nodeStatusUpdateFrequency(默认10s)的整数倍，</span><br><span class="line">      ## 其中N表示允许kubelet同步节点状态的重试次数，默认40s。</span><br><span class="line">      node-monitor-grace-period: &quot;20s&quot;</span><br><span class="line">      ## 再持续通信失败一段时间后，kubernetes判定节点为unhealthy状态，默认1m0s。</span><br><span class="line">      node-startup-grace-period: &quot;30s&quot;</span><br><span class="line">      ## 再持续失联一段时间，kubernetes开始迁移失联节点的Pod，默认5m0s。</span><br><span class="line">      pod-eviction-timeout: &quot;1m&quot;</span><br><span class="line">    cluster_cidr: 10.10.0.0/16</span><br><span class="line">    service_cluster_ip_range: 10.96.0.0/12</span><br><span class="line"><span class="meta">#</span><span class="bash"> 集群的一些配置，包括资源预留，集群名字，dns等配置</span></span><br><span class="line">  kubelet:</span><br><span class="line">    extra_args:</span><br><span class="line">      serialize-image-pulls: &quot;false&quot;</span><br><span class="line">      registry-burst: &quot;10&quot;</span><br><span class="line">      registry-qps: &quot;0&quot;</span><br><span class="line">      # # 节点资源预留</span><br><span class="line">      # enforce-node-allocatable: &#x27;pods&#x27;</span><br><span class="line">      # system-reserved: &#x27;cpu=0.5,memory=500Mi&#x27;</span><br><span class="line">      # kube-reserved: &#x27;cpu=0.5,memory=1500Mi&#x27;</span><br><span class="line">      # # POD驱逐，这个参数只支持内存和磁盘。</span><br><span class="line">      # ## 硬驱逐伐值</span><br><span class="line">      # ### 当节点上的可用资源降至保留值以下时，就会触发强制驱逐。强制驱逐会强制kill掉POD，不会等POD自动退出。</span><br><span class="line">      # eviction-hard: &#x27;memory.available&lt;300Mi,nodefs.available&lt;10%,imagefs.available&lt;15%,nodefs.inodesFree&lt;5%&#x27;</span><br><span class="line">      # ## 软驱逐伐值</span><br><span class="line">      # ### 以下四个参数配套使用，当节点上的可用资源少于这个值时但大于硬驱逐伐值时候，会等待eviction-soft-grace-period设置的时长；</span><br><span class="line">      # ### 等待中每10s检查一次，当最后一次检查还触发了软驱逐伐值就会开始驱逐，驱逐不会直接Kill POD，先发送停止信号给POD，然后等待eviction-max-pod-grace-period设置的时长；</span><br><span class="line">      # ### 在eviction-max-pod-grace-period时长之后，如果POD还未退出则发送强制kill POD&quot;</span><br><span class="line">      # eviction-soft: &#x27;memory.available&lt;500Mi,nodefs.available&lt;50%,imagefs.available&lt;50%,nodefs.inodesFree&lt;10%&#x27;</span><br><span class="line">      # eviction-soft-grace-period: &#x27;memory.available=1m30s&#x27;</span><br><span class="line">      # eviction-max-pod-grace-period: &#x27;30&#x27;</span><br><span class="line">      # eviction-pressure-transition-period: &#x27;30s&#x27;</span><br><span class="line">      volume-plugin-dir: /usr/libexec/kubernetes/kubelet-plugins/volume/exec</span><br><span class="line">    extra_binds:</span><br><span class="line">      - /usr/libexec/kubernetes/kubelet-plugins/volume/exec:/usr/libexec/kubernetes/kubelet-plugins/volume/exec</span><br><span class="line">    cluster_domain: cluster.local</span><br><span class="line">    infra_container_image: &quot;&quot;</span><br><span class="line">    cluster_dns_server: 10.96.0.10</span><br><span class="line">    fail_swap_on: false</span><br><span class="line">  kubeproxy:</span><br><span class="line">    extra_args:</span><br><span class="line">      # 默认使用iptables进行数据转发，如果要启用ipvs，则此处设置为`ipvs`</span><br><span class="line">      proxy-mode: &quot;ipvs&quot;</span><br><span class="line">  scheduler:</span><br><span class="line">    # 增加scheduler启动额外参数配置</span><br><span class="line">    extra_args:</span><br><span class="line">      policy-config-file: /etc/kubernetes/scheduler-policy-config.json</span><br><span class="line">      use-legacy-policy-config: true</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置集群的CNI网络模型</span></span><br><span class="line">network:</span><br><span class="line">  plugin: calico</span><br><span class="line"><span class="meta">  #</span><span class="bash"> mtu: 1400</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  options:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    canal_iface: bond_mgmt</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    flannel_backend_type: <span class="string">&quot;vxlan&quot;</span></span></span><br><span class="line">ssh_agent_auth: false</span><br><span class="line">authorization:</span><br><span class="line">  mode: rbac</span><br><span class="line">ignore_docker_version: false</span><br><span class="line"><span class="meta">#</span><span class="bash"> k8s的版本，可以通过rke config --system-images --all 命令列出所有rke支持的版本</span></span><br><span class="line">kubernetes_version: v1.21.4-rancher1-1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 国内使用阿里云的镜像</span></span><br><span class="line">private_registries:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> registry.local:9001/library</span></span><br><span class="line">  - url: registry.local:9001/library</span><br><span class="line">    user:</span><br><span class="line">    password:</span><br><span class="line">    is_default: true</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置ingress，目前RKE支持nginx。</span></span><br><span class="line">monitoring:</span><br><span class="line">  provider: metrics-server</span><br><span class="line">ingress:</span><br><span class="line">  provider: &quot;nginx&quot;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> 节点选择，和上面node配置结合的</span></span><br><span class="line">  node_selector:</span><br><span class="line">    app: ingress</span><br><span class="line">  options:</span><br><span class="line">    use-forwarded-headers: &quot;true&quot;</span><br><span class="line">cluster_name: rancher</span><br><span class="line">addon_job_timeout: 0</span><br><span class="line">dns:</span><br><span class="line">  provider: coredns</span><br><span class="line">  upstreamnameservers:</span><br><span class="line">  - 114.114.114.114</span><br></pre></td></tr></table></figure><p>更新kubernetes配置：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/.kube &amp;&amp; rke up</span><br></pre></td></tr></table></figure><h2 id="验证方式"><a href="#验证方式" class="headerlink" title="验证方式"></a>验证方式</h2><h3 id="查看GPU资源"><a href="#查看GPU资源" class="headerlink" title="查看GPU资源"></a>查看GPU资源</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@k104 vGPU]# kubectl describe node k104</span><br><span class="line">...</span><br><span class="line">Capacity:</span><br><span class="line">  cpu:                       20</span><br><span class="line">  ephemeral-storage:         333267976Ki</span><br><span class="line">  hugepages-1Gi:             92Gi</span><br><span class="line">  hugepages-2Mi:             0</span><br><span class="line">  memory:                    197620068Ki</span><br><span class="line">  pods:                      110</span><br><span class="line">  tencent.com/vcuda-core:    100</span><br><span class="line">  tencent.com/vcuda-memory:  59</span><br><span class="line">Allocatable:</span><br><span class="line">  cpu:                       20</span><br><span class="line">  ephemeral-storage:         307139766174</span><br><span class="line">  hugepages-1Gi:             92Gi</span><br><span class="line">  hugepages-2Mi:             0</span><br><span class="line">  memory:                    101048676Ki</span><br><span class="line">  pods:                      110</span><br><span class="line">  tencent.com/vcuda-core:    100</span><br><span class="line">  tencent.com/vcuda-memory:  59</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="TensorFlow框架-minst数据集测试"><a href="#TensorFlow框架-minst数据集测试" class="headerlink" title="TensorFlow框架+minst数据集测试"></a>TensorFlow框架+minst数据集测试</h3><ol><li>使用TensorFlow框架+minst数据集进行测试验证，TensorFlow镜像：</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ccr.ccs.tencentyun.com/menghe/tensorflow-gputest:0.2</span><br></pre></td></tr></table></figure><ol start="2"><li>创建一个测试负载<code>tensorflow-gputest.yaml</code>，内容如下：</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">vcuda-test</span></span><br><span class="line">    <span class="attr">qcloud-app:</span> <span class="string">vcuda-test</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vcuda-test</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">vcuda-test</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">vcuda-test</span></span><br><span class="line">        <span class="attr">qcloud-app:</span> <span class="string">vcuda-test</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">360000s</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PATH</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">ccr.ccs.tencentyun.com/menghe/tensorflow-gputest:0.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">tensorflow-test</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">8Gi</span></span><br><span class="line">            <span class="attr">tencent.com/vcuda-core:</span> <span class="string">&quot;50&quot;</span></span><br><span class="line">            <span class="attr">tencent.com/vcuda-memory:</span> <span class="string">&quot;32&quot;</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">8Gi</span></span><br><span class="line">            <span class="attr">tencent.com/vcuda-core:</span> <span class="string">&quot;50&quot;</span></span><br><span class="line">            <span class="attr">tencent.com/vcuda-memory:</span> <span class="string">&quot;32&quot;</span></span><br></pre></td></tr></table></figure><ol start="3"><li><p>进入容器，执行测试命令，可以根据需求选择不同训练框架/数据集</p><p>a）Mnist</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /data/tensorflow/mnist &amp;&amp; time python convolutional.py</span><br></pre></td></tr></table></figure><p> b）AlexNet</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /data/tensorflow/alexnet &amp;&amp; time python alexnet_benchmark.py</span><br></pre></td></tr></table></figure><p> c）Cifar10</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /data/tensorflow/cifar10 &amp;&amp; time python cifar10_train.py</span><br></pre></td></tr></table></figure><p><img src= "/img/loading.gif" data-lazy-src="/2022/11/22/NVIDIA%E7%A0%94%E5%8F%91%EF%BC%9AGPU-Manager%E9%83%A8%E7%BD%B2/NVIDIA%E7%A0%94%E5%8F%91%EF%BC%9AGPU-Manager%E9%83%A8%E7%BD%B2%5CMnist.jpg" alt="Mnist"></p></li><li><p>在物理机上通过<code>nvidia-smi pmon -s u -d 1</code>命令查看GPU资源使用情况 <img src= "/img/loading.gif" data-lazy-src="/2022/11/22/NVIDIA%E7%A0%94%E5%8F%91%EF%BC%9AGPU-Manager%E9%83%A8%E7%BD%B2/NVIDIA%E7%A0%94%E5%8F%91%EF%BC%9AGPU-Manager%E9%83%A8%E7%BD%B2%5Cpmon.png" alt="pmon"></p></li></ol><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://www.cnblogs.com/deny/p/16305744.html">腾讯vCUDA（gpu-manager）部署</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;本文介绍GPU Manager的部署流程，其原理本文不做介绍，原理可参考：&lt;a href=&quot;https://pokerfacesad.git</summary>
      
    
    
    
    <category term="Accelerator" scheme="https://renyb2.github.io/categories/Accelerator/"/>
    
    
    <category term="NVIDIA" scheme="https://renyb2.github.io/tags/NVIDIA/"/>
    
    <category term="Accelerator" scheme="https://renyb2.github.io/tags/Accelerator/"/>
    
    <category term="vGPU" scheme="https://renyb2.github.io/tags/vGPU/"/>
    
  </entry>
  
  <entry>
    <title>Chrome使用：通用手册</title>
    <link href="https://renyb2.github.io/2022/11/16/Chrome%E4%BD%BF%E7%94%A8%EF%BC%9A%E9%80%9A%E7%94%A8%E6%89%8B%E5%86%8C/"/>
    <id>https://renyb2.github.io/2022/11/16/Chrome%E4%BD%BF%E7%94%A8%EF%BC%9A%E9%80%9A%E7%94%A8%E6%89%8B%E5%86%8C/</id>
    <published>2022-11-16T07:50:18.000Z</published>
    <updated>2022-11-24T02:06:49.087Z</updated>
    
    <content type="html"><![CDATA[<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="NET-ERR-CERT-INVALID"><a href="#NET-ERR-CERT-INVALID" class="headerlink" title="NET::ERR_CERT_INVALID"></a>NET::ERR_CERT_INVALID</h3><img src= "/img/loading.gif" data-lazy-src="/2022/11/16/Chrome%E4%BD%BF%E7%94%A8%EF%BC%9A%E9%80%9A%E7%94%A8%E6%89%8B%E5%86%8C/NET_ERR_CERT_INVALID.png" alt="smbios-mode-smbios" style="zoom:100%;"><p>在chrome该页面上，直接键盘敲入这12个字符：<code>thisisunsafe</code></p><p><strong>注意：鼠标点击当前页面任意位置，让页面处于最上层即可输入</strong></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;常见问题&quot;&gt;&lt;a href=&quot;#常见问题&quot; class=&quot;headerlink&quot; title=&quot;常见问题&quot;&gt;&lt;/a&gt;常见问题&lt;/h2&gt;&lt;h3 id=&quot;NET-ERR-CERT-INVALID&quot;&gt;&lt;a href=&quot;#NET-ERR-CERT-INVALID&quot; cla</summary>
      
    
    
    
    <category term="研发工具" scheme="https://renyb2.github.io/categories/%E7%A0%94%E5%8F%91%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="Chrome" scheme="https://renyb2.github.io/tags/Chrome/"/>
    
    <category term="Google" scheme="https://renyb2.github.io/tags/Google/"/>
    
  </entry>
  
  <entry>
    <title>OpenStack研发：cinderclient</title>
    <link href="https://renyb2.github.io/2022/11/15/OpenStack%E7%A0%94%E5%8F%91%EF%BC%9Acinderclient/"/>
    <id>https://renyb2.github.io/2022/11/15/OpenStack%E7%A0%94%E5%8F%91%EF%BC%9Acinderclient/</id>
    <published>2022-11-15T09:42:02.000Z</published>
    <updated>2022-11-24T02:07:36.994Z</updated>
    
    <content type="html"><![CDATA[<h2 id="研发环境"><a href="#研发环境" class="headerlink" title="研发环境"></a>研发环境</h2><ul><li>python：2.7.5</li><li>python-cinderclient   5.0.2</li></ul><h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><h3 id="cinderclient调用方法"><a href="#cinderclient调用方法" class="headerlink" title="cinderclient调用方法"></a>cinderclient调用方法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> keystoneauth1 <span class="keyword">import</span> identity</span><br><span class="line"><span class="keyword">from</span> keystoneauth1 <span class="keyword">import</span> session</span><br><span class="line"><span class="keyword">from</span> cinderclient <span class="keyword">import</span> client</span><br><span class="line"></span><br><span class="line">username=<span class="string">&#x27;admin&#x27;</span></span><br><span class="line">password=<span class="string">&#x27;Inspur@123&#x27;</span></span><br><span class="line">project_name=<span class="string">&#x27;admin&#x27;</span></span><br><span class="line">project_domain_id=<span class="string">&#x27;default&#x27;</span></span><br><span class="line">user_domain_id=<span class="string">&#x27;default&#x27;</span></span><br><span class="line">auth_url=<span class="string">&#x27;http://111.111.9.207:35357/v3&#x27;</span></span><br><span class="line"></span><br><span class="line">CINDER_API_VERSION = <span class="string">&quot;3.0&quot;</span></span><br><span class="line"></span><br><span class="line">auth = identity.Password(auth_url=auth_url,</span><br><span class="line">                         username=username,</span><br><span class="line">                         password=password,</span><br><span class="line">                         project_name=project_name,</span><br><span class="line">                         project_domain_id=project_domain_id,</span><br><span class="line">                         user_domain_id=user_domain_id)</span><br><span class="line">sess = session.Session(auth=auth)</span><br><span class="line">cinder = client.Client(CINDER_API_VERSION, session=sess)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取所有卷快照</span></span><br><span class="line">cinder.volume_snapshots.list()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取所有卷备份</span></span><br><span class="line">cinder.backups.list()</span><br></pre></td></tr></table></figure><h3 id="cinderclient支持的方法"><a href="#cinderclient支持的方法" class="headerlink" title="cinderclient支持的方法"></a>cinderclient支持的方法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 代码取自cinderclient &gt; v3 &gt; client.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copyright (c) 2013 OpenStack Foundation</span></span><br><span class="line"><span class="comment"># All Rights Reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may</span></span><br><span class="line"><span class="comment">#    not use this file except in compliance with the License. You may obtain</span></span><br><span class="line"><span class="comment">#    a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#         http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#    Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">#    distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span></span><br><span class="line"><span class="comment">#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span></span><br><span class="line"><span class="comment">#    License for the specific language governing permissions and limitations</span></span><br><span class="line"><span class="comment">#    under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> cinderclient <span class="keyword">import</span> api_versions</span><br><span class="line"><span class="keyword">from</span> cinderclient <span class="keyword">import</span> client</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> attachments</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> availability_zones</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> capabilities</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> cgsnapshots</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> clusters</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> consistencygroups</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> group_snapshots</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> group_types</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> groups</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> limits</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> messages</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> pools</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> qos_specs</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> quota_classes</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> quotas</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> resource_filters</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> services</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> volume_backups</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> volume_backups_restore</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> volume_encryption_types</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> volume_snapshots</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> volume_transfers</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> volume_type_access</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> volume_types</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> volumes</span><br><span class="line"><span class="keyword">from</span> cinderclient.v3 <span class="keyword">import</span> workers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Client</span>(<span class="params">object</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Top-level object to access the OpenStack Volume API.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Create an instance with your creds::</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; client = Client(USERNAME, PASSWORD, PROJECT_ID, AUTH_URL)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Then call methods on its managers::</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &gt;&gt;&gt; client.volumes.list()</span></span><br><span class="line"><span class="string">        ...</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, username=None, api_key=None, project_id=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 auth_url=<span class="string">&#x27;&#x27;</span>, insecure=False, timeout=None, tenant_id=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 proxy_tenant_id=None, proxy_token=None, region_name=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 endpoint_type=<span class="string">&#x27;publicURL&#x27;</span>, extensions=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 service_type=<span class="string">&#x27;volumev3&#x27;</span>, service_name=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 volume_service_name=None, bypass_url=None, retries=<span class="number">0</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 http_log_debug=False, cacert=None, auth_system=<span class="string">&#x27;keystone&#x27;</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                 auth_plugin=None, session=None, api_version=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                 logger=None, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># FIXME(comstud): Rename the api_key argument above when we</span></span><br><span class="line">        <span class="comment"># know it&#x27;s not being used as keyword argument</span></span><br><span class="line">        password = api_key</span><br><span class="line">        self.version = <span class="string">&#x27;3.0&#x27;</span></span><br><span class="line">        self.limits = limits.LimitsManager(self)</span><br><span class="line">        self.api_version = api_version <span class="keyword">or</span> api_versions.APIVersion(self.version)</span><br><span class="line"></span><br><span class="line">        self.volumes = volumes.VolumeManager(self)</span><br><span class="line">        self.volume_snapshots = volume_snapshots.SnapshotManager(self)</span><br><span class="line">        self.volume_types = volume_types.VolumeTypeManager(self)</span><br><span class="line">        self.group_types = group_types.GroupTypeManager(self)</span><br><span class="line">        self.volume_type_access = \</span><br><span class="line">            volume_type_access.VolumeTypeAccessManager(self)</span><br><span class="line">        self.volume_encryption_types = \</span><br><span class="line">            volume_encryption_types.VolumeEncryptionTypeManager(self)</span><br><span class="line">        self.qos_specs = qos_specs.QoSSpecsManager(self)</span><br><span class="line">        self.quota_classes = quota_classes.QuotaClassSetManager(self)</span><br><span class="line">        self.quotas = quotas.QuotaSetManager(self)</span><br><span class="line">        self.backups = volume_backups.VolumeBackupManager(self)</span><br><span class="line">        self.messages = messages.MessageManager(self)</span><br><span class="line">        self.resource_filters = resource_filters.ResourceFilterManager(self)</span><br><span class="line">        self.restores = volume_backups_restore.VolumeBackupRestoreManager(self)</span><br><span class="line">        self.transfers = volume_transfers.VolumeTransferManager(self)</span><br><span class="line">        self.services = services.ServiceManager(self)</span><br><span class="line">        self.clusters = clusters.ClusterManager(self)</span><br><span class="line">        self.workers = workers.WorkerManager(self)</span><br><span class="line">        self.consistencygroups = consistencygroups.\</span><br><span class="line">            ConsistencygroupManager(self)</span><br><span class="line">        self.groups = groups.GroupManager(self)</span><br><span class="line">        self.cgsnapshots = cgsnapshots.CgsnapshotManager(self)</span><br><span class="line">        self.group_snapshots = group_snapshots.GroupSnapshotManager(self)</span><br><span class="line">        self.availability_zones = \</span><br><span class="line">            availability_zones.AvailabilityZoneManager(self)</span><br><span class="line">        self.pools = pools.PoolManager(self)</span><br><span class="line">        self.capabilities = capabilities.CapabilitiesManager(self)</span><br><span class="line">        self.attachments = \</span><br><span class="line">            attachments.VolumeAttachmentManager(self)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Add in any extensions...</span></span><br><span class="line">        <span class="keyword">if</span> extensions:</span><br><span class="line">            <span class="keyword">for</span> extension <span class="keyword">in</span> extensions:</span><br><span class="line">                <span class="keyword">if</span> extension.manager_class:</span><br><span class="line">                    setattr(self, extension.name,</span><br><span class="line">                            extension.manager_class(self))</span><br><span class="line"></span><br><span class="line">        self.client = client._construct_http_client(</span><br><span class="line">            username=username,</span><br><span class="line">            password=password,</span><br><span class="line">            project_id=project_id,</span><br><span class="line">            auth_url=auth_url,</span><br><span class="line">            insecure=insecure,</span><br><span class="line">            timeout=timeout,</span><br><span class="line">            tenant_id=tenant_id,</span><br><span class="line">            proxy_tenant_id=tenant_id,</span><br><span class="line">            proxy_token=proxy_token,</span><br><span class="line">            region_name=region_name,</span><br><span class="line">            endpoint_type=endpoint_type,</span><br><span class="line">            service_type=service_type,</span><br><span class="line">            service_name=service_name,</span><br><span class="line">            volume_service_name=volume_service_name,</span><br><span class="line">            bypass_url=bypass_url,</span><br><span class="line">            retries=retries,</span><br><span class="line">            http_log_debug=http_log_debug,</span><br><span class="line">            cacert=cacert,</span><br><span class="line">            auth_system=auth_system,</span><br><span class="line">            auth_plugin=auth_plugin,</span><br><span class="line">            session=session,</span><br><span class="line">            api_version=self.api_version,</span><br><span class="line">            logger=logger,</span><br><span class="line">            **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Authenticate against the server.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Normally this is called automatically when you first access the API,</span></span><br><span class="line"><span class="string">        but you can call this method to force authentication right now.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns on success; raises :exc:`exceptions.Unauthorized` if the</span></span><br><span class="line"><span class="string">        credentials are wrong.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.client.authenticate()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_volume_api_version_from_endpoint</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.client.get_volume_api_version_from_endpoint()</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;研发环境&quot;&gt;&lt;a href=&quot;#研发环境&quot; class=&quot;headerlink&quot; title=&quot;研发环境&quot;&gt;&lt;/a&gt;研发环境&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;python：2.7.5&lt;/li&gt;
&lt;li&gt;python-cinderclient   5.0.2&lt;/li&gt;
&lt;</summary>
      
    
    
    
    <category term="OpenStack" scheme="https://renyb2.github.io/categories/OpenStack/"/>
    
    
    <category term="OpenStack" scheme="https://renyb2.github.io/tags/OpenStack/"/>
    
    <category term="CLI" scheme="https://renyb2.github.io/tags/CLI/"/>
    
  </entry>
  
  <entry>
    <title>Libvirt研发：虚拟化特性检测</title>
    <link href="https://renyb2.github.io/2022/11/15/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9A%E8%99%9A%E6%8B%9F%E5%8C%96%E7%89%B9%E6%80%A7%E6%A3%80%E6%B5%8B/"/>
    <id>https://renyb2.github.io/2022/11/15/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9A%E8%99%9A%E6%8B%9F%E5%8C%96%E7%89%B9%E6%80%A7%E6%A3%80%E6%B5%8B/</id>
    <published>2022-11-15T03:35:10.000Z</published>
    <updated>2022-11-24T02:06:49.089Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>目前虚拟机环境检测有两个<strong>金标准</strong>，分别是<a href="https://link.zhihu.com/?target=https://github.com/LordNoteworthy/al-khaser">Al-khaser</a>和<a href="https://link.zhihu.com/?target=https://github.com/a0rtega/pafish">Pafish</a>。这两个开源项目几乎一网打尽了所有公开常见的<a href="https://www.zhihu.com/search?q=VM%E6%A3%80%E6%B5%8B%E6%8A%80%E6%9C%AF&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22:%22answer%22,%22sourceId%22:1792815099%7D">VM检测技术</a>。</p><p>国外SANS安全组织的研究人员总结出当前各种虚拟机检测手段不外乎以下四类：<br>●    搜索虚拟环境中的进程，文件系统，注册表；<br>●    搜索虚拟环境中的内存<br>●    搜索虚拟环境中的特定虚拟硬件<br>●    搜索虚拟环境中的特定处理器指令和功能</p><h2 id="Al-khaser"><a href="#Al-khaser" class="headerlink" title="Al-khaser"></a>Al-khaser</h2><p>Github：<a href="https://github.com/LordNoteworthy/al-khaser">https://github.com/LordNoteworthy/al-khaser</a></p><h2 id="Pafish"><a href="#Pafish" class="headerlink" title="Pafish"></a>Pafish</h2><p>Github：<a href="https://github.com/a0rtega/pafish">https://github.com/a0rtega/pafish</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">* Pafish (Paranoid Fish) *</span><br><span class="line"></span><br><span class="line">[-] Windows version: 6.2 build 9200</span><br><span class="line">[-] Running in WoW64: True</span><br><span class="line">[-] CPU: GenuineIntel</span><br><span class="line">    Hypervisor: @</span><br><span class="line">    CPU brand: Intel Core Processor (Broadwell)</span><br><span class="line"></span><br><span class="line">[-] Debuggers detection</span><br><span class="line">[*] Using IsDebuggerPresent() ... OK</span><br><span class="line">[*] Using BeingDebugged via PEB access ... OK</span><br><span class="line"></span><br><span class="line">[-] CPU information based detections</span><br><span class="line">[*] Checking the difference between CPU timestamp counters (rdtsc) ... OK</span><br><span class="line">[*] Checking the difference between CPU timestamp counters (rdtsc) forcing VM exit ... traced!</span><br><span class="line">[*] Checking hypervisor bit in cpuid feature bits ... OK</span><br><span class="line">[*] Checking cpuid hypervisor vendor for known VM vendors ... OK</span><br><span class="line"></span><br><span class="line">[-] Generic reverse turing tests</span><br><span class="line">[*] Checking mouse presence ... OK</span><br><span class="line">[*] Checking mouse movement ... OK</span><br><span class="line">[*] Checking mouse speed ... OK</span><br><span class="line">[*] Checking mouse click activity ... traced!</span><br><span class="line">[*] Checking mouse double click activity ... traced!</span><br><span class="line">[*] Checking dialog confirmation ... traced!</span><br><span class="line">[*] Checking plausible dialog confirmation ... traced!</span><br><span class="line"></span><br><span class="line">[-] Generic sandbox detection</span><br><span class="line">[*] Checking username ... OK</span><br><span class="line">[*] Checking file path ... OK</span><br><span class="line">[*] Checking common sample names in drives root ... OK</span><br><span class="line">[*] Checking if disk size &lt;= 60GB via DeviceIoControl() ... OK</span><br><span class="line">[*] Checking if disk size &lt;= 60GB via GetDiskFreeSpaceExA() ... traced!</span><br><span class="line">[*] Checking if Sleep() is patched using GetTickCount() ... OK</span><br><span class="line">[*] Checking if NumberOfProcessors is &lt; 2 via PEB access ... OK</span><br><span class="line">[*] Checking if NumberOfProcessors is &lt; 2 via GetSystemInfo() ... OK</span><br><span class="line">[*] Checking if pysical memory is &lt; 1Gb ... OK</span><br><span class="line">[*] Checking operating system uptime using GetTickCount() ... OK</span><br><span class="line">[*] Checking if operating system IsNativeVhdBoot() ... OK</span><br><span class="line"></span><br><span class="line">[-] Hooks detection</span><br><span class="line">[*] Checking function ShellExecuteExW method 1 ... OK</span><br><span class="line">[*] Checking function CreateProcessA method 1 ... OK</span><br><span class="line"></span><br><span class="line">[-] Sandboxie detection</span><br><span class="line">[*] Using GetModuleHandle(sbiedll.dll) ... OK</span><br><span class="line"></span><br><span class="line">[-] Wine detection</span><br><span class="line">[*] Using GetProcAddress(wine_get_unix_file_name) from kernel32.dll ... OK</span><br><span class="line">[*] Reg key (HKCU\SOFTWARE\Wine) ... OK</span><br><span class="line"></span><br><span class="line">[-] VirtualBox detection</span><br><span class="line">[*] Scsi port-&gt;bus-&gt;target id-&gt;logical unit id-&gt; 0 identifier ... OK</span><br><span class="line">[*] Reg key (HKLM\HARDWARE\Description\System &quot;SystemBiosVersion&quot;) ... OK</span><br><span class="line">[*] Reg key (HKLM\SOFTWARE\Oracle\VirtualBox Guest Additions) ... OK</span><br><span class="line">[*] Reg key (HKLM\HARDWARE\Description\System &quot;VideoBiosVersion&quot;) ... OK</span><br><span class="line">[*] Reg key (HKLM\HARDWARE\ACPI\DSDT\VBOX__) ... OK</span><br><span class="line">[*] Reg key (HKLM\HARDWARE\ACPI\FADT\VBOX__) ... OK</span><br><span class="line">[*] Reg key (HKLM\HARDWARE\ACPI\RSDT\VBOX__) ... OK</span><br><span class="line">[*] Reg key (HKLM\SYSTEM\ControlSet001\Services\VBox*) ... OK</span><br><span class="line">[*] Reg key (HKLM\HARDWARE\DESCRIPTION\System &quot;SystemBiosDate&quot;) ... OK</span><br><span class="line">[*] Driver files in C:\WINDOWS\system32\drivers\VBox* ... OK</span><br><span class="line">[*] Additional system files ... OK</span><br><span class="line">[*] Looking for a MAC address starting with 08:00:27 ... OK</span><br><span class="line">[*] Looking for pseudo devices ... OK</span><br><span class="line">[*] Looking for VBoxTray windows ... OK</span><br><span class="line">[*] Looking for VBox network share ... OK</span><br><span class="line">[*] Looking for VBox processes (vboxservice.exe, vboxtray.exe) ... OK</span><br><span class="line">[*] Looking for VBox devices using WMI ... OK</span><br><span class="line"></span><br><span class="line">[-] VMware detection</span><br><span class="line">[*] Scsi port 0,1,2 -&gt;bus-&gt;target id-&gt;logical unit id-&gt; 0 identifier ... OK</span><br><span class="line">[*] Reg key (HKLM\SOFTWARE\VMware, Inc.\VMware Tools) ... OK</span><br><span class="line">[*] Looking for C:\WINDOWS\system32\drivers\vmmouse.sys ... OK</span><br><span class="line">[*] Looking for C:\WINDOWS\system32\drivers\vmhgfs.sys ... OK</span><br><span class="line">[*] Looking for a MAC address starting with 00:05:69, 00:0C:29, 00:1C:14 or 00:50:56 ... OK</span><br><span class="line">[*] Looking for network adapter name ... OK</span><br><span class="line">[*] Looking for pseudo devices ... OK</span><br><span class="line">[*] Looking for VMware serial number ... OK</span><br><span class="line"></span><br><span class="line">[-] Qemu detection</span><br><span class="line">[*] Scsi port-&gt;bus-&gt;target id-&gt;logical unit id-&gt; 0 identifier ... OK</span><br><span class="line">[*] Reg key (HKLM\HARDWARE\Description\System &quot;SystemBiosVersion&quot;) ... OK</span><br><span class="line">[*] cpuid CPU brand string &#x27;QEMU Virtual CPU&#x27; ... OK</span><br><span class="line"></span><br><span class="line">[-] Bochs detection</span><br><span class="line">[*] Reg key (HKLM\HARDWARE\Description\System &quot;SystemBiosVersion&quot;) ... traced!</span><br><span class="line">[*] cpuid AMD wrong value for processor name ... OK</span><br><span class="line">[*] cpuid Intel wrong value for processor name ... OK</span><br><span class="line"></span><br><span class="line">[-] Cuckoo detection</span><br><span class="line">[*] Looking in the TLS for the hooks information structure ... OK</span><br><span class="line"></span><br><span class="line">[-] Pafish has finished analyzing the system, check the log file for more information</span><br><span class="line">    and visit the project&#x27;s site:</span><br><span class="line"></span><br><span class="line">    https://github.com/a0rtega/pafish</span><br></pre></td></tr></table></figure><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://bbs.pediy.com/thread-119969.htm">虚拟机检测技术剖析</a></li><li><a href="https://www.zhihu.com/question/359121561">操作系统能否知道自己处于虚拟机中?</a></li><li><a href="https://www.zhihu.com/question/53252265">软件如何判断自己运行在虚拟机中？</a></li><li><a href="http://www.hekaiyu.cn/hacker/1509.html">利用Pafish侦测虚拟环境</a></li><li><a href="https://ieeexplore.ieee.org/document/4630086">Towards an Understanding of Anti-virtualization and Anti-debugging Behavior in Modern Malware</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;目前虚拟机环境检测有两个&lt;strong&gt;金标准&lt;/strong&gt;，分别是&lt;a href=&quot;https://link.zhihu.com/?t</summary>
      
    
    
    
    <category term="Libvirt" scheme="https://renyb2.github.io/categories/Libvirt/"/>
    
    
    <category term="KVM" scheme="https://renyb2.github.io/tags/KVM/"/>
    
    <category term="Libvirt" scheme="https://renyb2.github.io/tags/Libvirt/"/>
    
    <category term="虚拟化" scheme="https://renyb2.github.io/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>Libvirt研发：屏蔽虚拟化特性</title>
    <link href="https://renyb2.github.io/2022/11/10/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9A%E5%B1%8F%E8%94%BD%E8%99%9A%E6%8B%9F%E5%8C%96%E7%89%B9%E6%80%A7/"/>
    <id>https://renyb2.github.io/2022/11/10/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9A%E5%B1%8F%E8%94%BD%E8%99%9A%E6%8B%9F%E5%8C%96%E7%89%B9%E6%80%A7/</id>
    <published>2022-11-10T08:30:45.000Z</published>
    <updated>2022-11-24T02:06:49.088Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>记录如何解决虚机内软件、游戏启动报错：<code>Sorry, This Application Cannot Run Under A Virtual Machine</code></p><h2 id="关键点"><a href="#关键点" class="headerlink" title="关键点"></a>关键点</h2><blockquote><p>虚拟化检测点可参考文档：<a href="https://www.zhihu.com/question/359121561">操作系统能否知道自己处于虚拟机中?</a></p></blockquote><h3 id="CPU-model-and-topology"><a href="#CPU-model-and-topology" class="headerlink" title="CPU model and topology"></a>CPU model and topology</h3><ol><li>禁用CPU的<code>hypervisor</code>功能。</li><li>使用<code>host-passthrough</code>模式，透传主机CPU能力。</li></ol><p>参考xml相关配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;host-passthrough&#x27;</span> <span class="attr">check</span>=<span class="string">&#x27;none&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">topology</span> <span class="attr">sockets</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cores</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">threads</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;disable&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;hypervisor&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">numa</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cell</span> <span class="attr">id</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpus</span>=<span class="string">&#x27;0-7&#x27;</span> <span class="attr">memory</span>=<span class="string">&#x27;33554432&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span> <span class="attr">memAccess</span>=<span class="string">&#x27;shared&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">numa</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cpu</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="SMBIOS-System-Information"><a href="#SMBIOS-System-Information" class="headerlink" title="SMBIOS System Information"></a>SMBIOS System Information</h3><ol><li>屏蔽透传给主机的底层系统信息，可修改为PC厂商的信息，或直接使用host模式。</li></ol><p>参考xml相关配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">os</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">smbios</span> <span class="attr">mode</span>=<span class="string">&quot;host&quot;</span>/&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">os</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>Windows系统内可通过<code>systeminfo</code>命令查看效果。</p><p>smbios mode为<code>smbios</code>时，系统内部可查看到的信息如下：</p><img src= "/img/loading.gif" data-lazy-src="/2022/11/10/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9A%E5%B1%8F%E8%94%BD%E8%99%9A%E6%8B%9F%E5%8C%96%E7%89%B9%E6%80%A7/smbios_mode_smbios.png" alt="smbios-mode-smbios" style="zoom:100%;"><p>smbios mode为<code>host</code>时，系统内部可查看到的信息如下：</p><img src= "/img/loading.gif" data-lazy-src="/2022/11/10/Libvirt%E7%A0%94%E5%8F%91%EF%BC%9A%E5%B1%8F%E8%94%BD%E8%99%9A%E6%8B%9F%E5%8C%96%E7%89%B9%E6%80%A7/smbios_mode_host.png" alt="smbios-mode-host" style="zoom:100%;"><h3 id="Hypervisor-features"><a href="#Hypervisor-features" class="headerlink" title="Hypervisor features"></a>Hypervisor features</h3><ol><li>隐藏kvm特性。</li><li>若启用了hyperv，则需要隐藏hyperv的vendor_id。在未来，可能需要启用hyperv能力。</li></ol><p>参考xml相关配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">features</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">hyperv</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vendor_id</span> <span class="attr">state</span>=<span class="string">&quot;on&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1234567890ab&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">hyperv</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">kvm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hidden</span> <span class="attr">state</span>=<span class="string">&quot;on&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">kvm</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">features</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="标准OpenStack-XML"><a href="#标准OpenStack-XML" class="headerlink" title="标准OpenStack XML"></a>标准OpenStack XML</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">type</span>=<span class="string">&#x27;kvm&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>instance-0000014f<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>3ba2abc6-8141-4782-9b57-18c8773a12c0<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">metadata</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">nova:instance</span> <span class="attr">xmlns:nova</span>=<span class="string">&quot;http://openstack.org/xmlns/libvirt/nova/1.0&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">nova:package</span> <span class="attr">version</span>=<span class="string">&quot;20.6.1&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">nova:name</span>&gt;</span>test-vgpu-6<span class="tag">&lt;/<span class="name">nova:name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">nova:creationTime</span>&gt;</span>2022-11-15 02:33:55<span class="tag">&lt;/<span class="name">nova:creationTime</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">nova:flavor</span> <span class="attr">name</span>=<span class="string">&quot;test-8u16g-vgpu&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nova:memory</span>&gt;</span>16384<span class="tag">&lt;/<span class="name">nova:memory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nova:disk</span>&gt;</span>200<span class="tag">&lt;/<span class="name">nova:disk</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nova:swap</span>&gt;</span>0<span class="tag">&lt;/<span class="name">nova:swap</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nova:ephemeral</span>&gt;</span>0<span class="tag">&lt;/<span class="name">nova:ephemeral</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nova:vcpus</span>&gt;</span>8<span class="tag">&lt;/<span class="name">nova:vcpus</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">nova:flavor</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">nova:owner</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nova:user</span> <span class="attr">uuid</span>=<span class="string">&quot;144ffda4d33c431095051cd5bebaf071&quot;</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">nova:user</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nova:project</span> <span class="attr">uuid</span>=<span class="string">&quot;a6fa603c739749e9b5edf31327bd507f&quot;</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">nova:project</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">nova:owner</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">nova:instance</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">metadata</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>16777216<span class="tag">&lt;/<span class="name">memory</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">currentMemory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>16777216<span class="tag">&lt;/<span class="name">currentMemory</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hugepages</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">page</span> <span class="attr">size</span>=<span class="string">&#x27;1048576&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span> <span class="attr">nodeset</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">hugepages</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpu</span> <span class="attr">placement</span>=<span class="string">&#x27;static&#x27;</span>&gt;</span>8<span class="tag">&lt;/<span class="name">vcpu</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cputune</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shares</span>&gt;</span>8192<span class="tag">&lt;/<span class="name">shares</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;16&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;48&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;21&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;53&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;29&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;5&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;61&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;6&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;54&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;7&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;22&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulatorpin</span> <span class="attr">cpuset</span>=<span class="string">&#x27;16,21-22,29,48,53-54,61&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">cputune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">numatune</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memory</span> <span class="attr">mode</span>=<span class="string">&#x27;strict&#x27;</span> <span class="attr">nodeset</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memnode</span> <span class="attr">cellid</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">mode</span>=<span class="string">&#x27;strict&#x27;</span> <span class="attr">nodeset</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">numatune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sysinfo</span> <span class="attr">type</span>=<span class="string">&#x27;smbios&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">system</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">entry</span> <span class="attr">name</span>=<span class="string">&#x27;manufacturer&#x27;</span>&gt;</span>OpenStack Foundation<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">entry</span> <span class="attr">name</span>=<span class="string">&#x27;product&#x27;</span>&gt;</span>OpenStack Nova<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">entry</span> <span class="attr">name</span>=<span class="string">&#x27;version&#x27;</span>&gt;</span>20.6.1<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">entry</span> <span class="attr">name</span>=<span class="string">&#x27;serial&#x27;</span>&gt;</span>3ba2abc6-8141-4782-9b57-18c8773a12c0<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">entry</span> <span class="attr">name</span>=<span class="string">&#x27;uuid&#x27;</span>&gt;</span>3ba2abc6-8141-4782-9b57-18c8773a12c0<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">entry</span> <span class="attr">name</span>=<span class="string">&#x27;family&#x27;</span>&gt;</span>Virtual Machine<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">system</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">sysinfo</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">os</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span> <span class="attr">arch</span>=<span class="string">&#x27;x86_64&#x27;</span> <span class="attr">machine</span>=<span class="string">&#x27;pc-i440fx-rhel7.2.0&#x27;</span>&gt;</span>hvm<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">boot</span> <span class="attr">dev</span>=<span class="string">&#x27;hd&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">smbios</span> <span class="attr">mode</span>=<span class="string">&#x27;smbios&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">os</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">features</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">acpi</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">apic</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">kvm</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">hidden</span> <span class="attr">state</span>=<span class="string">&#x27;on&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">kvm</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">features</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;custom&#x27;</span> <span class="attr">match</span>=<span class="string">&#x27;exact&#x27;</span> <span class="attr">check</span>=<span class="string">&#x27;partial&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">model</span> <span class="attr">fallback</span>=<span class="string">&#x27;allow&#x27;</span>&gt;</span>Broadwell<span class="tag">&lt;/<span class="name">model</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">topology</span> <span class="attr">sockets</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cores</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">threads</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;disable&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;hypervisor&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">numa</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">cell</span> <span class="attr">id</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpus</span>=<span class="string">&#x27;0-7&#x27;</span> <span class="attr">memory</span>=<span class="string">&#x27;16777216&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span> <span class="attr">memAccess</span>=<span class="string">&#x27;shared&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">numa</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">cpu</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">clock</span> <span class="attr">offset</span>=<span class="string">&#x27;utc&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;pit&#x27;</span> <span class="attr">tickpolicy</span>=<span class="string">&#x27;delay&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;rtc&#x27;</span> <span class="attr">tickpolicy</span>=<span class="string">&#x27;catchup&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;hpet&#x27;</span> <span class="attr">present</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">clock</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_poweroff</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_poweroff</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_reboot</span>&gt;</span>restart<span class="tag">&lt;/<span class="name">on_reboot</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_crash</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_crash</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulator</span>&gt;</span>/usr/libexec/qemu-kvm<span class="tag">&lt;/<span class="name">emulator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;network&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;disk&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;raw&#x27;</span> <span class="attr">cache</span>=<span class="string">&#x27;writeback&#x27;</span> <span class="attr">discard</span>=<span class="string">&#x27;unmap&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">auth</span> <span class="attr">username</span>=<span class="string">&#x27;cinder&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">secret</span> <span class="attr">type</span>=<span class="string">&#x27;ceph&#x27;</span> <span class="attr">uuid</span>=<span class="string">&#x27;457eb676-33da-42ec-9a8c-9293d545c337&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">auth</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">protocol</span>=<span class="string">&#x27;rbd&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;cinder-volumes/fd82f85e-0c67-4c4c-8738-d8e7ea3b9d0a&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">host</span> <span class="attr">name</span>=<span class="string">&#x27;111.111.9.207&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;6789&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;vda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">serial</span>&gt;</span>fd82f85e-0c67-4c4c-8738-d8e7ea3b9d0a<span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x0a&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;piix3-uhci&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x01&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;ehci&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x05&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;nec-xhci&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x06&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;ehci&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x07&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;nec-xhci&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x08&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pci-root&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x09&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;bridge&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;fa:16:3e:fa:21:60&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">bridge</span>=<span class="string">&#x27;br-int&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">virtualport</span> <span class="attr">type</span>=<span class="string">&#x27;openvswitch&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">parameters</span> <span class="attr">interfaceid</span>=<span class="string">&#x27;e0f2760f-3652-4d68-9332-f95b77c8ff03&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">virtualport</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;tape0f2760f-36&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mtu</span> <span class="attr">size</span>=<span class="string">&#x27;1500&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x03&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;bridge&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;fa:16:3e:fa:21:60&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">bridge</span>=<span class="string">&#x27;br-int&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">virtualport</span> <span class="attr">type</span>=<span class="string">&#x27;openvswitch&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">parameters</span> <span class="attr">interfaceid</span>=<span class="string">&#x27;e0f2760f-3652-4d68-9332-f95b77c8ff03&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">virtualport</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;tape0f2760f-36&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mtu</span> <span class="attr">size</span>=<span class="string">&#x27;1500&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x03&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">serial</span> <span class="attr">type</span>=<span class="string">&#x27;pty&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">log</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/nova/instances/3ba2abc6-8141-4782-9b57-18c8773a12c0/console.log&#x27;</span> <span class="attr">append</span>=<span class="string">&#x27;off&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;isa-serial&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;isa-serial&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">console</span> <span class="attr">type</span>=<span class="string">&#x27;pty&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">log</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/nova/instances/3ba2abc6-8141-4782-9b57-18c8773a12c0/console.log&#x27;</span> <span class="attr">append</span>=<span class="string">&#x27;off&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;serial&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">console</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">channel</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;com.redhat.spice.0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;tablet&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;mouse&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ps2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;keyboard&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ps2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">graphics</span> <span class="attr">type</span>=<span class="string">&#x27;vnc&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;-1&#x27;</span> <span class="attr">autoport</span>=<span class="string">&#x27;yes&#x27;</span> <span class="attr">listen</span>=<span class="string">&#x27;0.0.0.0&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">listen</span> <span class="attr">type</span>=<span class="string">&#x27;address&#x27;</span> <span class="attr">address</span>=<span class="string">&#x27;0.0.0.0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">graphics</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">graphics</span> <span class="attr">type</span>=<span class="string">&#x27;spice&#x27;</span> <span class="attr">autoport</span>=<span class="string">&#x27;yes&#x27;</span> <span class="attr">listen</span>=<span class="string">&#x27;0.0.0.0&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">listen</span> <span class="attr">type</span>=<span class="string">&#x27;address&#x27;</span> <span class="attr">address</span>=<span class="string">&#x27;0.0.0.0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">graphics</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sound</span> <span class="attr">model</span>=<span class="string">&#x27;ac97&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x04&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">sound</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">video</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;qxl&#x27;</span> <span class="attr">ram</span>=<span class="string">&#x27;65536&#x27;</span> <span class="attr">vram</span>=<span class="string">&#x27;65536&#x27;</span> <span class="attr">vgamem</span>=<span class="string">&#x27;32768&#x27;</span> <span class="attr">heads</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">primary</span>=<span class="string">&#x27;yes&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hostdev</span> <span class="attr">mode</span>=<span class="string">&#x27;subsystem&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;mdev&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;vfio-pci&#x27;</span> <span class="attr">display</span>=<span class="string">&#x27;off&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">address</span> <span class="attr">uuid</span>=<span class="string">&#x27;df8b83b3-0abc-4228-8311-1f82ea846165&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x0b&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">hostdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;4&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;4&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memballoon</span> <span class="attr">model</span>=<span class="string">&#x27;virtio&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">stats</span> <span class="attr">period</span>=<span class="string">&#x27;10&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x0c&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">memballoon</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://www.kanxue.com/">看雪官网</a></li><li><a href="https://libvirt.org/formatdomain.html">Libvirt官方文档：Domain XML format</a></li><li><a href="https://www.zhihu.com/question/359121561">操作系统能否知道自己处于虚拟机中?</a></li><li><a href="https://superuser.com/questions/1387935/hiding-virtual-machine-status-from-guest-operating-system">Hiding Virtual machine status from guest operating system</a></li><li><a href="https://cliuyang.cn/run-Windows-programs-on-Linux/">在 Linux 上原生运行 Windows 应用</a></li><li><a href="https://4-x.tw/application_run_under_vm/">如何解決程式無法正常在Virtual Machine環境執行</a></li><li><a href="https://www.likecs.com/show-203815307.html#sc=300">因为win10自带虚拟软件Hyper-V关闭不完全导致的无法打开闪讯客户端Netkeeper</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;记录如何解决虚机内软件、游戏启动报错：&lt;code&gt;Sorry, This Application Cannot Run Under A Vi</summary>
      
    
    
    
    <category term="Libvirt" scheme="https://renyb2.github.io/categories/Libvirt/"/>
    
    
    <category term="KVM" scheme="https://renyb2.github.io/tags/KVM/"/>
    
    <category term="Libvirt" scheme="https://renyb2.github.io/tags/Libvirt/"/>
    
    <category term="虚拟化" scheme="https://renyb2.github.io/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>OpenStack使用：GPU卡使用</title>
    <link href="https://renyb2.github.io/2022/08/22/OpenStack%E4%BD%BF%E7%94%A8%EF%BC%9AGPU%E5%8D%A1%E4%BD%BF%E7%94%A8/"/>
    <id>https://renyb2.github.io/2022/08/22/OpenStack%E4%BD%BF%E7%94%A8%EF%BC%9AGPU%E5%8D%A1%E4%BD%BF%E7%94%A8/</id>
    <published>2022-08-22T02:57:57.000Z</published>
    <updated>2023-01-19T09:57:10.712Z</updated>
    
    <content type="html"><![CDATA[<h2 id="含有多个设备的GPU"><a href="#含有多个设备的GPU" class="headerlink" title="含有多个设备的GPU"></a>含有多个设备的GPU</h2><p>常见型号：Quadro RTX 6000/8000</p><h3 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h3><p>系统内<code>lspci</code>查看显卡信息如下，可以看到同一个PCI插槽上（b1）包含了4个设备：VGA compatible、Audio device、USB、Serial bus，同时4个设备对应的驱动各不相同。</p><p><img src= "/img/loading.gif" data-lazy-src="/2022/08/22/OpenStack%E4%BD%BF%E7%94%A8%EF%BC%9AGPU%E5%8D%A1%E4%BD%BF%E7%94%A8/lspci%E4%BF%A1%E6%81%AF.png" alt="lspci信息"></p><p><img src= "/img/loading.gif" data-lazy-src="/2022/08/22/OpenStack%E4%BD%BF%E7%94%A8%EF%BC%9AGPU%E5%8D%A1%E4%BD%BF%E7%94%A8/%E5%8E%9F%E5%A7%8B%E9%A9%B1%E5%8A%A8.png" alt="原始驱动"></p><p>目前cyborg暂不支持此类加速设备的管理，cyborg采集的attach handle info中，只包含了function 0，即生成的xml中仅会透传GPU中的1个设备进入虚机，由于设备不完整，会导致libvirt会无法拉起虚机。</p><p><img src= "/img/loading.gif" data-lazy-src="/2022/08/22/OpenStack%E4%BD%BF%E7%94%A8%EF%BC%9AGPU%E5%8D%A1%E4%BD%BF%E7%94%A8/cyborg%E9%87%87%E9%9B%86%E5%88%B0%E7%9A%84%E4%BF%A1%E6%81%AF.png" alt="cyborg采集到的信息"></p><p>使用此类GPU，需要通过nova compute的PCI透传功能实现，<strong>总体思路</strong>如下：</p><ol><li>切换GPU卡各类设备的驱动为vfio_pci。</li><li>透传GPU卡的所有设备至虚机。</li></ol><p>若这两点有一点不满足，libvirt在拉起虚机时均会报如下报错：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br></pre></td><td class="code"><pre><span class="line">2022-08-20 16:39:06.047 3711 INFO nova.compute.claims [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Claim successful on node node01</span><br><span class="line">2022-08-20 16:39:06.259 3711 WARNING nova.virt.osinfo [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] Cannot find OS information - Reason: (No configuration information found for operating system Windows): OsInfoNotFound: No configuration information found for operating system Windows</span><br><span class="line">2022-08-20 16:39:06.282 3711 INFO nova.virt.libvirt.driver [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Ignoring supplied device name: /dev/vda. Libvirt can&#x27;t honour user-supplied dev names</span><br><span class="line">2022-08-20 16:39:06.283 3711 WARNING nova.virt.osinfo [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] Cannot find OS information - Reason: (No configuration information found for operating system Windows): OsInfoNotFound: No configuration information found for operating system Windows</span><br><span class="line">2022-08-20 16:39:06.402 3711 INFO nova.virt.block_device [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Booting with volume-backed-image eb3aee11-f487-45e3-ac36-984904ad010a at /dev/vda</span><br><span class="line">2022-08-20 16:39:12.973 3711 WARNING nova.virt.osinfo [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] Cannot find OS information - Reason: (No configuration information found for operating system Windows): OsInfoNotFound: No configuration information found for operating system Windows</span><br><span class="line">2022-08-20 16:39:12.975 3711 INFO nova.virt.libvirt.driver [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Creating image</span><br><span class="line">2022-08-20 16:39:13.008 3711 WARNING nova.virt.osinfo [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] Cannot find OS information - Reason: (No configuration information found for operating system Windows): OsInfoNotFound: No configuration information found for operating system Windows</span><br><span class="line">2022-08-20 16:39:13.013 3711 WARNING nova.virt.libvirt.driver [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] USB tablet requested for guests by host configuration. In order to accept this request VNC should be enabled or SPICE and SPICE agent disabled on host.</span><br><span class="line">2022-08-20 16:39:15.811 3711 ERROR nova.virt.libvirt.guest [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] Error launching a defined domain with XML: &lt;domain type=&#x27;kvm&#x27;&gt;</span><br><span class="line">  &lt;name&gt;instance-00000007&lt;/name&gt;</span><br><span class="line">  &lt;uuid&gt;285e807d-426d-4b4a-b500-e89f92b9172a&lt;/uuid&gt;</span><br><span class="line">  &lt;metadata&gt;</span><br><span class="line">    &lt;nova:instance xmlns:nova=&quot;http://openstack.org/xmlns/libvirt/nova/1.0&quot;&gt;</span><br><span class="line">      &lt;nova:package version=&quot;20.6.1&quot;/&gt;</span><br><span class="line">      &lt;nova:name&gt;win10-1&lt;/nova:name&gt;</span><br><span class="line">      &lt;nova:creationTime&gt;2022-08-20 16:39:12&lt;/nova:creationTime&gt;</span><br><span class="line">      &lt;nova:flavor name=&quot;win10_8C16G&quot;&gt;</span><br><span class="line">        &lt;nova:memory&gt;16384&lt;/nova:memory&gt;</span><br><span class="line">        &lt;nova:disk&gt;100&lt;/nova:disk&gt;</span><br><span class="line">        &lt;nova:swap&gt;0&lt;/nova:swap&gt;</span><br><span class="line">        &lt;nova:ephemeral&gt;0&lt;/nova:ephemeral&gt;</span><br><span class="line">        &lt;nova:vcpus&gt;8&lt;/nova:vcpus&gt;</span><br><span class="line">      &lt;/nova:flavor&gt;</span><br><span class="line">      &lt;nova:owner&gt;</span><br><span class="line">        &lt;nova:user uuid=&quot;20f2649ce88142f19048b0aa090b78a1&quot;&gt;admin&lt;/nova:user&gt;</span><br><span class="line">        &lt;nova:project uuid=&quot;a1670d65a7e644e2a78fa31a001f284b&quot;&gt;admin&lt;/nova:project&gt;</span><br><span class="line">      &lt;/nova:owner&gt;</span><br><span class="line">    &lt;/nova:instance&gt;</span><br><span class="line">  &lt;/metadata&gt;</span><br><span class="line">  &lt;memory unit=&#x27;KiB&#x27;&gt;16777216&lt;/memory&gt;</span><br><span class="line">  &lt;currentMemory unit=&#x27;KiB&#x27;&gt;16777216&lt;/currentMemory&gt;</span><br><span class="line">  &lt;memoryBacking&gt;</span><br><span class="line">    &lt;hugepages&gt;</span><br><span class="line">      &lt;page size=&#x27;1048576&#x27; unit=&#x27;KiB&#x27; nodeset=&#x27;0&#x27;/&gt;</span><br><span class="line">    &lt;/hugepages&gt;</span><br><span class="line">  &lt;/memoryBacking&gt;</span><br><span class="line">  &lt;vcpu placement=&#x27;static&#x27;&gt;8&lt;/vcpu&gt;</span><br><span class="line">  &lt;cputune&gt;</span><br><span class="line">    &lt;shares&gt;8192&lt;/shares&gt;</span><br><span class="line">    &lt;vcpupin vcpu=&#x27;0&#x27; cpuset=&#x27;3-15,35-47&#x27;/&gt;</span><br><span class="line">    &lt;vcpupin vcpu=&#x27;1&#x27; cpuset=&#x27;3-15,35-47&#x27;/&gt;</span><br><span class="line">    &lt;vcpupin vcpu=&#x27;2&#x27; cpuset=&#x27;3-15,35-47&#x27;/&gt;</span><br><span class="line">    &lt;vcpupin vcpu=&#x27;3&#x27; cpuset=&#x27;3-15,35-47&#x27;/&gt;</span><br><span class="line">    &lt;vcpupin vcpu=&#x27;4&#x27; cpuset=&#x27;3-15,35-47&#x27;/&gt;</span><br><span class="line">    &lt;vcpupin vcpu=&#x27;5&#x27; cpuset=&#x27;3-15,35-47&#x27;/&gt;</span><br><span class="line">    &lt;vcpupin vcpu=&#x27;6&#x27; cpuset=&#x27;3-15,35-47&#x27;/&gt;</span><br><span class="line">    &lt;vcpupin vcpu=&#x27;7&#x27; cpuset=&#x27;3-15,35-47&#x27;/&gt;</span><br><span class="line">    &lt;emulatorpin cpuset=&#x27;3-15,35-47&#x27;/&gt;</span><br><span class="line">  &lt;/cputune&gt;</span><br><span class="line">  &lt;numatune&gt;</span><br><span class="line">    &lt;memory mode=&#x27;strict&#x27; nodeset=&#x27;0&#x27;/&gt;</span><br><span class="line">    &lt;memnode cellid=&#x27;0&#x27; mode=&#x27;strict&#x27; nodeset=&#x27;0&#x27;/&gt;</span><br><span class="line">  &lt;/numatune&gt;</span><br><span class="line">  &lt;sysinfo type=&#x27;smbios&#x27;&gt;</span><br><span class="line">    &lt;system&gt;</span><br><span class="line">      &lt;entry name=&#x27;manufacturer&#x27;&gt;OpenStack Foundation&lt;/entry&gt;</span><br><span class="line">      &lt;entry name=&#x27;product&#x27;&gt;OpenStack Nova&lt;/entry&gt;</span><br><span class="line">      &lt;entry name=&#x27;version&#x27;&gt;20.6.1&lt;/entry&gt;</span><br><span class="line">      &lt;entry name=&#x27;serial&#x27;&gt;285e807d-426d-4b4a-b500-e89f92b9172a&lt;/entry&gt;</span><br><span class="line">      &lt;entry name=&#x27;uuid&#x27;&gt;285e807d-426d-4b4a-b500-e89f92b9172a&lt;/entry&gt;</span><br><span class="line">      &lt;entry name=&#x27;family&#x27;&gt;Virtual Machine&lt;/entry&gt;</span><br><span class="line">    &lt;/system&gt;</span><br><span class="line">  &lt;/sysinfo&gt;</span><br><span class="line">  &lt;os&gt;</span><br><span class="line">    &lt;type arch=&#x27;x86_64&#x27; machine=&#x27;pc-i440fx-rhel7.2.0&#x27;&gt;hvm&lt;/type&gt;</span><br><span class="line">    &lt;boot dev=&#x27;hd&#x27;/&gt;</span><br><span class="line">    &lt;smbios mode=&#x27;sysinfo&#x27;/&gt;</span><br><span class="line">  &lt;/os&gt;</span><br><span class="line">  &lt;features&gt;</span><br><span class="line">    &lt;acpi/&gt;</span><br><span class="line">    &lt;apic/&gt;</span><br><span class="line">  &lt;/features&gt;</span><br><span class="line">  &lt;cpu mode=&#x27;host-model&#x27; check=&#x27;partial&#x27;&gt;</span><br><span class="line">    &lt;model fallback=&#x27;allow&#x27;/&gt;</span><br><span class="line">    &lt;topology sockets=&#x27;2&#x27; cores=&#x27;1&#x27; threads=&#x27;4&#x27;/&gt;</span><br><span class="line">    &lt;numa&gt;</span><br><span class="line">      &lt;cell id=&#x27;0&#x27; cpus=&#x27;0-7&#x27; memory=&#x27;16777216&#x27; unit=&#x27;KiB&#x27; memAccess=&#x27;shared&#x27;/&gt;</span><br><span class="line">    &lt;/numa&gt;</span><br><span class="line">  &lt;/cpu&gt;</span><br><span class="line">  &lt;clock offset=&#x27;utc&#x27;&gt;</span><br><span class="line">    &lt;timer name=&#x27;pit&#x27; tickpolicy=&#x27;delay&#x27;/&gt;</span><br><span class="line">    &lt;timer name=&#x27;rtc&#x27; tickpolicy=&#x27;catchup&#x27;/&gt;</span><br><span class="line">    &lt;timer name=&#x27;hpet&#x27; present=&#x27;no&#x27;/&gt;</span><br><span class="line">  &lt;/clock&gt;</span><br><span class="line">  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;</span><br><span class="line">  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;</span><br><span class="line">  &lt;on_crash&gt;destroy&lt;/on_crash&gt;</span><br><span class="line">  &lt;devices&gt;</span><br><span class="line">    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;</span><br><span class="line">    &lt;disk type=&#x27;network&#x27; device=&#x27;disk&#x27;&gt;</span><br><span class="line">      &lt;driver name=&#x27;qemu&#x27; type=&#x27;raw&#x27; cache=&#x27;writeback&#x27; discard=&#x27;unmap&#x27;/&gt;</span><br><span class="line">      &lt;auth username=&#x27;cinder&#x27;&gt;</span><br><span class="line">        &lt;secret type=&#x27;ceph&#x27; uuid=&#x27;457eb676-33da-42ec-9a8c-9293d545c337&#x27;/&gt;</span><br><span class="line">      &lt;/auth&gt;</span><br><span class="line">      &lt;source protocol=&#x27;rbd&#x27; name=&#x27;cinder-volumes/a728e5a5-ca72-4d70-8d2f-4b193d88a595&#x27;&gt;</span><br><span class="line">        &lt;host name=&#x27;10.99.22.45&#x27; port=&#x27;6789&#x27;/&gt;</span><br><span class="line">      &lt;/source&gt;</span><br><span class="line">      &lt;target dev=&#x27;vda&#x27; bus=&#x27;virtio&#x27;/&gt;</span><br><span class="line">      &lt;serial&gt;a728e5a5-ca72-4d70-8d2f-4b193d88a595&lt;/serial&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x0a&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/disk&gt;</span><br><span class="line">    &lt;controller type=&#x27;usb&#x27; index=&#x27;0&#x27; model=&#x27;piix3-uhci&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x01&#x27; function=&#x27;0x2&#x27;/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller type=&#x27;usb&#x27; index=&#x27;1&#x27; model=&#x27;ehci&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x05&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller type=&#x27;usb&#x27; index=&#x27;2&#x27; model=&#x27;nec-xhci&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x06&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller type=&#x27;usb&#x27; index=&#x27;3&#x27; model=&#x27;ehci&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x07&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller type=&#x27;usb&#x27; index=&#x27;4&#x27; model=&#x27;nec-xhci&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x08&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller type=&#x27;pci&#x27; index=&#x27;0&#x27; model=&#x27;pci-root&#x27;/&gt;</span><br><span class="line">    &lt;controller type=&#x27;virtio-serial&#x27; index=&#x27;0&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x09&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;interface type=&#x27;bridge&#x27;&gt;</span><br><span class="line">      &lt;mac address=&#x27;fa:16:3e:58:02:a6&#x27;/&gt;</span><br><span class="line">      &lt;source bridge=&#x27;br-int&#x27;/&gt;</span><br><span class="line">      &lt;virtualport type=&#x27;openvswitch&#x27;&gt;</span><br><span class="line">        &lt;parameters interfaceid=&#x27;2fdb3a80-a1ca-4927-b11e-2c40024dad69&#x27;/&gt;</span><br><span class="line">      &lt;/virtualport&gt;</span><br><span class="line">      &lt;target dev=&#x27;tap2fdb3a80-a1&#x27;/&gt;</span><br><span class="line">      &lt;model type=&#x27;virtio&#x27;/&gt;</span><br><span class="line">      &lt;mtu size=&#x27;1500&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x03&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/interface&gt;</span><br><span class="line">    &lt;serial type=&#x27;pty&#x27;&gt;</span><br><span class="line">      &lt;log file=&#x27;/var/lib/nova/instances/285e807d-426d-4b4a-b500-e89f92b9172a/console.log&#x27; append=&#x27;off&#x27;/&gt;</span><br><span class="line">      &lt;target type=&#x27;isa-serial&#x27; port=&#x27;0&#x27;&gt;</span><br><span class="line">        &lt;model name=&#x27;isa-serial&#x27;/&gt;</span><br><span class="line">      &lt;/target&gt;</span><br><span class="line">    &lt;/serial&gt;</span><br><span class="line">    &lt;console type=&#x27;pty&#x27;&gt;</span><br><span class="line">      &lt;log file=&#x27;/var/lib/nova/instances/285e807d-426d-4b4a-b500-e89f92b9172a/console.log&#x27; append=&#x27;off&#x27;/&gt;</span><br><span class="line">      &lt;target type=&#x27;serial&#x27; port=&#x27;0&#x27;/&gt;</span><br><span class="line">    &lt;/console&gt;</span><br><span class="line">    &lt;channel type=&#x27;spicevmc&#x27;&gt;</span><br><span class="line">      &lt;target type=&#x27;virtio&#x27; name=&#x27;com.redhat.spice.0&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;virtio-serial&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; port=&#x27;1&#x27;/&gt;</span><br><span class="line">    &lt;/channel&gt;</span><br><span class="line">    &lt;channel type=&#x27;unix&#x27;&gt;</span><br><span class="line">      &lt;source mode=&#x27;bind&#x27; path=&#x27;/var/lib/libvirt/qemu/org.qemu.guest_agent.0.instance-00000007.sock&#x27;/&gt;</span><br><span class="line">      &lt;target type=&#x27;virtio&#x27; name=&#x27;org.qemu.guest_agent.0&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;virtio-serial&#x27; controller=&#x27;0&#x27; bus=&#x27;0&#x27; port=&#x27;2&#x27;/&gt;</span><br><span class="line">    &lt;/channel&gt;</span><br><span class="line">    &lt;input type=&#x27;mouse&#x27; bus=&#x27;ps2&#x27;/&gt;</span><br><span class="line">    &lt;input type=&#x27;keyboard&#x27; bus=&#x27;ps2&#x27;/&gt;</span><br><span class="line">    &lt;graphics type=&#x27;spice&#x27; autoport=&#x27;yes&#x27; listen=&#x27;0.0.0.0&#x27;&gt;</span><br><span class="line">      &lt;listen type=&#x27;address&#x27; address=&#x27;0.0.0.0&#x27;/&gt;</span><br><span class="line">    &lt;/graphics&gt;</span><br><span class="line">    &lt;sound model=&#x27;ac97&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x04&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/sound&gt;</span><br><span class="line">    &lt;video&gt;</span><br><span class="line">      &lt;model type=&#x27;qxl&#x27; ram=&#x27;65536&#x27; vram=&#x27;65536&#x27; vgamem=&#x27;32768&#x27; heads=&#x27;1&#x27; primary=&#x27;yes&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x02&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/video&gt;</span><br><span class="line">    &lt;hostdev mode=&#x27;subsystem&#x27; type=&#x27;pci&#x27; managed=&#x27;yes&#x27;&gt;</span><br><span class="line">      &lt;source&gt;</span><br><span class="line">        &lt;address domain=&#x27;0x0000&#x27; bus=&#x27;0xb1&#x27; slot=&#x27;0x00&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">      &lt;/source&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x0b&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/hostdev&gt;</span><br><span class="line">    &lt;redirdev bus=&#x27;usb&#x27; type=&#x27;spicevmc&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;usb&#x27; bus=&#x27;3&#x27; port=&#x27;1&#x27;/&gt;</span><br><span class="line">    &lt;/redirdev&gt;</span><br><span class="line">    &lt;redirdev bus=&#x27;usb&#x27; type=&#x27;spicevmc&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;usb&#x27; bus=&#x27;3&#x27; port=&#x27;2&#x27;/&gt;</span><br><span class="line">    &lt;/redirdev&gt;</span><br><span class="line">    &lt;redirdev bus=&#x27;usb&#x27; type=&#x27;spicevmc&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;usb&#x27; bus=&#x27;4&#x27; port=&#x27;1&#x27;/&gt;</span><br><span class="line">    &lt;/redirdev&gt;</span><br><span class="line">    &lt;redirdev bus=&#x27;usb&#x27; type=&#x27;spicevmc&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;usb&#x27; bus=&#x27;4&#x27; port=&#x27;2&#x27;/&gt;</span><br><span class="line">    &lt;/redirdev&gt;</span><br><span class="line">    &lt;redirdev bus=&#x27;usb&#x27; type=&#x27;spicevmc&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;usb&#x27; bus=&#x27;3&#x27; port=&#x27;3&#x27;/&gt;</span><br><span class="line">    &lt;/redirdev&gt;</span><br><span class="line">    &lt;redirdev bus=&#x27;usb&#x27; type=&#x27;spicevmc&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;usb&#x27; bus=&#x27;3&#x27; port=&#x27;4&#x27;/&gt;</span><br><span class="line">    &lt;/redirdev&gt;</span><br><span class="line">    &lt;redirdev bus=&#x27;usb&#x27; type=&#x27;spicevmc&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;usb&#x27; bus=&#x27;4&#x27; port=&#x27;3&#x27;/&gt;</span><br><span class="line">    &lt;/redirdev&gt;</span><br><span class="line">    &lt;redirdev bus=&#x27;usb&#x27; type=&#x27;spicevmc&#x27;&gt;</span><br><span class="line">      &lt;address type=&#x27;usb&#x27; bus=&#x27;4&#x27; port=&#x27;4&#x27;/&gt;</span><br><span class="line">    &lt;/redirdev&gt;</span><br><span class="line">    &lt;memballoon model=&#x27;virtio&#x27;&gt;</span><br><span class="line">      &lt;stats period=&#x27;10&#x27;/&gt;</span><br><span class="line">      &lt;address type=&#x27;pci&#x27; domain=&#x27;0x0000&#x27; bus=&#x27;0x00&#x27; slot=&#x27;0x0c&#x27; function=&#x27;0x0&#x27;/&gt;</span><br><span class="line">    &lt;/memballoon&gt;</span><br><span class="line">  &lt;/devices&gt;</span><br><span class="line">&lt;/domain&gt;</span><br><span class="line">: libvirtError: internal error: process exited while connecting to monitor: 2022-08-20T16:39:15.220119Z qemu-kvm: -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=32,max_outputs=1,bus=pci.0,addr=0x2: vhost_region_add_section:Section rounded to 0 prior to previous c0000</span><br><span class="line">2022-08-20 16:39:15.813 3711 ERROR nova.virt.libvirt.driver [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Failed to start libvirt guest: libvirtError: internal error: process exited while connecting to monitor: 2022-08-20T16:39:15.220119Z qemu-kvm: -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=32,max_outputs=1,bus=pci.0,addr=0x2: vhost_region_add_section:Section rounded to 0 prior to previous c0000</span><br><span class="line">2022-08-20 16:39:15.864 3711 INFO nova.virt.libvirt.driver [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Deleting instance files /var/lib/nova/instances/285e807d-426d-4b4a-b500-e89f92b9172a_del</span><br><span class="line">2022-08-20 16:39:15.865 3711 INFO nova.virt.libvirt.driver [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Deletion of /var/lib/nova/instances/285e807d-426d-4b4a-b500-e89f92b9172a_del complete</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Instance failed to spawn: libvirtError: internal error: process exited while connecting to monitor: 2022-08-20T16:39:15.220119Z qemu-kvm: -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=32,max_outputs=1,bus=pci.0,addr=0x2: vhost_region_add_section:Section rounded to 0 prior to previous c0000</span><br><span class="line">2022-08-20T16:39:15.220245Z qemu-kvm: -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=32,max_outputs=1,bus=pci.0,addr=0x2: vhost_region_add_section:Section rounded to 0 prior to previous c0000</span><br><span class="line">2022-08-20T16:39:15.224010Z qemu-kvm: -device vfio-pci,host=0000:b1:00.0,id=hostdev0,bus=pci.0,addr=0xb: vfio error: 0000:b1:00.0: group 183 is not viable</span><br><span class="line">Please ensure all devices within the iommu_group are bound to their vfio bus driver.</span><br><span class="line">unload codec helper module</span><br><span class="line">unload codec helper module done</span><br><span class="line">unload x264 encoder module done</span><br><span class="line">unload aac encode compress module</span><br><span class="line">unload aac encode compress done</span><br><span class="line">unload aac decode compress module</span><br><span class="line">unload aac decode compress done</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Traceback (most recent call last):</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/compute/manager.py&quot;, line 2808, in _build_resources</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     yield resources</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/compute/manager.py&quot;, line 2567, in _build_and_run_instance</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     accel_info=accel_info)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/driver.py&quot;, line 3524, in spawn</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     power_on=power_on)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/driver.py&quot;, line 6431, in _create_domain_and_network</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     destroy_disks_on_failure)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/oslo_utils/excutils.py&quot;, line 220, in __exit__</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     self.force_reraise()</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/oslo_utils/excutils.py&quot;, line 196, in force_reraise</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     six.reraise(self.type_, self.value, self.tb)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/driver.py&quot;, line 6397, in _create_domain_and_network</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     post_xml_callback=post_xml_callback)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/driver.py&quot;, line 6328, in _create_domain</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     guest.launch(pause=pause)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/guest.py&quot;, line 145, in launch</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     self._encoded_xml, errors=&#x27;ignore&#x27;)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/oslo_utils/excutils.py&quot;, line 220, in __exit__</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     self.force_reraise()</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/oslo_utils/excutils.py&quot;, line 196, in force_reraise</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     six.reraise(self.type_, self.value, self.tb)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/guest.py&quot;, line 140, in launch</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     return self._domain.createWithFlags(flags)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/eventlet/tpool.py&quot;, line 190, in doit</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     result = proxy_call(self._autowrap, f, *args, **kwargs)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/eventlet/tpool.py&quot;, line 148, in proxy_call</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     rv = execute(f, *args, **kwargs)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/eventlet/tpool.py&quot;, line 129, in execute</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     six.reraise(c, e, tb)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/eventlet/tpool.py&quot;, line 83, in tworker</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     rv = meth(*args, **kwargs)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/usr/lib64/python2.7/site-packages/libvirt.py&quot;, line 1110, in createWithFlags</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     if ret == -1: raise libvirtError (&#x27;virDomainCreateWithFlags() failed&#x27;, dom=self)</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] libvirtError: internal error: process exited while connecting to monitor: 2022-08-20T16:39:15.220119Z qemu-kvm: -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=32,max_outputs=1,bus=pci.0,addr=0x2: vhost_region_add_section:Section rounded to 0 prior to previous c0000</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] 2022-08-20T16:39:15.220245Z qemu-kvm: -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=32,max_outputs=1,bus=pci.0,addr=0x2: vhost_region_add_section:Section rounded to 0 prior to previous c0000</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] 2022-08-20T16:39:15.224010Z qemu-kvm: -device vfio-pci,host=0000:b1:00.0,id=hostdev0,bus=pci.0,addr=0xb: vfio error: 0000:b1:00.0: group 183 is not viable</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Please ensure all devices within the iommu_group are bound to their vfio bus driver.</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload codec helper module</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload codec helper module done</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload x264 encoder module done</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload aac encode compress module</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload aac encode compress done</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload aac decode compress module</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload aac decode compress done</span><br><span class="line">2022-08-20 16:39:15.950 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]</span><br><span class="line">2022-08-20 16:39:15.956 3711 INFO nova.compute.manager [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Terminating instance</span><br><span class="line">2022-08-20 16:39:15.961 3711 INFO nova.virt.libvirt.driver [-] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Instance destroyed successfully.</span><br><span class="line">2022-08-20 16:39:15.998 3711 INFO nova.virt.libvirt.driver [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Deletion of /var/lib/nova/instances/285e807d-426d-4b4a-b500-e89f92b9172a_del complete</span><br><span class="line">2022-08-20 16:39:16.104 3711 INFO nova.compute.manager [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Took 0.15 seconds to destroy the instance on the hypervisor.</span><br><span class="line">2022-08-20 16:39:16.412 3711 INFO nova.compute.manager [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Took 0.31 seconds to detach 1 volumes for instance.</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Failed to build and run instance: libvirtError: internal error: process exited while connecting to monitor: 2022-08-20T16:39:15.220119Z qemu-kvm: -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=32,max_outputs=1,bus=pci.0,addr=0x2: vhost_region_add_section:Section rounded to 0 prior to previous c0000</span><br><span class="line">2022-08-20T16:39:15.220245Z qemu-kvm: -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=32,max_outputs=1,bus=pci.0,addr=0x2: vhost_region_add_section:Section rounded to 0 prior to previous c0000</span><br><span class="line">2022-08-20T16:39:15.224010Z qemu-kvm: -device vfio-pci,host=0000:b1:00.0,id=hostdev0,bus=pci.0,addr=0xb: vfio error: 0000:b1:00.0: group 183 is not viable</span><br><span class="line">Please ensure all devices within the iommu_group are bound to their vfio bus driver.</span><br><span class="line">unload codec helper module</span><br><span class="line">unload codec helper module done</span><br><span class="line">unload x264 encoder module done</span><br><span class="line">unload aac encode compress module</span><br><span class="line">unload aac encode compress done</span><br><span class="line">unload aac decode compress module</span><br><span class="line">unload aac decode compress done</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Traceback (most recent call last):</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/compute/manager.py&quot;, line 2567, in _build_and_run_instance</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     accel_info=accel_info)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/driver.py&quot;, line 3524, in spawn</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     power_on=power_on)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/driver.py&quot;, line 6431, in _create_domain_and_network</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     destroy_disks_on_failure)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/oslo_utils/excutils.py&quot;, line 220, in __exit__</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     self.force_reraise()</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/oslo_utils/excutils.py&quot;, line 196, in force_reraise</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     six.reraise(self.type_, self.value, self.tb)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/driver.py&quot;, line 6397, in _create_domain_and_network</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     post_xml_callback=post_xml_callback)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/driver.py&quot;, line 6328, in _create_domain</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     guest.launch(pause=pause)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/guest.py&quot;, line 145, in launch</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     self._encoded_xml, errors=&#x27;ignore&#x27;)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/oslo_utils/excutils.py&quot;, line 220, in __exit__</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     self.force_reraise()</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/oslo_utils/excutils.py&quot;, line 196, in force_reraise</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     six.reraise(self.type_, self.value, self.tb)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/nova/virt/libvirt/guest.py&quot;, line 140, in launch</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     return self._domain.createWithFlags(flags)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/eventlet/tpool.py&quot;, line 190, in doit</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     result = proxy_call(self._autowrap, f, *args, **kwargs)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/eventlet/tpool.py&quot;, line 148, in proxy_call</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     rv = execute(f, *args, **kwargs)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/eventlet/tpool.py&quot;, line 129, in execute</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     six.reraise(c, e, tb)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/var/lib/kolla/venv/lib/python2.7/site-packages/eventlet/tpool.py&quot;, line 83, in tworker</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     rv = meth(*args, **kwargs)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]   File &quot;/usr/lib64/python2.7/site-packages/libvirt.py&quot;, line 1110, in createWithFlags</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]     if ret == -1: raise libvirtError (&#x27;virDomainCreateWithFlags() failed&#x27;, dom=self)</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] libvirtError: internal error: process exited while connecting to monitor: 2022-08-20T16:39:15.220119Z qemu-kvm: -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=32,max_outputs=1,bus=pci.0,addr=0x2: vhost_region_add_section:Section rounded to 0 prior to previous c0000</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] 2022-08-20T16:39:15.220245Z qemu-kvm: -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=32,max_outputs=1,bus=pci.0,addr=0x2: vhost_region_add_section:Section rounded to 0 prior to previous c0000</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] 2022-08-20T16:39:15.224010Z qemu-kvm: -device vfio-pci,host=0000:b1:00.0,id=hostdev0,bus=pci.0,addr=0xb: vfio error: 0000:b1:00.0: group 183 is not viable</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Please ensure all devices within the iommu_group are bound to their vfio bus driver.</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload codec helper module</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload codec helper module done</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload x264 encoder module done</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload aac encode compress module</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload aac encode compress done</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload aac decode compress module</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] unload aac decode compress done</span><br><span class="line">2022-08-20 16:39:16.770 3711 ERROR nova.compute.manager [instance: 285e807d-426d-4b4a-b500-e89f92b9172a]</span><br><span class="line">2022-08-20 16:39:18.018 3711 INFO nova.compute.manager [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] [instance: 285e807d-426d-4b4a-b500-e89f92b9172a] Took 1.20 seconds to deallocate network for instance.</span><br><span class="line">2022-08-20 16:39:18.330 3711 INFO nova.scheduler.client.report [req-5656f7a4-5fcf-4f5a-b72b-2f425087cfb4 20f2649ce88142f19048b0aa090b78a1 a1670d65a7e644e2a78fa31a001f284b - default default] Deleted allocation for instance 285e807d-426d-4b4a-b500-e89f92b9172a</span><br><span class="line">2022-08-20 17:00:09.337 3711 INFO nova.compute.manager [req-c902ff9e-9ef9-484a-87ed-30e51a8c7b03 - - - - -] Running instance usage audit for host node01 from 2022-08-20 16:00:00 to 2022-08-20 17:00:00. 3 instances.</span><br></pre></td></tr></table></figure><h3 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h3><h4 id="a-更换设备的驱动为vfio-pci"><a href="#a-更换设备的驱动为vfio-pci" class="headerlink" title="a. 更换设备的驱动为vfio_pci"></a>a. 更换设备的驱动为vfio_pci</h4><ol><li><p>配置加载vfio-pci模块，编辑<code>/etc/modules-load.d/openstack-gpu.conf</code>，添加如下内容：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vfio_pci</span><br><span class="line">pci_stub</span><br><span class="line">vfio</span><br><span class="line">vfio_iommu_type1</span><br><span class="line">kvm</span><br><span class="line">kvm_intel</span><br></pre></td></tr></table></figure></li><li><p>配置使用vfio驱动的设备（这里的设备就是<code>lspci</code>查到的GPU设备信息），编辑<code>/etc/modprobe.d/vfio.conf</code>，添加如下配置：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">options vfio-pci ids=10de:1e30,10de:10f7,10de:1ad6,10de:1ad7</span><br></pre></td></tr></table></figure></li><li><p>重启系统，通过<code>dmesg</code>查看驱动加载情况。</p></li></ol><p><img src= "/img/loading.gif" data-lazy-src="/2022/08/22/OpenStack%E4%BD%BF%E7%94%A8%EF%BC%9AGPU%E5%8D%A1%E4%BD%BF%E7%94%A8/dmesg%E4%BF%A1%E6%81%AF.png" alt="dmesg信息"></p><ol start="4"><li>更新驱动后，GPU卡的各类设备驱动信息如下，Audio device与Serial bus的驱动变为vfio-pci。</li></ol><p><img src= "/img/loading.gif" data-lazy-src="/2022/08/22/OpenStack%E4%BD%BF%E7%94%A8%EF%BC%9AGPU%E5%8D%A1%E4%BD%BF%E7%94%A8/%E6%9B%B4%E6%8D%A2vfio%E9%A9%B1%E5%8A%A8%E5%90%8E.png" alt="更换vfio驱动后"></p><h4 id="b-更改nova配置信息"><a href="#b-更改nova配置信息" class="headerlink" title="b. 更改nova配置信息"></a>b. 更改nova配置信息</h4><ol><li><p>修改nova-api.conf，增加如下PCI信息：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 配置直通PCI信息</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 需直通的PCI Function均需配置</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 参数配置原则：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - name：名称随便定义，通常一块卡上的多个设备名称类似</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - product_id：PCI Function对应的产品id，lspci -nn命令可查看product_id，显示格式：[&lt;vendor_id&gt;: &lt;product_id&gt;]</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - vendor_id：PCI Function对应的厂商id，lspci -nn命令可查看vendor_id，显示格式：[&lt;vendor_id&gt;: &lt;product_id&gt;]</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> - device_type：设备类型，PCI设备固定为：<span class="built_in">type</span>-PCI</span></span><br><span class="line">[pci]</span><br><span class="line">alias = &#123;&quot;name&quot;:&quot;a1&quot;,&quot;product_id&quot;:&quot;1e30&quot;,&quot;vendor_id&quot;:&quot;10de&quot;,&quot;device_type&quot;:&quot;type-PCI&quot;&#125;</span><br><span class="line">alias = &#123;&quot;name&quot;:&quot;a2&quot;,&quot;product_id&quot;:&quot;10f7&quot;,&quot;vendor_id&quot;:&quot;10de&quot;,&quot;device_type&quot;:&quot;type-PCI&quot;&#125;</span><br><span class="line">alias = &#123;&quot;name&quot;:&quot;a3&quot;,&quot;product_id&quot;:&quot;1ad6&quot;,&quot;vendor_id&quot;:&quot;10de&quot;,&quot;device_type&quot;:&quot;type-PCI&quot;&#125;</span><br><span class="line">alias = &#123;&quot;name&quot;:&quot;a4&quot;,&quot;product_id&quot;:&quot;1ad7&quot;,&quot;vendor_id&quot;:&quot;10de&quot;,&quot;device_type&quot;:&quot;type-PCI&quot;&#125;</span><br></pre></td></tr></table></figure></li><li><p>修改nova-scheduler.conf文件，添加<code>PciPassthroughFilter</code>，同时添加<code>available_filters = nova.scheduler.filters.all_filters</code>，如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 启用PciPassthroughFilter过滤器</span></span></span><br><span class="line">[filter_scheduler]</span><br><span class="line">enabled_filters = RetryFilter,AvailabilityZoneFilter,ComputeFilter,ComputeCapabilitiesFilter,ImagePropertiesFilter,ServerGroupAntiAffinityFilter,ServerGroupAffinityFilter,AggregateCoreFilter,AggregateDiskFilter,DifferentHostFilter,SameHostFilter,PciPassthroughFilter</span><br><span class="line">available_filters = nova.scheduler.filters.all_filters</span><br></pre></td></tr></table></figure></li><li><p>配置计算节点，编辑nova-compute.conf文件，如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 配置直通白名单</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 所有直通的PCI Function均需要配置</span></span><br><span class="line">[pci]</span><br><span class="line">alias = &#123;&quot;name&quot;:&quot;a1&quot;,&quot;product_id&quot;:&quot;1e30&quot;,&quot;vendor_id&quot;:&quot;10de&quot;,&quot;device_type&quot;:&quot;type-PCI&quot;&#125;</span><br><span class="line">alias = &#123;&quot;name&quot;:&quot;a2&quot;,&quot;product_id&quot;:&quot;10f7&quot;,&quot;vendor_id&quot;:&quot;10de&quot;,&quot;device_type&quot;:&quot;type-PCI&quot;&#125;</span><br><span class="line">alias = &#123;&quot;name&quot;:&quot;a3&quot;,&quot;product_id&quot;:&quot;1ad6&quot;,&quot;vendor_id&quot;:&quot;10de&quot;,&quot;device_type&quot;:&quot;type-PCI&quot;&#125;</span><br><span class="line">alias = &#123;&quot;name&quot;:&quot;a4&quot;,&quot;product_id&quot;:&quot;1ad7&quot;,&quot;vendor_id&quot;:&quot;10de&quot;,&quot;device_type&quot;:&quot;type-PCI&quot;&#125;</span><br><span class="line">passthrough_whitelist = [&#123;&quot;vendor_id&quot;: &quot;10de&quot;, &quot;product_id&quot;: &quot;1e30&quot;&#125;, &#123;&quot;vendor_id&quot;: &quot;10de&quot;, &quot;product_id&quot;: &quot;10f7&quot;&#125;, &#123;&quot;vendor_id&quot;: &quot;10de&quot;, &quot;product_id&quot;: &quot;1ad6&quot;&#125;, &#123;&quot;vendor_id&quot;: &quot;10de&quot;, &quot;product_id&quot;: &quot;1ad7&quot;&#125;]</span><br></pre></td></tr></table></figure></li></ol><h4 id="c-创建GPU-Flavor"><a href="#c-创建GPU-Flavor" class="headerlink" title="c. 创建GPU Flavor"></a>c. 创建GPU Flavor</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openstack flavor create --ram 2048 --disk 20 --vcpus 2 m1.large</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">alias</span>需要指定同一个PCI卡所包含的所有<span class="keyword">function</span>设备</span></span><br><span class="line">openstack flavor set m1.large --property pci_passthrough:alias=&#x27;a1:1,a2:1,a3:1,a4:1&#x27;</span><br></pre></td></tr></table></figure><p>使用该flavor创建虚机即可。</p><h3 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h3><p>正确instacne xml内容如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br></pre></td><td class="code"><pre><span class="line">()[root@node01 /]# virsh dumpxml instance-00000008</span><br><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">type</span>=<span class="string">&#x27;kvm&#x27;</span> <span class="attr">id</span>=<span class="string">&#x27;5&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>instance-00000008<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>1f4bb25c-d665-4f03-a0f4-6857af066781<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">metadata</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">nova:instance</span> <span class="attr">xmlns:nova</span>=<span class="string">&quot;http://openstack.org/xmlns/libvirt/nova/1.0&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">nova:package</span> <span class="attr">version</span>=<span class="string">&quot;20.6.1&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">nova:name</span>&gt;</span>win10-1<span class="tag">&lt;/<span class="name">nova:name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">nova:creationTime</span>&gt;</span>2022-08-20 17:14:33<span class="tag">&lt;/<span class="name">nova:creationTime</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">nova:flavor</span> <span class="attr">name</span>=<span class="string">&quot;win10_4C8G_GPU&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nova:memory</span>&gt;</span>8192<span class="tag">&lt;/<span class="name">nova:memory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nova:disk</span>&gt;</span>100<span class="tag">&lt;/<span class="name">nova:disk</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nova:swap</span>&gt;</span>0<span class="tag">&lt;/<span class="name">nova:swap</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nova:ephemeral</span>&gt;</span>0<span class="tag">&lt;/<span class="name">nova:ephemeral</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nova:vcpus</span>&gt;</span>4<span class="tag">&lt;/<span class="name">nova:vcpus</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">nova:flavor</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">nova:owner</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nova:user</span> <span class="attr">uuid</span>=<span class="string">&quot;20f2649ce88142f19048b0aa090b78a1&quot;</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">nova:user</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">nova:project</span> <span class="attr">uuid</span>=<span class="string">&quot;a1670d65a7e644e2a78fa31a001f284b&quot;</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">nova:project</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">nova:owner</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">nova:instance</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">metadata</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>8388608<span class="tag">&lt;/<span class="name">memory</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">currentMemory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>8388608<span class="tag">&lt;/<span class="name">currentMemory</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hugepages</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">page</span> <span class="attr">size</span>=<span class="string">&#x27;1048576&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span> <span class="attr">nodeset</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">hugepages</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">memoryBacking</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">vcpu</span> <span class="attr">placement</span>=<span class="string">&#x27;static&#x27;</span>&gt;</span>4<span class="tag">&lt;/<span class="name">vcpu</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cputune</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shares</span>&gt;</span>4096<span class="tag">&lt;/<span class="name">shares</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;17-31,49-63&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;17-31,49-63&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;17-31,49-63&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vcpupin</span> <span class="attr">vcpu</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">cpuset</span>=<span class="string">&#x27;17-31,49-63&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulatorpin</span> <span class="attr">cpuset</span>=<span class="string">&#x27;17-31,49-63&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">cputune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">numatune</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memory</span> <span class="attr">mode</span>=<span class="string">&#x27;strict&#x27;</span> <span class="attr">nodeset</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memnode</span> <span class="attr">cellid</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">mode</span>=<span class="string">&#x27;strict&#x27;</span> <span class="attr">nodeset</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">numatune</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">partition</span>&gt;</span>/machine<span class="tag">&lt;/<span class="name">partition</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sysinfo</span> <span class="attr">type</span>=<span class="string">&#x27;smbios&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">system</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">entry</span> <span class="attr">name</span>=<span class="string">&#x27;manufacturer&#x27;</span>&gt;</span>OpenStack Foundation<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">entry</span> <span class="attr">name</span>=<span class="string">&#x27;product&#x27;</span>&gt;</span>OpenStack Nova<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">entry</span> <span class="attr">name</span>=<span class="string">&#x27;version&#x27;</span>&gt;</span>20.6.1<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">entry</span> <span class="attr">name</span>=<span class="string">&#x27;serial&#x27;</span>&gt;</span>1f4bb25c-d665-4f03-a0f4-6857af066781<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">entry</span> <span class="attr">name</span>=<span class="string">&#x27;uuid&#x27;</span>&gt;</span>1f4bb25c-d665-4f03-a0f4-6857af066781<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">entry</span> <span class="attr">name</span>=<span class="string">&#x27;family&#x27;</span>&gt;</span>Virtual Machine<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">system</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">sysinfo</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">os</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span> <span class="attr">arch</span>=<span class="string">&#x27;x86_64&#x27;</span> <span class="attr">machine</span>=<span class="string">&#x27;pc-i440fx-rhel7.2.0&#x27;</span>&gt;</span>hvm<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">boot</span> <span class="attr">dev</span>=<span class="string">&#x27;hd&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">smbios</span> <span class="attr">mode</span>=<span class="string">&#x27;sysinfo&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">os</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">features</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">acpi</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">apic</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">features</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;custom&#x27;</span> <span class="attr">match</span>=<span class="string">&#x27;exact&#x27;</span> <span class="attr">check</span>=<span class="string">&#x27;full&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">model</span> <span class="attr">fallback</span>=<span class="string">&#x27;forbid&#x27;</span>&gt;</span>Cascadelake-Server<span class="tag">&lt;/<span class="name">model</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">vendor</span>&gt;</span>Intel<span class="tag">&lt;/<span class="name">vendor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">topology</span> <span class="attr">sockets</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cores</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">threads</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;ss&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;vmx&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;hypervisor&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;tsc_adjust&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;avx512ifma&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;sha-ni&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;avx512vbmi&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;umip&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;pku&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;avx512vbmi2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;gfni&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;vaes&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;vpclmulqdq&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;avx512bitalg&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;avx512-vpopcntdq&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;la57&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;md-clear&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;stibp&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;arch-capabilities&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;xsaves&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;require&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;ibpb&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;disable&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;mpx&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;disable&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;arat&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">numa</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">cell</span> <span class="attr">id</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpus</span>=<span class="string">&#x27;0-3&#x27;</span> <span class="attr">memory</span>=<span class="string">&#x27;8388608&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span> <span class="attr">memAccess</span>=<span class="string">&#x27;shared&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">numa</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">cpu</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">clock</span> <span class="attr">offset</span>=<span class="string">&#x27;utc&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;pit&#x27;</span> <span class="attr">tickpolicy</span>=<span class="string">&#x27;delay&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;rtc&#x27;</span> <span class="attr">tickpolicy</span>=<span class="string">&#x27;catchup&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">timer</span> <span class="attr">name</span>=<span class="string">&#x27;hpet&#x27;</span> <span class="attr">present</span>=<span class="string">&#x27;no&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">clock</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_poweroff</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_poweroff</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_reboot</span>&gt;</span>restart<span class="tag">&lt;/<span class="name">on_reboot</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">on_crash</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_crash</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">emulator</span>&gt;</span>/usr/libexec/qemu-kvm<span class="tag">&lt;/<span class="name">emulator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;network&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;disk&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;raw&#x27;</span> <span class="attr">cache</span>=<span class="string">&#x27;writeback&#x27;</span> <span class="attr">discard</span>=<span class="string">&#x27;unmap&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">auth</span> <span class="attr">username</span>=<span class="string">&#x27;cinder&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">secret</span> <span class="attr">type</span>=<span class="string">&#x27;ceph&#x27;</span> <span class="attr">uuid</span>=<span class="string">&#x27;457eb676-33da-42ec-9a8c-9293d545c337&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">auth</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">protocol</span>=<span class="string">&#x27;rbd&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;cinder-volumes/9dc4fcd1-a258-4f5c-8f3f-9029f699b064&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">host</span> <span class="attr">name</span>=<span class="string">&#x27;10.99.22.45&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;6789&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;vda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">serial</span>&gt;</span>9dc4fcd1-a258-4f5c-8f3f-9029f699b064<span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;virtio-disk0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x0a&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;ehci&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;usb1&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x05&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;nec-xhci&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;usb2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x06&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;ehci&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;usb3&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x07&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;nec-xhci&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;usb4&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x08&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;piix3-uhci&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;usb&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x01&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;pci-root&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;pci.0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">controller</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">index</span>=<span class="string">&#x27;0&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;virtio-serial0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x09&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">controller</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;bridge&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;fa:16:3e:f1:a6:a9&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">bridge</span>=<span class="string">&#x27;br-int&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">virtualport</span> <span class="attr">type</span>=<span class="string">&#x27;openvswitch&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">parameters</span> <span class="attr">interfaceid</span>=<span class="string">&#x27;f91ebe33-a80c-4038-a2f2-e543dbe509d9&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">virtualport</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;tapf91ebe33-a8&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mtu</span> <span class="attr">size</span>=<span class="string">&#x27;1500&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;net0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x03&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">serial</span> <span class="attr">type</span>=<span class="string">&#x27;pty&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">path</span>=<span class="string">&#x27;/dev/pts/5&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">log</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/nova/instances/1f4bb25c-d665-4f03-a0f4-6857af066781/console.log&#x27;</span> <span class="attr">append</span>=<span class="string">&#x27;off&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;isa-serial&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">model</span> <span class="attr">name</span>=<span class="string">&#x27;isa-serial&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;serial0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">console</span> <span class="attr">type</span>=<span class="string">&#x27;pty&#x27;</span> <span class="attr">tty</span>=<span class="string">&#x27;/dev/pts/5&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">path</span>=<span class="string">&#x27;/dev/pts/5&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">log</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/nova/instances/1f4bb25c-d665-4f03-a0f4-6857af066781/console.log&#x27;</span> <span class="attr">append</span>=<span class="string">&#x27;off&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;serial&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;serial0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">console</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">channel</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;com.redhat.spice.0&#x27;</span> <span class="attr">state</span>=<span class="string">&#x27;disconnected&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;channel0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">channel</span> <span class="attr">type</span>=<span class="string">&#x27;unix&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">mode</span>=<span class="string">&#x27;bind&#x27;</span> <span class="attr">path</span>=<span class="string">&#x27;/var/lib/libvirt/qemu/org.qemu.guest_agent.0.instance-00000008.sock&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;org.qemu.guest_agent.0&#x27;</span> <span class="attr">state</span>=<span class="string">&#x27;disconnected&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;channel1&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;mouse&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ps2&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;input0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;keyboard&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;ps2&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;input1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">input</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">graphics</span> <span class="attr">type</span>=<span class="string">&#x27;spice&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;5903&#x27;</span> <span class="attr">autoport</span>=<span class="string">&#x27;yes&#x27;</span> <span class="attr">listen</span>=<span class="string">&#x27;0.0.0.0&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">listen</span> <span class="attr">type</span>=<span class="string">&#x27;address&#x27;</span> <span class="attr">address</span>=<span class="string">&#x27;0.0.0.0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">graphics</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sound</span> <span class="attr">model</span>=<span class="string">&#x27;ac97&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;sound0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x04&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">sound</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">video</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;qxl&#x27;</span> <span class="attr">ram</span>=<span class="string">&#x27;65536&#x27;</span> <span class="attr">vram</span>=<span class="string">&#x27;65536&#x27;</span> <span class="attr">vgamem</span>=<span class="string">&#x27;32768&#x27;</span> <span class="attr">heads</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">primary</span>=<span class="string">&#x27;yes&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;video0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x02&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hostdev</span> <span class="attr">mode</span>=<span class="string">&#x27;subsystem&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;vfio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">address</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0xb1&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;hostdev0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x0b&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">hostdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hostdev</span> <span class="attr">mode</span>=<span class="string">&#x27;subsystem&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;vfio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">address</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0xb1&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;hostdev1&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x0c&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">hostdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hostdev</span> <span class="attr">mode</span>=<span class="string">&#x27;subsystem&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;vfio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">address</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0xb1&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;hostdev2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x0d&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">hostdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hostdev</span> <span class="attr">mode</span>=<span class="string">&#x27;subsystem&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">managed</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;vfio&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">address</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0xb1&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x3&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;hostdev3&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x0e&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">hostdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;redir0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;redir1&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;redir2&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;redir3&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;redir4&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;redir5&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;3&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;4&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;redir6&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;3&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redirdev</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;redir7&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;usb&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;4&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">redirdev</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memballoon</span> <span class="attr">model</span>=<span class="string">&#x27;virtio&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">stats</span> <span class="attr">period</span>=<span class="string">&#x27;10&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;balloon0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x0f&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">memballoon</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">seclabel</span> <span class="attr">type</span>=<span class="string">&#x27;dynamic&#x27;</span> <span class="attr">model</span>=<span class="string">&#x27;dac&#x27;</span> <span class="attr">relabel</span>=<span class="string">&#x27;yes&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>+0:+0<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">imagelabel</span>&gt;</span>+0:+0<span class="tag">&lt;/<span class="name">imagelabel</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">seclabel</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://copyfuture.com/blogs-details/20211209084308795f">openstack虚拟机透传GPU设备</a></li><li><a href="https://doowzs.com/posts/2021/04/rtx-vfio-passthrough/">Nvidia RTX显卡虚拟机直通指南</a></li><li><a href="https://www.cnblogs.com/weiwei2021/p/14307896.html">openstack ussuri PCI-passthrough集成GPU</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;含有多个设备的GPU&quot;&gt;&lt;a href=&quot;#含有多个设备的GPU&quot; class=&quot;headerlink&quot; title=&quot;含有多个设备的GPU&quot;&gt;&lt;/a&gt;含有多个设备的GPU&lt;/h2&gt;&lt;p&gt;常见型号：Quadro RTX 6000/8000&lt;/p&gt;
&lt;h3 id=&quot;</summary>
      
    
    
    
    <category term="OpenStack" scheme="https://renyb2.github.io/categories/OpenStack/"/>
    
    
    <category term="OpenStack" scheme="https://renyb2.github.io/tags/OpenStack/"/>
    
  </entry>
  
  <entry>
    <title>NVIDIA使用：虚机游戏性能</title>
    <link href="https://renyb2.github.io/2022/07/18/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9A%E8%99%9A%E6%9C%BA%E6%B8%B8%E6%88%8F%E6%80%A7%E8%83%BD/"/>
    <id>https://renyb2.github.io/2022/07/18/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9A%E8%99%9A%E6%9C%BA%E6%B8%B8%E6%88%8F%E6%80%A7%E8%83%BD/</id>
    <published>2022-07-18T06:24:37.000Z</published>
    <updated>2022-11-24T02:07:36.994Z</updated>
    
    <content type="html"><![CDATA[<h2 id="环境信息"><a href="#环境信息" class="headerlink" title="环境信息"></a>环境信息</h2><ul><li><strong>服务器：</strong>NE5260M5</li><li><strong>CPU型号：</strong>Intel(R) Xeon(R) Silver 4210 CPU @ 2.20GHz</li><li><strong>GPU型号：</strong>vGPU GRID T4-4Q（显存4G）</li><li><strong>虚机配置：</strong>绑核大页 8C16G，数据盘100G，系统盘200G</li><li><strong>游戏：</strong>英雄联盟，画质中等</li></ul><h2 id="部署问题"><a href="#部署问题" class="headerlink" title="部署问题"></a>部署问题</h2><h3 id="Windows虚机核数未完全被使用"><a href="#Windows虚机核数未完全被使用" class="headerlink" title="Windows虚机核数未完全被使用"></a>Windows虚机核数未完全被使用</h3><p>未配置CPU拓扑信息的虚机，CPU拓扑关系如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;host-passthrough&#x27;</span> <span class="attr">check</span>=<span class="string">&#x27;none&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">topology</span> <span class="attr">sockets</span>=<span class="string">&#x27;8&#x27;</span> <span class="attr">cores</span>=<span class="string">&#x27;1&#x27;</span> <span class="attr">threads</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">numa</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cell</span> <span class="attr">id</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpus</span>=<span class="string">&#x27;0-7&#x27;</span> <span class="attr">memory</span>=<span class="string">&#x27;16777216&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span> <span class="attr">memAccess</span>=<span class="string">&#x27;shared&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">numa</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cpu</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>CPU线程数 = Sockets * Cores * Threads</strong></p><p>由于win10系统socket最大只能使用2核，即最大只能到<code>sockets=&#39;2&#39;</code>，其余需分配给<code>cores</code>与<code>threads</code>。即需配置如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;host-passthrough&#x27;</span> <span class="attr">check</span>=<span class="string">&#x27;none&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">topology</span> <span class="attr">sockets</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cores</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">threads</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;disable&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;hypervisor&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">numa</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cell</span> <span class="attr">id</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpus</span>=<span class="string">&#x27;0-7&#x27;</span> <span class="attr">memory</span>=<span class="string">&#x27;16777216&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span> <span class="attr">memAccess</span>=<span class="string">&#x27;shared&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">numa</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cpu</span>&gt;</span></span><br></pre></td></tr></table></figure><p>对应的OpenStack Flavor元数据信息如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 设置vm的cpu toplogy。 max <span class="built_in">limit</span>类型的设置也可以通过image 属性来设置.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> nova flavor-key FLAVOR-NAME <span class="built_in">set</span> hw:cpu_sockets=FLAVOR-SOCKETS</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> nova flavor-key FLAVOR-NAME <span class="built_in">set</span> hw:cpu_cores=FLAVOR-CORES</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> nova flavor-key FLAVOR-NAME <span class="built_in">set</span> hw:cpu_threads=FLAVOR-THREADS</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> nova flavor-key FLAVOR-NAME <span class="built_in">set</span> hw:cpu_max_sockets=FLAVOR-SOCKETS</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> nova flavor-key FLAVOR-NAME <span class="built_in">set</span> hw:cpu_max_cores=FLAVOR-CORES</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> nova flavor-key FLAVOR-NAME <span class="built_in">set</span> hw:cpu_max_threads=FLAVOR-THREADS</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> FLAVOR-NAME    模板的名称</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sockets x cores x threads = 总vcpu数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sockets    <span class="comment"># 标识cpu的插槽数，根据操作系统能支持的主板cpu数量来填</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cores      <span class="comment"># cpu的核心数</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> threads    <span class="comment"># 线程</span></span></span><br></pre></td></tr></table></figure><h3 id="游戏检测运行环境为虚机"><a href="#游戏检测运行环境为虚机" class="headerlink" title="游戏检测运行环境为虚机"></a>游戏检测运行环境为虚机</h3><img src= "/img/loading.gif" data-lazy-src="/2022/07/18/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9A%E8%99%9A%E6%9C%BA%E6%B8%B8%E6%88%8F%E6%80%A7%E8%83%BD/游戏虚机环境检测.png" alt="cluster-diagram1" style="zoom:100%;"><p>该问题，需要禁用掉虚机内的虚拟化特性，具体xml代码段如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- in &lt;features&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">kvm</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">hidden</span> <span class="attr">state</span>=<span class="string">&#x27;on&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">kvm</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- in &lt;cpu&gt; --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;disable&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;hypervisor&#x27;</span>/&gt;</span></span><br></pre></td></tr></table></figure><p>参考范例如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">features</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">acpi</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">apic</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">kvm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hidden</span> <span class="attr">state</span>=<span class="string">&#x27;on&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">kvm</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">features</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">&#x27;host-passthrough&#x27;</span> <span class="attr">check</span>=<span class="string">&#x27;none&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">topology</span> <span class="attr">sockets</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">cores</span>=<span class="string">&#x27;2&#x27;</span> <span class="attr">threads</span>=<span class="string">&#x27;2&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">feature</span> <span class="attr">policy</span>=<span class="string">&#x27;disable&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;hypervisor&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">numa</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cell</span> <span class="attr">id</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">cpus</span>=<span class="string">&#x27;0-7&#x27;</span> <span class="attr">memory</span>=<span class="string">&#x27;33554432&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span> <span class="attr">memAccess</span>=<span class="string">&#x27;shared&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">numa</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cpu</span>&gt;</span></span><br></pre></td></tr></table></figure><p>对应的OpenStack Image元数据信息如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openstack image create --disk-format qcow2 --file cirros.qcow2 --property img_hide_hypervisor_id=true game-cirros</span><br></pre></td></tr></table></figure><h3 id="游戏无法初始化图形设备"><a href="#游戏无法初始化图形设备" class="headerlink" title="游戏无法初始化图形设备"></a>游戏无法初始化图形设备</h3><img src= "/img/loading.gif" data-lazy-src="/2022/07/18/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9A%E8%99%9A%E6%9C%BA%E6%B8%B8%E6%88%8F%E6%80%A7%E8%83%BD/无法初始化图形设备.jpg" alt="cluster-diagram1" style="zoom:100%;"><p>windows+R键，输入<code>dxdiag</code>，运行DirectX诊断工具，发现视频加速功能未启动。</p><img src= "/img/loading.gif" data-lazy-src="/2022/07/18/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9A%E8%99%9A%E6%9C%BA%E6%B8%B8%E6%88%8F%E6%80%A7%E8%83%BD/dxdiag未启用视频加速.png" alt="cluster-diagram1" style="zoom:100%;"><p>桌面右键，点击<code>NVIDIA控制面板</code>，查看当前能力，发现如下图：</p><img src= "/img/loading.gif" data-lazy-src="/2022/07/18/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9A%E8%99%9A%E6%9C%BA%E6%B8%B8%E6%88%8F%E6%80%A7%E8%83%BD/未启用视频加速.png" alt="cluster-diagram1" style="zoom:100%;"><p>出现该问题的原因在于，<strong>微软默认的<code>mstsc</code>无法调用GPU硬件，需要使用专业工具如：向日葵等软件</strong>，即可正常调用GPU。效果图如下：</p><img src= "/img/loading.gif" data-lazy-src="/2022/07/18/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9A%E8%99%9A%E6%9C%BA%E6%B8%B8%E6%88%8F%E6%80%A7%E8%83%BD/dxdiag启用视频加速.png" alt="cluster-diagram1" style="zoom:100%;"><img src= "/img/loading.gif" data-lazy-src="/2022/07/18/NVIDIA%E4%BD%BF%E7%94%A8%EF%BC%9A%E8%99%9A%E6%9C%BA%E6%B8%B8%E6%88%8F%E6%80%A7%E8%83%BD/启用视频加速.png" alt="cluster-diagram1" style="zoom:100%;"><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://www.gzhttp.com/zhishi/cpu_841_0.html#:~:text=Intel%20%E8%87%B3%E5%BC%BA%20Silver%204210R%E7%9A%84%E5%8F%82%E6%95%B0%E5%A6%82%E4%B8%8B%EF%BC%8C%E5%9F%BA%E7%A1%80%E5%8F%82%E6%95%B0%E6%96%B9%E9%9D%A2Intel%20%E8%87%B3%E5%BC%BA%20Silver%204210R%E7%9A%84%E4%B8%BB%E9%A2%91%E4%B8%BA2.40,GHz%EF%BC%8C%E6%A0%B8%E5%BF%83%E7%BA%BF%E7%A8%8B%E6%96%B9%E9%9D%A2%EF%BC%8C%E8%BF%99%E6%98%AF%E4%B8%80%E6%AC%BE10%20%E6%A0%B820%20%E7%BA%BF%E7%A8%8BCPU%EF%BC%8C%E5%8D%95%E6%A0%B8%E7%9D%BF%E9%A2%91%E8%BE%BE%E5%88%B03.20%20GHz%EF%BC%8C%E8%BF%99%E6%AC%BECPU%E9%87%87%E7%94%A8%E7%9A%84%E6%98%AFCascade%20Lake%E6%9E%B6%E6%9E%84%EF%BC%8C%E4%BD%BF%E7%94%A8%E4%BA%8614%20nm%E7%9A%84%E5%B7%A5%E8%89%BA%EF%BC%8C%E5%86%85%E5%AD%98%E5%8F%82%E6%95%B0%E6%96%B9%E9%9D%A2CPU%E6%9C%80%E5%A4%A7%E5%8F%AF%E4%BB%A5%E6%8F%92%E5%85%A51024%20GB%E7%9A%84%E5%86%85%E5%AD%98%EF%BC%8CECC%E5%8D%B3%E6%98%AF%E5%86%85%E5%AD%98%E7%BA%A0%E9%94%99%E6%8A%80%E6%9C%AF%EF%BC%8C%E8%BF%99%E6%AC%BECPU%E6%98%AF%E6%94%AF%E6%8C%81%E7%9A%84%EF%BC%8C">Intel 至强 Silver 4210R能玩什么游戏，可以打游戏吗</a></li><li><a href="https://knowledge.civilgeo.com/knowledge-base/enabling-gpu-rendering-for-microsoft-remote-desktop/">Enabling GPU Rendering for Microsoft Remote Desktop</a></li><li><a href="https://superuser.com/questions/1387935/hiding-virtual-machine-status-from-guest-operating-system">Hiding Virtual machine status from guest operating system</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;环境信息&quot;&gt;&lt;a href=&quot;#环境信息&quot; class=&quot;headerlink&quot; title=&quot;环境信息&quot;&gt;&lt;/a&gt;环境信息&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;服务器：&lt;/strong&gt;NE5260M5&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;CPU型号：&lt;/s</summary>
      
    
    
    
    <category term="Accelerator" scheme="https://renyb2.github.io/categories/Accelerator/"/>
    
    
    <category term="NVIDIA" scheme="https://renyb2.github.io/tags/NVIDIA/"/>
    
    <category term="Accelerator" scheme="https://renyb2.github.io/tags/Accelerator/"/>
    
  </entry>
  
  <entry>
    <title>Linux配置：硬件管理</title>
    <link href="https://renyb2.github.io/2022/07/14/Linux%E9%85%8D%E7%BD%AE%EF%BC%9A%E7%A1%AC%E4%BB%B6%E7%AE%A1%E7%90%86/"/>
    <id>https://renyb2.github.io/2022/07/14/Linux%E9%85%8D%E7%BD%AE%EF%BC%9A%E7%A1%AC%E4%BB%B6%E7%AE%A1%E7%90%86/</id>
    <published>2022-07-14T09:01:20.000Z</published>
    <updated>2022-12-02T06:45:04.187Z</updated>
    
    <content type="html"><![CDATA[<h2 id="IPMI管理"><a href="#IPMI管理" class="headerlink" title="IPMI管理"></a>IPMI管理</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看ipmi信息</span></span><br><span class="line">[root@k205 ~]# ipmitool lan print 1</span><br><span class="line">Set in Progress         : Set Complete</span><br><span class="line">Auth Type Support       : MD5</span><br><span class="line">Auth Type Enable        : Callback : MD5</span><br><span class="line">                        : User     : MD5</span><br><span class="line">                        : Operator : MD5</span><br><span class="line">                        : Admin    : MD5</span><br><span class="line">                        : OEM      : MD5</span><br><span class="line">IP Address Source       : Static Address</span><br><span class="line">IP Address              : 111.111.50.14</span><br><span class="line">Subnet Mask             : 255.255.255.0</span><br><span class="line">MAC Address             : 6c:92:bf:da:18:d8</span><br><span class="line">SNMP Community String   : AMI</span><br><span class="line">IP Header               : TTL=0x40 Flags=0x40 Precedence=0x00 TOS=0x10</span><br><span class="line">BMC ARP Control         : ARP Responses Enabled, Gratuitous ARP Disabled</span><br><span class="line">Gratituous ARP Intrvl   : 0.0 seconds</span><br><span class="line">Default Gateway IP      : 111.111.50.1</span><br><span class="line">Default Gateway MAC     : 7c:1e:06:27:f3:eb</span><br><span class="line">Backup Gateway IP       : 0.0.0.0</span><br><span class="line">Backup Gateway MAC      : 00:00:00:00:00:00</span><br><span class="line">802.1q VLAN ID          : Disabled</span><br><span class="line">802.1q VLAN Priority    : 0</span><br><span class="line">RMCP+ Cipher Suites     : 0,1,2,3,6,7,8,11,12,15,16,17</span><br><span class="line">Cipher Suite Priv Max   : caaaaaaaaaaaXXX</span><br><span class="line">                        :     X=Cipher Suite Unused</span><br><span class="line">                        :     c=CALLBACK</span><br><span class="line">                        :     u=USER</span><br><span class="line">                        :     o=OPERATOR</span><br><span class="line">                        :     a=ADMIN</span><br><span class="line">                        :     O=OEM</span><br><span class="line">Bad Password Threshold  : 3</span><br><span class="line">Invalid password disable: no</span><br><span class="line">Attempt Count Reset Int.: 200</span><br><span class="line">User Lockout Interval   : 300</span><br></pre></td></tr></table></figure><h2 id="硬件管理"><a href="#硬件管理" class="headerlink" title="硬件管理"></a>硬件管理</h2><h3 id="全部信息"><a href="#全部信息" class="headerlink" title="全部信息"></a>全部信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看所有硬件信息</span></span><br><span class="line">[root@k104 ~]# dmidecode</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 硬件基础信息目录</span></span><br><span class="line">[root@k104 ~]# ls /sys/devices/virtual/dmi/id/</span><br><span class="line">bios_date     board_asset_tag  board_vendor       chassis_serial  chassis_version  product_name    product_version  uevent</span><br><span class="line">bios_vendor   board_name       board_version      chassis_type    modalias         product_serial  subsystem</span><br><span class="line">bios_version  board_serial     chassis_asset_tag  chassis_vendor  power            product_uuid    sys_vendor</span><br></pre></td></tr></table></figure><p>自动获取脚本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">DMI=/sys/devices/virtual/dmi/id</span><br><span class="line"></span><br><span class="line">cd $DMI</span><br><span class="line">for i in $(ls $DMI); do</span><br><span class="line">    if [[ -f $DMI/$i ]]; then</span><br><span class="line">        echo -e &quot;$i:\t\t$(cat $DMI/$i)&quot;</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="处理器信息"><a href="#处理器信息" class="headerlink" title="处理器信息"></a>处理器信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看处理器硬件信息</span></span><br><span class="line">[root@k104 ~]# dmidecode --type processor</span><br><span class="line"><span class="meta">#</span><span class="bash"> dmidecode 3.2</span></span><br><span class="line">Getting SMBIOS data from sysfs.</span><br><span class="line">SMBIOS 3.2 present.</span><br><span class="line"></span><br><span class="line">Handle 0x0091, DMI type 4, 48 bytes</span><br><span class="line">Processor Information</span><br><span class="line">        Socket Designation: CPU0</span><br><span class="line">        Type: Central Processor</span><br><span class="line">        Family: Xeon</span><br><span class="line">        Manufacturer: Intel(R) Corporation</span><br><span class="line">        ID: 57 06 05 00 FF FB EB BF</span><br><span class="line">        Signature: Type 0, Family 6, Model 85, Stepping 7</span><br><span class="line">        Flags:</span><br><span class="line">                FPU (Floating-point unit on-chip)</span><br><span class="line">                VME (Virtual mode extension)</span><br><span class="line">                DE (Debugging extension)</span><br><span class="line">                PSE (Page size extension)</span><br><span class="line">                TSC (Time stamp counter)</span><br><span class="line">                MSR (Model specific registers)</span><br><span class="line">                PAE (Physical address extension)</span><br><span class="line">                MCE (Machine check exception)</span><br><span class="line">                CX8 (CMPXCHG8 instruction supported)</span><br><span class="line">                APIC (On-chip APIC hardware supported)</span><br><span class="line">                SEP (Fast system call)</span><br><span class="line">                MTRR (Memory type range registers)</span><br><span class="line">                PGE (Page global enable)</span><br><span class="line">                MCA (Machine check architecture)</span><br><span class="line">                CMOV (Conditional move instruction supported)</span><br><span class="line">                PAT (Page attribute table)</span><br><span class="line">                PSE-36 (36-bit page size extension)</span><br><span class="line">                CLFSH (CLFLUSH instruction supported)</span><br><span class="line">                DS (Debug store)</span><br><span class="line">                ACPI (ACPI supported)</span><br><span class="line">                MMX (MMX technology supported)</span><br><span class="line">                FXSR (FXSAVE and FXSTOR instructions supported)</span><br><span class="line">                SSE (Streaming SIMD extensions)</span><br><span class="line">                SSE2 (Streaming SIMD extensions 2)</span><br><span class="line">                SS (Self-snoop)</span><br><span class="line">                HTT (Multi-threading)</span><br><span class="line">                TM (Thermal monitor supported)</span><br><span class="line">                PBE (Pending break enabled)</span><br><span class="line">        Version: Intel(R) Xeon(R) Silver 4210 CPU @ 2.20GHz</span><br><span class="line">        Voltage: 1.6 V</span><br><span class="line">        External Clock: 100 MHz</span><br><span class="line">        Max Speed: 3200 MHz</span><br><span class="line">        Current Speed: 2200 MHz</span><br><span class="line">        Status: Populated, Enabled</span><br><span class="line">        Upgrade: Socket LGA3647-1</span><br><span class="line">        L1 Cache Handle: 0x008E</span><br><span class="line">        L2 Cache Handle: 0x008F</span><br><span class="line">        L3 Cache Handle: 0x0090</span><br><span class="line">        Serial Number: Not Specified</span><br><span class="line">        Asset Tag: UNKNOWN</span><br><span class="line">        Part Number: Not Specified</span><br><span class="line">        Core Count: 10</span><br><span class="line">        Core Enabled: 10</span><br><span class="line">        Thread Count: 10</span><br><span class="line">        Characteristics:</span><br><span class="line">                64-bit capable</span><br><span class="line">                Multi-Core</span><br><span class="line">                Hardware Thread</span><br><span class="line">                Execute Protection</span><br><span class="line">                Enhanced Virtualization</span><br><span class="line">                Power/Performance Control</span><br><span class="line"></span><br><span class="line">Handle 0x0095, DMI type 4, 48 bytes</span><br><span class="line">Processor Information</span><br><span class="line">        Socket Designation: CPU1</span><br><span class="line">        Type: Central Processor</span><br><span class="line">        Family: Xeon</span><br><span class="line">        Manufacturer: Intel(R) Corporation</span><br><span class="line">        ID: 57 06 05 00 FF FB EB BF</span><br><span class="line">        Signature: Type 0, Family 6, Model 85, Stepping 7</span><br><span class="line">        Flags:</span><br><span class="line">                FPU (Floating-point unit on-chip)</span><br><span class="line">                VME (Virtual mode extension)</span><br><span class="line">                DE (Debugging extension)</span><br><span class="line">                PSE (Page size extension)</span><br><span class="line">                TSC (Time stamp counter)</span><br><span class="line">                MSR (Model specific registers)</span><br><span class="line">                PAE (Physical address extension)</span><br><span class="line">                MCE (Machine check exception)</span><br><span class="line">                CX8 (CMPXCHG8 instruction supported)</span><br><span class="line">                APIC (On-chip APIC hardware supported)</span><br><span class="line">                SEP (Fast system call)</span><br><span class="line">                MTRR (Memory type range registers)</span><br><span class="line">                PGE (Page global enable)</span><br><span class="line">                MCA (Machine check architecture)</span><br><span class="line">                CMOV (Conditional move instruction supported)</span><br><span class="line">                PAT (Page attribute table)</span><br><span class="line">                PSE-36 (36-bit page size extension)</span><br><span class="line">                CLFSH (CLFLUSH instruction supported)</span><br><span class="line">                DS (Debug store)</span><br><span class="line">                ACPI (ACPI supported)</span><br><span class="line">                MMX (MMX technology supported)</span><br><span class="line">                FXSR (FXSAVE and FXSTOR instructions supported)</span><br><span class="line">                SSE (Streaming SIMD extensions)</span><br><span class="line">                SSE2 (Streaming SIMD extensions 2)</span><br><span class="line">                SS (Self-snoop)</span><br><span class="line">                HTT (Multi-threading)</span><br><span class="line">                TM (Thermal monitor supported)</span><br><span class="line">                PBE (Pending break enabled)</span><br><span class="line">        Version: Intel(R) Xeon(R) Silver 4210 CPU @ 2.20GHz</span><br><span class="line">        Voltage: 1.6 V</span><br><span class="line">        External Clock: 100 MHz</span><br><span class="line">        Max Speed: 3200 MHz</span><br><span class="line">        Current Speed: 2200 MHz</span><br><span class="line">        Status: Populated, Enabled</span><br><span class="line">        Upgrade: Socket LGA3647-1</span><br><span class="line">        L1 Cache Handle: 0x0092</span><br><span class="line">        L2 Cache Handle: 0x0093</span><br><span class="line">        L3 Cache Handle: 0x0094</span><br><span class="line">        Serial Number: Not Specified</span><br><span class="line">        Asset Tag: UNKNOWN</span><br><span class="line">        Part Number: Not Specified</span><br><span class="line">        Core Count: 10</span><br><span class="line">        Core Enabled: 10</span><br><span class="line">        Thread Count: 10</span><br><span class="line">        Characteristics:</span><br><span class="line">                64-bit capable</span><br><span class="line">                Multi-Core</span><br><span class="line">                Hardware Thread</span><br><span class="line">                Execute Protection</span><br><span class="line">                Enhanced Virtualization</span><br><span class="line">                Power/Performance Control</span><br></pre></td></tr></table></figure><h3 id="内存信息"><a href="#内存信息" class="headerlink" title="内存信息"></a>内存信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看内存硬件信息</span></span><br><span class="line">[root@k104 ~]# dmidecode --type memory</span><br><span class="line"><span class="meta">#</span><span class="bash"> dmidecode 3.2</span></span><br><span class="line">Getting SMBIOS data from sysfs.</span><br><span class="line">SMBIOS 3.2 present.</span><br><span class="line"></span><br><span class="line">Handle 0x0049, DMI type 16, 23 bytes</span><br><span class="line">Physical Memory Array</span><br><span class="line">        Location: System Board Or Motherboard</span><br><span class="line">        Use: System Memory</span><br><span class="line">        Error Correction Type: Single-bit ECC</span><br><span class="line">        Maximum Capacity: 4 TB</span><br><span class="line">        Error Information Handle: Not Provided</span><br><span class="line">        Number Of Devices: 24</span><br><span class="line"></span><br><span class="line">Handle 0x004A, DMI type 17, 40 bytes</span><br><span class="line">Memory Device</span><br><span class="line">        Array Handle: 0x0049</span><br><span class="line">        Error Information Handle: Not Provided</span><br><span class="line">        Total Width: 72 bits</span><br><span class="line">        Data Width: 64 bits</span><br><span class="line">        Size: 32 GB</span><br><span class="line">        Form Factor: DIMM</span><br><span class="line">        Set: None</span><br><span class="line">        Locator: CPU0_C0D0</span><br><span class="line">        Bank Locator: NODE 1</span><br><span class="line">        Type: DDR4</span><br><span class="line">        Type Detail: Synchronous</span><br><span class="line">        Speed: 2933 MT/s</span><br><span class="line">        Manufacturer: Hynix</span><br><span class="line">        Serial Number: 2FBC39EB</span><br><span class="line">        Asset Tag: CPU1_DIMM_A1_AssetTag</span><br><span class="line">        Part Number: HMA84GR7JJR4N-WM</span><br><span class="line">        Rank: 2</span><br><span class="line">        Configured Memory Speed: 2400 MT/s</span><br><span class="line">        Minimum Voltage: 1.2 V</span><br><span class="line">        Maximum Voltage: 1.2 V</span><br><span class="line">        Configured Voltage: 1.2 V</span><br><span class="line"></span><br><span class="line">Handle 0x004B, DMI type 17, 40 bytes</span><br><span class="line">Memory Device</span><br><span class="line">        Array Handle: 0x0049</span><br><span class="line">        Error Information Handle: Not Provided</span><br><span class="line">        Total Width: Unknown</span><br><span class="line">        Data Width: Unknown</span><br><span class="line">        Size: No Module Installed</span><br><span class="line">        Form Factor: Unknown</span><br><span class="line">        Set: None</span><br><span class="line">        Locator: CPU0_C0D1</span><br><span class="line">        Bank Locator: NODE 1</span><br><span class="line">        Type: Unknown</span><br><span class="line">        Type Detail: Unknown</span><br><span class="line">        Speed: Unknown</span><br><span class="line">        Manufacturer: NO DIMM</span><br><span class="line">        Serial Number: NO DIMM</span><br><span class="line">        Asset Tag: NO DIMM</span><br><span class="line">        Part Number: NO DIMM</span><br><span class="line">        Rank: Unknown</span><br><span class="line">        Configured Memory Speed: Unknown</span><br><span class="line">        Minimum Voltage: 1.2 V</span><br><span class="line">        Maximum Voltage: 1.2 V</span><br><span class="line">        Configured Voltage: 1.2 V</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="序列号"><a href="#序列号" class="headerlink" title="序列号"></a>序列号</h3><h4 id="产品序列号"><a href="#产品序列号" class="headerlink" title="产品序列号"></a>产品序列号</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k104 ~]# cat /sys/devices/virtual/dmi/id/product_serial</span><br><span class="line">220970081</span><br></pre></td></tr></table></figure><h4 id="主板序列号"><a href="#主板序列号" class="headerlink" title="主板序列号"></a>主板序列号</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k104 ~]# cat /sys/devices/virtual/dmi/id/board_serial</span><br><span class="line">MBL828S20171A50</span><br></pre></td></tr></table></figure><h4 id="硬盘序列号"><a href="#硬盘序列号" class="headerlink" title="硬盘序列号"></a>硬盘序列号</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@k104 ~]# lsblk -dno serial /dev/sda</span><br><span class="line">2665c9e900d00000</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;IPMI管理&quot;&gt;&lt;a href=&quot;#IPMI管理&quot; class=&quot;headerlink&quot; title=&quot;IPMI管理&quot;&gt;&lt;/a&gt;IPMI管理&lt;/h2&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gut</summary>
      
    
    
    
    <category term="Linux" scheme="https://renyb2.github.io/categories/Linux/"/>
    
    
    <category term="Linux" scheme="https://renyb2.github.io/tags/Linux/"/>
    
    <category term="硬件" scheme="https://renyb2.github.io/tags/%E7%A1%AC%E4%BB%B6/"/>
    
  </entry>
  
  <entry>
    <title>Linux配置：CPU管理</title>
    <link href="https://renyb2.github.io/2022/07/11/Linux%E9%85%8D%E7%BD%AE%EF%BC%9ACPU%E7%AE%A1%E7%90%86/"/>
    <id>https://renyb2.github.io/2022/07/11/Linux%E9%85%8D%E7%BD%AE%EF%BC%9ACPU%E7%AE%A1%E7%90%86/</id>
    <published>2022-07-11T07:56:52.000Z</published>
    <updated>2022-11-24T02:07:36.993Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Generic-Scaling-Governors"><a href="#Generic-Scaling-Governors" class="headerlink" title="Generic Scaling Governors"></a>Generic Scaling Governors</h2><p><code>CPUFreq</code> provides generic scaling governors that can be used with all scaling drivers. As stated before, each of them implements a single, possibly parametrized, performance scaling algorithm.</p><p>Scaling governors are attached to policy objects and different policy objects can be handled by different scaling governors at the same time (although that may lead to suboptimal results in some cases).</p><p>The scaling governor for a given policy object can be changed at any time with the help of the <code>scaling_governor</code> policy attribute in <code>sysfs</code>.</p><p>Some governors expose <code>sysfs</code> attributes to control or fine-tune the scaling algorithms implemented by them. Those attributes, referred to as governor tunables, can be either global (system-wide) or per-policy, depending on the scaling driver in use. If the driver requires governor tunables to be per-policy, they are located in a subdirectory of each policy directory. Otherwise, they are located in a subdirectory under <code>/sys/devices/system/cpu/cpufreq/</code>. In either case the name of the subdirectory containing the governor tunables is the name of the governor providing them.</p><h3 id="performance"><a href="#performance" class="headerlink" title="performance"></a><code>performance</code></h3><p>When attached to a policy object, this governor causes the highest frequency, within the <code>scaling_max_freq</code> policy limit, to be requested for that policy.</p><p>The request is made once at that time the governor for the policy is set to <code>performance</code> and whenever the <code>scaling_max_freq</code> or <code>scaling_min_freq</code> policy limits change after that.</p><h3 id="powersave"><a href="#powersave" class="headerlink" title="powersave"></a><code>powersave</code></h3><p>When attached to a policy object, this governor causes the lowest frequency, within the <code>scaling_min_freq</code> policy limit, to be requested for that policy.</p><p>The request is made once at that time the governor for the policy is set to <code>powersave</code> and whenever the <code>scaling_max_freq</code> or <code>scaling_min_freq</code> policy limits change after that.</p><h3 id="userspace"><a href="#userspace" class="headerlink" title="userspace"></a><code>userspace</code></h3><p>This governor does not do anything by itself. Instead, it allows user space to set the CPU frequency for the policy it is attached to by writing to the <code>scaling_setspeed</code> attribute of that policy.</p><h3 id="schedutil"><a href="#schedutil" class="headerlink" title="schedutil"></a><code>schedutil</code></h3><p>This governor uses CPU utilization data available from the CPU scheduler. It generally is regarded as a part of the CPU scheduler, so it can access the scheduler’s internal data structures directly.</p><p>It runs entirely in scheduler context, although in some cases it may need to invoke the scaling driver asynchronously when it decides that the CPU frequency should be changed for a given policy (that depends on whether or not the driver is capable of changing the CPU frequency from scheduler context).</p><p>The actions of this governor for a particular CPU depend on the scheduling class invoking its utilization update callback for that CPU. If it is invoked by the RT or deadline scheduling classes, the governor will increase the frequency to the allowed maximum (that is, the <code>scaling_max_freq</code> policy limit). In turn, if it is invoked by the CFS scheduling class, the governor will use the Per-Entity Load Tracking (PELT) metric for the root control group of the given CPU as the CPU utilization estimate (see the <a href="https://lwn.net/Articles/531853/">Per-entity load tracking</a> LWN.net article for a description of the PELT mechanism). Then, the new CPU frequency to apply is computed in accordance with the formula</p><blockquote><p>f = 1.25 * <code>f_0</code> * <code>util</code> / <code>max</code></p></blockquote><p>where <code>util</code> is the PELT number, <code>max</code> is the theoretical maximum of <code>util</code>, and <code>f_0</code> is either the maximum possible CPU frequency for the given policy (if the PELT number is frequency-invariant), or the current CPU frequency (otherwise).</p><p>This governor also employs a mechanism allowing it to temporarily bump up the CPU frequency for tasks that have been waiting on I/O most recently, called “IO-wait boosting”. That happens when the <code>SCHED_CPUFREQ_IOWAIT</code> flag is passed by the scheduler to the governor callback which causes the frequency to go up to the allowed maximum immediately and then draw back to the value returned by the above formula over time.</p><p>This governor exposes only one tunable:</p><ul><li><p><code>rate_limit_us</code></p><p>Minimum time (in microseconds) that has to pass between two consecutive runs of governor computations (default: 1000 times the scaling driver’s transition latency).The purpose of this tunable is to reduce the scheduler context overhead of the governor which might be excessive without it.</p></li></ul><p>This governor generally is regarded as a replacement for the older <a href="https://www.kernel.org/doc/html/v4.14/admin-guide/pm/cpufreq.html#ondemand">ondemand</a> and <a href="https://www.kernel.org/doc/html/v4.14/admin-guide/pm/cpufreq.html#conservative">conservative</a> governors (described below), as it is simpler and more tightly integrated with the CPU scheduler, its overhead in terms of CPU context switches and similar is less significant, and it uses the scheduler’s own CPU utilization metric, so in principle its decisions should not contradict the decisions made by the other parts of the scheduler.</p><h3 id="ondemand"><a href="#ondemand" class="headerlink" title="ondemand"></a><code>ondemand</code></h3><p>This governor uses CPU load as a CPU frequency selection metric.</p><p>In order to estimate the current CPU load, it measures the time elapsed between consecutive invocations of its worker routine and computes the fraction of that time in which the given CPU was not idle. The ratio of the non-idle (active) time to the total CPU time is taken as an estimate of the load.</p><p>If this governor is attached to a policy shared by multiple CPUs, the load is estimated for all of them and the greatest result is taken as the load estimate for the entire policy.</p><p>The worker routine of this governor has to run in process context, so it is invoked asynchronously (via a workqueue) and CPU P-states are updated from there if necessary. As a result, the scheduler context overhead from this governor is minimum, but it causes additional CPU context switches to happen relatively often and the CPU P-state updates triggered by it can be relatively irregular. Also, it affects its own CPU load metric by running code that reduces the CPU idle time (even though the CPU idle time is only reduced very slightly by it).</p><p>It generally selects CPU frequencies proportional to the estimated load, so that the value of the <code>cpuinfo_max_freq</code> policy attribute corresponds to the load of 1 (or 100%), and the value of the <code>cpuinfo_min_freq</code> policy attribute corresponds to the load of 0, unless when the load exceeds a (configurable) speedup threshold, in which case it will go straight for the highest frequency it is allowed to use (the <code>scaling_max_freq</code> policy limit).</p><p>This governor exposes the following tunables:</p><ul><li><p><code>sampling_rate</code></p><p>This is how often the governor’s worker routine should run, in microseconds.Typically, it is set to values of the order of 10000 (10 ms). Its default value is equal to the value of <code>cpuinfo_transition_latency</code> for each policy this governor is attached to (but since the unit here is greater by 1000, this means that the time represented by <code>sampling_rate</code> is 1000 times greater than the transition latency by default).If this tunable is per-policy, the following shell command sets the time represented by it to be 750 times as high as the transition latency:<code># echo </code>$(($(cat cpuinfo_transition_latency) * 750 / 1000)) &gt; ondemand/sampling_rate `</p></li><li><p><code>up_threshold</code></p><p>If the estimated CPU load is above this value (in percent), the governor will set the frequency to the maximum value allowed for the policy. Otherwise, the selected frequency will be proportional to the estimated CPU load.</p></li><li><p><code>ignore_nice_load</code></p><p>If set to 1 (default 0), it will cause the CPU load estimation code to treat the CPU time spent on executing tasks with “nice” levels greater than 0 as CPU idle time.This may be useful if there are tasks in the system that should not be taken into account when deciding what frequency to run the CPUs at. Then, to make that happen it is sufficient to increase the “nice” level of those tasks above 0 and set this attribute to 1.</p></li><li><p><code>sampling_down_factor</code></p><p>Temporary multiplier, between 1 (default) and 100 inclusive, to apply to the <code>sampling_rate</code> value if the CPU load goes above <code>up_threshold</code>.This causes the next execution of the governor’s worker routine (after setting the frequency to the allowed maximum) to be delayed, so the frequency stays at the maximum level for a longer time.Frequency fluctuations in some bursty workloads may be avoided this way at the cost of additional energy spent on maintaining the maximum CPU capacity.</p></li><li><p><code>powersave_bias</code></p><p>Reduction factor to apply to the original frequency target of the governor (including the maximum value used when the <code>up_threshold</code> value is exceeded by the estimated CPU load) or sensitivity threshold for the AMD frequency sensitivity powersave bias driver (<code>drivers/cpufreq/amd_freq_sensitivity.c</code>), between 0 and 1000 inclusive.If the AMD frequency sensitivity powersave bias driver is not loaded, the effective frequency to apply is given byf * (1 - <code>powersave_bias</code> / 1000)where f is the governor’s original frequency target. The default value of this attribute is 0 in that case.If the AMD frequency sensitivity powersave bias driver is loaded, the value of this attribute is 400 by default and it is used in a different way.On Family 16h (and later) AMD processors there is a mechanism to get a measured workload sensitivity, between 0 and 100% inclusive, from the hardware. That value can be used to estimate how the performance of the workload running on a CPU will change in response to frequency changes.The performance of a workload with the sensitivity of 0 (memory-bound or IO-bound) is not expected to increase at all as a result of increasing the CPU frequency, whereas workloads with the sensitivity of 100% (CPU-bound) are expected to perform much better if the CPU frequency is increased.If the workload sensitivity is less than the threshold represented by the <code>powersave_bias</code> value, the sensitivity powersave bias driver will cause the governor to select a frequency lower than its original target, so as to avoid over-provisioning workloads that will not benefit from running at higher CPU frequencies.</p></li></ul><h3 id="conservative"><a href="#conservative" class="headerlink" title="conservative"></a><code>conservative</code></h3><p>This governor uses CPU load as a CPU frequency selection metric.</p><p>It estimates the CPU load in the same way as the <a href="https://www.kernel.org/doc/html/v4.14/admin-guide/pm/cpufreq.html#ondemand">ondemand</a> governor described above, but the CPU frequency selection algorithm implemented by it is different.</p><p>Namely, it avoids changing the frequency significantly over short time intervals which may not be suitable for systems with limited power supply capacity (e.g. battery-powered). To achieve that, it changes the frequency in relatively small steps, one step at a time, up or down - depending on whether or not a (configurable) threshold has been exceeded by the estimated CPU load.</p><p>This governor exposes the following tunables:</p><ul><li><p><code>freq_step</code></p><p>Frequency step in percent of the maximum frequency the governor is allowed to set (the <code>scaling_max_freq</code> policy limit), between 0 and 100 (5 by default).This is how much the frequency is allowed to change in one go. Setting it to 0 will cause the default frequency step (5 percent) to be used and setting it to 100 effectively causes the governor to periodically switch the frequency between the <code>scaling_min_freq</code> and <code>scaling_max_freq</code> policy limits.</p></li><li><p><code>down_threshold</code></p><p>Threshold value (in percent, 20 by default) used to determine the frequency change direction.If the estimated CPU load is greater than this value, the frequency will go up (by <code>freq_step</code>). If the load is less than this value (and the <code>sampling_down_factor</code> mechanism is not in effect), the frequency will go down. Otherwise, the frequency will not be changed.</p></li><li><p><code>sampling_down_factor</code></p><p>Frequency decrease deferral factor, between 1 (default) and 10 inclusive.It effectively causes the frequency to go down <code>sampling_down_factor</code> times slower than it ramps up.</p></li></ul><h2 id="CPU管理命令"><a href="#CPU管理命令" class="headerlink" title="CPU管理命令"></a>CPU管理命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看当前CPU可用策略</span></span><br><span class="line">[root@k205 ~]# cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_available_governors</span><br><span class="line">performance powersave</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看当前CPU生效策略</span></span><br><span class="line">[root@k205 ~]# cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor</span><br><span class="line">performance</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看当前CPU频率</span></span><br><span class="line">[root@k205 ~]# cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_cur_freq</span><br><span class="line">2399926</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看当前所有CPU的信息</span></span><br><span class="line">[root@k205 ~]# cpupower -c all frequency-info</span><br><span class="line">analyzing CPU 0:</span><br><span class="line">  driver: intel_pstate</span><br><span class="line">  CPUs which run at the same hardware frequency: 0</span><br><span class="line">  CPUs which need to have their frequency coordinated by software: 0</span><br><span class="line">  maximum transition latency:  Cannot determine or is not supported.</span><br><span class="line">  hardware limits: 800 MHz - 3.00 GHz</span><br><span class="line">  available cpufreq governors: performance powersave</span><br><span class="line">  current policy: frequency should be within 800 MHz and 3.00 GHz.</span><br><span class="line">                  The governor &quot;performance&quot; may decide which speed to use</span><br><span class="line">                  within this range.</span><br><span class="line">  current CPU frequency: 2.40 GHz (asserted by call to hardware)</span><br><span class="line">  boost state support:</span><br><span class="line">    Supported: yes</span><br><span class="line">    Active: yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置所有CPU的模式</span></span><br><span class="line">[root@k205 ~]# cpupower -c all frequency-set -g performance</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看CPU的频率</span></span><br><span class="line">[root@k205 ~]# cat /proc/cpuinfo | grep &quot;cpu MHz*&quot;</span><br><span class="line">cpu MHz         : 2399.926</span><br></pre></td></tr></table></figure><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul><li><a href="https://www.kernel.org/doc/html/v4.14/admin-guide/pm/working-state.html">Linux Kernel官方文档：Working-State Power Management</a></li><li><a href="https://www.intel.cn/content/www/cn/zh/gaming/resources/game-server.html">Intel官方文档：如何设置专用游戏服务器</a></li><li><a href="https://www.intel.cn/content/www/cn/zh/gaming/resources/turbo-boost.html">Intel官方文档：什么是英特尔® 睿频加速技术？</a></li><li><a href="https://www.intel.cn/content/www/cn/zh/gaming/resources/how-to-overclock.html">Intel官方文档：如何超频您未锁频的英特尔® 酷睿™ 处理器</a></li><li><a href="https://www.cnblogs.com/ggzhangxiaochao/p/13948483.html">cpupower调整CPU主频</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Generic-Scaling-Governors&quot;&gt;&lt;a href=&quot;#Generic-Scaling-Governors&quot; class=&quot;headerlink&quot; title=&quot;Generic Scaling Governors&quot;&gt;&lt;/a&gt;Generic Sca</summary>
      
    
    
    
    <category term="Linux" scheme="https://renyb2.github.io/categories/Linux/"/>
    
    
    <category term="Linux" scheme="https://renyb2.github.io/tags/Linux/"/>
    
    <category term="CPU" scheme="https://renyb2.github.io/tags/CPU/"/>
    
  </entry>
  
</feed>
